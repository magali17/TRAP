---
title: "Aim 1: Survival Analysis"
author: "Magali Blanco"
date: " `r Sys.Date()` "
output: 
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
editor_options: 
  chunk_output_type: console
---
```{r, echo=F}
#NOTES
##4. merge with github. always do these 4 steps all together. enter the following into the Terminal (does not work any other way for some reason)
###a. git pull origin master #do this before start editing & before you're read to upload changes again
###b. git add A1.1_Survival.Rmd 
###c. git commit -m "my commit message in parentheses" 
###d. git push origin master

# see BIOST 537 Ch 5 Lecture, slide 33/57 

#plot multiple saved plots 
#grid.arrange(plot.interact, plot.complex, ncol = 2)

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache=T, cache.comments = F, message = F, warning = F, tidy.opts=list(width.cutoff=60), tidy=TRUE, fig.height = 8)  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
      detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

pacman::p_load(survival, haven, tidyverse, knitr, Hmisc, EnvStats, lubridate)  #Himsc: describe(); EnvStats: summaryFull() #coxphw: coxphw() for non-prop hazards

#To open doc:/home/gradstudent/magali/a. TRAP Project/R TRAP Project/data/issue_001.sas7bdat 

# dem0 <- read_sas(file.path("~", "a. TRAP Project", "R TRAP Project", "data", "issue_001_3.sas7bdat"), NULL)

source("A1.0.2_Var&Fns.R")

dem0.0 <- read_sas(file.path("Data", "Aim 1", "issue_001_4.sas7bdat"), NULL)

#remove SAS labels
labelled::var_label(dem0.0) <- NULL

#data that can be used for all analyses 
dem0.1 <- dem0.0 %>% 
  filter(
    #drop PM10 predictions
    pollutant %in% c("no2", "pm25")
    ) %>%
  select(
    study_id,
    birthdt,
    intakedt,
    last_visit,
    birth_cohort,
    corrected_onsetdate,
    onsetage,
    #"corrected_" = final decision on outcome
    corrected_anydementia,  
    corrected_dsmivdx,
    final_nindx,
    
    #M1, 6, sensitivity analyses
    exposure_year:exp_mos_coverage20_yr, 
    
    #M2
    apoe,
    male,
    education, degree,
    tr_med_inc_hshld, 
    race,
    
    #M3
    smoke, pack_years, 
    exercise, exercise_reg,
    
    #M4a
    Hypertension, Diabetes,
    CV_DIS, #indicates whether subject has ever reported having stroke, TIA, or CEA.
    Heart_Dis, #indicates whether subject has ever reported having an MI, Angina, CABG, or Angioplasty.
    bmi, bmi4,
    
    #M4b
    casi_irt, casi_valid
    ) %>%
  
  #create/clean up variables
  mutate(
    #rename updated variables for correct outcomes
    nindx = final_nindx,
    dsmivdx = corrected_dsmivdx,
    anydementia = corrected_anydementia,
    onsetdate = corrected_onsetdate,
    
    age_intake = round(as.numeric(intakedt - birthdt)/365, 3),  
    age_last_visit = round(as.numeric(last_visit - birthdt)/365, 3),  
    #traditional definition used by ACT for follow-up time for cases and controls
    age_onset = round(as.numeric(onsetdate - birthdt)/365, 3),
    age_act = round(ifelse(!is.na(age_onset), age_onset, age_last_visit), 3),
    #collapse earliest & latest cohorts since there are few ppl here 
    # birth_cohort = factor(ifelse(birth_cohort <= 1915, "1919 or earlier", 
    #                        ifelse(birth_cohort >= 1925, "1925 or later", birth_cohort))),  
    # update anydementia. Unless someone was suspected of dementia and was evaluated for it, the ANYDEMENTIA (as well as DSMIVDX, ANYAD, NINDX, etc.) field will be blank. Think of ‘0’ as a confirmation of no dementia, while blank as a presumption of no dementia.
    anydementia = ifelse(is.na(anydementia), 0, anydementia),
    dsmivdx = ifelse(is.na(dsmivdx), 0, dsmivdx),
    #dsmivdx = factor(dsmivdx, levels = c(0:6), labels = c("no dementia", "AD", "Vascular", "Other medical", "Substance", "Multiple etiologies", "Other or unknown cause")),
    nindx = ifelse(is.na(nindx), 0, nindx),
    #nindx = factor(nindx, levels = c(0:3), labels = c("no dementia", "probable AD", "possible AD", "Dementia, type unknown")),
     #Time-varying covariates
     ##starting age is age on Jan 1st of a given year if participant was enrolled, or on intake date, whichever came later
    age_start_exposure = round(ifelse(format(intakedt, "%Y") == exposure_year,
                                as.numeric(intakedt-birthdt)/365,
                                as.numeric(as.Date(paste0(exposure_year, "-01-01")) - birthdt)/365), 3),
    ##ending age is age at end of year or last visit date, whichever came first 
    age_end_exposure = round(ifelse(format(last_visit, "%Y") == exposure_year,
                                as.numeric(last_visit - birthdt)/365,
                                as.numeric(as.Date(paste0(exposure_year, "-12-31")) - birthdt)/365), 3),
    ### need to change age_last_visit to age_act for sensitivity analyses
    dementia_now = ifelse(age_end_exposure < age_last_visit, 0, anydementia),
    
    
    ad_nincds = ifelse(nindx %in% c(1,2), 1, 0),
    ad_now = ifelse(age_end_exposure < age_last_visit, 0, ad_nincds),
    
    
    
    #bmi4 = factor(bmi4, levels = c(0:3), labels = c("underweight", "normal", "overweight", "obese")),
    ## filter out invalid casi scores 
    casi_irt = ifelse(casi_valid ==1, casi_irt, NA),
    # recategorize?
    income_cat = #ifelse(tr_med_inc_hshld < 20000, 1,
                               ifelse(tr_med_inc_hshld < 35000, 1, #tr_med_inc_hshld >= 20000 & 
                                      ifelse(tr_med_inc_hshld >= 35000 & tr_med_inc_hshld < 50000, 2,
                                             ifelse(tr_med_inc_hshld >= 50000 & tr_med_inc_hshld < 75000, 3, 4)
                                             )), #),
    race_white = ifelse(race == 1, 1, 0),
    # ? make unknown degree=9 6 instead of creating more NAs?
    degree = ifelse(degree != 9, degree, 6)
    
    ) %>%
  select(
    study_id,
    birthdt, birth_cohort, intakedt, onsetdate, last_visit, 
    age_intake, age_act, age_last_visit, 
    
    anydementia, dsmivdx, nindx, ad_nincds,
    dementia_now, ad_now,
    
    age_start_exposure, age_end_exposure,
    #enrollment_yr,
    exposure_year, pollutant, exp_avg01_yr:exp_mos_coverage20_yr,
    
    apoe:degree, tr_med_inc_hshld, income_cat,race, race_white, smoke:bmi4, casi_irt, 
  ) 
 
#remove to speed up coding?
#rm(dem0.0)

#how long have participants been followed? 
yr <- dem0.1 %>%
  group_by(study_id) %>%
  mutate(
    intake_yr = as.numeric(min(format(intakedt, "%Y"))),
    last_visit_yr = as.numeric(min(format(last_visit, "%Y"))),
    fu_yrs = last_visit_yr - intake_yr +1
    ) %>%
  select(
    study_id, intake_yr, last_visit_yr, fu_yrs #yr_n  #pollutant
  ) %>%
  unique()

# 1 row per follow-up/exposure year
enrollment_yrs <-rep(yr$study_id, yr$fu_yrs) %>%
  as.data.frame() %>%
  rename(study_id = ".") %>%
  left_join(yr) %>%
  group_by(study_id) %>%
  mutate(
    #use min() b/c need 1 value and all vector values are same
    enrollment_yr = seq(1:min(fu_yrs)),
    exposure_year = seq(from=min(intake_yr), to=min(last_visit_yr))) %>%
  select(study_id, fu_yrs, enrollment_yr, exposure_year) %>%
  as.data.frame()

#data that can be used for all analyses 
dem0.1 <-  dem0.1 %>% 
  #keep all enrollment years
  right_join(enrollment_yrs) %>%
  select(
    study_id:age_end_exposure,
    fu_yrs,
    enrollment_yr,
    exposure_year:casi_irt
  )

#rm(dem0.0)


# #proportion of observations with at least 95% of months in 10-year period; for NO2 and PM2.5
# prop.table(table(dem0.1$exp_mos_coverage10_yr>0.95)) %>% round(2)

#data for primary and some secondary analyses 
dem1 <- dem0.1 %>% 
  filter(
    #drop exposure predictions after the last visit when individuals are no longer "at risk" of the terminating event. 
    ## --> note: when using act_age, have to change last_visit to onsetdate
    exposure_year <= as.numeric(format(last_visit, "%Y")),
  ) %>%
  mutate(
     #only keep predictions w/ at least x% coverage
    exp_avg01_yr = ifelse(exp_mos_coverage01_yr >= min.pct, exp_avg01_yr, NA),
    exp_avg05_yr = ifelse(exp_mos_coverage05_yr >= min.pct, exp_avg05_yr, NA),
    exp_avg10_yr = ifelse(exp_mos_coverage10_yr >= min.pct, exp_avg10_yr, NA),
    exp_avg20_yr = ifelse(exp_mos_coverage20_yr >= min.pct, exp_avg10_yr, NA),
    exp_avg10_yr10yrlag = ifelse(exp_mos_coverage10_yr10yrlag >= min.pct, exp_avg10_yr10yrlag, NA),
    exp_avg10_yr20yrlag = ifelse(exp_mos_coverage10_yr20yrlag >= min.pct, exp_avg10_yr20yrlag, NA),
    )   

#make wide format
no2 <- dem1 %>% 
  filter(pollutant == "no2") %>%
  select(-pollutant) %>%
  rename(
    no2_1yr = exp_avg01_yr,
    no2_5yr = exp_avg05_yr,
    no2_10yr = exp_avg10_yr,
    no2_20yr = exp_avg20_yr,
    no2_10yr10yrlag = exp_avg10_yr10yrlag,
    no2_10yr20yrlag = exp_avg10_yr20yrlag,
    no2_coverage_1yr = exp_mos_coverage01_yr,
    no2_coverage_5yr = exp_mos_coverage05_yr,
    no2_coverage_10yr = exp_mos_coverage10_yr,
    no2_coverage_20yr = exp_mos_coverage20_yr,
    no2_coverage_10yr10yrlag = exp_mos_coverage10_yr10yrlag,
    no2_coverage_10yr20yrlag = exp_mos_coverage10_yr20yrlag
    ) 

pm25 <- dem1 %>% 
  filter(pollutant == "pm25") %>%
  select(-pollutant) %>%
  rename(
    pm25_1yr = exp_avg01_yr,
    pm25_5yr = exp_avg05_yr,
    pm25_10yr = exp_avg10_yr,
    pm25_20yr = exp_avg20_yr,
    pm25_10yr10yrlag = exp_avg10_yr10yrlag,
    pm25_10yr20yrlag = exp_avg10_yr20yrlag,
    pm25_coverage_1yr = exp_mos_coverage01_yr,
    pm25_coverage_5yr = exp_mos_coverage05_yr,
    pm25_coverage_10yr = exp_mos_coverage10_yr,
    pm25_coverage_20yr = exp_mos_coverage20_yr,
    pm25_coverage_10yr10yrlag = exp_mos_coverage10_yr10yrlag,
    pm25_coverage_10yr20yrlag = exp_mos_coverage10_yr20yrlag
    )   
dem.w <- full_join(no2, pm25)

#add indicator for whether rows are used in model 2. Do this after creating dem.w, otherwise in_m2 value results in duplicate rows w/ NAs.
dem1 <- dem1 %>%
  mutate(
    in_m2 = (pollutant == "no2" & !is.na(exp_avg10_yr) & !is.na(male) & !is.na(degree) & !is.na(race_white) & !is.na(income_cat) & !is.na(birth_cohort) & !is.na(apoe))
  )

dem.w <- dem.w %>% 
  mutate(
    in_m2 = (!is.na(no2_10yr) & !is.na(male) & !is.na(degree) & !is.na(race_white) & !is.na(income_cat) & !is.na(birth_cohort) & !is.na(apoe))
  )

```

```{r}
fixed.covariates <- dem.w %>%
  select(
    # study_id, birth_cohort,
    # age_intake, age_act, age_last_visit,
    # anydementia, dsmivdx, nindx, ad_nincds,
    study_id:ad_nincds,
    apoe:casi_irt
    ) %>% 
  #make all variables numeric; code has values starting at 0, whereas as.numeric() starts at 1, subtract 1 to fix
  mutate(
    #bmi4 = as.numeric(bmi4)-1,
    # dsmivdx = as.numeric(dsmivdx)-1,
    # nindx = as.numeric(nindx)-1
    birth_yr = as.numeric(format(birthdt, "%Y")),
    intake_yr = as.numeric(format(intakedt, "%Y")),
    onset_yr = as.numeric(format(onsetdate, "%Y")),
    last_visit_yr = as.numeric(format(last_visit, "%Y"))
    ) %>%
  #drop dates, which are not "numeric" 
  select(
    -birthdt, -intakedt, -onsetdate, -last_visit
  ) %>%
  #one row per individual
  unique() 

```


# Quality Control

Make sure age variables make sense.

```{r}
#check that ages make sense ages
table(round(dem.w$age_intake, 1) <= round(dem.w$age_act, 1))  
#View(dem.w[which(dem.w$age_intake > dem.w$age_act),]) 
table(dem.w$age_intake <= dem.w$age_last_visit)
#View(dem.w[which(dem.w$age_intake > dem.w$age_last_visit),]) #study_id: 4647 has wrong last_visit/intakedt? last_visit is correct. "Will be updated in next freeze"
table(dem.w$age_act <= dem.w$age_last_visit)

#dementia 
dementia_counts <- dem.w %>% 
  group_by(study_id) %>%
  dplyr::summarize(
    #study_id = mean(study_id),
    #number of times each patient has dementia_now==1 (should be max 1)
    anydementia = mean(anydementia),
    dem_now_n = sum(dementia_now==1)
  ) 

##check that individuals who have anydementia=1 also have dementia_now=1 & those who don't don't  
dementia_counts %>%
  with(., table(anydementia, dem_now_n))

##check that individuals only have 1 dementia_now
dementia_counts %>%
  with(., table(dem_now_n <= 1))
#View(dem.w[which(dem.w$age_intake > dem.w$age_last_visit),]) 
#study_id 1027 has 2 dementia_now's b/c last visit age vs end of year age, which rounded to same thing
#View(dem.w[dem.w$study_id==1027,]) 

#AD 
ad_counts <- dem.w %>% 
  group_by(study_id) %>%
  dplyr::summarize(
    ad_nincds = mean(ad_nincds),
    ad_now_n = sum(ad_now==1)
  ) 
##check that individuals who have ad_nincds=1 also have ad_now=1 & those who don't don't #looks good
ad_counts %>%
  with(., table(ad_nincds, ad_now_n))

##check that individuals only have 1 ad_now
ad_counts %>%
  with(., table(ad_now_n <= 1))

```



# Descriptive Statistics 

## Sample size

```{r, echo=T}
#sample size 
##no. in cohort 
cohort_ids <- dem.w %>%
  select(study_id) %>%
  unique() 

n_cohort <- length(cohort_ids$study_id)

##no of cases
cases_ids <- dem.w %>%
  filter(anydementia==1) %>%
  select(study_id) %>%
  unique() 

n_cases <- length(cases_ids$study_id)

## no. noncases
non_cases_ids <-dem.w %>%
  filter(anydementia==0) %>%
  select(study_id) %>%
  unique()  

n_noncases <- length(non_cases_ids$study_id)

case_proportion <- round(n_cases/n_cohort, 2)
  
n_personyears <- nrow(dem.w)

data.frame(cohort = n_cohort, 
          cases = n_cases, 
          non_cases =n_noncases,
          case_proportion = case_proportion,
                total_person_years = n_personyears
           ) %>%
  kable(caption = "Sample size")
 
```

## Dementia incidence over time   

```{r dementia}

#enrolled participants & dementia incidence over time
dem.w %>%
  mutate(dementia_now = factor(dementia_now, levels = c(1,0))) %>%
  ggplot(aes(x= exposure_year, 
             fill= dementia_now
             #fill=dsmivdx
             )) + 
  geom_bar() + 
  labs(title = "enrolled participants",
       fill = "dementia incidence"
       ) #+ 
  #scale_y_log10()


#dementia incidence over time
dem.w %>%
  filter(dementia_now==1) %>%
  ggplot(aes(x= exposure_year,  fill=dsmivdx)) + 
  geom_bar() + 
  labs(title= "number of dementia incident cases over time")

#follow-up time
##new id by intake date  
new_id <- dem.w %>%
  arrange(intakedt) %>%
  select(study_id) %>%
  unique() %>%
  mutate(id = row_number())

dem.w %>% 
  #filter(study_id < 1100) %>%
  left_join(new_id) %>%
  mutate(dementia_now = factor(dementia_now)) %>%
  ggplot(aes(x=exposure_year, y=id, group=id, colour=dementia_now)) + 
  geom_line() +
  geom_point(aes())
  #geom_point(data=dem.w[dem.w$dementia_now==1,], aes(x=exposure_year, y=id))

```

## AP Exposure

Statistics calculated for individuals for whom we know at least `r min.pct*100`% of their past residential address (e.g., 114/120 months for 10-year avg).

Using NO2 (ppb) and PM2.5 (µg/m3) concentration at baseline.

```{r exposure}
#participants in M2 at any time point
m2.participants <- dem1 %>%
  filter(in_m2 == TRUE) %>%
  select(study_id) %>%
  unique()  
m2.participants <- m2.participants$study_id

dem.bsl <- dem1 %>%
  filter(
    #1st year of enrollment (baseline)
    enrollment_yr == 1
    ) %>%
  #drop unnecessary rows
  select(-c(exp_avg01_yr, exp_avg05_yr, exp_avg10_yr10yrlag:exp_avg20_yr,
            exp_mos_coverage01_yr:exp_mos_coverage20_yr)) %>%
  mutate(
    #in_m2 as long as Any rows (years) used (thus this count is greater than in_m2 variable)
    m2_id = study_id %in% m2.participants
  )
#table(in_m2=dem.bsl$in_m2, in_m2.2=dem.bsl$m2_id)  
#View(dem.bsl[c("study_id", "in_m2", "m2_id")])


#calculate enrollment pollutant levels
bsl.expo.distrib <- dem.bsl %>% 
  group_by(pollutant) %>%
  drop_na(exp_avg10_yr) %>%
  dplyr::summarize(
    N = n(),
    median = median(exp_avg10_yr),
    iqr = IQR(exp_avg10_yr),
    mean = mean(exp_avg10_yr),
    sd = sd(exp_avg10_yr),
    min = min(exp_avg10_yr),
    max = max(exp_avg10_yr)
  )

kable(bsl.expo.distrib, digits = 0, caption = "Air Pollution Levels During Enrollment")

```

Correlation between NO2 and PM2.5 seem high.    
-confounding may be an issue
-using 10 yr avgs

```{r}
# 10 yr correlations
(no2_pm25_10yr_r2 <- with(dem.w, 
                         cor(no2_10yr, pm25_10yr,
                             method = "pearson",
                             use = "complete.obs")^2))

```


```{r}
#new variable for being above/below median AP exposure 

median.bsl.no2 <- bsl.expo.distrib %>%
  filter(pollutant == "no2") %>%
  select(median) %>%
  as.numeric() %>% round()
 
median.bsl.pm25 <- bsl.expo.distrib %>%
  filter(pollutant == "pm25") %>%
  select(median) %>%
  as.numeric() %>% round()

#variable for whether baseline concentrations are above/below median concentration
dem.bsl <- dem.bsl %>%
  mutate(
    no2_median = ifelse(pollutant == "no2" & exp_avg10_yr >= median.bsl.no2, "above", 
                         ifelse(pollutant == "no2" & exp_avg10_yr < median.bsl.no2,"below", NA)),
    pm25_median = ifelse(pollutant == "pm25" & exp_avg10_yr >= median.bsl.pm25, "above", 
                         ifelse(pollutant == "pm25" & exp_avg10_yr < median.bsl.pm25,"below", NA))
    ) 

```

## Distribution of key covariates.

```{r}

#histograms
fixed.covariates %>% 
  gather(key = "variable",  value = "value", -study_id) %>%   
  ggplot(aes(x=value)) + 
  geom_histogram() +
    facet_wrap(~variable, scales = "free")

```

Distribution of variables used in models. Do any have less than ~~ 50 individuals?

```{r}
fixed.covariates %>%
  select(
    birth_cohort,
    apoe,
    male,
    degree,
    income_cat,
    race_white,
    smoke,
    exercise_reg,
    Hypertension,
    Diabetes,
    CV_DIS,
    Heart_Dis,
    bmi4,
    #casi_irt
  ) %>%
  mutate(
    apoe = factor(apoe),
    male = factor(male),
    race_white = factor(race_white),
    exercise_reg = factor(exercise_reg),
    Hypertension = factor(Hypertension),
    Diabetes = factor(Diabetes),
    CV_DIS = factor(CV_DIS),
    Heart_Dis = factor(Heart_Dis),
    bmi4 = factor(bmi4)
    ) %>%
  describe()
  


```

```{r}
 


```


Individuals in each birth Cohort and birth year. Some 5-year cohorts have few only 1 individual

```{r}
#birth cohort/year
fixed.covariates %>%
  gather(key = "variable",  value = "value", -study_id) %>%  
  filter(variable %in% c("birth_yr", "birth_cohort")) %>%
  #ggplot(aes(x=birth_cohort, group=birth_cohort)) + 
  #geom_histogram()
  ggplot(aes(x=value)) + 
  geom_histogram() +
    facet_wrap(~variable, scales = "free")

#table(fixed.covariates$birth_yr)
table(fixed.covariates$birth_cohort)

```

Degree.

```{r}
fixed.covariates %>%
  gather(key = "variable",  value = "value", -study_id) %>%  
  filter(variable %in% c("degree", "education")) %>%
  #ggplot(aes(x=birth_cohort, group=birth_cohort)) + 
  #geom_histogram()
  ggplot(aes(x=value)) + 
  geom_histogram() +
    facet_wrap(~variable, scales = "free")

# issue: what is degree 9? has 2/few individuals 
table(degree = fixed.covariates$degree)
table(edu = fixed.covariates$education)


# how is degree categorized???
table(degree = fixed.covariates$degree, edu = fixed.covariates$education)

```

Income. Only 7 individuals in income category 1. Combine categories 1 and 2?

```{r}
fixed.covariates %>%
  gather(key = "variable",  value = "value", -study_id) %>%  
  filter(variable %in% c("income_cat", "tr_med_inc_hshld")) %>%
  #ggplot(aes(x=birth_cohort, group=birth_cohort)) + 
  #geom_histogram()
  ggplot(aes(x=value)) + 
  geom_histogram() +
    facet_wrap(~variable, scales = "free")

table(income_cat = fixed.covariates$income_cat)

```








### Missingness  

Data is for all individuals with NO2 and/or PM2.5 predictions.    
-lot of individuals with missing apoe readings    

```{r}

fixed.covariates %>% summaryFull(digit.type = "round")  
#describe()  #Info: how continuous the variable is, Gmd: Gini's mean difference - measure of dispersion

```

## Table 1
Participant baseline characteristics. Percents are calculated based on the number of individuals with available data (missing values removed). Some participants did not have baseline exposure estimates and are thus excluded from above/below median columns. 
 
How others have stratified:   
-most proivde a table for the entire cohort (? & don't state which went into models?)   
- entire cohort vs dementia cases (chen 2017)   
- by exposure quartiles at baseline (baseline was during same time period, e.g., 1993-1995) (Oudin 2016; Chang 2014) ["baseline" was same time period for cohort]   
- mean personal AP  
 
```{r}
#characteristics for entire cohort 
t1.all <- dem.bsl %>% 
#1 row per participant
  filter(pollutant == "no2") %>%
  unique() %>%
  t1.fn(data=.)

kable(t1.all, caption = "Cohort Baseline Characteristics")

#characteristics by pollutant and concentration level
## no2
t1.no2.all <- dem.bsl %>%
  filter(pollutant == "no2") %>%
  #drop ppl w/o  exposure estimates @ their baseline
  drop_na(exp_avg10_yr) %>%
  t1.fn(data = ., column.name = "no2 all")

t1.no2.below <- dem.bsl %>%
  filter(pollutant == "no2",
         no2_median == "below") %>%
  t1.fn(data = ., column.name = "no2 below")

t1.no2.above <- dem.bsl %>%
  filter(pollutant == "no2",
         no2_median == "above") %>%
  t1.fn(data = ., column.name = "no2 above")

t1.no2.na <- dem.bsl %>%
  filter(pollutant == "no2",
         is.na(no2_median) ) %>%
  t1.fn(data = ., column.name = "no2 NA")

t1.no2 <- cbind(t1.no2.all, 
                t1.no2.below, 
                t1.no2.above, 
                t1.no2.na)

## pm2.5
t1.pm25.all <- dem.bsl %>%
  filter(pollutant == "pm25") %>%
  drop_na(exp_avg10_yr) %>%
  t1.fn(data = ., column.name = "pm25 all")

t1.pm25.below <- dem.bsl %>%
  filter(pollutant == "pm25",
         pm25_median == "below") %>%
  t1.fn(data = ., column.name = "pm25 below")

t1.pm25.above <- dem.bsl %>%
  filter(pollutant == "pm25",
         pm25_median == "above") %>%
  t1.fn(data = ., column.name = "pm25 above")

t1.pm25.na <- dem.bsl %>%
  filter(pollutant == "pm25",
         is.na(pm25_median) ) %>%
  t1.fn(data = ., column.name = "pm25 NA")

t1.pm25 <- cbind(t1.pm25.all, 
                t1.pm25.below, 
                t1.pm25.above, 
                t1.pm25.na)

t1.by.pollutant <- cbind(t1.no2, t1.pm25)

kable(t1.by.pollutant, caption = "Cohort Characteristics by 10 yr avg Air Pollution Exposure Estimates Upon Enrollment")

#characteristics by dementia status
t1.dem.case <- dem.bsl %>%
  #1 row per participant
  filter(pollutant == "no2") %>%
  filter(anydementia == 1) %>%
  t1.fn(data = ., column.name = "Dementia")

t1.dem.noncase <- dem.bsl %>%
  #1 row per participant
  filter(pollutant == "no2") %>%
  filter(anydementia == 0) %>%
  t1.fn(data = ., column.name = "No Dementia")

t1.by.anydementia <- cbind(t1.dem.case, t1.dem.noncase)

kable(t1.by.anydementia, caption = "Cohort Characteristics by Dementia Outcome")

#characteristics by AD status
t1.ad.case <- dem.bsl %>%
  #1 row per participant
  filter(pollutant == "no2") %>%
  filter(ad_nincds == 1) %>%
  t1.fn(data = ., column.name = "AD")

t1.ad.noncase <- dem.bsl %>%
  #1 row per participant
  filter(pollutant == "no2") %>%
  filter(ad_nincds == 0) %>%
  t1.fn(data = ., column.name = "No AD")

t1.by.ad <- cbind(t1.ad.case, t1.ad.noncase)

kable(t1.by.ad, caption = "Cohort Characteristics by AD Outcome")

```

# Inferential Statistics

 
## Primary Analysis, Redued & Extended Models

"Hazard of dementia incidence is __% higher for every additional 10 ppb of NO2 exposure in the past 10 years.

```{r}
#dataset with model variables of interest for descriptive purposes (similar dataset generated in models.fn())
model.vars <- dem.w %>%
  select(
    #m1 & sensitivity
    no2_1yr:no2_20yr ,
    #m2
    apoe,
    male,
    race_white,
    income = income_cat,
    edu = degree,
    birth_cohort,
    #m3
    smoke,
    exercise_reg,
    #m4
    Hypertension,
    Diabetes, 
    CV_DIS,
    Heart_Dis,
    bmi = bmi4,
    #m6
    pm25_1yr:pm25_20yr,
    #pm25_10yr
    ) %>%
  mutate(
  #make factors
    income = factor(income),
    edu = factor(edu),
    birth_cohort = factor(birth_cohort),
    smoke = factor(smoke),
    
    #make 10 ppb units
    no2_10ppb_1yr = no2_1yr/my.no2.units,
    no2_10ppb_5yr = no2_5yr/my.no2.units,
    no2_10ppb_10yr = no2_10yr/my.no2.units,
    no2_10ppb_20yr = no2_20yr/my.no2.units,
    no2_10ppb_10yr10yrlag = no2_10yr10yrlag/my.no2.units,
    no2_10ppb_10yr20yrlag = no2_10yr20yrlag/my.no2.units,
    
    #make 5 mg/m3
    pm25_5ugm3_1yr = pm25_1yr/my.pm25.units,
    pm25_5ugm3_5yr = pm25_5yr/my.pm25.units,
    pm25_5ugm3_10yr = pm25_10yr/my.pm25.units,
    pm25_5ugm3_20yr = pm25_20yr/my.pm25.units,
    pm25_5ugm3_10yr10yrlag = pm25_10yr10yrlag/my.pm25.units,
    pm25_5ugm3_10yr20yrlag = pm25_10yr20yrlag/my.pm25.units,
   ) %>%
  #drop these columns to avoid confusion, since using 10 ppb for NO2 and 5 ug/m3 for pm2.5
  select(-c(no2_1yr:no2_20yr, 
            pm25_1yr:pm25_20yr)) 

```

### Correlations of variables in models     

See high correlatin (R^2) between NO2 and PM2.5. Results may be confounded by PM2.5.

```{r}
#plots
model.vars %>% 
  mutate(
    #make numeric for cor() fn
    income = as.numeric(income),
    edu = as.numeric(edu),
    birth_cohort = as.numeric(birth_cohort),
    smoke = as.numeric(smoke)
    ) %>%
  #select(apoe:bmi) %>%
  cor(method = "pearson",
      use ="complete.obs") %>%
  corrplot::corrplot(method="color")
 

# #more descriptive correlation plots but take too long to load
# model.vars %>%
#   mutate(
#     #make numeric for cor() fn
#     income = as.numeric(income),
#     edu = as.numeric(edu),
#     birth_cohort = as.numeric(birth_cohort),
#     smoke = as.numeric(smoke)
#     ) %>%
#   select(-c(no2_10ppb_1yr:pm25_5ugm3_10yr20yrlag)) %>%
#   #select(apoe, bmi) %>%
#   PerformanceAnalytics::chart.Correlation(histogram = T, pch=19)

r <- model.vars %>% 
  mutate(
    #make numeric for cor() fn
    income = as.numeric(income),
    edu = as.numeric(edu),
    birth_cohort = as.numeric(birth_cohort),
    smoke = as.numeric(smoke)
    ) %>%
    select(no2_10ppb_1yr:pm25_5ugm3_10yr20yrlag) %>%
  cor(method = "pearson",
      use ="complete.obs")  

r2 <- r^2

kable(r2, caption = "R2", digits = 3)

```

### Dementia Incidence, Different Exposure Windows   

```{r }
#run all models, all exposure windows
dem.results <- diff.exposures.fn(mydata.2 = dem.w,
                   surv.time2.2 = "age_end_exposure", 
                   surv.event.2 = "dementia_now", 
                   outcome.text.2 = "Dementia")

#table of all HRs for all times & models
kable(dem.results$HRs, caption = "Dementia HRs")

#plot of all HRs for all times & models
#### --> large CI for 20 yr copollutant model
dem.results$HRs %>%
  filter(hr <11) %>%
  hr.plot(., outcome.var = "Dementia")   

# example of raw model output
print("10 yr exposure model")
dem.results$model.output$`10yr` #$model2


```


## Other Sensitivity Analyses    
### AD outcome    

```{r}
#run all models, all exposure windows
ad.results <- diff.exposures.fn(mydata.2 = dem.w,
                   surv.time2.2 = "age_end_exposure", 
                   surv.event.2 = "ad_now", 
                   outcome.text.2 = "AD")

#table of all HRs for all times & models
kable(ad.results$HRs, caption = "AD HRs")

#plot of all HRs for all times & models
#### --> large CI for 20 yr copollutant model
ad.results$HRs %>%
  filter(hr <11) %>%
  hr.plot(., outcome.var = "AD")   

# example of raw model output
print("10 yr exposure model")
ad.results$model.output$`10yr`

```


### Redefine dementia onset to match ACT study definition

```{r}
##when using ONSET AGE (age_act), need to drop exposure predictions after age_act. filter(age_at_exposure <= age_act) & dementia_now = ifelse(age_at_exposure < age_act, 0, anydementia),

```



### Cox model assumptions and inference validity    
1. Proportional hazards Assumption    
a) Schoenfeld residuals. If the proportional hazards model is correctly specified, there should be no trend in the residuals over time (uncorrelated, with mean zero across event times)

#### --> check that the final M2 is being used here, once

```{r}
#run model since m2 is now in the models.fn()
##create survival object w/ TVC dataset (accounts for "delayed entry")

#individuals w/ only baseline observations are dropped/NAs created
s.dem <- with(dem.w, Surv(
  # --> update so that time < time2
  time = age_start_exposure,
  time2 = age_end_exposure,
  event = dementia_now
  )
  )

# 541 NA's produced out of 46,513 rows (1.1%)
#table(is.na(s.dem))

m2 <- model.vars %>%
  #prep the dataset for use in the function, set correct no2 estimate you want to use in the model
  rename(
    no2 = no2_10ppb_10yr,
    #pm25 = pm25_5ugm3_10yr
    ) %>%
    coxph(s.dem ~ no2 + strata(apoe) + male + race_white + income + 
            #factor(degree) + factor(birth_cohort), 
            edu +  birth_cohort, 
          #don't use edu & birth year categories b/c too few ppl w/ low degrees and early birth years, thus reference category is small/unstable? 
          #education + as.numeric(format(birthdt, "%Y")),
          data=., 
          robust = T,
          #ties = "exact" #output is weird if use this
    ) 
  
m2.s <- m2 %>% summary()
  
```

```{r}
# # TEST
# (t <- model.vars %>%
#   #prep the dataset for use in the function, set correct no2 estimate you want to use in the model
#   rename(
#     no2 = no2_10ppb_10yr,
#     #pm25 = pm25_5ugm3_10yr
#     ) %>%
#     coxph(s.dem ~ no2 + strata(apoe) + male + race_white + income + 
#             #factor(degree) + factor(birth_cohort), 
#             edu +  birth_cohort, 
#           #don't use edu & birth year categories b/c too few ppl w/ low degrees and early birth years, thus reference category is small/unstable? 
#           #education + as.numeric(format(birthdt, "%Y")),
#           data=., 
#           robust = T,
#           ties = "exact" #output is weird if use this
#     )
# )
#   
# (t.s <- t %>% summary())

```


```{r}
## ?? what are the values in each vector/model variable? 
schoenresid = residuals(m2, type = "scaledsch")
## ?? is this failure time? 
time = as.numeric(rownames(schoenresid))

# link no2_10yr & "times" column
cbind(resid=schoenresid[,1], time) %>%
  as.data.frame() %>%
  ggplot(aes(x=time, y=resid)) + 
  geom_point() + 
  geom_smooth() + 
  labs(y = "scaled Schoenfeld residuals",
       x = "failure time (age at dementia incidence)")

```

b. formally test. using cox.zph(). if global p-val is significant, assumption is violated   
-assumption is violated. ?? are median income and exposure year the reason why? 

```{r}
cox.zph(m2)
```

2. linear relationship between continuous covariates and log hazard of the outcome    
### --> use survminer::ggcoxfunctiona()

```{r}
##??
martingalesid = residuals(m2, type = "martingale")
## ? error, diff lengths??
#cbind(resid=martingalesid, no2_10yr=dem.w$no2_10yr) #%>%
  # as.data.frame() %>%
  # ggplot(aes(x=no2_10yr, y=resid)) + 
  # geom_point() + 
  # geom_smooth() + 
  # labs(y = "Martingale residuals"
  #     )

```

### --> $ \triangle \beta $ doesn't work  
3. no outliers or influential observations, $ \triangle \beta $

### --> calculate standardized delta Bs?    
 
```{r}
# B537 L3, slide 125

# ? don't have to fit M2 again w/ subset=ind?
dfbetas <- residuals(m2, type="dfbeta") 

#rename columns
colnames(dfbetas) <- names(coef(m2))

dfbetas %>%  
  as.data.frame() %>%
  #get rows used in model
  rownames_to_column(var = "ind") %>%
  mutate(ind = as.numeric(ind)) %>%
  #make long format
  gather(covariate, value, -ind) %>%
  as.data.frame() %>%
  #plot
  ggplot(aes(x=ind, y=value)) +
  geom_point() +
  facet_wrap(~covariate, scales="free") + 
  labs(x="observation index",
       y= "delta beta")

```



### Restrict Analysis to individuals for whom we have high quality data

```{r}



```

### Adjust for baseline CASI score 

```{r}

```

### Adjust for ACT cohort 

```{r}

```

### IPW for missing APOE

-APOE is more likely to be missing if: 
--predictor variables: ppl born later in time, later intake year, have CV_dis, diabetes, ??low/high education, less exercise, non-whites, ?current smoker   
--outcomes: AD, demenentia, younger during last visit or onset date, later onset year

Rachel: "...if there are missing values in the predictor variables for the IPW selection modeling, it won't work, so Lianne had me create different versions of those variables without any missingness (ie: re-classifying them to the most logical alternative) before doing the IPW in my other analysis."
 
```{r}
# see B540 L7-8

apoe.l <- fixed.covariates %>%
  mutate(
    apoe_available = !is.na(apoe)
  ) %>% 
  select(-apoe) %>%
  gather("variable", "value", -study_id, -apoe_available) %>%
  mutate(
    group = group_indices(., variable)
  )

#MAR: are missing APOE values assoc w/ other measured variables, including calendar time? 
#NMAR: are missing APOE associated w/ dementia or AD incidence that we don't obseve...? 

apoe.l %>%
  #only look at first few variables
  filter(group %in% c(1:15)) %>%
  ggplot(aes(x=value, fill= apoe_available)) + 
  #geom_histogram(aes(y = stat(density)), position = "dodge") +
  geom_density(alpha=0.3) +  #stat = "density"
  facet_wrap(~variable, scales="free") #+ 
  #scale_y_continuous(labels = percent_format()) 

apoe.l %>%
  #only look at first few variables
  filter(group %in% c(16:max(group))) %>%
  ggplot(aes(x=value, fill= apoe_available)) + 
  #geom_histogram(aes(y = stat(density)), position = "dodge") +
  geom_density(alpha=0.3) +  #stat = "density"
  facet_wrap(~variable, scales="free") #+ 

# ? run models? 
## make wide format for models
apoe.w <- apoe.l %>%
  select(-group) %>%
  spread(variable, value)

```

```{r old model using manually selected predictor variables}
# -predictor variables: ppl born later in time, later intake year, have CV_dis, diabetes, ??low/high education, less exercise, non-whites, ?current smoker   
# --outcomes: AD, demenentia, younger during last visit or onset date, later onset year

# apoe.w %>%
#   glm(apoe_available ~ age_last_visit + birth_cohort + age_intake + intake_yr +
#         CV_DIS + Diabetes + factor(degree) + exercise_reg + race_white + factor(smoke) + 
#         anydementia
#         ,
#   family = "binomial",
#   data = .
#   ) %>%
#   summary()

# are missing APOE values associated w/ AP (above/below median)? 
# ? Is it a confounder...? 

```

```{r}
# IPW with coxph()
###1. use selection model (e.g. lasso for glm) to select predictors of whether or now we have APOE values for people: apoe_available (in apoe.w)
### 2. fit logistic model to determine probability of observing an observation given predictors: glm(apoe_available ~ [predictors])
### 3. use model w/ dataset to get predicted values (probability of being observed), 
### 3b. ? repeate for other variables w/ a lot of missing data (e.g. income?) to get probability of being observed; multiply by apoe probability to get overall probability that both variables were observed
### 4. take the inverse of probabilities to calculate "weights", use these weights in coxph(, weights = c()) 
#### ?? any issues w/ other, non-APOE variables being missing? 



```


```{r}
# optional, could repeate and use weights based on the probability that All of the M2 predictors (not just APOE) are observed (e.g., all_covs_available ~ [predictors])

```




```{r}

```


### Optional

1. finer adjustments for confounders
2. use a continuous adjustment for education. And other variables?

```{r}


```



```{r lincom}
# estimating SE & CIs for linear combinations of coefficients
# m2c <- coxph(surv.addicts ~ dose*prison + strata(clinic), data=addicts)
# #summary(m2c)
# 
# est <- as.numeric(exp(60*coef(m2c)["dose"] + 1*coef(m2c)["prison"] + 100*coef(m2c)["dose:prison"]))
# 
# se <- deltamethod(g = ~exp(60*x1 + x2 + 100*x3),
#                   mean = coef(m2c)[c("dose", "prison", "dose:prison")],
#                   cov= vcov(m2c)[c("dose", "prison", "dose:prison"), 
#                                  c("dose", "prison", "dose:prison")],
#                   ses = T) 
# 
# ci = as.numeric(c(est-se*1.96, est+ se*1.96))

```

