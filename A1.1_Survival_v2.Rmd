---
title: 'Aim 1: Dementia Survival Analysis'
author: "Magali Blanco"
date: ' `r Sys.Date()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
  pdf_document:
    toc: yes
    toc_depth: '3'
editor_options:
  chunk_output_type: console
---


```{r}
# --> TO DO
# --> road proximity exposure sensitivity analysis
# --> NO2 predictions from ST model
 
```

```{r, echo=F}
#NOTES
# network/pacific/rad/transfer

##4. merge with github. always do these 4 steps all together. enter the following into the Terminal (does not work any other way for some reason)
###a. git pull origin master #do this before start editing & before you're read to upload changes again
###b. git add A1.1_Survival.Rmd 
###c. git commit -m "my commit message in parentheses" 
###d. git push origin master

##########
# calculating gap lengths:
# x = c(1,2,4,NA,NA,6,NA,19,NA,NA)
# res = rle(is.na(x))
# rep(res$values*res$lengths,res$lengths)

```

```{r}
# ABOUT THIS DATASET
# exact_ variables: NAs indicate either no location, or no pollutant level info over the period of interest. Whenever you see an NA on exact_, there should also be NA in the corresponding exp_avg var

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      cache=F, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE,
                      dpi=300,
                      fig.height = 4
                      )  
set.seed(1)

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
      detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

# Load key packages using pacman 
my_repo <- 'http://cran.r-project.org'
if (!require("pacman")) {install.packages("pacman", repos = my_repo)}

#Himsc: describe(); EnvStats: summaryFull(); survminer: ggflexsurvplot()  
pacman::p_load(knitr, kableExtra,
               Hmisc, EnvStats, lubridate, 
               survival, survminer, glmnet, splines,
               #attach these last to use these functions as the defaults?
               tidyverse, dplyr,
               qwraps2
               )  

```

# Model Notation

Primary analysis model

$$h(age) = h_0(age|APOE) exp ( \beta_1 X_{NO_2} } + \beta_2 X_{gender} + \beta_3 X_{edu} + \beta_4 X_{income} + \beta_5 X_{race} + \beta_6 X_{birthcohort})$$






```{r}
#other directory:/home/gradstudent/magali/a. TRAP Project/R TRAP Project/data/issue_001.sas7bdat 
# dem0 <- read_sas(file.path("~", "a. TRAP Project", "R TRAP Project", "data", "issue_001.sas7bdat"), NULL)

source("0.Global_Fns.R")
source("A1.0.2_Var&Fns.R")

# main dataset
dem0.0 <- haven::read_sas(file.path("Data", "Aim 1", "200702 Survival", "issue_001.sas7bdat"), NULL)
# exposure at age 65
dem0.0_65 <-  haven::read_sas(file.path("Data", "Aim 1", "200702 Survival", "issue_001_supp.sas7bdat"), NULL)

#remove SAS labels
labelled::var_label(dem0.0) <- NULL
labelled::var_label(dem0.0_65) <- NULL

```

create a primary dataset.

### --> update use_model "_SP" to "_ST" later

```{r}
use_model <- c("_SP", "_ST")

#data that can be used for all analyses 
dem0.1 <- dem0.0 %>% 
  #drop PM10 predictions
  filter(pollutant != "pm10") %>%
  select(
    study_id,
    birthdt,
    intakedt,
    last_visit,
    
    deathdt,
    
    birth_cohort,
    corrected_onsetdate,
    onsetage,
    #"corrected_" = final decision on outcome
    corrected_anydementia,
    corrected_dsmivdx,
    final_nindx,

    #M1, 6, sensitivity analyses
    exposure_year, #age_at_exposure,
    pollutant, 
    
    # exp avg & coverage variables
    contains(use_model, ignore.case = F), 

    #M2
    apoe,
    male,
    degree, #education, 
    ## household income at the longest addressed lived at prior to baseline. It may include the date of the baseline
    tr_med_inc_hshld,
    race,

    #M3
    smoke, #pack_years,
    exercise_reg, #exercise, 
    cohort,

    #M4a
    Hypertension, Diabetes,
    CV_DIS, #indicates whether subject has ever reported having stroke, TIA, or CEA.
    Heart_Dis, #indicates whether subject has ever reported having an MI, Angina, CABG, or Angioplasty.
    bmi=bmi4, #bmi, 

    #M4b
    casi_irt, casi_valid,
    #address exactness
    
    # sensitivity analyses
    one_location,
    imputed_coverage10_yr, imputed_coverage01_yr,
    exact_coverage10_yr, exact_coverage01_yr,
    imp_qual10_yr,
    
    #deathdt
    ) %>%
  #create/clean up variables
  mutate(
    #rename updated variables for correct outcomes
    nindx = final_nindx,
    dsmivdx = corrected_dsmivdx,
    anydementia = corrected_anydementia,
    onsetdate = corrected_onsetdate,
    
    age_intake = as.numeric(intakedt - birthdt)/365,  
    age_last_visit = as.numeric(last_visit - birthdt)/365,
    #traditional definition used by ACT for follow-up time for cases and controls
    age_onset = as.numeric(onsetdate - birthdt)/365, 
    age_act = ifelse(!is.na(age_onset), age_onset, age_last_visit), 
    
    # original binning for modeling
    birth_cohort_5yr = birth_cohort,
    #collapse earliest & latest cohorts since there are few ppl here - for tables/figures
    birth_cohort = factor(ifelse(birth_cohort <= 1905, 1895,
                           ifelse(birth_cohort >= 1935, 1935, birth_cohort))),
    #create 2 yr cal time categories like Rachel's: "2-year categories, except for a 3-year category covering the most recent years 2016-2018"
    cal_t = factor(ifelse(exposure_year==2018, 2016, floor(exposure_year/2)*2)),
    
    # update anydementia. Unless someone was suspected of dementia and was evaluated for it, the ANYDEMENTIA (as well as DSMIVDX, ANYAD, NINDX, etc.) field will be blank. Think of ‘0’ as a confirmation of no dementia, while blank as a presumption of no dementia.
    anydementia = ifelse(is.na(anydementia), 0, anydementia),
    dsmivdx = ifelse(is.na(dsmivdx), 0, dsmivdx),
    nindx = ifelse(is.na(nindx), 0, nindx),
     #Time-varying covariates
     ##starting age is age on Jan 1st of a given year if participant was enrolled, or on intake date, whichever came later
    age_start_exposure = ifelse(format(intakedt, "%Y") == exposure_year,
                                as.numeric(intakedt-birthdt)/365,
                                as.numeric(as.Date(paste0(exposure_year, "-01-01")) - birthdt)/365), 
    ##ending age is age at end of year or last visit date, whichever came first 
    age_end_exposure = ifelse(format(last_visit, "%Y") == exposure_year,
                                as.numeric(last_visit - birthdt)/365,
                                as.numeric(as.Date(paste0(exposure_year, "-12-31")) - birthdt)/365),
    ### need to change age_last_visit to age_act for sensitivity analyses
    dementia_now = ifelse(age_end_exposure < age_last_visit, 0, anydementia),
    
    ad_nincds = ifelse(nindx %in% c(1,2), 1, 0),
    ad_now = ifelse(age_end_exposure < age_last_visit, 0, ad_nincds),
    
    ## filter out invalid casi scores 
    casi_irt = ifelse(casi_valid ==1, casi_irt, NA),
    
    # Roy - accidentally made this a character?
    tr_med_inc_hshld = as.numeric(tr_med_inc_hshld),
    
    income_cat = ifelse(tr_med_inc_hshld < 35000, 1,  
                                      ifelse(tr_med_inc_hshld >= 35000 & tr_med_inc_hshld < 50000, 2,
                                             ifelse(tr_med_inc_hshld >= 50000 & tr_med_inc_hshld < 75000, 3, 4)
                                             )),  
    race_white = ifelse(race == 1, 1, 0),
    # make unknown degree=9 an 6 ("other") to avoid creating more NAs; 
    # Rachel/Lianne - change 9 to none? 
    degree = ifelse(degree != 9, degree, 0),
    # combine GED and HS. Note, there is now no degree==2, but shoudn't matter since this is treated as a categorical variable
    degree = ifelse(degree %in% c(1:2), 1, degree)
    ) %>%
  select(
  study_id,
  birthdt, birth_cohort_5yr, birth_cohort, cal_t, cohort, intakedt, onsetdate, last_visit,
  
  deathdt,
  
  age_intake, age_act, age_last_visit,

  anydementia, dsmivdx, nindx, ad_nincds,
  dementia_now, ad_now,

  age_start_exposure, age_end_exposure,
  exposure_year, pollutant, 
  
  # exposure averages & coverage
  contains(use_model), 
                            
  apoe:degree, income_cat,race_white, smoke:bmi, casi_irt, #race, bmi4, tr_med_inc_hshld,

  one_location,
  exact_coverage10_yr, exact_coverage01_yr,
  imputed_coverage10_yr, imputed_coverage01_yr,
  imp_qual10_yr
  )
 
#how long have participants been followed? 
yr <- dem0.1 %>%
  group_by(study_id) %>%
  mutate(
    intake_yr = as.numeric(min(format(intakedt, "%Y"))),
    last_visit_yr = as.numeric(min(format(last_visit, "%Y"))),
    fu_yrs = last_visit_yr - intake_yr +1
    ) %>%
  select(study_id, intake_yr, last_visit_yr, fu_yrs) %>%
  unique()

# 1 row per follow-up/exposure year
enrollment_yrs <-rep(yr$study_id, yr$fu_yrs) %>%
  as.data.frame() %>%
  rename(study_id = ".") %>%
  left_join(yr, by = "study_id") %>%
  group_by(study_id) %>%
  mutate(
    #use min() b/c need 1 value and all vector values are same
    enrollment_yr = seq(1:min(fu_yrs)),
    exposure_year = seq(from=min(intake_yr), to=min(last_visit_yr))) %>%
  select(study_id, fu_yrs, enrollment_yr, exposure_year) %>%
  as.data.frame()

dem1 <-  dem0.1 %>% 
  #keep all enrollment years
  right_join(enrollment_yrs, by = c("study_id", "exposure_year")) %>%
  select(
  study_id:age_end_exposure,
  fu_yrs,
  enrollment_yr,

  exposure_year:casi_irt,

  one_location,
  imputed_coverage10_yr, # "doesn't exist"?? #imputed_coverage01_yr,
  exact_coverage10_yr, exact_coverage01_yr,
  imp_qual10_yr,
  
  deathdt
  ) %>%
  filter(
    #drop ppl with only a baseline observation
    intakedt != last_visit,
    #drop exposure predictions after the last visit when individuals are no longer "at risk"  
    ## note: when using act_age, have to change last_visit to onsetdate
    exposure_year <= as.numeric(format(last_visit, "%Y")),  
    ) 

```

```{r}
#make wide format
no2 <- dem1 %>% 
  filter(pollutant == "no2") %>%
  select(-pollutant) %>%
  rename(
    #rename values to be used in main analysis

    ### --> change SP to ST when have new predictions
    
    no2_1yr = exp_avg01_yr_SP,
    no2_5yr = exp_avg05_yr_SP,
    no2_10yr = exp_avg10_yr_SP,
    no2_20yr = exp_avg20_yr_SP,
    no2_10yr10yrlag = exp_avg10_yr10yrlag_SP,
    no2_10yr05yrlag = exp_avg10_yr05yrlag_SP,
    
    no2_coverage_1yr = exp_wks_coverage01_yr_SP,
    no2_coverage_5yr = exp_wks_coverage05_yr_SP,
    no2_coverage_10yr = exp_wks_coverage10_yr_SP,
    no2_coverage_20yr = exp_wks_coverage20_yr_SP,
    no2_coverage_10yr10yrlag = exp_wks_coverage10_yr10yrlag_SP,
    no2_coverage_10yr05yrlag = exp_wks_coverage10_yr05yrlag_SP,
    ) %>%
  
  ### --> won't need this later
  # drop ST predictions 
  select(-contains("ST", ignore.case = F))

pm25 <- dem1 %>% 
  filter(pollutant == "pm25") %>%
  select(-pollutant) %>%
  rename(
    
    ### --> change SP to ST when have new predictions
    
    pm25_1yr = exp_avg01_yr_ST,
    pm25_5yr = exp_avg05_yr_ST,
    pm25_10yr = exp_avg10_yr_ST,
    pm25_20yr = exp_avg20_yr_ST,
    pm25_10yr10yrlag = exp_avg10_yr10yrlag_ST,
    pm25_10yr05yrlag = exp_avg10_yr05yrlag_ST,
    
    pm25_coverage_1yr = exp_wks_coverage01_yr_ST,
    pm25_coverage_5yr = exp_wks_coverage05_yr_ST,
    pm25_coverage_10yr = exp_wks_coverage10_yr_ST,
    pm25_coverage_20yr = exp_wks_coverage20_yr_ST,
    pm25_coverage_10yr10yrlag = exp_wks_coverage10_yr10yrlag_ST,
    pm25_coverage_10yr05yrlag = exp_wks_coverage10_yr05yrlag_ST,
    ) %>%
  
  ### --> won't need this later
  # drop ST predictions 
  select(-contains("SP", ignore.case = F))

a1  <- dem1 %>% 
  filter(pollutant == "a1") %>%
    select(-pollutant) %>%
  # values are available under "SP" rather than "ST"
  rename(a1_10yr = exp_avg10_yr_SP) %>%
  #drop these columns, which are blank or unnecessary for road analysis since they are duplicated in the no2 and pm25 datasets
  select_if(str_detect(names(.), "exp_avg|exp_wks_coverage", negate = T)) 
            
a2  <- dem1 %>% 
  filter(pollutant == "a2") %>%
    select(-pollutant) %>%
  # values are available under "SP" rather than "ST"
  rename(a2_10yr = exp_avg10_yr_SP) %>%
  #drop these columns, which are blank or unnecessary for road analysis since they are duplicated in the no2 and pm25 datasets
  select_if(str_detect(names(.), "exp_avg|exp_wks_coverage", negate = T))  

a3  <- dem1 %>% 
  filter(pollutant == "a3") %>%
    select(-pollutant) %>%
  # values are available under "SP" rather than "ST"
  rename(a3_10yr = exp_avg10_yr_SP) %>%
  #drop these columns, which are blank or unnecessary for road analysis since they are duplicated in the no2 and pm25 datasets
  select_if(str_detect(names(.), "exp_avg|exp_wks_coverage", negate = T))  

# define TIME near road as falling in columns m_a-m_d
near_rd <- dem1 %>%
  # define near-road as ma-me
  filter(grepl(pattern ="^m_[a-d]", x = pollutant)) %>%
  group_by(study_id, exposure_year) %>%
  #mutate(
  dplyr::summarize(
    near_rd_10yr = sum(exp_avg10_yr_SP)
  ) #%>% select(study_id, exposure_year, pollutant, exp_avg10_yr_SP, near_rd_10yr)


dem.w <- full_join(no2, pm25)  %>%
  #left join since a1 has more person-years corresponding to ppl who moved otu of the ST modeling area (where we have no NO2 or PM2.5 predictions)
  left_join(a1) %>% left_join(a2) %>% left_join(a3) %>%
  left_join(near_rd)

#check that only a few additinoal columns have been added (i.e., not additional duplicate columns due to name changes) #looks good
#dim(dem.w)

#define near rd
near_a1 <- 300
near_a2 <- 50
near_a3 <- 50

dem.w <- dem.w %>%
  # DISTANCE from road - if on avg, they lived near road
  mutate(
  near_rd_cat = ifelse(exp(a1_10yr) <= near_a1 | exp(a2_10yr) <= near_a2 | exp(a3_10yr) <= near_a3, "Near (A-D)", 
                          ifelse(exp(a1_10yr) > near_a1 & (exp(a2_10yr) > 150 | exp(a3_10yr) > 150), "Far (F)", "Mid (E)")
                          )
  )

#dem.w.$near_rd_cat

```

```{r}
# dem.w.2 %>% group_by(near_rd_cat) %>% dplyr::summarize(n = n(), min_a1 = min(exp(a1_10yr)), max_a1 = max(exp(a1_10yr)), min_a2 = min(exp(a2_10yr)), max_a2 = max(exp(a2_10yr)), min_a3 = min(exp(a3_10yr)), max_a3 = max(exp(a3_10yr))) 

 

```


Add estimates at age 65 to main dataset. 

### --> change _SP to _ST later?

```{r}

# add exposure at age 65
dem0.1_65 <- dem0.0_65 %>%
  select(
    study_id,
    exposure_year_65 = exposure_year,
    pollutant, 
    
    ### --> change _SP to _ST later
    
    exp_avg10_age_65_SP,  
    exp_wks_coverage10_age_65_SP,
    
    exact_coverage10_age_65, 
    imputed_coverage10_age_65
  )
 
dem_65_no2 <- dem0.1_65 %>% 
   filter(pollutant== "no2") %>%
   select(-pollutant) %>%
   rename(
     
    # ---> change _SP to _ST later
     
     no2_exp_avg10_age_65 = exp_avg10_age_65_SP,
     no2_exp_wks_coverage10_age_65 = exp_wks_coverage10_age_65_SP,
   )
    
dem_65_pm25 <- dem0.1_65 %>% 
   filter(pollutant== "pm25") %>%
   select(-pollutant) %>%
   rename(
     
     # ---> change _SP to _ST later
     
    pm25_exp_avg10_age_65 = exp_avg10_age_65_SP,
    pm25_exp_wks_coverage10_age_65 = exp_wks_coverage10_age_65_SP,
   )
 
dem_65 <- full_join(dem_65_no2, dem_65_pm25)

dem.w <- left_join(dem.w, dem_65)
 
```



```{r}
### --> ? Only including people with an exact address at least 80% of their follow-up time? 

```

create a dataset for alternative analyses using onset age rather than diagnosis age.

```{r}
#add variables for alternative analysis using age at onset (cases) or age at last visit (noncases)
dem.w2 <- dem.w %>%
  mutate(
    last_act_fu_yr = ifelse(!is.na(onsetdate), year(onsetdate),
                             year(last_visit)),
    age_end_exposure2 = ifelse(last_act_fu_yr == exposure_year,
                                age_act,
                                as.numeric(as.Date(paste0(exposure_year, "-12-31")) - birthdt)/365),  
    dementia_now2 = ifelse(age_end_exposure2 < age_act, 0, anydementia),
    ad_now2 = ifelse(age_end_exposure2 < age_act, 0, ad_nincds),
  ) %>%
  #drop exposure predictions after individuals are no longer "at risk"  
  filter(exposure_year <= last_act_fu_yr)

```

create a person-level (non-time-varying, fixed covariate) dataset 

```{r}
# create a person-level, fixed covariates dataset 
fixed.covariates <- dem.w %>%
  select(
    study_id:birthdt, 
    #don't include birth_cohort_5yr
    birth_cohort:ad_nincds,
    apoe:casi_irt,
    
    #don't include this for now. cal_t is similar to birth_cohort
    -deathdt, -cal_t
    ) %>% 
  #make all variables numeric; code has values starting at 0, whereas as.numeric() starts at 1, subtract 1 to fix
  mutate(
    birth_cohort = as.numeric(birth_cohort),
    birth_yr = as.numeric(format(birthdt, "%Y")),
    intake_yr = as.numeric(format(intakedt, "%Y")),
    onset_yr = as.numeric(format(onsetdate, "%Y")),
    last_visit_yr = as.numeric(format(last_visit, "%Y")),
    ) %>%
  #drop dates, which are not "numeric" 
  select(-birthdt, -intakedt, -onsetdate, -last_visit, -onset_yr) %>%
  #one row per individual
  unique() 

# str(fixed.covariates)

```

```{r}
# common variables 
m2_all_vars <- c("apoe", "male", "race_white", "income_cat", "degree", 
                 "cal_t",
                 #"birth_cohort", #"birth_cohort_5yr", 
                 "no2_10yr") 
## adjustment variables
m2_vars <- c("apoe", "male", "race_white", "income_cat", "degree", "cal_t"#,
             #"birth_cohort" #"birth_cohort_5yr"
             ) 



```


# Sample Size 

Sample size for entire cohort (includes those with missing covariate values not included in any/some analyses) and those included in the primary analysis (Model 2).

### --> why does M2 here have 4 more ppl than below (e.g., Table 1)? 

```{r}

total_n <- dem.w %>%
  summarize(
    N = "Total",
    person_years = n(),
    persons = length(unique(study_id)),
    proportion = n()/nrow(.)
  ) 

m2_n <- dem.w %>%
  drop_na(m2_all_vars) %>%
  summarize(
    N = "Primary analysis",
    person_years = n(),
    persons = length(unique(study_id)),
    proportion = n()/nrow(dem.w)
  )
  
rbind(total_n, m2_n) %>%
  kable(caption = "Sample size", 
        digits = 2) %>%
  kable_styling()

```


```{r}
# #sample size 
# ##no. in cohort 
# cohort_ids <- dem.w %>%
#   select(study_id) %>%
#   unique() 
# 
# n_cohort <- length(cohort_ids$study_id)
# 
# ##no. of cases
# cases_ids <- dem.w %>%
#   filter(anydementia==1) %>%
#   select(study_id) %>%
#   unique() 
# 
# n_cases <- length(cases_ids$study_id)
# 
# ## no. noncases
# non_cases_ids <-dem.w %>%
#   filter(anydementia==0) %>%
#   select(study_id) %>%
#   unique()  
# 
# n_noncases <- length(non_cases_ids$study_id)
# 
# case_proportion <- round(n_cases/n_cohort, 2)
#   
# n_personyears <- nrow(dem.w)
# 
# data.frame(cohort = n_cohort, 
#           cases = n_cases, 
#           non_cases =n_noncases,
#           case_proportion = case_proportion,
#                 total_person_years = n_personyears
#            ) %>%
#   kable(caption = "Sample size") %>%
#   kable_styling()
 
```


# QAQC  

## Missingness

Number of missing observations for fixed covariates. 

APOE has the most missingness observations. A few individuals have misising BMI and other health indicators. Very few individuals have missing income or race indicators.

```{r}
missing_df <- colSums(is.na(fixed.covariates)) %>% as.data.frame() %>%
  rownames_to_column() 

names(missing_df) <- c("Covariate", "N")

missing_df %>%
  filter(N >0)  %>%
  mutate(Percent = N/nrow(fixed.covariates)*100,
         #TOTAL_MISSING = sum(Percent)
         ) %>%
  rbind(c("TOTAL" ,sum(.$N), sum(.$Percent))) %>%
  mutate(Percent = round(as.numeric(Percent), 2)) %>%
  
  arrange(desc(Percent)) %>%
  kable(caption = "Number and proportion of total of missing observations by covariate", 
        #digits = 2
        ) %>%
  kable_styling()

```

### APOE 

Plots of APOE availability by enrollment year. There are proportionally more missing APOE values for more recent years. This may be because they have not yet had their blood work processed.
 
```{r}
apoe_avail_ct_p <- dem.w %>%
  filter(enrollment_yr==1) %>%
  mutate(exposure_year = factor(exposure_year)) %>%
  ggplot(aes(x=exposure_year, fill = !is.na(apoe))) + 
  geom_bar() + 
  theme(axis.text.x = element_text( angle = 90)) + 
  labs(x = "Exposure year",
       y = "Count",
      fill = "APOE available"
       )

apoe_avail_prop_p <- dem.w %>%
  filter(enrollment_yr==1,
         ) %>%
  mutate(exposure_year = factor(exposure_year)) %>%
  ggplot(aes(x=exposure_year, fill = !is.na(apoe))) + 
  geom_bar(position = "fill") + 
  theme(axis.text.x = element_text( angle = 90)) + 
  labs(x = "Exposure year",
       y = "proportion",
       fill = "APOE available"
       )

ggarrange(apoe_avail_ct_p,
          apoe_avail_prop_p, 
          ncol=1,   
          common.legend = T, legend = "bottom",
          heights = c(1,1), 
          labels = "Enrolless by APOE availability"
          )

```

Calculate weights for IPW analysis. Stabilizing weights for IPW based on logistic regression models. Using lasso-selected variable predictors of APOE availability for the denominator and a gender predictor for the numerator.

```{r}
# see B540 L7-8
# Approach:
#1. fill in missing values with their most likely option (mean for continuous, mode for categorical variables)
#2. use selection model (e.g. lasso for glm) to select predictors of whether or not we have APOE values for people: apoe_available (in apoe.w)
# 3. fit logistic model to determine probability of observing an observation given predictors: glm(apoe_available ~ [predictors]). use model w/ dataset to get predicted values (probability of being observed), 
# 4. calculate stablized weights 

apoe0 <- fixed.covariates %>%
  mutate(apoe_available = !is.na(apoe)) %>% 
 dplyr::select(-apoe) 

#1. replace missing values w/ most likely outcome  
##variables w/ missing values  
with.nas <- names(which(colSums(is.na(apoe0)) > 0))

# "income_cat"   "race_white"   "smoke"        "exercise_reg" "Hypertension" "Diabetes"     "CV_DIS"       "Heart_Dis"    "bmi"  "casi_irt"     

# making this all 0s since all but casi_irt are categorical. Filling in missing w/ the model.
#1 = TRUE, 0 = FALSE
mynumeric <- rep(0, length(with.nas))

apoe <- apoe0  
#replace  missing values w/ mean (if numeric) or mode (if factor)
for (i in seq_along(with.nas)) {
  #vector w/ missing values 
  myvar <- with.nas[i]  
  apoe[[myvar]] <- replace.nas.fn(apoe[[myvar]], 
                                  numeric = mynumeric[i])
  }

#check that there are no more NAs #looks good
#describe(apoe) 
#table(!is.na(apoe))
 
#2. Use Lasso to select variables most predictive of APOE being present
#apoe2 <-apoe 

apoe <- apoe %>%
  #convert character variables to numberic
  mutate_if(is.character, as.numeric) %>%
  #convert these to factors
  mutate_at(c("birth_cohort", 
              "nindx", 
              "dsmivdx",
              "degree",
              "income_cat",
              "smoke",
              "bmi"
              ), 
            as.factor)

lasso_results <- lasso_fn(dt = apoe, x_names = names(apoe)[2:(ncol(apoe)-1)], y_name = "apoe_available", family. = "binomial", 
                          lambda. = ""
                          )

lasso.vars <- lasso_results$results$cov

#select selected variables if they are in main dataset as is or if the name is prior to a number. prevents similarly-named variables (e.g. exercise vs exercise_reg) from being selected
#save names & relabel categorized bmi4 variable for now (has issues in loop below b/c of #4 - selects both "bmi" & "bmi4") 
lasso_names <- lasso.vars  
apoe_names <- names(apoe)  

selected_cov <- vector()

for (i in seq_len(length(apoe_names))) {
  #i=2 
  # find exact name or one w/ a digit after the string, e.g., birth_cohort, cohort 
  find_pattern <- paste0("^", apoe_names[i], "$", "|", "^", apoe_names[i], "\\d")
  if(any(grepl(find_pattern, lasso_names))) { selected_cov <- append(selected_cov, apoe_names[i]) }
}

apoe <- apoe %>%
  select(study_id,
         #y
        apoe_available,
        #categories selected via Lasso 
        selected_cov)  

#3. model to predict APOE variable being present
apoe.m <- apoe %>%
  select(-study_id) %>%
  glm(apoe_available ~ .,
  family = "binomial",
  data = .) 

##denominator: probability of APOE being present
apoe_available_prob <- predict(apoe.m, type = "response") 

#min(apoe_available_prob) #check that probability isn't Tiny (like when used "race")
 
#numerator: stabilizer 
apoe.male.m <- apoe %>%
  glm(apoe_available ~ male,
  family = "binomial",
  data = .) 
 
apoe_male_prob <- predict(apoe.male.m, type = "response") 

apoe.wts <- apoe %>% 
  select(study_id) %>%
  mutate(model_wt = apoe_male_prob/apoe_available_prob)
#summary(apoe.wts$model_wt)

# 4. take the inverse of probabilities to calculate "weights", use these weights in coxph(, weights = c()) 
dem.w <- dem.w %>% 
  #add stabilized weights  
  left_join(apoe.wts, by = "study_id")

#for sensitivity analyses 
dem.w2 <- dem.w2 %>% 
  #add stabilized weights  
  left_join(apoe.wts, by = "study_id")

# # Lasso-selected covariates:
# selected_cov
```

Distribution of weights: 

```{r}
ipw_all <- dem.w %>%
  distribution.table(var.string = "model_wt", round.int = 2) %>%
  mutate(Data = "Total") 

ipw_m2 <- dem.w %>%
  drop_na(m2_all_vars) %>%
  distribution.table(var.string = "model_wt", round.int = 2) %>%
  mutate(Data = "Primary analysis")

rbind(ipw_all, ipw_m2) %>%
  select(Data, everything()) %>%
  kable(caption = "Distribution of weights from IPW for person-years included in the primary analysis") %>%
  kable_styling()

```


## Distribution of Key Covariates

```{r}
#histograms
fixed.covariates %>% 
  #drop_na(m2_vars) %>%
  mutate(birth_cohort = as.numeric(birth_cohort),
         ) %>%
  gather(key = "variable",  value = "value", -study_id) %>%   
  ggplot(aes(x=value)) + 
  geom_histogram() +
  facet_wrap(~variable, scales = "free") + 
  labs(title = "Distribution of key covariates in primary analysis")

```

Dementia onset age

```{r}

# count
p1 <- fixed.covariates %>%
  mutate(
    age_last_visit2 = round(age_last_visit/5)*5,
    anydementia = ifelse(anydementia ==1, "Dementia", "No Dementia"),
    anydementia = relevel(factor(anydementia), ref = "No Dementia")
  ) %>%
  ggplot(aes(x=age_last_visit2, fill=anydementia)) + 
  geom_bar() + 
  theme(legend.position = "bottom") +
  labs(x = "", # "Age of Last Visit",
       y = "Count",
       #title = "All-cause dementia diagnosis by last visit",
       fill = ""
       )


#proportion 
p2 <- fixed.covariates %>%
  mutate(
    age_last_visit2 = round(age_last_visit/5)*5,
    anydementia = ifelse(anydementia ==1, "Dementia", "No Dementia"),
    anydementia = relevel(factor(anydementia), ref = "No Dementia")
  ) %>%
  ggplot(aes(x=age_last_visit2, fill=anydementia)) + 
  geom_bar(position = "fill") + 
  theme(legend.position = "bottom") +
  labs(x = "", #"Age of Last Visit",
       y = "Proportion",
       #title = "All-cause dementia diagnosis by last visit",
       fill = ""
       )

 

ggarrange(p1, p2, 
          ncol=1,   
          common.legend = T, legend = "bottom", 
          label.x = "Age",
          heights = c(1,1) 
          #labels = "All-cause dementia diagnosis by last visit"
          ) %>%
  annotate_figure(top = "All-cause dementia diagnosis by last visit", 
                  bottom = "Age of Last Visit"
                  )

```


## Age variables 

```{r}
dem.w %>%
    drop_na(m2_all_vars) %>%
  gather("Variable", "Age", 
         age_intake, age_last_visit, age_act, age_start_exposure, age_end_exposure,
         na.rm = T) %>%
  mutate(Variable = factor(Variable, levels=unique(Variable))) %>%
  ggplot(aes(x=Age, fill=Variable)) + 
  geom_density(alpha=0.3) + 
  labs(title = "Distribution of various age variables for person-years in the primary analysis")

```

```{r}
dem.w %>%
  drop_na(m2_all_vars) %>%
  gather("Variable", "Value", 
         age_intake, age_last_visit, age_act, age_start_exposure, age_end_exposure,
         na.rm = T) %>%
  mutate(Variable = factor(Variable, levels=unique(Variable))) %>%
  group_by(Variable) %>%
  distribution.table(var.string = "Value") %>%
  kable(caption = "Distribution of various age variables") %>%
  kable_styling()
  
```

```{r, ?d, include=F}
#check that ages make sense ages
table(round(dem.w$age_intake, 1) <= round(dem.w$age_act, 1))  
#View(dem.w[which(dem.w$age_intake > dem.w$age_act),]) 
table(dem.w$age_intake <= dem.w$age_last_visit)
#View(dem.w[which(dem.w$age_intake > dem.w$age_last_visit),]) #study_id: 4647 has wrong last_visit/intakedt? last_visit is correct. "Will be updated in next freeze"
table(dem.w$age_act <= dem.w$age_last_visit)

#dementia 
dementia_counts <- dem.w %>% 
  group_by(study_id) %>%
  dplyr::summarize(
    #study_id = mean(study_id),
    #number of times each patient has dementia_now==1 (should be max 1)
    anydementia = mean(anydementia),
    dem_now_n = sum(dementia_now==1)
  ) 

##check that individuals who have anydementia=1 also have dementia_now=1 & those who don't don't  
dementia_counts %>%
  with(., table(anydementia, dem_now_n))

##check that individuals only have 1 dementia_now
dementia_counts %>%
  with(., table(dem_now_n <= 1))
#View(dem.w[which(dem.w$age_intake > dem.w$age_last_visit),]) 
#study_id 1027 has 2 dementia_now's b/c last visit age vs end of year age, which rounded to same thing
#View(dem.w[dem.w$study_id==1027,]) 

#AD 
ad_counts <- dem.w %>% 
  group_by(study_id) %>%
  dplyr::summarize(
    ad_nincds = mean(ad_nincds),
    ad_now_n = sum(ad_now==1)
  ) 
##check that individuals who have ad_nincds=1 also have ad_now=1 & those who don't don't #looks good
ad_counts %>%
  with(., table(ad_nincds, ad_now_n))

##check that individuals only have 1 ad_now
ad_counts %>%
  with(., table(ad_now_n <= 1))

```

## Event ties

```{r}
dem.w %>%
  filter(dementia_now==1) %>%
  #for cases, age of last visit (primary analysis)
  ggplot(aes(x=age_end_exposure)) +
  geom_bar() + 
    
    labs(title = "Number of events by age (time axis)",
         x = "Age",
         y = "Number of Events"
         )
  
  
```

t119 event ties

```{r}
dem.w %>%
  filter(dementia_now==1) %>%
  group_by(age_end_exposure) %>%
  mutate(N = n()) %>%
  # ties
  filter(N >1) %>%
  select(age_end_exposure) %>%
  unique() %>% 
  nrow()
  
   
  
```

## Summary of location & prediction quality variables

All person-years have 10 yr predictions for NO2 and PM2.5. Most person-years do not have imputation (value of 0). Most person-years have exact addresses. Most person-years have the highest imputation quality (0). About 39% of the person-years are from individuals living in one location.

```{r}
dem.w %>%
  drop_na(m2_all_vars) %>%
  mutate(imp_qual10_yr_of_0or1 = imp_qual10_yr %in% c(0, 1)) %>%
  gather("variable", "value", 
         no2_coverage_10yr, pm25_coverage_10yr, 
         imputed_coverage10_yr,
         exact_coverage10_yr,
         
         #imp_qual10_yr,
         imp_qual10_yr_of_0or1,

         one_location,
         ) %>%
  drop_na(value) %>%
  mutate(variable = factor(variable, levels = unique(variable))) %>%
  group_by(variable) %>%
  distribution.table(var.string = "value", round.int = 2) %>%
  kable(caption = paste0("Distribution of location & prediction quality variable values for person-years in primary analysis")) %>%
  kable_styling()

 
  
```


## Compare numbers vs Rachel's

```{r, include=F}
summary(dem.w$age_end_exposure)

summary(dem.w2$age_end_exposure2 )

summary(dem.w$age_act) 
#summary(dem.w$age_act[dem.w$anydementia==1]) 

summary(dem.w2$last_act_fu_yr)
 

summary(fixed.covariates$age_last_visit)

table(dem.w$dementia_now)
table(dem.w2$dementia_now2)

summary(fixed.covariates$age_last_visit)
summary(fixed.covariates$age_act) 

summary(fixed.covariates$age_last_visit[fixed.covariates$anydementia==1]) 
summary(fixed.covariates$age_act[fixed.covariates$anydementia==1]) 

```



# Descriptive Statistics

## Table 1   

* note, birth cohort categories are summarized relative to how they were used in the analysis (not showing additional 5 yr birth categories for youngest and oldest cohorts)


Dementia

### --> total py should be: 41,213.  table reads: 41,195
### --> ? update "100%" in first row. add to 2nd row? 

```{r}
#table1

# everyone in sample
t1_all <- dem.w %>%
  #1st year of enrollment (baseline)
  filter(enrollment_yr == 1) %>%
  t1.fn() %>%
  #separate N & %s
  separate(col = V1, into = c("All_a", "All_b"), sep = " ", fill = "right")  %>%
    mutate_all(~str_replace(., "0 \\(NaN%\\)", "NA"))   

## Replace NAs w/ ""
t1_all$All_b[is.na(t1_all$All_b)] <- ""


# total 
t1_tot <- dem.w %>%
  # only keep individuals included in Model 2
  drop_na(m2_all_vars) %>%
  
  #mutate(tot_py = nrow(.)) %>%
  
  #1st year of enrollment (baseline)
  filter(enrollment_yr == 1) %>%
  t1.fn() %>%
  #separate N & %s
  separate(col = V1, into = c("Total_a", "Total_b"), sep = " ", fill = "right")  %>%
    mutate_all(~str_replace(., "0 \\(NaN%\\)", "NA"))   

## Replace NAs w/ ""
t1_tot$Total_b[is.na(t1_tot$Total_b)] <- ""

 

t1_all %>% 
  left_join(t1_tot) %>%
  column_to_rownames(var = "Variable") %>%
  kable(caption = "Cohort characteristics", 
        col.names = c(#"Variable", 
                      "Entire Cohort", "",  "Cohort in Primary Analysis", " " 
          ), 
        align = "r"
        ) %>%
  add_indent(c(8:14,18:23,25:28, 30:32, 35:38, 40:42, 47:49)) %>%
  add_footnote(c(
    "Primary analysis column is for participants with complete observations for: APOE status, gender, race, Census Tract income, education and birth cohort",
    "Birth cohort is summarized in fewer categories than how the analysis is performed (additional 5 yr categories)",
    "Baseline cognition is based on CASI scores that have been adjusted for accuracy using Item Response Theory (IRT). Higher numbers indicate greater cognitive function."
    ))

```

## Age distribution over time

```{r}
dem.w %>%
  drop_na(m2_vars) %>%
  ggplot(aes(x=exposure_year, y = age_start_exposure, group=exposure_year,
             )) +
  geom_boxplot() +
  geom_vline(xintercept = c(1994, 2000, 2004), col = "blue") + 
    labs(x = "Year",
         y = "Participant Age",
         col = "Birth Cohort",
         title = "Age distribution over time of person-years in the primary analysis",
         caption = "Original cohort: 1994-1999; Expansion: 2000-2002, Replacement: 2004+"
           ) 
```


## Exposure Distribution


```{r}
# NO2 
all_yrs <- dem.w %>%
  mutate(Years = "All") %>%
  group_by(Years) %>%
  drop_na(m2_vars,
          no2_1yr) %>%
  distribution.table(var.string = "no2_1yr")

by_yr <- dem.w %>%
  drop_na(m2_vars,
          no2_1yr) %>%
  mutate(Years = cut_interval(x = exposure_year, n = 4, dig.lab=4)) %>%
  group_by(Years) %>%
    distribution.table(var.string = "no2_1yr")

no2_all <- rbind(all_yrs, by_yr) 

no2_all %>%
  kable(caption = "Annual average NO2 (ppb) exposure predictions for person-years in the primary analysis") %>%
  kable_styling()
```

-more specific, by the year 

```{r}
dem.w %>%
  drop_na(m2_vars,
          no2_1yr) %>%
  group_by(exposure_year) %>%
    distribution.table(var.string = "no2_1yr") %>%
  kable(caption = "Annual average NO2 (ppb) exposure predictions for person-years in the primary analysis") %>%
  kable_styling()

```


No2 exposure by participant age and birth cohort. 

Each dot represents a person-year, such that people generally have multiple dots on the plot. Within a given birth cohort, exposure typically decreased as participants age as a result of decreasing concentrations over time. For any given age, individuals born in earlier cohorts generally have higher exposures because they were that age at an earlier time period.

```{r}
# 1 yr exposure
dem.w %>%
  drop_na(m2_vars) %>%
  group_by(birth_cohort) %>%
  #relabel birth cohort
  mutate(birth_cohort2 = paste0(min(year(birthdt)), "-", max(year(birthdt)))) %>%
  ggplot(aes(x=age_start_exposure, y = no2_1yr, col = birth_cohort2)) +
  geom_point(alpha=0.05) +
  geom_smooth(aes(col = birth_cohort2)) + 
    labs(x = "Age (years)",
         y = "Annual NO2 Exposure (ppb)",
         col = "Birth Cohort",
         title = "Annual NO2 exposure by participant age for person-years in the primary analysis"
           ) 

```

```{r}
# 10 yr exposure 
dem.w %>%
  drop_na(m2_vars) %>%
  group_by(birth_cohort) %>%
  #relabel birth cohort
  mutate(birth_cohort2 = paste0(min(year(birthdt)), "-", max(year(birthdt)))) %>%
  ggplot(aes(x=age_start_exposure, y = no2_10yr, col = birth_cohort2)) +
  geom_point(alpha=0.05) +
  geom_smooth(aes(col = birth_cohort2)) + 
    labs(x = "Age (years)",
         y = "10 yr NO2 Exposure (ppb)",
         col = "Birth Cohort",
         title = "10 yr NO2 exposure by participant age for person-years in the primary analysis"
           ) 
```

-same as above but with spaghetti plot

```{r}
dem.w %>%
  drop_na(m2_vars) %>%
   group_by(birth_cohort) %>%
   #relabel birth cohort
  mutate(birth_cohort2 = paste0(min(year(birthdt)), "-", max(year(birthdt)))) %>%
  ggplot(aes(x=age_start_exposure, y = no2_10yr, )) +
  #geom_point(alpha=0.05, aes(col = birth_cohort2)) +
  geom_line(aes(col = birth_cohort2,
                  group=study_id
                  ), 
              alpha=0.1
              ) + 
  #make alpha darker in legend 
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    labs(x = "Age (years)",
         y = "10 yr NO2 Exposure (ppb)",
         col = "Birth Cohort",
         title = "10 yr NO2 exposure by participant age for person-years in the primary analysis"
           ) 
```

-boxplots of NO2 vs year, colored by age

```{r}
age_group <- 10

dem.w %>%
  drop_na(m2_vars) %>%
  mutate(
    age2 = factor(floor(age_start_exposure/age_group)*age_group)
  ) %>%
  
  ggplot(aes(x=cal_t, y=no2_10yr, #col=age2
             )) + 
  geom_boxplot() + 
  labs(title = "NO2 exposure for a given year ",
       x = "Year",
       y="10 yr NO2 Exposure (ppb)",
       col = "Age"
       )
  
```


Distribution of geometric mean road proximity.

* On average, most participants lived relatively far from an A1 or A2 road, and closer to A3 roads when looking at the 10 yr geometric mean. 

```{r}
#road proximity
dem.w %>%
  drop_na(m2_vars) %>%
  gather(Road, Distance, str_subset(names(.), "^a[1-3]_10yr")) %>%
  #View()
  mutate(Road = toupper(str_sub(Road, 1,2)),
         Distance = exp(Distance)
         ) %>%
  ggplot(aes(x=Distance, fill=Road)) +
  geom_density(alpha=0.3) +
  facet_wrap(~Road, scales="free") +
    labs(x = "Road Proximity (m)",
         title = "10 yr road proximity for person-years in the primary analysis"
         )

```

```{r}
dem.w %>%
  gather(Road, Distance, str_subset(names(.), "^a[1-3]_10yr")) %>%
    drop_na(m2_vars, Distance) %>%
  mutate(Road = toupper(str_sub(Road, 1,2)),
         Distance = exp(Distance)
         ) %>% 
  group_by(Road) %>%
  #View()
  distribution.table(var.string = "Distance") %>%
  kable(caption = "Distribution of geometric mean 10 yr road proximity (m) by road type. N are person-years.") %>%
  kable_styling()

```

Define "near road" (A-D) as being within `r near_a1` m of an A1 road, `r near_a2` m of an A2 road or `r near_a3` m of an A3 road. Midway is (E): A1 > 300 m & A2/3 51-150 m. Away (F) is A1 > 300 m and A2/3 > 150 m.

```{r}
dem.w %>%
  drop_na(m2_all_vars,
          # --> ? why are there NAs in this variable?
          near_rd_cat
          ) %>%
  group_by(near_rd_cat) %>%
  dplyr::summarize(
    n = n(),
    perc = n/nrow(.)*100
  # "#near_rd_cat" = qwraps2::n_perc(near_rd_cat, na_rm = T, 
  #                                    show_denom = "always",
  #                                    markup = "markdown", digits = 0)  
  ) %>%
  kable(caption = "Near-road proximity and person-years (categorical analysis)", 
        col.names = c("Category", "Person-Years", "%"), 
        digits = 1,
        ) %>%
  kable_styling()
   
```

### Time near road

```{r}
road_prop_t <- data.frame(A2_or_A3 = c("<= 50 m", "51-150 m", ">150 m"), 
                          A1_within300m = c("A","B","C"),
                          A1_morethan300m = c("D", "E", "F")
                          )  
   

road_prop_t %>%
  kable(col.names = c("", "≤300 m", ">300 m"), 
        align = "lcc",
        caption = "Definition table for the geometric mean proportion of time spent 'near road' within the past 10 yrs (A-F). A-F add up to 1 for any given person-year."
          ) %>%
  add_header_above(c("A2 or A3", "A1"=2)) %>%
  column_spec(1, bold = TRUE,  
              )   %>%
  kable_styling()

```

Distribution of the proporiton of time individuals spend in each cell

```{r}
#m2_all_vars 
dem1 %>%
  drop_na(m2_vars,
          
          ) %>% 
  filter(str_detect(pollutant, "^m_[a-f]")) %>%
  ggplot(aes(x=exp_avg10_yr_SP, fill=pollutant)) +
  geom_density(alpha=0.3)
  
```




```{r}
# # - on average, most exposure periods are  spent in categories D, E and F, away from A1 roads  
# 
# dem.w %>%
#   #pearson-years w/o missing no2... predictions
#   drop_na(m2_all_vars) %>%
#   select(study_id, exposure_year) %>%
#   unique() %>%
#   
#   # dataset w/ non-aggragated, m_a-f pollutant values
#   left_join(dem1) %>%
# 
#   filter(str_detect(pollutant, "^m_[a-f]")) %>%
#   mutate(pollutant = toupper(str_extract(pollutant, "[a-f]"))) %>%
#   
#   group_by('Proximity Category' = pollutant) %>%
#   distribution.table(var.string = "exp_avg10_yr_SP",round.int = 2) %>%
#   kable(caption = "Proportion of time in past 10 yrs that individuals lived 'near road' ", 
#         ) %>%
#   kable_styling()
   

```


Proportion of time near an A1 (≤ 300 m) or near an A2/3 (≤ 50 m).

-on average, more than half of the person-years in this analysis were spent "near road."

```{r}
dem.w %>%
  drop_na(m2_all_vars, near_rd_10yr) %>%
  distribution.table("near_rd_10yr", round.int = 2) %>%
  kable(caption = "Proportion of time during past 10 yrs that individuals lived 'near road' ") %>%
  kable_styling()

```



PM2.5 exposure over time

```{r}
dem.w %>%
  drop_na(m2_vars) %>%
  ggplot(aes(x=exposure_year, y = pm25_1yr, group=exposure_year)) +
  geom_boxplot(alpha=0.05) +
    labs(x = "Year",
         y = "Annual PM2.5 Exposure (ug/m3)",
         col = "Birth Cohort",
         title = "Annual PM2.5 exposure over time for person-years in the primary analysis"
           ) 

```

```{r}

# PM2.5
all_yrs <- dem.w %>%
  mutate(Years = "All") %>%
  group_by(Years) %>%
  drop_na(m2_vars,
          pm25_1yr) %>%
  distribution.table(var.string = "pm25_1yr")

by_yr <- dem.w %>%
      drop_na(m2_vars, 
              pm25_1yr) %>%
  mutate(Years = cut_interval(x = exposure_year, n = 4, dig.lab=4)) %>%
  group_by(Years) %>%
    distribution.table(var.string = "pm25_1yr")

pm25_all <- rbind(all_yrs, by_yr) 

pm25_all %>% kable(caption = "Annual average PM2.5 (ug/m3) exposure predictions over time for person-years in the primary analysis") %>%
  kable_styling()
 
```

PM2.5 exposure by participant age and birth cohort 

```{r}
# 1 yr exposure
dem.w %>%
  drop_na(m2_vars) %>%
  group_by(birth_cohort) %>%
  mutate(birth_cohort2 = paste0(min(year(birthdt)), "-", max(year(birthdt)))) %>%
  ggplot(aes(x=age_start_exposure, y = pm25_1yr, col = birth_cohort2)) +
  geom_point(alpha=0.05) +
  geom_smooth(aes(col = birth_cohort2)) + 
    labs(x = "Age (years)",
         y = "Annual PM2.5 Exposure (ug/m3)",
         col = "Birth Cohort",
         title = "Annual PM2.5 exposure by participant age for person-years in the primary analysis"
           ) 

```

```{r}
# 10 yr exposure
dem.w %>%
  drop_na(m2_vars) %>%
  group_by(birth_cohort) %>%
  mutate(birth_cohort2 = paste0(min(year(birthdt)), "-", max(year(birthdt)))) %>%
  ggplot(aes(x=age_start_exposure, y = pm25_10yr, col = birth_cohort2)) +
  geom_point(alpha=0.05) +
  geom_smooth(aes(col = birth_cohort2)) + 
    labs(x = "Age (years)",
         y = "10 yr PM2.5 Exposure (ug/m3)",
         col = "Birth Cohort",
         title = "10 yr PM2.5 exposure by participant age for person-years in the primary analysis"
           ) 
```


## Covariate Correlations 

```{r}
r2 <- with(dem.w, cor(no2_10yr, pm25_10yr,
                method = "pearson", use = "complete.obs")^2) %>% round(2)

```

See moderate correlation (R2 = `r r2`) between NO2 and PM2.5. Non copollutant models may be confounded by PM2.5.

```{r}
#dataset with model variables of interest for descriptive purposes (similar dataset generated in models.fn())
dem.w %>% select(
    #m2
    apoe,
    male,
    race_white,
    income_cat,
    degree,
    birth_cohort_5yr,
    cal_t,
    #m3
    smoke,
    exercise_reg,
    #m4
    Hypertension,
    Diabetes, 
    CV_DIS,
    Heart_Dis,
    bmi,
    #m6
    pm25_10yr,
    no2_10yr) %>% 
  mutate_all( ~as.numeric(.)) %>%
  cor(method = "pearson", use ="complete.obs") %>%
  corrplot::corrplot(method="color") 

```

# Survival Analysis

## Primary Analysis, Reduced & Extended Models

Dementia

```{r}
# note, functions use cluster = study_id in order for coxph() to calculate robust SEs

dem_10yr <- dem.w %>%
  models.fn(.,
                models = paste0("m", c(1, 2, "3a", "3b",  "4a", #"4b", 
                                       5, 6)),  
                surv.time2 = "age_end_exposure", 
                surv.event = "dementia_now", 
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr"  
                )

#dem_10yr$raw_model_output
#dem_10yr$hrs

# test <- dem_10yr$raw_model_output$m2
#summary(test)



dem_10yr_hrs <- dem_10yr$hrs %>%
  mutate(
    Model = c("1",
           "2", 
           "3a", 
           "3b", 
           "4", 
           #"4b", 
           #renaming M5 b/c M5 will now be full stratification
           "Interaction", #"5"
           "Interaction", #"5"
           "6"),
    Description = c(" (M1) Reduced",
           " (M2) Primary", 
           " (M3a) Extended", 
           " (M3b) Extended, ACT Cohort", 
           " (M4) Extended & Mediation", 
           #"Extended & Mediation, CASI Score", 
           "Interaction, no APOE", 
           "Interaction, APOE", 
           " (M5) PM2.5 Adjusted")
    )

 
# dem_10yr_hrs

#m2 for other exposure years
dem_other_yrs <- data.frame()
expo.prds <- paste0("no2_", c("1yr", "5yr", "20yr", "10yr10yrlag", "10yr05yrlag"))

for (i in seq_along(expo.prds)) {
  df <- models.fn(mydata = dem.w,
                models = "m2",
                surv.time2 = "age_end_exposure", 
                surv.event = "dementia_now", 
                no2.var = expo.prds[i])
  
  dem_other_yrs <- rbind(dem_other_yrs, df$hrs)
  }

dem_other_yrs <- dem_other_yrs %>%
  mutate(
    Model = "2",
    Description = c("1 yr Exposure", 
                    "5 yr Exposure", 
                    "20 yr Exposure", 
                    "10 yr 5 yr Lag Exposure", 
                    "10 yr 10 yr Lag Exposure")
    )

#HR table 
dem_hrs <- rbind(dem_10yr_hrs, dem_other_yrs) %>%
  mutate(Exposure = factor(Exposure, levels = c("1yr", "5yr", "10yr", "20yr", "10yr10yrlag", "10yr05yrlag")))

```

-all-cause dementia & APOE interaction p-value: 

```{r}
#dem_10yr$raw_model_output$m5

dem.w %>%
apoe_model(.,
           surv.time2 = "age_end_exposure",
           surv.event = "dementia_now",
           no2.var = "no2_10yr",
           pm25.var = "pm25_10yr"
           ) %>%
broom::tidy() %>%
filter(term=="apoe:no2") %>%
select(p.value) %>%
round(2) %>%
pull()

```


AD 

```{r}
ad_10yr <- models.fn(mydata = dem.w,
                models = paste0("m", c(1, 2, "3a", "3b", "4a", #"4b", 
                                       5, 6)),  
                surv.time2 = "age_end_exposure", 
                surv.event = "ad_now", 
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")

ad_10yr_hrs <- ad_10yr$hrs %>%
  mutate(
    Model = c("1",
           "2", 
           "3a", 
           "3b",
           "4",  #"4a", 
           #"4b", 
           "Interaction", #"5"
           "Interaction", #"5"
           "6"),
    Description = c(" (M1) Reduced",
           " (M2) Primary", 
           " (M3a) Extended", 
           " (M3b) Extended, ACT Cohort", 
           " (M4) Extended & Mediation", 
           #"Extended & Mediation, CASI Score", 
           "Interaction, no APOE", 
           "Interaction, APOE", 
           " (M5) PM2.5 Adjusted")
    )
    

#m2 for other exposure years
ad_other_yrs <- data.frame()

for (i in seq_along(expo.prds)) {
  df <- models.fn(mydata = dem.w,
                models = "m2",
                surv.time2 = "age_end_exposure", 
                surv.event = "ad_now", 
                no2.var = expo.prds[i])
  
  ad_other_yrs <- rbind(ad_other_yrs, df$hrs)
  }

ad_other_yrs <- ad_other_yrs %>% 
  mutate(Model = "2",
         #Description = "Different exposure period"
         Description = c("1 yr Exposure", 
                    "5 yr Exposure", 
                    "20 yr Exposure", 
                    "10 yr 5 yr Lag Exposure", 
                    "10 yr 10 yr Lag Exposure")
  )

#HR table 
ad_hrs <- rbind(ad_10yr_hrs, ad_other_yrs) %>%
  mutate(Exposure = factor(Exposure, levels = c("1yr", "5yr", "10yr", "20yr", "10yr10yrlag", "10yr05yrlag")))  

```

-AD & APOE interaction p-value

```{r}
dem.w %>%
apoe_model(.,
           surv.time2 = "age_end_exposure",
           surv.event = "ad_now",
           no2.var = "no2_10yr",
           pm25.var = "pm25_10yr"
           ) %>%
broom::tidy() %>%
filter(term=="apoe:no2") %>%
select(p.value) %>%
round(2) %>%
pull()

```


## M2 using age at ACT onset diagnosis (cases) or last visit (noncases) 

Dementia 

```{r}

dem_10yr_act <- dem.w2 %>%
  models.fn(.,
            models = paste0("m2"),
            surv.time2 = "age_end_exposure2", 
            surv.event = "dementia_now2", 
            no2.var = "no2_10yr",
            pm25.var = "pm25_10yr") 

dem_10yr_act <- dem_10yr_act$hrs %>%
  mutate(Model = "2",
         Description = "Onset Age")

```

AD

```{r}
ad_10yr_act <- dem.w2 %>%
  models.fn(.,
            models = paste0("m2"),
            surv.time2 = "age_end_exposure2", 
            surv.event = "ad_now2", 
            no2.var = "no2_10yr",
            pm25.var = "pm25_10yr")  

ad_10yr_act <- ad_10yr_act$hrs %>%
  mutate(Model = "2",
         Description = "Onset Age")

```

## M2 without IPW for missing APOE status

Dementia

```{r}
dem_10yr_m2_wt1 <- dem.w %>%
  mutate(model_wt = 1) %>%
  models.fn(mydata = .,
            models = "m2",
            surv.time2 = "age_end_exposure",
            surv.event = "dementia_now",
            no2.var = "no2_10yr",
            pm25.var = "pm25_10yr")
 
dem_10yr_m2_wt1_hr <- dem_10yr_m2_wt1$hrs %>%
  mutate(Model = "2",
         Description = "No IPW")

```

AD

```{r}
ad_10yr_m2_wt1 <- dem.w %>%
  mutate(model_wt = 1) %>%
  models.fn(mydata = .,
            models = "m2",
            surv.time2 = "age_end_exposure",
            surv.event = "ad_now",
            no2.var = "no2_10yr",
            pm25.var = "pm25_10yr")
 
ad_10yr_m2_wt1_hr <- ad_10yr_m2_wt1$hrs %>%
  mutate(Model = "2",
         Description = "No IPW")

```

## Highest quality address history (no imputation)

Restirct analysis to individuals without address imputation and lived at an exact address at least 80% of the time. 

Dementia

**note:** HR becomes non-significant if run co-pollutant model 6

```{r, notes on other potential analyses}
### --> ? run other analyses w/ this subset of ppl? These models have a different subste of people than other models 
### --> ? is this the same as restricting to ~ 2000+? Do a time-restricted analysis (model predictions may be more accurate for more recent years - more monitors)?

```

```{r}

dem_highest_qual <- dem.w %>%
  filter(imp_qual10_yr == 0,
         exact_coverage10_yr >= 0.8) %>%
  models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure",
                surv.event = "dementia_now",
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")

#dem_highest_qual$hrs

dem_highest_qual_hrs <- dem_highest_qual$hrs %>%
  mutate(Model = "2",
         Description = "Highest Quality Address Hx") 

```

AD

```{r}
ad_highest_qual <- dem.w %>%
  filter(imp_qual10_yr == 0,
         exact_coverage10_yr >= 0.8) %>%
  models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure",
                surv.event = "ad_now",
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")


# ad_one_location$raw_model_output
ad_highest_qual_hrs <- ad_highest_qual$hrs %>%
  mutate(Model = "2",
         Description = "Highest Quality Address Hx") 

```

## High quality address history (high imputation quality)

Restirct analysis to individuals with: 

* an imputation quality of 0 or 1   
  + 0: no imputation   
  + 1: a) had an address gap(s) that was < 2 years w/ a different location before and after, or b) if the address was the first record, the start time of that was only extended backwards by the amount of known time that they lived at that location, up to 10 years   

* and those that lived at an exact address at least 80% of the time

Dementia 

```{r}
dem_high_quality <- dem.w %>%
  filter(imp_qual10_yr <=1,
         exact_coverage10_yr >= 0.8) %>%
  models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure",
                surv.event = "dementia_now",
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")

dem_high_quality_hrs <- dem_high_quality$hrs %>%
  mutate(Model = "2",
         Description = "High Quality Address Hx") 


```

AD

```{r}
ad_high_quality <- dem.w %>%
  filter(imp_qual10_yr <=1,
         exact_coverage10_yr >= 0.8) %>%
  models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure",
                surv.event = "ad_now",
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")


# ad_one_location$raw_model_output
ad_high_quality_hrs <- ad_high_quality$hrs %>%
  mutate(Model = "2",
         Description = "High Quality Address Hx") 

```

## Never Movers

Restirct analysis to individuals who have never moved and lived at an exact address at least 80% of the time. Using exact address threshold b/c individuals could, for example, have different addresses with poor geocoding at the zip code level linked to the same zip code.

Dementia

**note:** HR becomes non-significant if run co-pollutant model 6

```{r, notes on other potential analyses 2}
### --> ? run other analyses w/ this subset of ppl? These models have a different subste of people than other models 
```

```{r, eval=T}

dem_never_movers <- dem.w %>%
  filter(one_location == 1,
         exact_coverage10_yr >= 0.8) %>%
  models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure",
                surv.event = "dementia_now",
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")

#dem_highest_qual$hrs

dem_never_movers_hrs <- dem_never_movers$hrs %>%
  mutate(Model = "2",
         Description = "Never Movers") 

```

AD

```{r, eval=T}
ad_never_movers <- dem.w %>%
  filter(one_location == 1,
         exact_coverage10_yr >= 0.8) %>%
  models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure",
                surv.event = "ad_now",
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")


# ad_one_location$raw_model_output
ad_never_movers_hrs <- ad_never_movers$hrs %>%
  mutate(Model = "2",
         Description = "Never Movers") 

```


## Fixed AP at age 65

Dementia

```{r}

dem_age_65 <- dem.w %>%
  # fixed exposure 
  filter(enrollment_yr == 1) %>%
  models.fn(mydata = .,
            models = "m2", 
            surv.time1 = "age_intake",
            surv.time2 = "age_last_visit",
            surv.event = "anydementia",
            no2.var = "no2_exp_avg10_age_65")

dem_age_65_hrs <- dem_age_65$hrs %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = "Fixed Exposure at Age 65") 

```

AD

```{r}
ad_age_65 <- dem.w %>%
  filter(enrollment_yr == 1) %>%
  models.fn(mydata = .,
            models = "m2", 
            surv.time1 = "age_intake",
            surv.time2 = "age_last_visit",
            surv.event = "ad_nincds",
            no2.var = "no2_exp_avg10_age_65")

ad_age_65_hrs <- ad_age_65$hrs %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = "Fixed Exposure at Age 65") 

```

## Fixed AP at study entry

Dementia 

```{r}
dem_age_entry <- dem.w %>%
  filter(enrollment_yr == 1) %>%
  models.fn(mydata = .,
            models = "m2", 
            surv.time1 = "age_intake",
            surv.time2 = "age_last_visit",
            surv.event = "anydementia",
            no2.var = "no2_10yr")

dem_age_entry_hrs <- dem_age_entry$hrs %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = "Fixed Exposure at Entry") 

```

AD

```{r}
ad_age_entry <- dem.w %>%
  # fixed exposure 
  filter(enrollment_yr == 1) %>%
  models.fn(mydata = .,
            models = "m2", 
            surv.time1 = "age_intake",
            surv.time2 = "age_last_visit",
            surv.event = "ad_nincds",
            no2.var = "no2_10yr")

ad_age_entry_hrs <- ad_age_entry$hrs %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = "Fixed Exposure at Entry") 

```



## Finer Adjustment for Calendar time

Goal is not prediction here. Want to estimate fewer parameters than when we categorize this variable. Shoudd look at whether the NO2 HR estimates change when we adjust for calendar time more/less finely (e.g., different spline parameters).

```{r, code for spline. d?}

# n=400
# #takes long time to calculate
# df=as.data.frame(matrix(NA, ncol=n, nrow=length(y)))
# for (i in 3:n){
# lm1=lm(y~bs(x,df=i))
# df[i]=predict(lm1)
# }
# df$x=x
# 
# par(mfrow=c(1,1))
# plot(y~x)
# lines(df[400], col="red", lwd=2) 
# lines(df[100], col="orange", lwd=2) 
# lines(sin((1:1000)/100)*4,col="yellow", lwd=3) #true function? w/o error?
# lines(df[10], col="pink", lwd=2) 
# lines(df[5], col="brown", lwd=2) 
# lines(df[3], col="black")
# #lines(y, col="blue")
# legend("topright", legend=c("400 DF", "100 DF", "10 DF", "5 DF", "3 DF", "true f(x)"), col=c("red","orange", "pink", "brown", "black", "yellow"), lty = 1, cex=.75)

```

```{r}
no2.var = "no2_10yr"
pm25.var = "pm25_10yr"

#rename variables for fns
mydata <- dem.w %>%
  rename(
    #m1 
    no2 = no2.var,
    #m2
    income = income_cat,
    edu = degree,
    #m6
    pm25 = pm25.var) %>%
  mutate_at(
    c("income",
      "edu",
      "birth_cohort", "birth_cohort_5yr",
      "cohort",
      "smoke",
      "bmi"), 
    as.factor) %>%
  mutate(
    #adjust AP units
    no2 = as.double(no2/my.no2.units),
    pm25 = as.double(pm25/my.pm25.units),
    #birth_year = year(birthdt)
  )  
  
#create a survival object
s.dem <- Surv(
  time = mydata$age_start_exposure, 
  time2 = mydata$age_end_exposure, 
  event = mydata$dementia_now)
  
s.ad <- Surv(
  time = mydata$age_start_exposure, 
  time2 = mydata$age_end_exposure, 
  event = mydata$ad_now)

# calendar time axis
s.dem_calendar <- Surv(
  time = mydata$exposure_year-1,
  time2 = mydata$exposure_year,
  event = mydata$dementia_now)

s.ad_calendar <- Surv(
  time = mydata$exposure_year-1,
  time2 = mydata$exposure_year,
  event = mydata$ad_now)

```

Cumulative hazard functions are hard to compare becuase some curves are not overlapping. Don't apper to be proportional? See the crossing of cumulative hazard functions (violation of proportional hazard assumption - though this does not include confidence intervals). This is an argument for stratifying by cohort? 

```{r} 
# 537 ch 3 slide 70-72?
#coxfit <- coxph(s.dem ~birth_cohort, data = mydata)

# 1895 1910 1915 1920 1925 1930 1935
plot(survfit(s.dem~1, subset = dem.w$birth_cohort==1895, #conf.int=0
             ), 
     col="1895",  
     cumhaz = T, conf.int = F,      #fun = "cumhaz", #conf.type = "none"
     #log = T,
     ylab = "Cumulative Hazard",
     xlab = "Age",
     main = "Cumulative Hazard of Dementia by Birth Cohort",
     xlim=c(65,110), 
     )
lines(survfit(s.dem~1, subset = dem.w$birth_cohort==1910), col="1910",   
      cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$birth_cohort==1915), col="1915",
      cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$birth_cohort==1920), col="1920",
      cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$birth_cohort==1925), col="1925",
      cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$birth_cohort==1930), col="1930",
      cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$birth_cohort==1935), col="1935",
      cumhaz = T, conf.int = F)
legend("topleft", 
       fill = levels(dem.w$birth_cohort), 
       legend = levels(dem.w$birth_cohort)
       )
 
```

Same as above, but stratifying by calendar year.    
?? coding issue?? plot looks strange.

```{r, eval=F}
plot(survfit(s.dem_calendar~1,
             subset = dem.w$exposure_year[dem.w$exposure_year %in% c(1994:1999)]
             ), 
     col="1994",  
     cumhaz = T, conf.int = F,     
     ylab = "Cumulative Hazard",
     xlab = "Year",
     main = "Cumulative Hazard of Dementia by Birth Cohort",
     xlim=c(1994,2020), 
     )
lines(survfit(s.dem~1, subset = dem.w$exposure_year[dem.w$exposure_year %in% c(2000:2004)]), 
              col="2000",   
      cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$exposure_year[dem.w$exposure_year %in% c(2005:2009)]), col="2005",
      cumhaz = T, conf.int = F)

# lines(survfit(s.dem~1, subset = dem.w$birth_cohort==1920), col="1920",
#       cumhaz = T, conf.int = F)
# lines(survfit(s.dem~1, subset = dem.w$birth_cohort==1925), col="1925",
#       cumhaz = T, conf.int = F)
# lines(survfit(s.dem~1, subset = dem.w$birth_cohort==1930), col="1930",
#       cumhaz = T, conf.int = F)
# lines(survfit(s.dem~1, subset = dem.w$birth_cohort==1935), col="1935",
#       cumhaz = T, conf.int = F)
# legend("topleft", 
#        fill = levels(dem.w$birth_cohort), 
#        legend = levels(dem.w$birth_cohort)
#        )
```

### Birth cohort (5 yrs)

to address the AP trends and the fact that the AP changes more coarsely on a calendar year basis
 

```{r}
 # 5 yr birth cohort (vs cal time)
round_year <- 5

dem_cal_time_hrs1 <- mydata %>%
  #mutate(year_cohort = factor(round(exposure_year/round_year)*round_year),) %>%
  coxph(s.dem ~ no2 + strata(apoe) + male + race_white + income + edu +  
          birth_cohort_5yr, #year_cohort, 
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() %>%
  hr.output.fn(model.s = .) %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = paste0(round_year, " Yr Birth Cohort (vs 2 Yr Cal Time)"))


# 2 yr adjustment
round_year <- 2

dem_cal_time_hrs2 <-
  mydata %>%
  mutate(
    birth_cohort_2yr = factor(floor(year(birthdt)/round_year)*round_year)
    # using floor instead of round() to match Rachel's 2 yr categories, which start in 1994 (e.g., 1994-1995). rachel binned 2016-2018
    # exposure_year = ifelse(exposure_year == 2018, 2017, exposure_year),
    # year_cohort = factor(floor(exposure_year/round_year)*round_year),
  ) %>%
  coxph(s.dem ~ no2 + strata(apoe) + male + race_white + income + edu +  
          birth_cohort_2yr,#year_cohort, 
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() %>%
  hr.output.fn(model.s = .) %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = paste0(round_year, " Yr Birth Cohort (vs 2 Yr Cal Time)"))

## combine both year bins
dem_cal_time_hrs <- rbind(
  dem_cal_time_hrs1, 
  dem_cal_time_hrs2
)

```

AD

```{r}
# 5 yr calendar time
round_year <- 5

ad_cal_time_hrs1 <- mydata %>%
  mutate(year_cohort = factor(round(exposure_year/round_year)*round_year)) %>%
                #pm25
  coxph(s.ad ~ no2 + strata(apoe) + male + race_white + income + edu +  
        birth_cohort_5yr, #year_cohort,  
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() %>%
  hr.output.fn(model.s = .) %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = paste0(round_year, " Yr Birth Cohort (vs 2 Yr Cal Time)"))


# 2 yr calendar time
round_year <- 2

ad_cal_time_hrs2 <- mydata %>%
  mutate(birth_cohort_2yr = factor(floor(year(birthdt)/round_year)*round_year)) %>%
                #pm25
  coxph(s.ad ~ no2 + strata(apoe) + male + race_white + income + edu +  
        birth_cohort_2yr, #year_cohort, 
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() %>%
  hr.output.fn(model.s = .) %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = paste0(round_year, " Yr Birth Cohort (vs 2 Yr Cal Time)"))

ad_cal_time_hrs <- rbind(
  ad_cal_time_hrs1,
  ad_cal_time_hrs2
)
```

### Spline adjustment 

to account for trends in the outcome, using continuous time (meaning calendar time on the day scale) 

Don’t care about model fit, but how well we can control confounding (How much is the NO2 HR affected?). Can increase/decrease the df's in the ns() function to make the fit more/less flexible. This does not appear to have a large effect on the NO2 HR.

Dementia

```{r}

dem_spline_cal_time_hrs <- mydata %>%
  coxph(s.dem ~ no2 + strata(apoe) + male + race_white + income + edu +  
        #the default ns() values returns a straight line within the boundary knowits unless the user specifies either the df's or the knots 
          #The default bs() values will create a cubic B-spline basis with two boundary knots and one interior knot placed at the median of the observed data values
          splines::ns(exposure_year, df = 3),
        #splines::bs(exposure_year),
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() %>%
  hr.output.fn(model.s = .) %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = "Spline 1 Yr Cal Time (vs Linear 2 Yr Cal Time)") 

```

AD

```{r}
ad_spline_cal_time_hrs <- mydata %>%
  coxph(s.ad ~ no2 + strata(apoe) + male + race_white + income + edu +  
        splines::ns(exposure_year, df = 3), 
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() %>%
  hr.output.fn(model.s = .) %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = "Spline 1 Yr Cal Time (vs Linear 2 Yr Cal Time)") 

```

## Calendar time as time axis, adjusted for birth cohort (2 yrs)

Dementia

```{r}
round_year <- 5

dem_cal_time_axis_hrs <-
  mydata %>%
    mutate(birth_cohort_2yr = factor(floor(year(birthdt)/round_year)*round_year)) %>%

  coxph(s.dem_calendar ~ no2 + strata(apoe) + male + race_white + income + edu +  
        birth_cohort_2yr #birth_cohort_5yr #what primary model is using
          #year_cohort
        , 
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() %>%
  hr.output.fn(model.s = .) %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = "Cal Time Axis w/ 2 Yr Birth Cohort Adj")  #adjusted for [5 yr] Birth Cohort 


#dem_cal_time_axis_hrs

```

AD
```{r}
ad_cal_time_axis_hrs <-
  mydata %>%
      mutate(birth_cohort_2yr = factor(floor(year(birthdt)/round_year)*round_year)) %>%
  coxph(s.ad_calendar ~ no2 + strata(apoe) + male + race_white + income + edu +  
        birth_cohort_2yr #birth_cohort_5yr #what primary model is using
          #year_cohort
        , 
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() %>%
  hr.output.fn(model.s = .) %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = "Cal Time Axis w/ 2 Yr Birth Cohort Adj")  #adjusted for [5 yr] Birth Cohort 


#ad_cal_time_axis_hrs
```


## Road Proximity exposure

* advantages of using time-varying road proximity 
  - incorportates all residential hx, and does not assume individuals lived at a single residence during their entire follow-up period

separating A1 from A2-3 b/c:
* have heavier, more consistent traffic patterns
* these are more likely to have diesel trucks, large TRAP emitters (Auchincloss 2008)


### Categorical near road (Proximity/Ln distnace)
 
* Wilker 2015: "proximity is an integrated measure of exposure to traffic, which includes vehicle emissions, noise, ultrafine particles, road dust, and gaseous pollutants such as nitrogen dioxide, carbon monoxide, and volatile organic compounds but does not specifically account for the intensity of traffic or meteorologic conditions"

* Chen 2013: "LUR modeling of TRAP (NO2) takes into account roadway proximity, topography, meteorological factors affecting disperison and vehicle mix...LUR models should thus be omre accurate estimates of TRAP exposure than road proximity alone." Though NO2 HRs can't be interpreted as causal since they are used as markers of overall TRAP.

* rationale natural log of distance has been linearly related to martality and morbidity outcomes.(Chen 2017  living near; Wilker 2014 & 2015; 24: chen 2012)


Dementia

* Have narrower HRs b/c pppl mostly low/high a-d/e categories. Have Maximum variability in that variable. 


* near-road is defined as being within a geometric mean of `r near_a1` m from an A1 or within `r near_a2` m from an A2/A3 in the past 10 yrs.

```{r}

#m_units <- 100
#log(m_units) # 4.60517 ln m = 100 m

dem_near_road_cat_proximity_hrs <- mydata %>%
  coxph(s.dem ~  near_rd_cat +  
          strata(apoe) + male + race_white + income + edu + cal_t, #birth_cohort,
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() 

dem_near_road_cat_proximity_hrs1 <- dem_near_road_cat_proximity_hrs %>%
    hr.output.fn(., no2.coef = "near_rd_catNear (A-D)") %>%
    mutate(
      Exposure = "10yr",
      Model = "2",
      Description = paste0("Major Road Proximity: Near (vs Far)")
    )

dem_near_road_cat_proximity_hrs2 <- dem_near_road_cat_proximity_hrs %>%
    hr.output.fn(., no2.coef = "near_rd_catMid (E)") %>%
    mutate(
      Exposure = "10yr",
      Model = "2",
      Description = paste0("Major Road Proximity: Midway (vs Far)")
    )

dem_near_road_cat_proximity_hrs <- rbind(
  dem_near_road_cat_proximity_hrs1,
  dem_near_road_cat_proximity_hrs2
)

```

AD

```{r}

ad_near_road_cat_proximity_hrs <- mydata %>%
  coxph(s.ad ~  near_rd_cat + 
          strata(apoe) + male + race_white + income + edu + cal_t, #birth_cohort,
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() 

ad_near_road_cat_proximity_hrs1 <- ad_near_road_cat_proximity_hrs %>%
    hr.output.fn(., no2.coef = "near_rd_catNear (A-D)") %>%
    mutate(
      Exposure = "10yr",
      Model = "2",
      Description = paste0("Major Road Proximity: Near (vs Far)")
    )
ad_near_road_cat_proximity_hrs2 <- ad_near_road_cat_proximity_hrs %>%
    hr.output.fn(., no2.coef = "near_rd_catMid (E)") %>%
    mutate(
      Exposure = "10yr",
      Model = "2",
      Description = paste0("Major Road Proximity: Midway (vs Far)")
    )

ad_near_road_cat_proximity_hrs <- rbind(
  ad_near_road_cat_proximity_hrs1,
  ad_near_road_cat_proximity_hrs2
)

#ad_near_road_binary_hrs

```


### Time "near road" 

* Hazard ratios are for every additional year, in the past 10 yrs, living near-road.

```{r}
near_rd <- c("A", "B", "C", "D") #, "E")

```

Defining "near road" as being in cells: `r paste(near_rd, collapse = " or ")`

```{r}
road_prop_t %>%
  mutate(
    A1_morethan300m = cell_spec(A1_morethan300m, "html", color = ifelse(A1_morethan300m %in% near_rd, "blue", "black")),
A1_within300m = cell_spec(A1_within300m, "html", color = ifelse(A1_within300m %in% near_rd, "blue", "black"))
  ) %>%
  kable(
    #allow cell_spec() to work properly
    format="html",
    escape=F,
    
    col.names = c("", "≤300 m", ">300 m"), 
        align = "lcc",
        caption = paste0("Defining 'near road' as the proportion of time spent in cells ",
                         min(near_rd), "-", max(near_rd)),
    #paste(near_rd, collapse = " or ")
    
    ) %>%
  add_header_above(c("A2 or A3", "A1"=2)) %>%
  column_spec(1, bold = TRUE)   %>%
  column_spec(2, color = "blue")   %>%
  #row_spec(1:2, color = "blue")   %>%

  kable_styling()

```

 
Dementia

### --> should n be 40243 here?

```{r, eval=T}

dem_time_near_road <- mydata %>%
  #drop_na(no2) %>%
  # don't do. #convert from a 10 yr proportion to 1 yr estimates
  #mutate(near_rd_10yr = near_rd_10yr*10) %>%
  coxph(s.dem ~  near_rd_10yr + 
          strata(apoe) + male + race_white + income + edu + cal_t, #birth_cohort,
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() %>%
    hr.output.fn(., no2.coef = "near_rd_10yr") %>%
    mutate(
      Exposure = "10yr",
      Model = "2",
      Description = paste0("Time Near Road (10 vs 0 yr)")
    )
 
dem_time_near_road

```

AD

```{r}
ad_time_near_road <- mydata %>%
  # don't do #convert from a 10 yr proportion to 1 yr estimates
  #mutate(near_rd_10yr = near_rd_10yr*10) %>%
  coxph(s.ad ~  near_rd_10yr + 
          strata(apoe) + male + race_white + income + edu + cal_t, #birth_cohort,
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() %>%
    hr.output.fn(., no2.coef = "near_rd_10yr") %>%
    mutate(
      Exposure = "10yr",
      Model = "2",
      Description = paste0("Time Near Road (10 vs 0 yr)")
    )
```



## Stratify by all confounders

Plots checking to see if the proportional hazards assumptions appear to be true. **Crossing curves indicate non-proportinality**

**Note**
-these do not adjust for other covariates in our models  

-gender 

```{r}
plot(survfit(s.dem~1, subset = dem.w$male==0), 
     col=1,  
     cumhaz = T, conf.int = F,    
     ylab = "Cumulative Hazard",
     xlab = "Age",
     main = "Cumulative Hazard of Dementia by Gender",
     xlim=c(65,110))
lines(survfit(s.dem~1, subset = dem.w$male==1), col=2, cumhaz = T, conf.int = F)
legend("topleft", 
       fill = c(1,2), 
       legend = c("female", "male"))

```

- education

```{r, eval=F}
#plot is grouped cruder than in the models
plot(survfit(s.dem~1, subset = dem.w$degree <=1), 
     col=1,  
     cumhaz = T, conf.int = F,   
     ylab = "Cumulative Hazard",
     xlab = "Age",
     main = "Cumulative Hazard of Dementia by Degree (smaller numbers are less edu)",
     xlim=c(65,110))
lines(survfit(s.dem~1, subset = dem.w$degree %in% c(3:4)), col=3, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$degree %in% c(5:6)), col=5, cumhaz = T, conf.int = F)
legend("topleft", 
       fill = c(0,3,5), 
       legend = c("0 or 1","3 or 4","5 or 6"))

```

```{r}
plot(survfit(s.dem~1, subset = dem.w$degree ==0), 
     col=7,  
     cumhaz = T, conf.int = F,   
     ylab = "Cumulative Hazard",
     xlab = "Age",
     main = "Cumulative Hazard of Dementia by Degree (smaller numbers are less edu)",
     xlim=c(65,110))
lines(survfit(s.dem~1, subset = dem.w$degree ==1), col=1, cumhaz = T, conf.int = F)
#lines(survfit(s.dem~1, subset = dem.w$degree ==2), col=2, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$degree ==3), col=3, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$degree ==4), col=4, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$degree ==5), col=5, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$degree ==6), col=6, cumhaz = T, conf.int = F)
legend("topleft", 
       fill = c(7,1, 3:6), 
       legend = c("Less HS", "HS or GED", "Bachelor's", "Master's", "Doctoral", "Other")
       )
```

-race

```{r}
plot(survfit(s.dem~1, subset = dem.w$race_white==0), 
     col=1,  
     cumhaz = T, conf.int = F,  
     ylab = "Cumulative Hazard",
     xlab = "Age",
     main = "Cumulative Hazard of Dementia by Race",
     xlim=c(65,110))
lines(survfit(s.dem~1, subset = dem.w$race_white==1), col=2, cumhaz = T, conf.int = F)
legend("topleft", 
       fill = c(1,2), 
       legend = c("non-white", "white"))

```

-income 

```{r}
plot(survfit(s.dem~1, subset = dem.w$income_cat ==1), 
     col=1,  
     cumhaz = T, conf.int = F,   
     ylab = "Cumulative Hazard",
     xlab = "Age",
     main = "Cumulative Hazard of Dementia by Income category (smaller numbers are lower incomes)",
     xlim=c(65,110))
lines(survfit(s.dem~1, subset = dem.w$income_cat ==2), col=2, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$income_cat ==3), col=3, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$income_cat ==4), col=4, cumhaz = T, conf.int = F)
legend("topleft", 
       fill = c(1:4), 
       legend = c("[$0 - $35k]", "($35k - 50k]", "($50k - $75k]", "> $75k") #c(1:4)
       )

```

-birth cohort

```{r}
plot(survfit(s.dem~1, subset = dem.w$birth_cohort  ==1895), 
     col=1,  
     cumhaz = T, conf.int = F,   
     ylab = "Cumulative Hazard",
     xlab = "Age",
     main = "Cumulative Hazard of Dementia by Birth Cohort",
     xlim=c(65,110))
lines(survfit(s.dem~1, subset = dem.w$birth_cohort  ==1910), col=2, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$birth_cohort  ==1915), col=3, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$birth_cohort  ==1920), col=4, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$birth_cohort  ==1925), col=5, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$birth_cohort  ==1930), col=6, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$birth_cohort  ==1935), col=7, cumhaz = T, conf.int = F)

legend("topleft", 
       fill = c(1:7), 
       legend = c("1895", "1910", "1915", "1920", "1925", "1930", "1935")
       )

```

-calendar time

```{r}
plot(survfit(s.dem~1, subset = dem.w$cal_t  %in%c(1994, 1996)), 
     col=1,  
     cumhaz = T, conf.int = F,   
     ylab = "Cumulative Hazard",
     xlab = "Age",
     main = "Cumulative Hazard of Dementia by Calendar Year",
     xlim=c(65,110))
lines(survfit(s.dem~1, subset = dem.w$cal_t  %in%c(1998, 2000)), col=2, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$cal_t  %in%c(2002, 2004)), col=3, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$cal_t  %in%c(2006, 2008)   ), col=4, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$cal_t    %in%c(2010, 2012)), col=5, cumhaz = T, conf.int = F)
lines(survfit(s.dem~1, subset = dem.w$cal_t    %in%c(2014, 2016)), col=6, cumhaz = T, conf.int = F)
# lines(survfit(s.dem~1, subset = dem.w$cal_t  ==2006), col=7, cumhaz = T, conf.int = F)
# lines(survfit(s.dem~1, subset = dem.w$cal_t  ==2008), col=8, cumhaz = T, conf.int = F)
# lines(survfit(s.dem~1, subset = dem.w$cal_t  ==2010), col=9, cumhaz = T, conf.int = F)
# lines(survfit(s.dem~1, subset = dem.w$cal_t  ==2012), col=10, cumhaz = T, conf.int = F)
# lines(survfit(s.dem~1, subset = dem.w$cal_t  ==2014), col=11, cumhaz = T, conf.int = F)
# lines(survfit(s.dem~1, subset = dem.w$cal_t  ==2016), col=12, cumhaz = T, conf.int = F)

legend("topleft", 
       fill = c(1:6), 
       legend = c("1994", "1998", "2002", "2006", "2010", "2014")
       )

```

```{r}
#count in each calendar year bin
dem.w %>%
  ggplot(aes(x=cal_t)) + 
  geom_bar() + 
  
  labs(title = "Person-years per calendar year bin",
       x = "Year",
       y = "person-years"
       )

```
 
* there are few individuals and person years > 80 yrs and especially > 90 yrs of age in the 1994-1997 bin? You can tell by the cruder steps when compared to the other strata

```{r}
dem.w %>%
  mutate(
    between_80_90yr = ifelse(age_start_exposure >= 80 & age_start_exposure < 90, TRUE, FALSE ),
    above_90yr = ifelse(age_start_exposure >= 90, TRUE, FALSE ),
    cal_t = ifelse(cal_t %in% c(1994, 1996), 1994,
                   ifelse(cal_t %in% c(1998, 2000), 1998,
                          ifelse(cal_t %in% c(2002, 2004), 2002,
                                 ifelse(cal_t %in% c(2006, 2008), 2006,
                                        ifelse(cal_t %in% c(2010, 2012), 2010,
                                               2014
                   )))))
    ) %>%
  group_by(
    between_80_90yr, above_90yr, cal_t
  ) %>%
  summarize(
    n = n(),
    prop = round(n/nrow(.), 2)
  ) %>%
  kable(caption = "Person-years in each 4-yr calendar bin, stratified by whether individuals are less than or greater than 80 yrs of age") %>%
  kable_styling()
  
```


Dementia

```{r}
dem_stratification_hrs <- mydata %>%
  coxph(s.dem ~ no2 + strata(apoe) + strata(male) + strata(race_white) + strata(income) + strata(edu) + strata(cal_t), #strata(birth_cohort), 
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() %>%
  hr.output.fn(model.s = .) %>%
  mutate(
    Exposure = "10yr",
    Model = "5",
    Description = "(M6) Full Confounder Stratification") 

```

AD

```{r}
ad_stratification_hrs <- mydata %>%
  coxph(s.ad ~ no2 + strata(apoe) + strata(male) + strata(race_white) + strata(income) + strata(edu) + strata(cal_t), #strata(birth_cohort), 
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary() %>%
  hr.output.fn(model.s = .) %>%
  mutate(
    Exposure = "10yr",
    Model = "5",
    Description = "(M6) Full Confounder Stratification")
```

## Competing Events

See Waller 2020 review article for additional details.

### Descriptives

Number and proportion of deaths before dementia (censored due to death)

* everybody has a status: alive, withdrew or died   
* if status = dead, then deathdt = status_date   
* if status = withdrew, discontinue_reason is also available (otherwise not available)   
  - some of these also have deathdt, but not all   

Dates should be fairly accurate. Roy's email regarding this:
* "I think ACT’s death dates are pretty good. Every month, Pete runs a SAS program that looks for new death dates in [our research data warehouse (RDW)], and anything new that the ACT staff don’t already know about, it gets added to the ACT database. (I am over-simplifying the part about Pete’s program and the RDW; check with Pete if you want to know exactly how he pulls the death dates.) Besides the RDW, ACT staff get info about death from other places. Sometimes the family member will call and tell us about a new death, or we find out when we call to schedule a follow-up visit. And if someone has consented to brain autopsy, we get a call when the brain arrives at the hospital. Also, ACT staff sometimes finds deaths of participants in the obituary section of local newspapers."

```{r}
# dem0.0
# deathdt
# discontinue_reason 
  ##"" "Refused" "Moved Out of Area" "Other" "Terminal Illness" "Unable to Locate" "Disc Referral" "Disc Annual"   

# status, status_date          
  # "died"     "withdrew" "alive"   


# using raw dataset 
competing <- dem0.0 %>%
  select(study_id, birthdt,
         intakedt, last_visit,
         deathdt, discontinue_reason,
         status, status_date
         ) %>%
  unique()

```

 
* Roy's email regarding different discontinuation reasons: "Discontinuation reason 7 is simply saying that a participant discontinued from ACT while he is in the “referral” track. “Referral” is a transitional state between the Biennial track (normal cognition) and the Annual track (demented). And reason 8 is used when someone discontinues from ACT while she is in the Annual track. These reasons were selected probably because the real reason could not be obtained; thus, all we could say was that they left the study during those periods. There may be more info in the paper charts if Magali needs to know more or wants to dig deeper. There aren’t very many cases of these."

```{r}
# status of individuals
competing %>%
  group_by(status, discontinue_reason) %>%
  summarise(
    N_people = n()
  )
  
```

check that they had a last biennial visit before their death data, **using dem.w**

* using 2 yr cut off to define death prior to dementia in the no dementia panel since:    
  - this is "near" the last study visit and **the last visit is the last time we can be "sure" that individuals did not have dementia** (and thus could experience the competing risk). Anything later than that would require too strong of an assumption since participants were not followed long enough to assess whether they developed dementia.   
    - we can imagine that these people were still being "followed" after their last visit up until their death since this study has interval censoring
    - assigning death before dementia follow-up time at last study visit is similar to how non-cases are assigned follow-up time  

  
```{r}
dem.w %>%
  # person-level statistics
  select(study_id, last_visit, deathdt, anydementia) %>% unique() %>%  
  # only those that have died have a deathdt
  filter(!is.na(deathdt)) %>%
  mutate(died_after_censored = deathdt > last_visit,
         anydementia = ifelse(anydementia==0, "No Dementia", "Dementia")
         ) %>%  {
  ggplot(data=., aes(x=last_visit, y=deathdt,
             col = died_after_censored
             )) + 
  geom_point(alpha=0.3) + 
  geom_abline(intercept = 0, slope = 1, col="1-1") +
  geom_abline(intercept = 2*365, slope = 1, col="2 yr later") + 
      
      facet_wrap(~anydementia) +

  labs(title = "Among those that have died, \nchecking that the last vist date occurred before the death date",
       subtitle = paste0("N = ", nrow(.)),
       x = "Last Visit Date",
       y = "Death Date",
       col = "Death Date After\nLast Visit",
       caption = "red line is 2 yr after the last visit date"
       )
  }

```

* One person 'died' ~1 month before having a last visit. 
  - roy's email regarding this: "Yes, we know about [subject w/deathdt < last_visit] and its date anomaly. The death date is correct. What happened was that this person was in the Referral track, but then died before the dementia evaluation was completed. According to the ACT tracking database, he did not actually have that “last visit” (probably too sick by then). But in the ACT research database, **because a dementia diagnosis was made posthumously (about 1 month after death), that diagnosis was keyed in with a Visit ID and date, and the date of the diagnosis was used as the visit date.** I believe this is going to get corrected in the next data freeze. But to be honest, I don’t how they’ll correct it. It’s perfectly OK to have a dementia diagnosis date later than death date. I think this is a scenario that the original database designer did not anticipate—how to key in a diagnosis without a visit."

```{r}
dem.w %>%
  filter(last_visit > deathdt) %>%
  select(study_id,  
         intakedt, last_visit,
         deathdt, anydementia, #censored_death 
         ) %>%
  unique() %>%
  kable(caption = "One person 'died' before having a last visit (where dementia was diagnosed) ??") %>%
  kable_styling()

```


### 1. Cause-specific Cox PH Model for death before dementia  

purpose: To identify if AP is associated with death before dementia (if it's a competing risk). If we do see a relationship, AP could appear to be protectie of Dementia

* outcome: death **before**/(?)without a dementia diagnosis
* censoring: age at last study visit (both for dementia diagnosis or non-cases)
  - dat of a dementia diagnosis occurs during last visit (for primary analysis), meaning that they developed it within the last ~2 years. Thus, any cases that also die within the *next* 2 yrs died after (not at the same time) as a dementia diagnosis   
* predictors: same as primary model   
### --> ?? or any predictors we think may be associated with death?


define censored due to death if:    
1. they were not diagnosed w/ dementia during their last FU visit   
2. there is a death date on record (otherwise, we are assuming they are not still alive)   
  * these individuals could have been diagnosed with dementia beforehand    
3. the recorded death date was within 2 yrs of last biennial visit (i.e., we are assuming that this is why they didn't have another follow-up)       
4. use age at last visit as the follow up time (slightly less than age at death) since
  * we may not have accurate residence location after they leave the study
      - this assumption may not be true when people approach death?       
  * This is the time for which we have AP data   
      - assumption may be for up to 2 yrs later     
  - **??** death dates are not subject to interval censoring like dementia diagnoses and would thus be more accurate. This way, the event of interest is identified or censored for at the last study visit    

* Otherwise, we have to assume constant AP and residence after leaving the study     
* is this similar to the dementia cause-specific Cox PH model?    


* note   
- don't use "status" variable as outcome since it reflects a person's "status" after the end of the study (e.g., cases may have a 'died' status if they died after being diagnosed)   


```{r}

mort.w <- dem.w %>% 
  # # need?  # add mortality variables: discontinue_reason, status, status_date
  left_join(competing) %>%
  
  #select(study_id:deathdt, discontinue_reason:status_date, everything())
 
  mutate(
    # define censored due to death before dementia if...
    censored_death = as.numeric(
      # they were not diagnosed with dementia before leaving the study
      (anydementia ==0) &
        # a death date is on record (otherwise, we think they are still alive)
        (!is.na(deathdt)) &
        # they died within 2 yrs of last biennial visit (and couldn't attend a follow-up)
        (deathdt <= last_visit + 365*2)
      ),
    # status for fine & gray model (dementia as primary outcome: 1, death as competing risk: 2, censored: 0)
    dementia_fine_gray = ifelse(anydementia ==1, 1, 
                       # if censored due to dying, recode as 2
                       ifelse(censored_death == 1, 2, 0)
                       )
  ) %>%
  
  # generate time-varying death incidene (similar to dementia_now variable)
  group_by(study_id) %>%
                              # incidence doesn't happen until last visit, if at all
  mutate(death_now = ifelse(test = (enrollment_yr == max(enrollment_yr)), 
                       # can be 0 or 1
                       yes = censored_death, 
                       # always 0 before the end of their FU period
                       no = 0), 
         dementia_fine_gray_now = ifelse(test = (enrollment_yr == max(enrollment_yr)), 
                       yes = dementia_fine_gray, 
                       no = 0),
         
         ) %>%
  
  # for modeling 
  ##want to use 5 yr bins instead of this one w/ larger categories (similar to primary analysis)
  select(-birth_cohort) %>%
  rename(
    #m1 
    no2 = no2_10yr,
    birth_cohort = birth_cohort_5yr,
    #m2
    income = income_cat,
    edu = degree,
    #m6
    pm25 = pm25_10yr
    ) %>%
  mutate_at(
    c("income",
      "edu",
      "birth_cohort",
      
      "cohort",
      "smoke",
      "bmi"
      ), 
    as.factor) %>%
  mutate(
    #adjust AP units
    no2 = as.double(no2/my.no2.units),
    pm25 = as.double(pm25/my.pm25.units),
  ) %>%
  
  select(study_id, intakedt, last_visit, deathdt, 
         anydementia, censored_death, dementia_fine_gray,
         dementia_now, death_now, dementia_fine_gray_now,
         everything()
         )  
  

```

tables of change in status from dementia-specific Cox models 

```{r}

mort.w %>%
  # create a person-level data
  select(study_id, last_visit, anydementia, dementia_fine_gray, censored_death) %>%
  unique() %>% 
  group_by(anydementia, dementia_fine_gray, censored_death) %>%
  summarize(
    N = n(),
    Proportion = round(N/nrow(.), 2)
  ) %>%
  kable(caption = "Person-level outcomes. N = people") %>%
  kable_styling()
  
mort.w %>%
  group_by(anydementia, dementia_fine_gray, censored_death) %>%
  summarize(
    N = n(),
    Proportion = round(N/nrow(.), 2)
  ) %>%
  kable(caption = "Person-year level outcomes. N = person-years. ~ weighted version of previous table since longer enrollment periods contribute more to the numerator and denominator counts") %>%
  kable_styling()

mort.w %>%
  group_by(dementia_now, dementia_fine_gray_now, death_now) %>%
  summarize(
    N = n(),
    Proportion = round(N/nrow(.), 2)
  ) %>%
  kable(caption = "Total Person-years associated with no event, death and dementia incidnece. N = person-years") %>%
  kable_styling()



```

#### Table 1 Alternative, stratified by outcome

* showing those in primary analysis  

* e.g., smokers are more likely to leave the risk set due to death before/without dementia

* note, that there are some AD cases in no-dementia and censored columns. This is because dementia and AD diagnoses use different criteria (DSM-IV anydementia vs NINCDS possible/probably AD) 

### --> fix py count?

Dementia 

```{r}
#mort.w %>%

t1_tot_merged <- t1_tot %>%
  mutate(Total = paste(Total_a, Total_b)) %>%
  select(-Total_a, -Total_b)

t1_censored <- mort.w %>%
  
  # fn is expecting diff names
  rename(
    income_cat = income,
    degree = edu,
    no2_10yr = no2
  ) %>%
  
  # ???? only keep individuals included in Model 2
  drop_na(m2_all_vars) %>%
  
  #1st year of enrollment (baseline)
  filter(enrollment_yr == 1) %>%  

    group_by(factor(dementia_fine_gray, levels = c(1, 2, 0))) %>%

  t1.fn() %>%  
  rename(Dementia = V1,
         Death = V2,
         Censored = V3
         ) #%>%
  # #separate N & %s
  # separate(col = V1, into = c("Total_a", "Total_b"), sep = " ", fill = "right")  %>%
  #   mutate_all(~str_replace(., "0 \\(NaN%\\)", "NA"))   

  
  #column_to_rownames(var = "Variable") 
  
  
## Replace NAs w/ ""
#t1_tot$Total_b[is.na(t1_tot$Total_b)] <- ""
  
  
  
t1_tot_merged %>% left_join(t1_censored) %>% #View() 
  #slice(-1) %>%
  kable(caption = "Alternative Table 1. Cohort characteristics, stratified by outcome. Table includes everyone in primary analysis.", 
        col.names = c("Variable", 
                       "Total", "Dementia", "Death (without Dementia)", "Censored"
          ), 
        align = c("l", rep("r", 4))
        ) %>%
  add_indent(c(8:14,18:23,25:28, 30:32, 35:38, 40:42, 47:49)) %>%
  add_footnote(c(
    "Table includes participants in primary analysis (those with complete observations for: APOE status, gender, race, Census Tract income, education and birth cohort)",
    "Baseline cognition is based on CASI scores that have been adjusted for accuracy using Item Response Theory (IRT). Higher numbers indicate greater cognitive function."
    ))   
  
```

### --> AD 

```{r}

```


Cox models 

```{r}
# generate survival object 
## 2 ppl are dropped b/c of minor error? their intakedt was a few days sooner than their last_visit. we'll assume these dates were the same such that these individuals were censored and had "no" follow-up time. Thus dropping them is fine. 

s.death <- Surv(
  time = mort.w$age_start_exposure, 
  time2 = mort.w$age_end_exposure, 
  event = mort.w$death_now)

# see why 2 times age_start_exposure >= age_end_exposure 
#mort.w %>% filter(age_start_exposure >= age_end_exposure) %>% View()

```

M2: no2 + strata(apoe) + male + race_white + income + birth_cohort

* AP is not significantly associated with death before a dementia diagnosis

```{r}
# # death Cox PH
death_hrs_m2 <- mort.w %>%
  coxph(s.death ~  no2 +
          strata(apoe) + male + race_white + income + edu + cal_t # birth_cohort #+ pm25
          ,
        data=.,
        cluster = study_id,
        weights = model_wt) %>%
  summary()

death_hrs_m2

death_hrs_m2 <- death_hrs_m2 %>%
    hr.output.fn(.) %>%
    mutate(
      Exposure = "10yr",
      Model = "2",
      Description = paste0("(M2) Death Censored at Last Visit")
    )

```

model with additional adjustment for smoking and exercise (pontential confounders of the AP-death relationship)

m3a: m2 +  smoking & exercise 

```{r}
# m3a: m2 +  smoking & exercise 
death_hrs_m3a <- mort.w %>%
  coxph(s.death ~  no2 +
          strata(apoe) + male + race_white + income + edu + cal_t + #birth_cohort +
          smoke + exercise_reg
          ,
        data=.,
        cluster = study_id,
        weights = model_wt) %>%
  summary()

death_hrs_m3a

death_hrs_m3a <- death_hrs_m3a %>%
    hr.output.fn(.) %>%
    mutate(
      Exposure = "10yr",
      Model = "3a",
      Description = paste0("(M3a) Death Censored at Last Visit")
    )

```

M4 (extended and mediation 1): M3a + vascular health + heart disease + BMI

* some covariates to be predictive of censoring due to death prior to dementia   
* idea: we would like to have a risk set after people leave due to death prior to dementia to still be representative of the sample population (interval validity) and general population (external validity).  
  - non-informative sensoring: censoring b/c of deaths prior to dementia should not be associated w/ dementia 
  
* This may not be the case if those that are sick are more likely to leave the study. For example, what we are left with is a population with fewer cardiovascuar health issues and fewer smokers. 

* some of these significant findings are in line with Waller 2020 (Table 3)

```{r}
# M4 (extended and mediation 1): M3a + vascular health + heart disease + BMI
death_hrs_m4 <- mort.w %>%
  coxph(s.death ~  no2 +
          strata(apoe) + male + race_white + income + edu + cal_t + #birth_cohort +
          smoke + exercise_reg +
          Hypertension + Diabetes + CV_DIS + Heart_Dis + bmi,
        data=.,
        cluster = study_id,
        weights = model_wt) %>%
  summary()

death_hrs_m4

death_hrs_m4 <- death_hrs_m4 %>%
    hr.output.fn(.) %>%
    mutate(
      Exposure = "10yr",
      Model = "4",
      Description = paste0("(M4) Death Censored at Last Visit")
    )

```

* MP: censoring due to death before a dementia diagnosis is happening, but it is not significanlty associated with NO2 exposure. **Thus, death is not a competing event?**

```{r}
# combine death HR models
death_hrs <- rbind(
   death_hrs_m2,
   death_hrs_m3a,
   death_hrs_m4
   )

death_hrs %>%
  kable(caption = "HRs for death without dementia for 10 yr avg NO2 exposure increase of 10 ppb") %>%
  kable_styling()

```


### [Maybe - Sindana's suggestion] IPW cause-specific Cox PH modlel

```{r}

```


### 2. Subdistributional - Fine and Gray Model

* "The sub-distribution hazard ratio is interpreted as the relative change in the instantaneous rate of the occurrence of dementia in those without dementia **or** those who died without dementia during follow-up" - Waller 2020

* in this model, those who experience the competing event (death) are retained in the risk set after the competing event, but their weight/influence is diminished over time. These people are "immortal".

*	If there are a lot more deaths than dementia And there is a strong relationship btwn AP & the competing event, if we use Fine and Gray model, we will get an attenuated HR b/c deaths before dementia cases will remain in the risk set as never having had the event through the end of the study period (be "immortal")

* In this model, you are looking at the direct (vs intermediate) effect of AP on dementia since you are analzying a "population" without the competing event  
  - vs the real world where experience the competing event (people die before dementia)

### --> does crr() work /w delayed entry?      
### --> how to run crr() with TVCs? need th cov2 and tf arguments. receive error: "Error in solve.default(h, z[[2]]) : Lapack routine dgesv: system is exactly singular: U[24,24] = 0"     
cov2 = mort.w$no2[use_rows],
tf = function(t) cbind(t)

?? alternatively, could use the riskRegression package. ? use the Beyersmann and Schumacher for time-varying covariates (FG model is more suited for time-independent analyses?)

```{r, eval=F}
library(cmprsk) # crr() fn for competing risks 
 
# need to code categorical variables numerically (generate dummy variables)
cov_matrix <- model.matrix(~no2 + apoe + male + race_white + income + edu + birth_cohort,
                           mort.w)[,-1]

# rows w/ complete covariates (since there is missingness). for comparability w/ cov_matrix, above
use_rows <- mort.w %>%
  mutate(use = !is.na(no2) & !is.na(apoe) & !is.na(male) & !is.na(race_white) & !is.na(income) & !is.na(edu) & !is.na(birth_cohort)) %>%
  pull(use)

# Scrucca 2010: "The main function to fit regression models for competing risks data is cmprsk::crr(). In the simplest form it requires a vector of follow-up times, a vector of status with a code for each failure type or censoring, and a matrix of fixed covariates. By default, the censoring code for status is set by the optional argument cencode=0, and the code that denotes the failure type of interest is set by the optional argument failcode=1. (In our example, transplant-related death, which is the competing event, is coded with 2.)

m1 <- crr(mort.w$age_start_exposure[use_rows], mort.w$age_end_exposure[use_rows], 
          
          fstatus = mort.w$dementia_fine_gray_now[use_rows], 
          # predictors
          cov1 = cov_matrix, 
          # default values. looking at dementia incidence as primary outcome (failcode 1)
          failcode = 1, cencode = 0,
          
          #for TVCs, need to alsos use cov2 and tf arguments
          ### --> ?? how to use this???
          cov2 = mort.w$no2[use_rows], 
          tf = function(t) t # no function #cbind(t)
          )
          
           

```


### 3. Modified Fine and Gray Model w/ Propensity scores

* purpose of this analysis: to address a weakness in the Fine and Gray Model, which assumes that none of the individuals who exeprienced the competing event (died) would have experienced the terminating event of interest (dementia) had they survived during the rest of the study period. 
  - This is unlikely in an older population.

* use propensity scores (logistic regression) to estimate the probability that those w/ the competing event Would have gotten dementia

Approach:  
1. fit a logistic regression model for dementia incidence *among people who did not experience the competing event* (those who were not censored due to death before dementia) using the covariate predictors from the primary model    
2. use the model to predict propensity scores for those who experienced the competing event (the probability that, based on their characteristics, they would have developed dementia)   
3. if a person's score is greater than the median predicted propensity score ___?for dementia cases__, a person is reclassified as having had the outcome of interest (dementia), otherwise they are left as censored   
4. fit a Fine and Gray Model using this modified dataset 


```{r}

```


### 4. Time to diagnosis models

Approach: use a parametric survival time model (w/ time of diagnosis of dementia as the outcome). deaths w/ a predicted date of dementia before the end of the follow-up period were recoded as having a dementia diagnosis, w/ the date of diagnosis estimated from the model   

1. fit a parametric survival time model (w/ time of diagnosis of dementia as the outcome) w/ a Weibull distribution, among women who did not die during the follow-up period   
2. use model to predict the time of a dementia diagnosis among those that died before a dementia diagnosis   
3. if the predicted time of dementia for an individual was between their death date and the end of the study period, reclassify them as having had dementia w/ the diagnosis date being predicted from the model. If the predicted date of dementia is after the end of the study period, no changes are made. 


```{r}

```



### --> combine other Dem/AD models adjusting for death??

```{r}

```





## Compare all HRs

### Dementia

```{r}
#combine HRs from all analyses 

dem_all_hrs <- rbind(
  #reduced, primary & extended models, using 10 yr exposure
  dem_hrs,
  #M2 using age at ACT onset diagnosis (cases) or last visit (noncases)  
  dem_10yr_act,
  #no IPW
  dem_10yr_m2_wt1_hr,
  # high quality address imputation
  dem_highest_qual_hrs,
  dem_high_quality_hrs,
  
  #dem_never_movers_hrs,
  
  # using fixed exposure at age 65 - Rachel dropped. low N?
  #dem_age_65_hrs,
  # using fixed exposure at entry
  #dem_age_entry_hrs,
  # road proximity
  dem_near_road_cat_proximity_hrs,
  dem_time_near_road,
  
  #using calendar time as the time axis
  dem_cal_time_axis_hrs,
  
  # adjusting for birth cohort/calendar time more finely
  dem_cal_time_hrs,
  #dem_spline_cal_time_hrs,
  # stratifying by all confounders
  dem_stratification_hrs
  ) %>%
  mutate(
    model_description = paste0(Model, ". ", Description),
    hr_ci = paste0(hr, " (", lower_limit, ", ", upper_limit, ")"),
    Exposure = recode_factor(Exposure,
                              "1yr" = "1 yr",
                              "5yr" = "5 yr",
                              "10yr" = "10 yr",
                              "20yr" = "20 yr",
                              "10yr10yrlag" = "10 yr 10 yr lag",
                              "10yr05yrlag" = "10 yr 5 yr lag"
                              ),
    Exposure = factor(Exposure,
                      levels = c("10 yr",
                                 "1 yr",
                                 "5 yr",
                                 "20 yr",
                                 "10 yr 5 yr lag",
                                 "10 yr 10 yr lag")
                      ),
    Description = factor(Description, levels = Description),
    Type =case_when(
    grepl("Primary", Description) ~ "Primary",
    #!grepl("Primary", Description) ~ "Sensitivity",
    grepl("Reduced|PM2.5|Extended|Stratification", Description) ~ "Confounding & Mediation",
    grepl("Address", Description) ~ "Address Quality",
    grepl("Calendar|Onset|Cal ", Description) ~ "Time Variants",
    #TRUE ~ "Other",
    
    #secondary
    grepl("Exposure", Description) ~ "Exposure Period",
    grepl("Road", Description) ~ "Major Road Exposure",
    grepl("Interaction", Description) ~ "APOE Interaction",
    TRUE ~ "Other"
    
    ),
    #Description = str_to_title(Description),
    Type = factor(Type, levels = c("Primary",
                                   "Confounding & Mediation",
                                   "Time Variants",
                                   "Address Quality",
                                   
                                   "Exposure Period",
                                   "Major Road Exposure",
                                   "APOE Interaction",
                                   
                                   "Other"
                                   )
                  )
    )  

```

```{r}
# table
dem_results_table <- dem_all_hrs %>%
  select(
    Model, Description, Exposure,
    hr_ci,
    n, number_events,
    Type
    ) %>%
  rename(
    "Model Covariates" = Model,
    "HR (95% CI)" = hr_ci,
    "N" = n,
    "No. events" = number_events,
    ) 

```

primary & sensitivity analyses
### --> ? add ad_all_hrs ?

```{r, fig.height=8}
 
dem_all_hrs %>% 
  
  #rbind(ad_all_hrs) %>%
  
  filter(!grepl("Exposure|Road|Interaction", Description, ignore.case = T)) %>%
  mutate(
  Description = gsub("Primary", "Primary Analysis", Description) 
  ) %>%
  hr.plot(., outcome_var = "dementia",
          title_pollutant = "Primary & sensitivity analyses for NO2 (10 ppb)\n") +
  facet_grid(vars(Type),  
             scales = "free_y", 
             space = "free_y", 
             switch = "y"
             )

dem_results_table %>%
    filter(!grepl("Exposure|Road|Interaction", Description, ignore.case = T)) %>%
   mutate(
  #    Type =case_when(
  #   grepl("Primary", Description) ~ "Primary",
  #   !grepl("Primary", Description) ~ "Sensitivity",
  # ),
  Description = gsub("Primary", "Primary Analysis", Description) 
  ) %>%
    select(`Model Covariates`, Type, everything()) %>%
  arrange(Type) %>%
  kable(caption = "Primary & sensitivity analyses: Dementia hazard ratios for a 10 ppb increase in NO2 exposure", 
        align = "l") %>%
  kable_styling() %>%
  add_footnote("'N' is person-years for time-varying analyses and persons for fixed exposure analyses")

```


secondary analyses

```{r, fig.height=8} 
 
## secondary analyses 
dem_all_hrs %>% 
  filter(grepl("Exposure|Road|Interaction", Description, ignore.case = T)) %>%
  mutate(
    #Type =case_when(
    # grepl("Exposure", Description) ~ "Exposure Period",
    # grepl("road", Description) ~ "Major Road Exposure",
    # grepl("Interaction", Description) ~ "APOE Interaction"
  #),
  Description = gsub("Interaction, | Exposure", "", Description),
  # Exposure = factor(Exposure, 
  #                   levels = c("10 yr",
  #                              "1 yr",
  #                              "5 yr",
  #                              "20 yr",
  #                              "10 yr 5 yr lag",
  #                              "10 yr 10 yr lag")
  #                   )
  
) %>%
  hr.plot(., outcome_var = "dementia", 
          title_pollutant = "Secondary analyses for NO2 (10 ppb)\n") +
  facet_grid(vars(Type),  
             scales = "free_y", 
             space = "free_y", 
             switch = "y"
             )

dem_results_table %>%
    filter(grepl("Exposure|Road|Interaction", Description, ignore.case = T)) %>%
    mutate(Type =case_when(
    grepl("Exposure", Description, ignore.case = T) ~ "Exposure Period",
    grepl("Road", Description, ignore.case = T) ~ "Major Road Exposure",
    grepl("Interaction", Description, ignore.case = T) ~ "APOE Interaction"
  ),
  Description = gsub("Interaction, | Exposure", "", Description) 
  ) %>%
  select(`Model Covariates`, Type, everything()) %>%
  kable(caption = "Secondary analyses: Dementia hazard ratios for a 10 ppb increase in NO2 exposure", 
        align = "l") %>%
  kable_styling() %>%
  add_footnote("'N' is person-years for time-varying analyses and persons for fixed exposure analyses")

```

 
### AD

```{r, fig.height=8}
#AD
ad_all_hrs <- rbind(
  #reduced, primary & extended models, using 10 yr exposure 
  ad_hrs, 
  #M2 using age at ACT onset diagnosis (cases) or last visit (noncases)  
  ad_10yr_act, 
  #no IPW
  ad_10yr_m2_wt1_hr,
  #high address quality
  ad_highest_qual_hrs,
  ad_high_quality_hrs,
  
  # if include never movers, look into who these individuals are.  Do they tend to be younger?  Or be in a different ACT cohort?
  #ad_never_movers_hrs,
  
  # using fixed exposure at age 65
  #ad_age_65_hrs,
  # using fixed exposure at entry
  #ad_age_entry_hrs,
  # road proximity
  ad_near_road_cat_proximity_hrs,
  ad_time_near_road,
  
  #using calendar time as the time axi
  ad_cal_time_axis_hrs,
  
  # adjusting for calendar time more finely
  ad_cal_time_hrs,
  #ad_spline_cal_time_hrs,
  # stratifying by all confounders
  ad_stratification_hrs
) %>%
  mutate(
    model_description = paste0(Model, ". ", Description),
    hr_ci = paste0(hr, " (", lower_limit, ", ", upper_limit, ")"),
    Exposure = recode_factor(Exposure,
                              "1yr" = "1 yr",
                              "5yr" = "5 yr",
                              "10yr" = "10 yr",
                              "20yr" = "20 yr",
                              "10yr10yrlag" = "10 yr 10 yr lag",
                              "10yr05yrlag" = "10 yr 5 yr lag"
                              ),
    Description = factor(Description, levels = Description),
    Type =case_when(
    grepl("Primary", Description) ~ "Primary",
    #!grepl("Primary", Description) ~ "Sensitivity",
    grepl("Reduced|PM2.5|Extended|Stratification", Description, ignore.case = T) ~ "Confounding & Mediation",
    grepl("Address", Description, ignore.case = T) ~ "Address Quality",
    grepl("Calendar|Onset|Cal ", Description, ignore.case = T) ~ "Time Variants",
    #TRUE ~ "Other",
    
    #secondary
    grepl("Exposure", Description, ignore.case = T) ~ "Exposure Period",
    grepl("Road", Description, ignore.case = T) ~ "Major Road Exposure",
    grepl("Interaction", Description, ignore.case = T) ~ "APOE Interaction",
    TRUE ~ "Other"
    
    ),
    Type = factor(Type, levels = c("Primary",
                                   "Confounding & Mediation",
                                   "Time Variants",
                                   "Address Quality",
                                   
                                   "Exposure Period",
                                   "Major Road Exposure",
                                   "APOE Interaction",
                                   
                                   "Other"
                                   )
                  )
  )

```

```{r}
# table
ad_results_table <- ad_all_hrs %>%
  select(
    Model, Description, Exposure,
    hr_ci,
    n, number_events,
    Type
    ) %>%
  rename(
    "Model Covariates" = Model,
    "HR (95% CI)" = hr_ci,
    "N" = n,
    "No. events" = number_events,
    ) 

```

primary & sensitivity analyses

```{r, fig.height=8}
 
# plot
ad_all_hrs %>%  
  filter(!grepl("Exposure|Road|Interaction", Description, ignore.case = T)) %>%
  mutate(
    # Type =case_when(
    # grepl("Primary", Description) ~ "Primary",
    # #!grepl("Primary", Description) ~ "Sensitivity",
    # grepl("Reduced|PM2.5|Extended|Stratification", Description) ~ "Confounding & Mediation",
    # grepl("address", Description) ~ "Address Quality",
    # grepl("Calendar|Onset Age", Description) ~ "Time Variants",
    # TRUE ~ "Other"
    # ),
    # Type = factor(Type, levels = c("Primary",
    #                                "Confounding & Mediation",
    #                                "Time Variants",
    #                                "Address Quality",
    #                                "Other"
    #                                )
    #               ),
  Description = gsub("Primary", "Primary Analysis", Description) 
  ) %>%
  hr.plot(., outcome_var = "AD",
          title_pollutant = "Primary & sensitivity analyses for NO2 (10 ppb)\n") +
  facet_grid(vars(Type),  
             scales = "free_y", 
             space = "free_y", 
             switch = "y"
             )

#table
ad_results_table %>%
    filter(!grepl("Exposure|Road|Interaction", Description, ignore.case = T)) %>%
   mutate(
    #  Type =case_when(
    # grepl("Primary", Description) ~ "Primary",
    # !grepl("Primary", Description) ~ "Sensitivity",
  #),
  Description = gsub("Primary", "Primary Analysis", Description) 
  ) %>%
    select(`Model Covariates`, Type, everything()) %>%
  arrange(Type) %>%
  kable(caption = "Primary & sensitivity analyses: AD hazard ratios for a 10 ppb increase in NO2 exposure", 
        align = "l") %>%
  kable_styling() %>%
  add_footnote("'N' is person-years for time-varying analyses and persons for fixed exposure analyses")
```

secondary analyses

```{r, fig.height=8}
# plot
ad_all_hrs %>%
 filter(grepl("Exposure|Road|Interaction", Description, ignore.case = T)) %>%
  mutate(Type =case_when(
    grepl("Exposure", Description, ignore.case = T) ~ "Exposure Period",
    grepl("Road", Description, ignore.case = T) ~ "Major Road Exposure",
    grepl("Interaction", Description, ignore.case = T) ~ "APOE Interaction"
  ),
  Description = gsub("Interaction, | Exposure", "", Description),
  Exposure = factor(Exposure, 
                    levels = c("10 yr",
                               "1 yr",
                               "5 yr",
                               "20 yr",
                               "10 yr 5 yr lag",
                               "10 yr 10 yr lag"
                               )
                    )
  ) %>%
  hr.plot(., outcome_var = "AD", 
          title_pollutant = "Secondary analyses for NO2 (10 ppb)\n") +
  facet_grid(vars(Type),  
             scales = "free_y", 
             space = "free_y", 
             switch = "y"
             )

#table
ad_results_table %>%
    filter(grepl("Exposure|Road|Interaction", Description, ignore.case = T)) %>%
    mutate(Type =case_when(
    grepl("Exposure", Description, ignore.case = T) ~ "Exposure Period",
    grepl("Road", Description, ignore.case = T) ~ "Major Road Exposure",
    grepl("Interaction", Description, ignore.case = T) ~ "APOE Interaction"
  ),
  Description = gsub("Interaction, | Exposure", "", Description, ignore.case = T) 
  ) %>%
  select(`Model Covariates`, Type, everything()) %>%
  kable(caption = "Secondary analyses: AD hazard ratios for a 10 ppb increase in NO2 exposure", 
        align = "l") %>%
  kable_styling() %>%
  add_footnote("'N' is person-years for time-varying analyses and persons for fixed exposure analyses")

 
```


### Combine plots

```{r}
dem_all_hrs1 <- dem_all_hrs %>% mutate(Outcome = "All-Cause Dementia")
ad_all_hrs1 <- ad_all_hrs %>% mutate(Outcome = "AD")
all_hrs1 <- rbind(dem_all_hrs1, ad_all_hrs1)

```

primary & sensitivity 

```{r, fig.height=8}


all_hrs1 %>%
  
  filter(!grepl("Exposure|Road|Interaction", Description, ignore.case = T)) %>%
  mutate(
    
    Outcome = factor(Outcome, levels = c("All-Cause Dementia", "AD")),
    
  Description = gsub("Primary", "Primary Analysis", Description) 
  ) %>%
  hr.plot(., outcome_var = "dementia & AD",
          title_pollutant = "Primary & sensitivity analyses for NO2 (10 ppb)\n") +
  facet_grid(Type~Outcome,  
             scales = "free_y", 
             space = "free_y", 
             switch = "y"
             )

```

secondary analyses

```{r}
 
all_hrs1 %>%
 filter(grepl("Exposure|Road|Interaction", Description, ignore.case = T)) %>%
  mutate(Outcome = factor(Outcome, levels = c("All-Cause Dementia", "AD")),
         Type =case_when(
    grepl("Exposure", Description, ignore.case = T) ~ "Exposure Period",
    grepl("Road", Description, ignore.case = T) ~ "Major Road Exposure",
    grepl("Interaction", Description, ignore.case = T) ~ "APOE Interaction"
  ),
  Description = gsub("Interaction, | Exposure", "", Description),
  Exposure = factor(Exposure, 
                    levels = c("10 yr",
                               "1 yr",
                               "5 yr",
                               "20 yr",
                               "10 yr 5 yr lag",
                               "10 yr 10 yr lag"
                               )
                    )
  ) %>%
  hr.plot(., outcome_var = "dementia & AD", 
          title_pollutant = "Secondary analyses for NO2 (10 ppb) and Major Road\n") +
  facet_grid(Type~Outcome,  
             scales = "free_y", 
             space = "free_y", 
             switch = "y"
             )
```


## Competing Risks

### Death before Dementia

```{r}
all_death_hrs <- death_hrs %>%
  mutate(
    model_description = paste0(Model, ". ", Description),
    hr_ci = paste0(hr, " (", lower_limit, ", ", upper_limit, ")"),
    Exposure = recode_factor(Exposure,
                              #"1yr" = "1 yr",
                              #"5yr" = "5 yr",
                              "10yr" = "10 yr",
                              #"20yr" = "20 yr",
                              #"10yr10yrlag" = "10 yr 10 yr lag",
                              #"10yr05yrlag" = "10 yr 5 yr lag"
                              ),
    Exposure = factor(Exposure,
                      levels = c("10 yr" #,
                                 # "1 yr",
                                 # "5 yr",
                                 # "20 yr",
                                 # "10 yr 5 yr lag",
                                 # "10 yr 10 yr lag"
                                 )
                      ),
    #Description = factor(Description, levels = Description),
    
    ### --> Update once have more models?
    Type = "",
    # Type =case_when(
    #   grepl("Primary", Description) ~ "Primary",
    # 
    #   TRUE ~ "Other"
    # ),
    # Type = factor(Type, levels = c(#"Primary",
    #                                 
    #                                
    #                                "Other"
    #                                )
    #               )
    
    )  

  
  
  
```

```{r}
# table
death_results_table <- all_death_hrs %>%
  select(
    Model, Description, Exposure,
    hr_ci,
    n, number_events,
    Type
    ) %>%
  rename(
    "Model Covariates" = Model,
    "HR (95% CI)" = hr_ci,
    "N" = n,
    "No. events" = number_events,
    ) 

```

```{r}
all_death_hrs %>%
  hr.plot(., outcome_var = "death before dementia",
          title_pollutant = "Competing Risk Analyses for NO2 (10 ppb)\n") +
  facet_grid(vars(Type),  
             scales = "free_y", 
             space = "free_y", 
             switch = "y"
             )

death_results_table %>%
    select(`Model Covariates`, Type, everything()) %>%
  arrange(Type) %>%
  kable(caption = "Competing risk analyses using cause-specific Cox proportional hazard models. Table shows hazard ratios for death before dementia for a 10 ppb increase in NO2 exposure", 
        align = "l") %>%
  kable_styling() 

```








### Death before AD

```{r}

```




# Running models for PM2.5 as the primary exposure (Rachel's analysis)

Dementia 

-reduced, primary, exntended models; different exposure windows


**note: adjusting for birth cohort more finely (round_year = 5)**

```{r}
round_year <- 5

# NOTE: treating PM2.5 as if it were my primary exposure, thus treating it as "NO2" in the models. 
dem_10yr_pm25 <- dem.w %>%
  mutate(
    # adjust for birth cohort  
    birth_cohort = factor(year(round_date(birthdt, unit = paste(round_year, "year"))))
  ) %>%
  models.fn(.,
           models = paste0("m", c(1, 2,  "3a", "3b",  "4a", "4b", 5, 6)), 
                surv.time2 = "age_end_exposure", 
                surv.event = "dementia_now", 
                no2.var = "pm25_10yr",
                pm25.var ="no2_10yr", 
                
                no2.units = 1, # really this is for PM2.5
                pm25.units = 10 # this is for NO2
                )

#dem_10yr_pm25$hrs

dem_10yr_pm25_hrs <- dem_10yr_pm25$hrs %>%
  mutate(
    Model = c("1",
           "2", 
           "3a", 
           "3b", 
           "4a", 
           "4b", 
           "5", 
           "5", 
           "6"),
    Description = c("Reduced",
           "Primary", 
           "Extended", 
           "Extended, ACT Cohort", 
           "Extended & Mediation", 
           "Extended & Mediation, CASI Score", 
           "Interaction, no APOE", 
           "Interaction, APOE", 
           "NO2 Adjusted"))

#m2 for other exposure years
dem_other_yrs_pm25 <- data.frame()
expo.prds <- paste0("pm25_", c("1yr", "5yr", "20yr", "10yr10yrlag", "10yr05yrlag"))

for (i in seq_along(expo.prds)) {
  df <- dem.w %>%
    mutate(
    # adjust for birth cohort more finely
    birth_cohort = factor(year(round_date(birthdt, unit = paste(round_year, "year"))))
  ) %>%
    models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure", 
                surv.event = "dementia_now", 
                no2.var = expo.prds[i],
                
                no2.units = 1, # really this is for PM2.5
                pm25.units = 10 # this is for NO2
                )
  
  dem_other_yrs_pm25 <- rbind(dem_other_yrs_pm25, df$hrs)
  }

dem_other_yrs_pm25 <- dem_other_yrs_pm25 %>%
  mutate(
    Model = "2",
    Description = c("1 yr Exposure", 
                    "5 yr Exposure", 
                    "20 yr Exposure", 
                    "10 yr 5 yr Lag Exposure", 
                    "10 yr 10 yr Lag Exposure")
    )

#HR table 
dem_hrs_pm25 <- rbind(dem_10yr_pm25_hrs, dem_other_yrs_pm25) %>%
  mutate(
    Exposure = substr(as.character(Exposure), 2, nchar(as.character(Exposure))),
    Exposure = factor(Exposure, levels = c("1yr", "5yr", "10yr", "20yr", "10yr10yrlag", "10yr05yrlag")))


# onset age
dem_10yr_act_pm25 <- dem.w2 %>%
  mutate(
    # adjust for birth cohort more finely
    birth_cohort = factor(year(round_date(birthdt, unit = paste(round_year, "year"))))
  ) %>%
  models.fn(.,
            models = paste0("m2"),
            surv.time2 = "age_end_exposure2", 
            surv.event = "dementia_now2", 
            no2.var = "pm25_10yr",
            pm25.var = "no2_10yr",
             
            no2.units = 1, # really this is for PM2.5
            pm25.units = 10 # this is for NO2
            ) 

dem_10yr_act_pm25 <- dem_10yr_act_pm25$hrs %>%
  mutate(Model = "2",
         Exposure = substr(as.character(Exposure), 2, nchar(as.character(Exposure))),
         Description = "Onset Age")

```

Table & plot of all HRs

```{r}
dem_all_hrs_pm25 <- rbind(
  #reduced, primary & extended models, using 10 yr exposure
  dem_hrs_pm25,
  #M2 using age at ACT onset diagnosis (cases) or last visit (noncases)  
  dem_10yr_act_pm25
  ) %>%
  mutate(
    model_description = paste0(Model, ". ", Description),
    hr_ci = paste0(hr, " (", lower_limit, ", ", upper_limit, ")"),
    Exposure = recode_factor(Exposure,
                              "1yr" = "1 yr",
                              "5yr" = "5 yr",
                              "10yr" = "10 yr",
                              "20yr" = "20 yr",
                              "10yr10yrlag" = "10 yr 10 yr lag",
                              "10yr05yrlag" = "10 yr 5 yr lag"
                              ),
    Description = factor(Description, levels = Description)
    )  

```

```{r, fig.height=8}

# table
dem_all_hrs_pm25 %>%
  select(
    Model, Description, Exposure,
    hr_ci,
    n, number_events
    ) %>%
  rename(
    "HR (95% CI)" = hr_ci,
    "N" = n,
    "No. events" = number_events,
    ) %>%
  kable(caption = "Dementia hazard ratios for a 1 ug/m3 increase in PM2.5 exposure") %>%
  kable_styling()

#plot HRs
dem_all_hrs_pm25 %>% hr.plot(., outcome_var = "dementia", title_pollutant = "PM2.5 (ug/m3)")

```



# Competing Risks analysis

Competing risks analysis: does high AP cause loss to FU, e.g. due to death (e.g., AP —> CVD —> death)?

potential descriptive statistics   
-? show cumulative incidence curves for prop of deaths among those w/ “high” vs “low” ??10 yr AP exposure
-show survival curves for incidence of: dementia, death
-run coxph() models for both dementia and death outcomes

Chang 2012    
-calc propensity (probability) scores: 
logit(AD) ~ smk + edu + MI + diabetes….   
-reassign those who were lost to FU b/c they died as “AD” if above ?median propensity score for those w/ AD, or keep “censored” if below  
-run modified Fine-Gray competing risks regressions   


```{r}

```















# Alt models possibly explaining negative HRs
Is there an interaction between AP and...
- older age?     
- gender?   
- white race?      

```{r}

```



# Cox model assumptions and inference validity    
1. Proportional hazards Assumption    
a) Schoenfeld residuals. If the proportional hazards model is correctly specified, there should be no trend in the residuals over time (uncorrelated, with mean zero across event times)

```{r, eval=F}
m2 <- dem_10yr$raw_model_output$m2

```

```{r, eval=F}
## ?? interpretation of schenresid matrix?
schoenresid = residuals(m2, type = "scaledsch")

time = as.numeric(rownames(schoenresid))

# link no2_10yr & "times" column
cbind(resid=schoenresid[,1], time) %>%
  as.data.frame() %>%
  ggplot(aes(x=time, y=resid)) + 
  geom_point() + 
  geom_smooth() + 
  labs(y = "scaled Schoenfeld residuals for NO2 coefficient",
       x = "failure time (age at dementia incidence)")

```

b. formally test. using cox.zph(). if global p-val is significant, assumption is violated   
-assumption is not violated 

```{r, eval=F}
cox.zph(m2)

```

2. linear relationship between continuous covariates and log hazard of the outcome    
If a correct model is used, these residuals are uncorrelated and have mean nearly zero.


Martingale residuals are used to check if the functional form of the covariate is okay (eg. linear vs quadratic terms). 

```{r, eval=F}
##??
martingalesid = residuals(m2, type = "martingale", data = dem.w) %>%
  as.data.frame() %>%
  #df rows used in M2
  rownames_to_column(.) 
names(martingalesid)[names(martingalesid) %in% "."] <- "martingaleresid" 
  
#only keep rows used in M2. 
dem.w.m2 <- dem.w[martingalesid$rowname,] 

plot.martingaleresid <- cbind(resid=martingalesid$martingaleresid, no2_10yr=dem.w.m2$no2_10yr) %>%
  as.data.frame() 

plot.martingaleresid %>%
  ggplot(aes(x=no2_10yr, y=resid)) +
  geom_point(alpha=0.3) +
  geom_smooth() +
  labs(y = "Martingale residuals",
       x = "NO2 (ppb), 10 yr avg"
      )

#mean, +-SD  # looks good, mean is close to 0?
print("mean, SD")
mean(plot.martingaleresid$resid)
sd(plot.martingaleresid$resid)

```

3. no outliers or influential observations, $\triangle \beta$
 
```{r, fig.height=8, eval=F}
# B537 L3, slide 125

dfbetas <- residuals(m2, type="dfbeta") 
#rename columns
colnames(dfbetas) <- names(coef(m2))

dfbetas %>%  
  as.data.frame() %>%
  #get rows used in model
  rownames_to_column(var = "ind") %>%
  mutate(ind = as.numeric(ind)) %>%
  #make long format
  gather(covariate, value, -ind) %>%
  as.data.frame() %>%
  #plot
  ggplot(aes(x=ind, y=value)) +
  geom_point() +
  facet_wrap(~covariate, scales="free") + 
  labs(x="observation index",
       y= "delta beta")


```
