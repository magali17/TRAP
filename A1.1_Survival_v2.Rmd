---
title: 'Aim 1: Dementia Survival Analysis'
author: "Magali Blanco"
date: ' `r Sys.Date()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
  pdf_document:
    toc: yes
    toc_depth: '3'
editor_options:
  chunk_output_type: console
---

```{r}
# --> TO DO
# --> road proximity exposure sensitivity analysis
# --> use FSS for IPWs? 
# --> NO2 predictions from ST model
# --> stratify  by all confounders? See other General Exam
# --> add sensitivity analyses: 1) Restrict primary analysis to (say) people with 80% of their time from 1990 forward at an exact location in Puget Sound; fill in up to 20% with zip center and/or national model. Include extending the first address backward 10 years
## 2) Sensitivity analysis 1 (most restricted): The subset of those folks who are never movers living within PS at an exact address
## 3) Sensitivity 2 (least restrictive): Include anyone with zip or better at any location for any amount of time
## 4) Sensitivity 3 (using only predictions from ST model): People with 80% exact coverage and up to 20% zip, but only using ST model
##  5) Maybe sensitivity 4 (address extension): Drop address extension time (problem is that all the events before 1999 will be dropped, may cause immortal time bias, check with Lianne)

```

```{r, echo=F}
#NOTES
# network/pacific/rad/transfer

##4. merge with github. always do these 4 steps all together. enter the following into the Terminal (does not work any other way for some reason)
###a. git pull origin master #do this before start editing & before you're read to upload changes again
###b. git add A1.1_Survival.Rmd 
###c. git commit -m "my commit message in parentheses" 
###d. git push origin master

##########
# calculating gap lengths:
# x = c(1,2,4,NA,NA,6,NA,19,NA,NA)
# res = rle(is.na(x))
# rep(res$values*res$lengths,res$lengths)

```

```{r}
# ABOUT THIS DATASET
# exact_ variables: NAs indicate either no location, or no pollutant level info over the period of interest. Whenever you see an NA on exact_, there should also be NA in the corresponding exp_avg var

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      cache=T, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE,
                      dpi=300,
                      fig.height = 4
                      )  
set.seed(1)

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
      detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

#Himsc: describe(); EnvStats: summaryFull(); survminer: ggflexsurvplot()  
pacman::p_load(knitr, kableExtra,
               Hmisc, EnvStats, lubridate, 
               survival, survminer, glmnet, splines,
               #attach these last to use these functions as the defaults?
               tidyverse, dplyr
               )  

#other directory:/home/gradstudent/magali/a. TRAP Project/R TRAP Project/data/issue_001.sas7bdat 
# dem0 <- read_sas(file.path("~", "a. TRAP Project", "R TRAP Project", "data", "issue_001.sas7bdat"), NULL)

source("0.Global_Fns.R")
source("A1.0.2_Var&Fns.R")

# main dataset
dem0.0 <- haven::read_sas(file.path("Data", "Aim 1", "200331", "issue_001.sas7bdat"), NULL)
# exposure at age 65
dem0.0_65 <-  haven::read_sas(file.path("Data", "Aim 1", "200331", "issue_001_supp.sas7bdat"), NULL)

#remove SAS labels
labelled::var_label(dem0.0) <- NULL
labelled::var_label(dem0.0_65) <- NULL

```

create a primary dataset.

### --> update use_model "_SP" to "_ST" later

```{r}
use_model <- c("_SP", "_ST")

#data that can be used for all analyses 
dem0.1 <- dem0.0 %>% 
  #drop PM10 predictions
  filter(pollutant %in% c("no2", "pm25")) %>%
  select(
    study_id,
    birthdt,
    intakedt,
    last_visit,
    birth_cohort,
    corrected_onsetdate,
    onsetage,
    #"corrected_" = final decision on outcome
    corrected_anydementia,
    corrected_dsmivdx,
    final_nindx,

    #M1, 6, sensitivity analyses
    exposure_year, #age_at_exposure,
    pollutant, 
    
    # exp avg & coverage variables
    contains(use_model, ignore.case = F), 

    #M2
    apoe,
    male,
    degree, #education, 
    ## household income at the longest addressed lived at prior to baseline. It may include the date of the baseline
    tr_med_inc_hshld,
    race,

    #M3
    smoke, #pack_years,
    exercise_reg, #exercise, 
    cohort,

    #M4a
    Hypertension, Diabetes,
    CV_DIS, #indicates whether subject has ever reported having stroke, TIA, or CEA.
    Heart_Dis, #indicates whether subject has ever reported having an MI, Angina, CABG, or Angioplasty.
    bmi=bmi4, #bmi, 

    #M4b
    casi_irt, casi_valid,
    #address exactness
    
    # sensitivity analyses
    one_location,
    imputed_coverage10_yr, imputed_coverage01_yr,
    exact_coverage10_yr, exact_coverage01_yr,
    imp_qual10_yr
    ) %>%
  #create/clean up variables
  mutate(
    #rename updated variables for correct outcomes
    nindx = final_nindx,
    dsmivdx = corrected_dsmivdx,
    anydementia = corrected_anydementia,
    onsetdate = corrected_onsetdate,
    
    age_intake = as.numeric(intakedt - birthdt)/365,  
    age_last_visit = as.numeric(last_visit - birthdt)/365,
    #traditional definition used by ACT for follow-up time for cases and controls
    age_onset = as.numeric(onsetdate - birthdt)/365, 
    age_act = ifelse(!is.na(age_onset), age_onset, age_last_visit), 
    #collapse earliest & latest cohorts since there are few ppl here 
    birth_cohort = factor(ifelse(birth_cohort <= 1905, 1895,
                           ifelse(birth_cohort >= 1935, 1935, birth_cohort))),
    # update anydementia. Unless someone was suspected of dementia and was evaluated for it, the ANYDEMENTIA (as well as DSMIVDX, ANYAD, NINDX, etc.) field will be blank. Think of ‘0’ as a confirmation of no dementia, while blank as a presumption of no dementia.
    anydementia = ifelse(is.na(anydementia), 0, anydementia),
    dsmivdx = ifelse(is.na(dsmivdx), 0, dsmivdx),
    nindx = ifelse(is.na(nindx), 0, nindx),
     #Time-varying covariates
     ##starting age is age on Jan 1st of a given year if participant was enrolled, or on intake date, whichever came later
    age_start_exposure = ifelse(format(intakedt, "%Y") == exposure_year,
                                as.numeric(intakedt-birthdt)/365,
                                as.numeric(as.Date(paste0(exposure_year, "-01-01")) - birthdt)/365), 
    ##ending age is age at end of year or last visit date, whichever came first 
    age_end_exposure = ifelse(format(last_visit, "%Y") == exposure_year,
                                as.numeric(last_visit - birthdt)/365,
                                as.numeric(as.Date(paste0(exposure_year, "-12-31")) - birthdt)/365),
    ### need to change age_last_visit to age_act for sensitivity analyses
    dementia_now = ifelse(age_end_exposure < age_last_visit, 0, anydementia),
    
    ad_nincds = ifelse(nindx %in% c(1,2), 1, 0),
    ad_now = ifelse(age_end_exposure < age_last_visit, 0, ad_nincds),
    
    ## filter out invalid casi scores 
    casi_irt = ifelse(casi_valid ==1, casi_irt, NA),
    
    # Roy - accidentally made this a character?
    tr_med_inc_hshld = as.numeric(tr_med_inc_hshld),
    
    income_cat = ifelse(tr_med_inc_hshld < 35000, 1,  
                                      ifelse(tr_med_inc_hshld >= 35000 & tr_med_inc_hshld < 50000, 2,
                                             ifelse(tr_med_inc_hshld >= 50000 & tr_med_inc_hshld < 75000, 3, 4)
                                             )),  
    race_white = ifelse(race == 1, 1, 0),
    # make unknown degree=9 an 6 ("other") to avoid creating more NAs; 
    # Rachel/Lianne - change 9 to none? 
    degree = ifelse(degree != 9, degree, 0),
    # combine GED and HS. Note, there is now no degree==2, but shoudn't matter since this is treated as a categorical variable
    degree = ifelse(degree %in% c(1:2), 1, degree)
    ) %>%
  select(
  study_id,
  birthdt, birth_cohort, cohort, intakedt, onsetdate, last_visit,
  age_intake, age_act, age_last_visit,

  anydementia, dsmivdx, nindx, ad_nincds,
  dementia_now, ad_now,

  age_start_exposure, age_end_exposure,
  exposure_year, pollutant, 
  
  # exposure averages & coverage
  contains(use_model), 
                            
  apoe:degree, income_cat,race_white, smoke:bmi, casi_irt, #race, bmi4, tr_med_inc_hshld,

  one_location,
  exact_coverage10_yr, exact_coverage01_yr,
  imputed_coverage10_yr, imputed_coverage01_yr,
  imp_qual10_yr
  )
 
#how long have participants been followed? 
yr <- dem0.1 %>%
  group_by(study_id) %>%
  mutate(
    intake_yr = as.numeric(min(format(intakedt, "%Y"))),
    last_visit_yr = as.numeric(min(format(last_visit, "%Y"))),
    fu_yrs = last_visit_yr - intake_yr +1
    ) %>%
  select(study_id, intake_yr, last_visit_yr, fu_yrs) %>%
  unique()

# 1 row per follow-up/exposure year
enrollment_yrs <-rep(yr$study_id, yr$fu_yrs) %>%
  as.data.frame() %>%
  rename(study_id = ".") %>%
  left_join(yr, by = "study_id") %>%
  group_by(study_id) %>%
  mutate(
    #use min() b/c need 1 value and all vector values are same
    enrollment_yr = seq(1:min(fu_yrs)),
    exposure_year = seq(from=min(intake_yr), to=min(last_visit_yr))) %>%
  select(study_id, fu_yrs, enrollment_yr, exposure_year) %>%
  as.data.frame()

dem1 <-  dem0.1 %>% 
  #keep all enrollment years
  right_join(enrollment_yrs, by = c("study_id", "exposure_year")) %>%
  select(
  study_id:age_end_exposure,
  fu_yrs,
  enrollment_yr,

  exposure_year:casi_irt,

  one_location,
  imputed_coverage10_yr, # "doesn't exist"?? #imputed_coverage01_yr,
  exact_coverage10_yr, exact_coverage01_yr,
  imp_qual10_yr
  ) %>%
  filter(
    #drop ppl with only a baseline observation
    intakedt != last_visit,
    #drop exposure predictions after the last visit when individuals are no longer "at risk"  
    ## note: when using act_age, have to change last_visit to onsetdate
    exposure_year <= as.numeric(format(last_visit, "%Y")),  
    ) 

#make wide format
no2 <- dem1 %>% 
  filter(pollutant == "no2") %>%
  select(-pollutant) %>%
  rename(
    #rename values to be used in main analysis

    ### --> change SP to ST when have new predictions
    
    no2_1yr = exp_avg01_yr_SP,
    no2_5yr = exp_avg05_yr_SP,
    no2_10yr = exp_avg10_yr_SP,
    no2_20yr = exp_avg20_yr_SP,
    no2_10yr10yrlag = exp_avg10_yr10yrlag_SP,
    no2_10yr05yrlag = exp_avg10_yr05yrlag_SP,
    
    no2_coverage_1yr = exp_wks_coverage01_yr_SP,
    no2_coverage_5yr = exp_wks_coverage05_yr_SP,
    no2_coverage_10yr = exp_wks_coverage10_yr_SP,
    no2_coverage_20yr = exp_wks_coverage20_yr_SP,
    no2_coverage_10yr10yrlag = exp_wks_coverage10_yr10yrlag_SP,
    no2_coverage_10yr05yrlag = exp_wks_coverage10_yr05yrlag_SP,
    ) %>%
  
  ### --> won't need this later
  # drop ST predictions 
  select(-contains("ST", ignore.case = F))

pm25 <- dem1 %>% 
  filter(pollutant == "pm25") %>%
  select(-pollutant) %>%
  rename(
    
    ### --> change SP to ST when have new predictions
    
    pm25_1yr = exp_avg01_yr_ST,
    pm25_5yr = exp_avg05_yr_ST,
    pm25_10yr = exp_avg10_yr_ST,
    pm25_20yr = exp_avg20_yr_ST,
    pm25_10yr10yrlag = exp_avg10_yr10yrlag_ST,
    pm25_10yr05yrlag = exp_avg10_yr05yrlag_ST,
    
    pm25_coverage_1yr = exp_wks_coverage01_yr_ST,
    pm25_coverage_5yr = exp_wks_coverage05_yr_ST,
    pm25_coverage_10yr = exp_wks_coverage10_yr_ST,
    pm25_coverage_20yr = exp_wks_coverage20_yr_ST,
    pm25_coverage_10yr10yrlag = exp_wks_coverage10_yr10yrlag_ST,
    pm25_coverage_10yr05yrlag = exp_wks_coverage10_yr05yrlag_ST,
    ) %>%
  
  ### --> won't need this later
  # drop ST predictions 
  select(-contains("SP", ignore.case = F))


dem.w <- full_join(no2, pm25)  

```

Add estimates at age 65 to main dataset. 

### --> change _SP to _ST later

```{r}

# add exposure at age 65
dem0.1_65 <- dem0.0_65 %>%
  select(
    study_id,
    exposure_year_65 = exposure_year,
    pollutant, 
    
    ### --> change _SP to _ST later
    
    exp_avg10_age_65_SP,  
    exp_wks_coverage10_age_65_SP,
    
    exact_coverage10_age_65, 
    imputed_coverage10_age_65
  )
 
dem_65_no2 <- dem0.1_65 %>% 
   filter(pollutant== "no2") %>%
   select(-pollutant) %>%
   rename(
     
    # ---> change _SP to _ST later
     
     no2_exp_avg10_age_65 = exp_avg10_age_65_SP,
     no2_exp_wks_coverage10_age_65 = exp_wks_coverage10_age_65_SP,
   )
    
dem_65_pm25 <- dem0.1_65 %>% 
   filter(pollutant== "pm25") %>%
   select(-pollutant) %>%
   rename(
     
     # ---> change _SP to _ST later
     
    pm25_exp_avg10_age_65 = exp_avg10_age_65_SP,
    pm25_exp_wks_coverage10_age_65 = exp_wks_coverage10_age_65_SP,
   )
 
dem_65 <- full_join(dem_65_no2, dem_65_pm25)

dem.w <- left_join(dem.w, dem_65)
 
```


### --> ? Only including people with an exact address at least 80% of their follow-up time? 

```{r}

```

create a dataset for alternative analyses using onset age rather than diagnosis age.

```{r}
#add variables for alternative analysis using age at onset (cases) or age at last visit (noncases)
dem.w2 <- dem.w %>%
  mutate(
    last_act_fu_yr = ifelse(!is.na(onsetdate), year(onsetdate),
                             year(last_visit)),
    age_end_exposure2 = ifelse(last_act_fu_yr == exposure_year,
                                age_act,
                                as.numeric(as.Date(paste0(exposure_year, "-12-31")) - birthdt)/365),  
    dementia_now2 = ifelse(age_end_exposure2 < age_act, 0, anydementia),
    ad_now2 = ifelse(age_end_exposure2 < age_act, 0, ad_nincds),
  ) %>%
  #drop exposure predictions after individuals are no longer "at risk"  
  filter(exposure_year <= last_act_fu_yr)

```

create a person-level (non-time-varying, fixed covariate) dataset 

```{r}
# create a person-level, fixed covariates dataset 
fixed.covariates <- dem.w %>%
  select(
    study_id:ad_nincds,
    apoe:casi_irt
    ) %>% 
  #make all variables numeric; code has values starting at 0, whereas as.numeric() starts at 1, subtract 1 to fix
  mutate(
    birth_cohort = as.numeric(birth_cohort),
    birth_yr = as.numeric(format(birthdt, "%Y")),
    intake_yr = as.numeric(format(intakedt, "%Y")),
    onset_yr = as.numeric(format(onsetdate, "%Y")),
    last_visit_yr = as.numeric(format(last_visit, "%Y")),
    ) %>%
  #drop dates, which are not "numeric" 
  select(-birthdt, -intakedt, -onsetdate, -last_visit, -onset_yr) %>%
  #one row per individual
  unique() 

# str(fixed.covariates)

```

```{r}
# common variables 
## includes no2
m2_all_vars <- c("apoe", "male", "race_white", "income_cat", "degree", "birth_cohort", "no2_10yr") 
## adjustment variables
m2_vars <- c("apoe", "male", "race_white", "income_cat", "degree", "birth_cohort") 



```


# Sample Size 

Sample size for entire cohort (includes those with missing covariate values not included in any/some analyses) and those included in the primary analysis (Model 2).

### --> why does M2 here have 4 more ppl than below (e.g., Table 1)? 

```{r}

total_n <- dem.w %>%
  summarize(
    N = "Total",
    person_years = n(),
    persons = length(unique(study_id)),
    proportion = n()/nrow(.)
  ) 

m2_n <- dem.w %>%
  drop_na(m2_all_vars) %>%
  summarize(
    N = "Primary analysis",
    person_years = n(),
    persons = length(unique(study_id)),
    proportion = n()/nrow(dem.w)
  )
  
rbind(total_n, m2_n) %>%
  kable(caption = "Sample size", 
        digits = 2) %>%
  kable_styling()

```


```{r}
# #sample size 
# ##no. in cohort 
# cohort_ids <- dem.w %>%
#   select(study_id) %>%
#   unique() 
# 
# n_cohort <- length(cohort_ids$study_id)
# 
# ##no. of cases
# cases_ids <- dem.w %>%
#   filter(anydementia==1) %>%
#   select(study_id) %>%
#   unique() 
# 
# n_cases <- length(cases_ids$study_id)
# 
# ## no. noncases
# non_cases_ids <-dem.w %>%
#   filter(anydementia==0) %>%
#   select(study_id) %>%
#   unique()  
# 
# n_noncases <- length(non_cases_ids$study_id)
# 
# case_proportion <- round(n_cases/n_cohort, 2)
#   
# n_personyears <- nrow(dem.w)
# 
# data.frame(cohort = n_cohort, 
#           cases = n_cases, 
#           non_cases =n_noncases,
#           case_proportion = case_proportion,
#                 total_person_years = n_personyears
#            ) %>%
#   kable(caption = "Sample size") %>%
#   kable_styling()
 
```


# QAQC  

## Missingness

Number of missing observations for fixed covariates. 

APOE has the most missingness observations. A few individuals have misising BMI and other health indicators. Very few individuals have missing income or race indicators.

```{r}
missing_df <- colSums(is.na(fixed.covariates)) %>% as.data.frame() %>%
  rownames_to_column() 

names(missing_df) <- c("Covariate", "N")

missing_df %>%
  filter(N >0)  %>%
  mutate(Proportion = N/nrow(fixed.covariates)) %>%
  arrange(desc(N)) %>%
  kable(caption = "Number and proportion of total of missing observations by covariate", 
        digits = 3) %>%
  kable_styling()

```

### APOE 

Plots of APOE availability by enrollment year. There are proportionally more missing APOE values for more recent years. This may be because they have not yet had their blood work processed.
 
```{r}
apoe_avail_ct_p <- dem.w %>%
  filter(enrollment_yr==1) %>%
  mutate(exposure_year = factor(exposure_year)) %>%
  ggplot(aes(x=exposure_year, fill = !is.na(apoe))) + 
  geom_bar() + 
  theme(axis.text.x = element_text( angle = 90)) + 
  labs(x = "Exposure year",
       y = "Count",
      fill = "APOE available"
       )

apoe_avail_prop_p <- dem.w %>%
  filter(enrollment_yr==1,
         ) %>%
  mutate(exposure_year = factor(exposure_year)) %>%
  ggplot(aes(x=exposure_year, fill = !is.na(apoe))) + 
  geom_bar(position = "fill") + 
  theme(axis.text.x = element_text( angle = 90)) + 
  labs(x = "Exposure year",
       y = "proportion",
       fill = "APOE available"
       )

ggarrange(apoe_avail_ct_p,
          apoe_avail_prop_p, 
          ncol=1,   
          common.legend = T, legend = "bottom",
          heights = c(1,1), 
          labels = "Enrolless by APOE availability"
          )

```

Calculate weights for IPW analysis. Stabilizing weights for IPW based on logistic regression models. Using lasso-selected variable predictors of APOE availability for the denominator and a gender predictor for the numerator.

```{r}
# see B540 L7-8
# Approach:
#1. fill in missing values with their most likely option (mean for continuous, mode for categorical variables)
#2. use selection model (e.g. lasso for glm) to select predictors of whether or not we have APOE values for people: apoe_available (in apoe.w)
# 3. fit logistic model to determine probability of observing an observation given predictors: glm(apoe_available ~ [predictors]). use model w/ dataset to get predicted values (probability of being observed), 
# 4. calculate stablized weights 

apoe0 <- fixed.covariates %>%
  mutate(apoe_available = !is.na(apoe)) %>% 
 dplyr::select(-apoe) 

#1. replace missing values w/ most likely outcome  
##variables w/ missing values  
with.nas <- names(which(colSums(is.na(apoe0)) > 0))

# "income_cat"   "race_white"   "smoke"        "exercise_reg" "Hypertension" "Diabetes"     "CV_DIS"       "Heart_Dis"    "bmi"  "casi_irt"     

# making this all 0s since all but casi_irt are categorical. Filling in missing w/ the model.
#1 = TRUE, 0 = FALSE
mynumeric <- rep(0, length(with.nas))

apoe <- apoe0  
#replace  missing values w/ mean (if numeric) or mode (if factor)
for (i in seq_along(with.nas)) {
  #vector w/ missing values 
  myvar <- with.nas[i]  
  apoe[[myvar]] <- replace.nas.fn(apoe[[myvar]], 
                                  numeric = mynumeric[i])
  }

#check that there are no more NAs #looks good
#describe(apoe) 
#table(!is.na(apoe))
 
#2. Use Lasso to select variables most predictive of APOE being present
#apoe2 <-apoe 

apoe <- apoe %>%
  #convert character variables to numberic
  mutate_if(is.character, as.numeric) %>%
  #convert these to factors
  mutate_at(c("birth_cohort", 
              "nindx", 
              "dsmivdx",
              "degree",
              "income_cat",
              "smoke",
              "bmi"
              ), 
            as.factor)

lasso_results <- lasso_fn(dt = apoe, x_names = names(apoe)[2:(ncol(apoe)-1)], y_name = "apoe_available", family. = "binomial", 
                          lambda. = ""
                          )

lasso.vars <- lasso_results$results$cov

#select selected variables if they are in main dataset as is or if the name is prior to a number. prevents similarly-named variables (e.g. exercise vs exercise_reg) from being selected
#save names & relabel categorized bmi4 variable for now (has issues in loop below b/c of #4 - selects both "bmi" & "bmi4") 
lasso_names <- lasso.vars  
apoe_names <- names(apoe)  

selected_cov <- vector()

for (i in seq_len(length(apoe_names))) {
  #i=2 
  # find exact name or one w/ a digit after the string, e.g., birth_cohort, cohort 
  find_pattern <- paste0("^", apoe_names[i], "$", "|", "^", apoe_names[i], "\\d")
  if(any(grepl(find_pattern, lasso_names))) { selected_cov <- append(selected_cov, apoe_names[i]) }
}

apoe <- apoe %>%
  select(study_id,
         #y
        apoe_available,
        #categories selected via Lasso 
        selected_cov)  

#3. model to predict APOE variable being present
apoe.m <- apoe %>%
  select(-study_id) %>%
  glm(apoe_available ~ .,
  family = "binomial",
  data = .) 

##denominator: probability of APOE being present
apoe_available_prob <- predict(apoe.m, type = "response") 

#min(apoe_available_prob) #check that probability isn't Tiny (like when used "race")
 
#numerator: stabilizer 
apoe.male.m <- apoe %>%
  glm(apoe_available ~ male,
  family = "binomial",
  data = .) 
 
apoe_male_prob <- predict(apoe.male.m, type = "response") 

apoe.wts <- apoe %>% 
  select(study_id) %>%
  mutate(model_wt = apoe_male_prob/apoe_available_prob)
#summary(apoe.wts$model_wt)

# 4. take the inverse of probabilities to calculate "weights", use these weights in coxph(, weights = c()) 
dem.w <- dem.w %>% 
  #add stabilized weights  
  left_join(apoe.wts, by = "study_id")

#for sensitivity analyses 
dem.w2 <- dem.w2 %>% 
  #add stabilized weights  
  left_join(apoe.wts, by = "study_id")

# # Lasso-selected covariates:
# selected_cov
```

Distribution of weights: 

```{r}
ipw_all <- dem.w %>%
  distribution.table(var.string = "model_wt", round.int = 2) %>%
  mutate(Data = "Total") 

ipw_m2 <- dem.w %>%
  drop_na(m2_all_vars) %>%
  distribution.table(var.string = "model_wt", round.int = 2) %>%
  mutate(Data = "Primary analysis")

rbind(ipw_all, ipw_m2) %>%
  select(Data, everything()) %>%
  kable(caption = "Distribution of weights from IPW for person-years included in the primary analysis") %>%
  kable_styling()

```

## Distribution of Key Covariates

```{r}
#histograms
fixed.covariates %>% 
  drop_na(m2_vars) %>%
  mutate(birth_cohort = as.numeric(birth_cohort)) %>%
  gather(key = "variable",  value = "value", -study_id) %>%   
  ggplot(aes(x=value)) + 
  geom_histogram() +
  facet_wrap(~variable, scales = "free") + 
  labs(title = "Distribution of key covariates in primary analysis")

```

## Age variables 

```{r}
dem.w %>%
    drop_na(m2_all_vars) %>%
  gather("Variable", "Age", 
         age_intake, age_last_visit, age_act, age_start_exposure, age_end_exposure,
         na.rm = T) %>%
  mutate(Variable = factor(Variable, levels=unique(Variable))) %>%
  ggplot(aes(x=Age, fill=Variable)) + 
  geom_density(alpha=0.3) + 
  labs(title = "Distribution of various age variables for person-years in the primary analysis")

```

```{r}
dem.w %>%
  drop_na(m2_all_vars) %>%
  gather("Variable", "Value", 
         age_intake, age_last_visit, age_act, age_start_exposure, age_end_exposure,
         na.rm = T) %>%
  mutate(Variable = factor(Variable, levels=unique(Variable))) %>%
  group_by(Variable) %>%
  distribution.table(var.string = "Value") %>%
  kable(caption = "Distribution of various age variables") %>%
  kable_styling()
  
```

```{r, ?delete, include=F}
#check that ages make sense ages
table(round(dem.w$age_intake, 1) <= round(dem.w$age_act, 1))  
#View(dem.w[which(dem.w$age_intake > dem.w$age_act),]) 
table(dem.w$age_intake <= dem.w$age_last_visit)
#View(dem.w[which(dem.w$age_intake > dem.w$age_last_visit),]) #study_id: 4647 has wrong last_visit/intakedt? last_visit is correct. "Will be updated in next freeze"
table(dem.w$age_act <= dem.w$age_last_visit)

#dementia 
dementia_counts <- dem.w %>% 
  group_by(study_id) %>%
  dplyr::summarize(
    #study_id = mean(study_id),
    #number of times each patient has dementia_now==1 (should be max 1)
    anydementia = mean(anydementia),
    dem_now_n = sum(dementia_now==1)
  ) 

##check that individuals who have anydementia=1 also have dementia_now=1 & those who don't don't  
dementia_counts %>%
  with(., table(anydementia, dem_now_n))

##check that individuals only have 1 dementia_now
dementia_counts %>%
  with(., table(dem_now_n <= 1))
#View(dem.w[which(dem.w$age_intake > dem.w$age_last_visit),]) 
#study_id 1027 has 2 dementia_now's b/c last visit age vs end of year age, which rounded to same thing
#View(dem.w[dem.w$study_id==1027,]) 

#AD 
ad_counts <- dem.w %>% 
  group_by(study_id) %>%
  dplyr::summarize(
    ad_nincds = mean(ad_nincds),
    ad_now_n = sum(ad_now==1)
  ) 
##check that individuals who have ad_nincds=1 also have ad_now=1 & those who don't don't #looks good
ad_counts %>%
  with(., table(ad_nincds, ad_now_n))

##check that individuals only have 1 ad_now
ad_counts %>%
  with(., table(ad_now_n <= 1))

```

## CASI by age & case status


### --> edit...how to interpret this??

```{r}
# CASI vs intake age
## CASI decreases in older enrollees
fixed.covariates %>%
    drop_na(m2_vars) %>%
  mutate(anydementia = factor(anydementia)) %>%
  ggplot(aes(x=age_intake, y = casi_irt, col = anydementia, group=anydementia)) + 
  geom_point(alpha=0.5) + 
  geom_smooth() + 
  geom_hline(yintercept = c(0.07, 0.46))

# age at entry & dementia outcome
## non-cases generally enrollat younger ages
fixed.covariates %>%
    drop_na(m2_vars) %>%
  mutate(anydementia = factor(anydementia),
         age_intake_group = cut(age_intake, 5)
         ) %>%
  ggplot(aes(x=age_intake_group, fill = anydementia)) + 
  geom_bar(position = "dodge", stat = "count")

# age at entry & AP over time
## AP is higher for older enrollees - earlier in time? 
dem.w %>%
  #filter(enrollment_yr==1) %>%
    drop_na(m2_vars) %>%
  mutate(anydementia = factor(anydementia)) %>%
  ggplot(aes(x=age_intake, y = no2_10yr, col = anydementia, group=anydementia)) + 
  geom_point(alpha=0.2) + 
  geom_smooth()

# age at entry vs calendar time of entry
# -->?? interaction for cases vs non-cases?
dem.w %>%
  filter(enrollment_yr==1) %>%
    drop_na(m2_vars) %>%
  mutate(anydementia = factor(anydementia)) %>%
  ggplot(aes(x=age_intake, y = exposure_year, col = anydementia, group=anydementia)) + 
  geom_point(alpha=0.2) + 
  geom_smooth()


# age at intake vs age over time
dem.w %>%
  #filter(enrollment_yr==1) %>%
    drop_na(m2_vars) %>%
  mutate(anydementia = factor(anydementia)) %>%
  ggplot(aes(x=age_intake, y = age_start_exposure, col = anydementia, group=anydementia)) + 
  geom_point(alpha=0.2) + 
  geom_smooth()


```

## Follow-up time & cohort 

Later cohorts have less follow-up time

```{r}
dem.w %>%
  filter(enrollment_yr==1) %>%
  drop_na(m2_vars) %>%
  mutate(cohort = factor(cohort)) %>%
  ggplot(aes(x=cohort, y = fu_yrs, col = anydementia)) + 
  geom_boxplot() + 
  labs(y = "Follow-up years",
       title = "Follow-up time by ACT cohort"
       )

```

### --> dementia cases over time

```{r}
dem.w %>%
  filter(dementia_now==1) %>%
  drop_na(m2_vars) %>%
  ggplot(aes(x=exposure_year)) + 
  geom_bar() + 
  labs( 
       title = "No. of dementia cases over time"
       )


```



## Summary of location & prediction quality variables

All person-years have 10 yr predictions for NO2 and PM2.5. Most person-years do not have imputation (value of 0). Most person-years have exact addresses. Most person-years have the highest imputation quality (0). About 39% of the person-years are from individuals living in one location.

```{r}
dem.w %>%
  drop_na(m2_all_vars) %>%
  mutate(imp_qual10_yr_of_0or1 = imp_qual10_yr %in% c(0, 1)) %>%
  gather("variable", "value", 
         no2_coverage_10yr, pm25_coverage_10yr, 
         imputed_coverage10_yr,
         exact_coverage10_yr,
         
         #imp_qual10_yr,
         imp_qual10_yr_of_0or1,

         one_location,
         ) %>%
  drop_na(value) %>%
  mutate(variable = factor(variable, levels = unique(variable))) %>%
  group_by(variable) %>%
  distribution.table(var.string = "value", round.int = 2) %>%
  kable(caption = paste0("Distribution of location & prediction quality variable values for person-years in primary analysis")) %>%
  kable_styling()

 
  
```


## Compare numbers vs Rachel's

```{r, include=F}
summary(dem.w$age_end_exposure)

summary(dem.w2$age_end_exposure2 )

summary(dem.w$age_act) 
#summary(dem.w$age_act[dem.w$anydementia==1]) 

summary(dem.w2$last_act_fu_yr)
 

summary(fixed.covariates$age_last_visit)

table(dem.w$dementia_now)
table(dem.w2$dementia_now2)

summary(fixed.covariates$age_last_visit)
summary(fixed.covariates$age_act) 

summary(fixed.covariates$age_last_visit[fixed.covariates$anydementia==1]) 
summary(fixed.covariates$age_act[fixed.covariates$anydementia==1]) 

```



# Descriptive Statistics

## Table 1   

Participant characteristics.  

Dementia

### --> issue, why is entry age & FU yrs pct weird?

```{r}
#table1

# total 
t1_tot <- dem.w %>%
  # only keep individuals included in Model 2
  drop_na(m2_all_vars) %>%
  #1st year of enrollment (baseline)
  filter(enrollment_yr == 1) %>%
  t1.fn() %>%
  #separate N & %s
  separate(col = V1, into = c("Total_a", "Total_b"), sep = " ", fill = "right")  %>%
    mutate_all(~str_replace(., "0 \\(NaN%\\)", "NA"))   

## Replace NAs w/ ""
t1_tot$Total_b[is.na(t1_tot$Total_b)] <- ""
 
# dementia 
t1_dem <- dem.w %>%
  # only keep individuals included in Model 2
  drop_na(m2_all_vars) %>%
  #1st year of enrollment (baseline)
  filter(enrollment_yr == 1) %>%
  group_by(anydementia) %>%
  t1.fn() %>%
  separate(col = V1, into = c("NoDementia_a", "NoDementia_b"), sep = " ", fill = "right")  %>%
  separate(col = V2, into = c("Dementia_a", "Dementia_b"), sep = " ", fill = "right")  %>%
  #replace "NaN" estimates for APOE w/ "NA"
  mutate_all(~str_replace(., "0 \\(NaN%\\)", "NA")) %>%
  #remove grouping rows
  slice(-c(1)) %>%
  select(Variable, starts_with("Dementia"), starts_with("NoDementia"))

## Replace NAs w/ ""
t1_dem$NoDementia_b[is.na(t1_dem$NoDementia_b)] <- ""
t1_dem$Dementia_b[is.na(t1_dem$Dementia_b)] <- "" 


# AD 
t1_ad <- dem.w %>%
  drop_na(m2_all_vars) %>%
  filter(enrollment_yr == 1) %>%
  group_by(ad_nincds) %>%
  t1.fn() %>%
  #separate N & %s
 separate(col = V1, into = c("NoAD_a", "NoAD_b"), sep = " ", fill = "right")  %>%
  separate(col = V2, into = c("AD_a", "AD_b"), sep = " ", fill = "right")  %>%
  #replace "NaN" estimates for APOE w/ "NA"
  mutate_all(~str_replace(., "0 \\(NaN%\\)", "NA")) %>%
  #remove grouping rows
  slice(-c(1)) %>%
  select(Variable, starts_with("AD"), starts_with("No"))

## Replace NAs w/ ""
t1_ad$NoAD_b[is.na(t1_ad$NoAD_b)] <- ""
t1_ad$AD_b[is.na(t1_ad$AD_b)] <- "" 


t1_tot %>%
  left_join(t1_dem) %>%
left_join(t1_ad)  %>%
  column_to_rownames(var = "Variable") %>%
  kable(caption = "Cohort characteristics by all-cause dementia and Alzheimer's Disease incidence", 
        col.names = c(#"Variable", 
                      "Total", " ", "Dementia", " ", "No Dementia", "", "AD", "", "No AD", ""), 
        align = "r"
        ) %>%
  add_indent(c(5:11,15:20,22:25, 27:29, 32:35, 37:39, 44:46)) %>%
  add_footnote(c(
    "Table includes participants in primary analysis (those with complete observations for: APOE status, gender, race, Census Tract income, education and birth cohort)",
    "Baseline cognition is based on CASI scores that have been adjusted for accuracy using Item Response Theory (IRT). Higher numbers indicate greater cognitive function."
    ))

```

## Age distribution over time

```{r}
dem.w %>%
  drop_na(m2_vars) %>%
  ggplot(aes(x=exposure_year, y = age_start_exposure, group=exposure_year,
             )) +
  geom_boxplot() +
  geom_vline(xintercept = c(1994, 2000, 2004), col = "blue") + 
    labs(x = "Year",
         y = "Participant Age",
         col = "Birth Cohort",
         title = "Age distribution over time of person-years in the primary analysis",
         caption = "Original cohort: 1994-1999; Expansion: 2000-2002, Replacement: 2004+"
           ) 
```


## Exposure Distribution

NO2 exposure over time

```{r}
dem.w %>%
  drop_na(m2_vars) %>%
  ggplot(aes(x=exposure_year, y = no2_1yr, group=exposure_year)) +
  geom_boxplot(alpha=0.05) +
    labs(x = "Year",
         y = "NO2 Exposure (ppb)",
         col = "Birth Cohort",
         title = "Annual NO2 exposure over time for person-years in the primary analysis"
           ) 
```

```{r}
# NO2 
all_yrs <- dem.w %>%
  mutate(Years = "All") %>%
  group_by(Years) %>%
  drop_na(m2_vars,
          no2_1yr) %>%
  distribution.table(var.string = "no2_1yr")

by_yr <- dem.w %>%
  drop_na(m2_vars,
          no2_1yr) %>%
  mutate(Years = cut_interval(x = exposure_year, n = 4, dig.lab=4)) %>%
  group_by(Years) %>%
    distribution.table(var.string = "no2_1yr")

no2_all <- rbind(all_yrs, by_yr) 

no2_all %>%
  kable(caption = "Annual average NO2 (ppb) exposure predictions for person-years in the primary analysis") %>%
  kable_styling()
```

No2 exposure by participant age and birth cohort. 

Each dot represents a person-year, such that people generally have multiple dots on the plot. Within a given birth cohort, exposure typically decreased as participants age as a result of decreasing concentrations over time. For any given age, individuals born in earlier cohorts generally have higher exposures because they were that age at an earlier time period.

```{r}
# 1 yr exposure
dem.w %>%
  drop_na(m2_vars) %>%
  group_by(birth_cohort) %>%
  #relabel birth cohort
  mutate(birth_cohort2 = paste0(min(year(birthdt)), "-", max(year(birthdt)))) %>%
  ggplot(aes(x=age_start_exposure, y = no2_1yr, col = birth_cohort2)) +
  geom_point(alpha=0.05) +
  geom_smooth(aes(col = birth_cohort2)) + 
    labs(x = "Age (years)",
         y = "Annual NO2 Exposure (ppb)",
         col = "Birth Cohort",
         title = "Annual NO2 exposure by participant age for person-years in the primary analysis"
           ) 

```

```{r}
# 10 yr exposure 
dem.w %>%
  drop_na(m2_vars) %>%
  group_by(birth_cohort) %>%
  #relabel birth cohort
  mutate(birth_cohort2 = paste0(min(year(birthdt)), "-", max(year(birthdt)))) %>%
  ggplot(aes(x=age_start_exposure, y = no2_10yr, col = birth_cohort2)) +
  geom_point(alpha=0.05) +
  geom_smooth(aes(col = birth_cohort2)) + 
    labs(x = "Age (years)",
         y = "10 yr NO2 Exposure (ppb)",
         col = "Birth Cohort",
         title = "10 yr NO2 exposure by participant age for person-years in the primary analysis"
           ) 
```


PM2.5 exposure over time

```{r}
dem.w %>%
  drop_na(m2_vars) %>%
  ggplot(aes(x=exposure_year, y = pm25_1yr, group=exposure_year)) +
  geom_boxplot(alpha=0.05) +
    labs(x = "Year",
         y = "Annual PM2.5 Exposure (ug/m3)",
         col = "Birth Cohort",
         title = "Annual PM2.5 exposure over time for person-years in the primary analysis"
           ) 

```

```{r}

# PM2.5
all_yrs <- dem.w %>%
  mutate(Years = "All") %>%
  group_by(Years) %>%
  drop_na(m2_vars,
          pm25_1yr) %>%
  distribution.table(var.string = "pm25_1yr")

by_yr <- dem.w %>%
      drop_na(m2_vars, 
              pm25_1yr) %>%
  mutate(Years = cut_interval(x = exposure_year, n = 4, dig.lab=4)) %>%
  group_by(Years) %>%
    distribution.table(var.string = "pm25_1yr")

pm25_all <- rbind(all_yrs, by_yr) 

pm25_all %>% kable(caption = "Annual average PM2.5 (ug/m3) exposure predictions over time for person-years in the primary analysis") %>%
  kable_styling()
 
```

PM2.5 exposure by participant age and birth cohort 

```{r}
# 1 yr exposure
dem.w %>%
  drop_na(m2_vars) %>%
  group_by(birth_cohort) %>%
  mutate(birth_cohort2 = paste0(min(year(birthdt)), "-", max(year(birthdt)))) %>%
  ggplot(aes(x=age_start_exposure, y = pm25_1yr, col = birth_cohort2)) +
  geom_point(alpha=0.05) +
  geom_smooth(aes(col = birth_cohort2)) + 
    labs(x = "Age (years)",
         y = "Annual PM2.5 Exposure (ug/m3)",
         col = "Birth Cohort",
         title = "Annual PM2.5 exposure by participant age for person-years in the primary analysis"
           ) 

```

```{r}
# 10 yr exposure
dem.w %>%
  drop_na(m2_vars) %>%
  group_by(birth_cohort) %>%
  mutate(birth_cohort2 = paste0(min(year(birthdt)), "-", max(year(birthdt)))) %>%
  ggplot(aes(x=age_start_exposure, y = pm25_10yr, col = birth_cohort2)) +
  geom_point(alpha=0.05) +
  geom_smooth(aes(col = birth_cohort2)) + 
    labs(x = "Age (years)",
         y = "10 yr PM2.5 Exposure (ug/m3)",
         col = "Birth Cohort",
         title = "10 yr PM2.5 exposure by participant age for person-years in the primary analysis"
           ) 
```

## Covariate Correlations 

```{r}
r2 <- with(dem.w, cor(no2_10yr, pm25_10yr,
                method = "pearson", use = "complete.obs")^2) %>% round(2)

```

See moderate correlation (R2 = `r r2`) between NO2 and PM2.5. Non copollutant models may be confounded by PM2.5.

```{r}
#dataset with model variables of interest for descriptive purposes (similar dataset generated in models.fn())
dem.w %>% select(
    #m2
    apoe,
    male,
    race_white,
    income_cat,
    degree,
    birth_cohort,
    #m3
    smoke,
    exercise_reg,
    #m4
    Hypertension,
    Diabetes, 
    CV_DIS,
    Heart_Dis,
    bmi,
    #m6
    pm25_10yr,
    no2_10yr) %>% 
  mutate_all( ~as.numeric(.)) %>%
  cor(method = "pearson", use ="complete.obs") %>%
  corrplot::corrplot(method="color") 

```

# Survival Analysis

## Primary Analysis, Reduced & Extended Models

Dementia

```{r, fig.height=8}
# note, functions use cluster = study_id in order for coxph() to calculate robust SEs

dem_10yr <- dem.w %>%
  #filter(cohort != 1) %>% 
  #filter(birth_cohort != "1935") %>%
  models.fn(.,
                models = paste0("m", c(1, 2, "3a", "3b",  "4a", "4b", 5, 6)),  
                surv.time2 = "age_end_exposure", 
                surv.event = "dementia_now", 
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr" #pm25.units = 5
                )

 
#dem_10yr$hrs

dem_10yr_hrs <- dem_10yr$hrs %>%
  mutate(
    Model = c("1",
           "2", 
           "3a", 
           "3b", 
           "4a", 
           "4b", 
           "5", 
           "5", 
           "6"),
    Description = c("Reduced",
           "Primary", 
           "Extended", 
           "Extended, ACT Cohort", 
           "Extended & Mediation", 
           "Extended & Mediation, CASI Score", 
           "Interaction, no APOE", 
           "Interaction, APOE", 
           "PM2.5 Adjusted")
    )

 
# dem_10yr_hrs

#m2 for other exposure years
dem_other_yrs <- data.frame()
expo.prds <- paste0("no2_", c("1yr", "5yr", "20yr", "10yr10yrlag", "10yr05yrlag"))

for (i in seq_along(expo.prds)) {
  df <- models.fn(mydata = dem.w,
                models = "m2",
                surv.time2 = "age_end_exposure", 
                surv.event = "dementia_now", 
                no2.var = expo.prds[i])
  
  dem_other_yrs <- rbind(dem_other_yrs, df$hrs)
  }

dem_other_yrs <- dem_other_yrs %>%
  mutate(
    Model = "2",
    Description = c("1 yr Exposure", 
                    "5 yr Exposure", 
                    "20 yr Exposure", 
                    "10 yr 5 yr Lag Exposure", 
                    "10 yr 10 yr Lag Exposure")
    )

#HR table 
dem_hrs <- rbind(dem_10yr_hrs, dem_other_yrs) %>%
  mutate(Exposure = factor(Exposure, levels = c("1yr", "5yr", "10yr", "20yr", "10yr10yrlag", "10yr05yrlag")))

```


AD 

```{r, fig.height=8}
ad_10yr <- models.fn(mydata = dem.w,
                models = paste0("m", c(1, 2, "3a", "3b",  "4a", "4b", 5, 6)),  
                surv.time2 = "age_end_exposure", 
                surv.event = "ad_now", 
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")

ad_10yr_hrs <- ad_10yr$hrs %>%
  mutate(
    Model = c("1",
           "2", 
           "3a", 
           "3b", 
           "4a", 
           "4b", 
           "5", 
           "5", 
           "6"),
    Description = c("Reduced",
           "Primary", 
           "Extended", 
           "Extended, ACT Cohort", 
           "Extended & Mediation", 
           "Extended & Mediation, CASI Score", 
           "Interaction, no APOE", 
           "Interaction, APOE", 
           "PM2.5 Adjusted")
    )

#m2 for other exposure years
ad_other_yrs <- data.frame()

for (i in seq_along(expo.prds)) {
  df <- models.fn(mydata = dem.w,
                models = "m2",
                surv.time2 = "age_end_exposure", 
                surv.event = "ad_now", 
                no2.var = expo.prds[i])
  
  ad_other_yrs <- rbind(ad_other_yrs, df$hrs)
  }

ad_other_yrs <- ad_other_yrs %>% 
  mutate(Model = "2",
         #Description = "Different exposure period"
         Description = c("1 yr Exposure", 
                    "5 yr Exposure", 
                    "20 yr Exposure", 
                    "10 yr 5 yr Lag Exposure", 
                    "10 yr 10 yr Lag Exposure")
  )

#HR table 
ad_hrs <- rbind(ad_10yr_hrs, ad_other_yrs) %>%
  mutate(Exposure = factor(Exposure, levels = c("1yr", "5yr", "10yr", "20yr", "10yr10yrlag", "10yr05yrlag")))  

```

## M2 using age at ACT onset diagnosis (cases) or last visit (noncases) 

Dementia 

```{r}

dem_10yr_act <- dem.w2 %>%
  models.fn(.,
            models = paste0("m2"),
            surv.time2 = "age_end_exposure2", 
            surv.event = "dementia_now2", 
            no2.var = "no2_10yr",
            pm25.var = "pm25_10yr") 

dem_10yr_act <- dem_10yr_act$hrs %>%
  mutate(Model = "2",
         Description = "Onset Age")

```

AD

```{r}
ad_10yr_act <- dem.w2 %>%
  models.fn(.,
            models = paste0("m2"),
            surv.time2 = "age_end_exposure2", 
            surv.event = "ad_now2", 
            no2.var = "no2_10yr",
            pm25.var = "pm25_10yr")  

ad_10yr_act <- ad_10yr_act$hrs %>%
  mutate(Model = "2",
         Description = "Onset age")

```

## M2 without IPW for missing APOE status

Dementia

```{r}
dem_10yr_m2_wt1 <- dem.w %>%
  mutate(model_wt = 1) %>%
  models.fn(mydata = .,
            models = "m2",
            surv.time2 = "age_end_exposure",
            surv.event = "dementia_now",
            no2.var = "no2_10yr",
            pm25.var = "pm25_10yr")
 
dem_10yr_m2_wt1_hr <- dem_10yr_m2_wt1$hrs %>%
  mutate(Model = "2",
         Description = "No IPW")

```

AD

```{r}
ad_10yr_m2_wt1 <- dem.w %>%
  mutate(model_wt = 1) %>%
  models.fn(mydata = .,
            models = "m2",
            surv.time2 = "age_end_exposure",
            surv.event = "ad_now",
            no2.var = "no2_10yr",
            pm25.var = "pm25_10yr")
 
ad_10yr_m2_wt1_hr <- ad_10yr_m2_wt1$hrs %>%
  mutate(Model = "2",
         Description = "No IPW")

```

## Highest quality address history (no imputation)

Restirct analysis to individuals without address imputation and lived at an exact address at least 80% of the time. 

Dementia

**note:** HR becomes non-significant if run co-pollutant model 6

### --> ? run other analyses w/ this subset of ppl? These models have a different subste of people than other models 

### --> ? is this the same as restricting to ~ 2000+? Do a time-restricted analysis (model predictions may be more accurate for more recent years - more monitors)?

```{r}

dem_highest_qual <- dem.w %>%
  filter(imp_qual10_yr == 0,
         exact_coverage10_yr >= 0.8) %>%
  models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure",
                surv.event = "dementia_now",
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")

#dem_highest_qual$hrs

dem_highest_qual_hrs <- dem_highest_qual$hrs %>%
  mutate(Model = "2",
         Description = "Highest quality address hx") 

```

AD

```{r}
ad_highest_qual <- dem.w %>%
  filter(imp_qual10_yr == 0,
         exact_coverage10_yr >= 0.8) %>%
  models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure",
                surv.event = "ad_now",
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")


# ad_one_location$raw_model_output
ad_highest_qual_hrs <- ad_highest_qual$hrs %>%
  mutate(Model = "2",
         Description = "Highest quality address hx") 

```

## High quality address history (high imputation quality)

Restirct analysis to individuals with: 

* an imputation quality of 0 or 1   
  + 0: no imputation   
  + 1: a) had an address gap(s) that was < 2 years w/ a different location before and after, or b) if the address was the first record, the start time of that was only extended backwards by the amount of known time that they lived at that location, up to 10 years   

* and those that lived at an exact address at least 80% of the time

Dementia 

```{r}
dem_high_quality <- dem.w %>%
  filter(imp_qual10_yr <=1,
         exact_coverage10_yr >= 0.8) %>%
  models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure",
                surv.event = "dementia_now",
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")

dem_high_quality_hrs <- dem_high_quality$hrs %>%
  mutate(Model = "2",
         Description = "High quality address hx") 

```

AD

```{r}
ad_high_quality <- dem.w %>%
  filter(imp_qual10_yr <=1,
         exact_coverage10_yr >= 0.8) %>%
  models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure",
                surv.event = "ad_now",
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")


# ad_one_location$raw_model_output
ad_high_quality_hrs <- ad_high_quality$hrs %>%
  mutate(Model = "2",
         Description = "High quality address hx") 

```

## Never Movers

Restirct analysis to individuals who have never moved and lived at an exact address at least 80% of the time. Using exact address threshold b/c individuals could, for example, have different addresses with poor geocoding at the zip code level linked to the same zip code.

Dementia

**note:** HR becomes non-significant if run co-pollutant model 6

### --> ? run other analyses w/ this subset of ppl? These models have a different subste of people than other models 

```{r}

dem_never_movers <- dem.w %>%
  filter(one_location == 1,
         exact_coverage10_yr >= 0.8) %>%
  models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure",
                surv.event = "dementia_now",
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")

#dem_highest_qual$hrs

dem_never_movers_hrs <- dem_never_movers$hrs %>%
  mutate(Model = "2",
         Description = "Never movers") 

```

AD

```{r}
ad_never_movers <- dem.w %>%
  filter(one_location == 1,
         exact_coverage10_yr >= 0.8) %>%
  models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure",
                surv.event = "ad_now",
                no2.var = "no2_10yr",
                pm25.var = "pm25_10yr")


# ad_one_location$raw_model_output
ad_never_movers_hrs <- ad_never_movers$hrs %>%
  mutate(Model = "2",
         Description = "Never movers") 

```


## Fixed AP at age 65

Dementia

```{r}

dem_age_65 <- dem.w %>%
  # fixed exposure 
  filter(enrollment_yr == 1) %>%
  models.fn(mydata = .,
            models = "m2", 
            surv.time1 = "age_intake",
            surv.time2 = "age_last_visit",
            surv.event = "anydementia",
            no2.var = "no2_exp_avg10_age_65")

dem_age_65_hrs <- dem_age_65$hrs %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = "Fixed exposure at age 65") 

```

AD

```{r}
ad_age_65 <- dem.w %>%
  filter(enrollment_yr == 1) %>%
  models.fn(mydata = .,
            models = "m2", 
            surv.time1 = "age_intake",
            surv.time2 = "age_last_visit",
            surv.event = "ad_nincds",
            no2.var = "no2_exp_avg10_age_65")

ad_age_65_hrs <- ad_age_65$hrs %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = "Fixed exposure at age 65") 

```

### Fixed AP at study entry

Dementia 

```{r}
dem_age_entry <- dem.w %>%
  filter(enrollment_yr == 1) %>%
  models.fn(mydata = .,
            models = "m2", 
            surv.time1 = "age_intake",
            surv.time2 = "age_last_visit",
            surv.event = "anydementia",
            no2.var = "no2_10yr")

dem_age_entry_hrs <- dem_age_entry$hrs %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = "Fixed exposure at entry") 

```

AD

```{r}
ad_age_entry <- dem.w %>%
  # fixed exposure 
  filter(enrollment_yr == 1) %>%
  models.fn(mydata = .,
            models = "m2", 
            surv.time1 = "age_intake",
            surv.time2 = "age_last_visit",
            surv.event = "ad_nincds",
            no2.var = "no2_10yr")

ad_age_entry_hrs <- ad_age_entry$hrs %>%
  mutate(
    Exposure = "10yr",
    Model = "2",
    Description = "Fixed exposure at entry") 

```

## Road Proximity exposure

### --> need road covariate 
###--> define "near road" - < 150 m from A1 or < 50 m A2
### --> also model log(distance to A1 or A2)

Dementia

```{r}

# dem_road <- dem.w %>%
#   models.fn(mydata = .,
#                 models = "m2",
#                 surv.time2 = "age_end_exposure",
#                 surv.event = "dementia_now",
#             
#             # --> update 
#                 no2.var = "no2_10yr",
#             
#                 pm25.var = "pm25_10yr")
# 
# dem_road_hrs <- dem_road$hrs %>%
#   mutate(Model = "2",
#          Description = "Road proximity exposure") 

```

AD

```{r}

```

### --> DIFFERENT MODELS
### --> finer birth cohort adjustment (is 1935-51 birth cohort too large? ppl turn 65 starting in 2,000). or use grouped calendar year (5 yrs)?
###--> ? stratify by time adjustment variable
### --> ? separate analyses for each ACT cohort

can use exposure_year for primary model, but extended models don't have enough values 

```{r}
no2.var = "no2_10yr"
pm25.var = "pm25_10yr"

#rename variables for fns
mydata <- dem.w %>%
  rename(
    #m1 
    no2 = no2.var,
    #m2
    income = income_cat,
    edu = degree,
    #m6
    pm25 = pm25.var) %>%
  mutate_at(
    c("income",
      "edu",
      "birth_cohort",
      "cohort",
      "smoke",
      "bmi"), 
    as.factor) %>%
  mutate(
    #adjust AP units
    no2 = as.double(no2/my.no2.units),
    pm25 = as.double(pm25/my.pm25.units),
    birth_year = year(birthdt)
  )  
  
#create a survival object
s.dem <- Surv(
  time = mydata$age_start_exposure, 
  time2 = mydata$age_end_exposure, 
  event = mydata$dementia_now)
  
#s.dem <- dem_10yr$survival_object

```

 

### Spline Adjustment for calendar time 

o	Goal is not prediction here. Want to use fewer categories 

### --> plot hazard of dementia vs birth year/calendar year. 
### --> overlay different natural splines. Which fits best? 

```{r}
s_time <- Surv(
  time = mydata$exposure_year-1, 
  time2 = mydata$exposure_year, 
  event = mydata$dementia_now)

# 537 ch 3 slide 72?
coxfit <- coxph(s.dem ~birth_cohort, data = mydata)

plot(survfit(coxfit), 
      xlim=c(65,110),
     #fun = "cumhaz", 
     #conf.type = "none",

     )




# n=400
# #takes long time to calculate
# df=as.data.frame(matrix(NA, ncol=n, nrow=length(y)))
# for (i in 3:n){
# lm1=lm(y~bs(x,df=i))
# df[i]=predict(lm1)
# }
# df$x=x
# 
# par(mfrow=c(1,1))
# plot(y~x)
# lines(df[400], col="red", lwd=2) 
# lines(df[100], col="orange", lwd=2) 
# lines(sin((1:1000)/100)*4,col="yellow", lwd=3) #true function? w/o error?
# lines(df[10], col="pink", lwd=2) 
# lines(df[5], col="brown", lwd=2) 
# lines(df[3], col="black")
# #lines(y, col="blue")
# legend("topright", legend=c("400 DF", "100 DF", "10 DF", "5 DF", "3 DF", "true f(x)"), col=c("red","orange", "pink", "brown", "black", "yellow"), lty = 1, cex=.75)

```
 
Primary and extended models for PM2.5 HRs are no longer protective when we adjsut for birth cohort more finely.

```{r}


# primary analysis HR is: 1.04 (0.82, 1.33)
round_year <- 5

mydata %>%
  mutate(
    # adjust for birth cohort  
    birth_cohort = factor(year(round_date(birthdt, unit = paste(round_year, "year"))))
  ) %>%
  coxph(s.dem ~ pm25 + strata(apoe) + male + race_white + income + edu +  
        strata(birth_cohort) +
              smoke + exercise_reg #+
              #Hypertension + Diabetes + CV_DIS + Heart_Dis + bmi #+
              #casi_irt +
        #no2
        
        
        , 
        data=., 
        cluster = study_id,
        weights = model_wt) %>% 
  summary()




```

plot spline: hazard of dementia vs birth cohort 

```{r}
dem.w %>%
  ggplot(aes(x=birth_cohort, y = dementia_now)) + 
  geom_li


```


```{r}
# table of person-years in each cohort vs year
table(dem.w$birth_cohort)

table(round(dem.w$exposure_year/5)*5)

table(round(dem.w$exposure_year/5)*5, dem.w$birth_cohort)

```


```{r}
# age vs birth cohort
dem.w %>%
  mutate(birth_cohort = factor(year(round_date(birthdt, unit = "5 year")))
         ) %>%
  ggplot(aes(x=birth_cohort, y=age_end_exposure, fill=factor(dementia_now))) + 
  geom_boxplot()

#age vs calendar year
dem.w %>%
  mutate(year_bin = factor(round(exposure_year/round_year)*round_year)
         ) %>%
  ggplot(aes(x=year_bin, y=age_end_exposure, fill=factor(dementia_now))) + 
  geom_boxplot()

```





### --> stratify by all confoundres

```{r}

```



## Compare all HRs

### Dementia

```{r, fig.height=8}
#combine HRs from all analyses 

dem_all_hrs <- rbind(
  #reduced, primary & extended models, using 10 yr exposure
  dem_hrs,
  #M2 using age at ACT onset diagnosis (cases) or last visit (noncases)  
  dem_10yr_act,
  #no IPW
  dem_10yr_m2_wt1_hr,
  # high quality address imputation
  dem_highest_qual_hrs,
  dem_high_quality_hrs,
  dem_never_movers_hrs,
  # using fixed exposure at age 65
  dem_age_65_hrs,
  # using fixed exposure at entry
  dem_age_entry_hrs
  # road proximity
  #dem_road
  ) %>%
  mutate(
    model_description = paste0(Model, ". ", Description),
    hr_ci = paste0(hr, " (", lower_limit, ", ", upper_limit, ")"),
    Exposure = recode_factor(Exposure,
                              "1yr" = "1 yr",
                              "5yr" = "5 yr",
                              "10yr" = "10 yr",
                              "20yr" = "20 yr",
                              "10yr10yrlag" = "10 yr 10 yr lag",
                              "10yr05yrlag" = "10 yr 5 yr lag"
                              ),
    Description = factor(Description, levels = Description)
    )  


# table
dem_all_hrs %>%
  select(
    Model, Description, Exposure,
    hr_ci,
    n, number_events
    ) %>%
  rename(
    "Model Covariates" = Model,
    "HR (95% CI)" = hr_ci,
    "N" = n,
    "No. events" = number_events,
    ) %>%
  kable(caption = "Dementia hazard ratios for a 10 ppb increase in NO2 exposure", 
        align = "l") %>%
  kable_styling() %>%
  add_footnote("'N' is person-years for time-varying analyses and persons for fixed exposure analyses")

 
#plot HRs
dem_all_hrs %>% hr.plot(., outcome_var = "dementia")

```

 
### AD

```{r, fig.height=8}
#AD
ad_all_hrs <- rbind(
  #reduced, primary & extended models, using 10 yr exposure 
  ad_hrs, 
  #M2 using age at ACT onset diagnosis (cases) or last visit (noncases)  
  ad_10yr_act, 
  #no IPW
  ad_10yr_m2_wt1_hr,
  #high address quality
  ad_highest_qual_hrs,
  ad_high_quality_hrs,
  ad_never_movers_hrs,
  # using fixed exposure at age 65
  ad_age_65_hrs,
  # using fixed exposure at entry
  ad_age_entry_hrs
  # road proximity
  #ad_road
) %>%
  mutate(
    model_description = paste0(Model, ". ", Description),
    hr_ci = paste0(hr, " (", lower_limit, ", ", upper_limit, ")"),
    Exposure = recode_factor(Exposure,
                              "1yr" = "1 yr",
                              "5yr" = "5 yr",
                              "10yr" = "10 yr",
                              "20yr" = "20 yr",
                              "10yr10yrlag" = "10 yr 10 yr lag",
                              "10yr05yrlag" = "10 yr 5 yr lag"
                              ),
    Description = factor(Description, levels = Description)
  )

# table
ad_all_hrs %>%
  select(
    Model, Description, Exposure,
    hr_ci,
    n, number_events
    ) %>%
  rename(
    "HR (95% CI)" = hr_ci,
    "N" = n,
    "No. events" = number_events,
    ) %>%
  kable(caption = "AD hazard ratios for a 10 ppb increase in NO2 exposure", 
        align = "l") %>%
  kable_styling()%>%
  add_footnote("'N' is person-years for time-varying analyses and persons for fixed exposure analyses")

ad_all_hrs %>% hr.plot(., outcome_var = "AD")

```

# Running models for PM2.5 as the primary exposure (Rachel's analysis)

Dementia 

-reduced, primary, exntended models; different exposure windows


### --> note: adjusting for birth cohort more finely (round_year)

```{r}
round_year <- 5

# NOTE: treating PM2.5 as if it were my primary exposure, thus treating it as "NO2" in the models. 
dem_10yr_pm25 <- dem.w %>%
  mutate(
    # adjust for birth cohort  
    birth_cohort = factor(year(round_date(birthdt, unit = paste(round_year, "year"))))
  ) %>%
  models.fn(.,
           models = paste0("m", c(1, 2,  "3a", "3b",  "4a", "4b", 5, 6)), 
                surv.time2 = "age_end_exposure", 
                surv.event = "dementia_now", 
                no2.var = "pm25_10yr",
                pm25.var ="no2_10yr", 
                
                no2.units = 1, # really this is for PM2.5
                pm25.units = 10 # this is for NO2
                )

#dem_10yr_pm25$hrs

dem_10yr_pm25_hrs <- dem_10yr_pm25$hrs %>%
  mutate(
    Model = c("1",
           "2", 
           "3a", 
           "3b", 
           "4a", 
           "4b", 
           "5", 
           "5", 
           "6"),
    Description = c("Reduced",
           "Primary", 
           "Extended", 
           "Extended, ACT Cohort", 
           "Extended & Mediation", 
           "Extended & Mediation, CASI Score", 
           "Interaction, no APOE", 
           "Interaction, APOE", 
           "NO2 Adjusted"))

#m2 for other exposure years
dem_other_yrs_pm25 <- data.frame()
expo.prds <- paste0("pm25_", c("1yr", "5yr", "20yr", "10yr10yrlag", "10yr05yrlag"))

for (i in seq_along(expo.prds)) {
  df <- dem.w %>%
    mutate(
    # adjust for birth cohort more finely
    birth_cohort = factor(year(round_date(birthdt, unit = paste(round_year, "year"))))
  ) %>%
    models.fn(mydata = .,
                models = "m2",
                surv.time2 = "age_end_exposure", 
                surv.event = "dementia_now", 
                no2.var = expo.prds[i],
                
                no2.units = 1, # really this is for PM2.5
                pm25.units = 10 # this is for NO2
                )
  
  dem_other_yrs_pm25 <- rbind(dem_other_yrs_pm25, df$hrs)
  }

dem_other_yrs_pm25 <- dem_other_yrs_pm25 %>%
  mutate(
    Model = "2",
    Description = c("1 yr Exposure", 
                    "5 yr Exposure", 
                    "20 yr Exposure", 
                    "10 yr 5 yr Lag Exposure", 
                    "10 yr 10 yr Lag Exposure")
    )

#HR table 
dem_hrs_pm25 <- rbind(dem_10yr_pm25_hrs, dem_other_yrs_pm25) %>%
  mutate(
    Exposure = substr(as.character(Exposure), 2, nchar(as.character(Exposure))),
    Exposure = factor(Exposure, levels = c("1yr", "5yr", "10yr", "20yr", "10yr10yrlag", "10yr05yrlag")))


# onset age
dem_10yr_act_pm25 <- dem.w2 %>%
  mutate(
    # adjust for birth cohort more finely
    birth_cohort = factor(year(round_date(birthdt, unit = paste(round_year, "year"))))
  ) %>%
  models.fn(.,
            models = paste0("m2"),
            surv.time2 = "age_end_exposure2", 
            surv.event = "dementia_now2", 
            no2.var = "pm25_10yr",
            pm25.var = "no2_10yr",
             
            no2.units = 1, # really this is for PM2.5
            pm25.units = 10 # this is for NO2
            ) 

dem_10yr_act_pm25 <- dem_10yr_act_pm25$hrs %>%
  mutate(Model = "2",
         Exposure = substr(as.character(Exposure), 2, nchar(as.character(Exposure))),
         Description = "Onset Age")

```

Table & plot of all HRs

```{r}
dem_all_hrs_pm25 <- rbind(
  #reduced, primary & extended models, using 10 yr exposure
  dem_hrs_pm25,
  #M2 using age at ACT onset diagnosis (cases) or last visit (noncases)  
  dem_10yr_act_pm25
  ) %>%
  mutate(
    model_description = paste0(Model, ". ", Description),
    hr_ci = paste0(hr, " (", lower_limit, ", ", upper_limit, ")"),
    Exposure = recode_factor(Exposure,
                              "1yr" = "1 yr",
                              "5yr" = "5 yr",
                              "10yr" = "10 yr",
                              "20yr" = "20 yr",
                              "10yr10yrlag" = "10 yr 10 yr lag",
                              "10yr05yrlag" = "10 yr 5 yr lag"
                              ),
    Description = factor(Description, levels = Description)
    )  

```

```{r, fig.height=8}

# table
dem_all_hrs_pm25 %>%
  select(
    Model, Description, Exposure,
    hr_ci,
    n, number_events
    ) %>%
  rename(
    "HR (95% CI)" = hr_ci,
    "N" = n,
    "No. events" = number_events,
    ) %>%
  kable(caption = "Dementia hazard ratios for a 1 ug/m3 increase in PM2.5 exposure") %>%
  kable_styling()

#plot HRs
dem_all_hrs_pm25 %>% hr.plot(., outcome_var = "dementia", title_pollutant = "PM2.5 (ug/m3)")

```










# Alt models possibly explaining negative HRs
Is there an interaction between AP and...
- older age?     
- gender?   
- white race?      

```{r}

```



# Cox model assumptions and inference validity    
1. Proportional hazards Assumption    
a) Schoenfeld residuals. If the proportional hazards model is correctly specified, there should be no trend in the residuals over time (uncorrelated, with mean zero across event times)

```{r, eval=F}
m2 <- dem_10yr$raw_model_output$m2

```

```{r, eval=F}
## ?? interpretation of schenresid matrix?
schoenresid = residuals(m2, type = "scaledsch")

time = as.numeric(rownames(schoenresid))

# link no2_10yr & "times" column
cbind(resid=schoenresid[,1], time) %>%
  as.data.frame() %>%
  ggplot(aes(x=time, y=resid)) + 
  geom_point() + 
  geom_smooth() + 
  labs(y = "scaled Schoenfeld residuals for NO2 coefficient",
       x = "failure time (age at dementia incidence)")

```

b. formally test. using cox.zph(). if global p-val is significant, assumption is violated   
-assumption is not violated 

```{r, eval=F}
cox.zph(m2)

```

2. linear relationship between continuous covariates and log hazard of the outcome    
If a correct model is used, these residuals are uncorrelated and have mean nearly zero.


Martingale residuals are used to check if the functional form of the covariate is okay (eg. linear vs quadratic terms). 

```{r, eval=F}
##??
martingalesid = residuals(m2, type = "martingale", data = dem.w) %>%
  as.data.frame() %>%
  #df rows used in M2
  rownames_to_column(.) 
names(martingalesid)[names(martingalesid) %in% "."] <- "martingaleresid" 
  
#only keep rows used in M2. 
dem.w.m2 <- dem.w[martingalesid$rowname,] 

plot.martingaleresid <- cbind(resid=martingalesid$martingaleresid, no2_10yr=dem.w.m2$no2_10yr) %>%
  as.data.frame() 

plot.martingaleresid %>%
  ggplot(aes(x=no2_10yr, y=resid)) +
  geom_point(alpha=0.3) +
  geom_smooth() +
  labs(y = "Martingale residuals",
       x = "NO2 (ppb), 10 yr avg"
      )

#mean, +-SD  # looks good, mean is close to 0?
print("mean, SD")
mean(plot.martingaleresid$resid)
sd(plot.martingaleresid$resid)

```

3. no outliers or influential observations, $\triangle \beta$
 
```{r, fig.height=8, eval=F}
# B537 L3, slide 125

dfbetas <- residuals(m2, type="dfbeta") 
#rename columns
colnames(dfbetas) <- names(coef(m2))

dfbetas %>%  
  as.data.frame() %>%
  #get rows used in model
  rownames_to_column(var = "ind") %>%
  mutate(ind = as.numeric(ind)) %>%
  #make long format
  gather(covariate, value, -ind) %>%
  as.data.frame() %>%
  #plot
  ggplot(aes(x=ind, y=value)) +
  geom_point() +
  facet_wrap(~covariate, scales="free") + 
  labs(x="observation index",
       y= "delta beta")


```
