---
title: "Geocovariate Preprocessing"
author: "Magali Blanco"
date: ' `r Sys.Date()` '
output:
  html_document:
    number_sections: yes
    df_print: paged
    toc: yes
    toc_depth: '3'
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
editor_options:
  chunk_output_type: console
params: 
  output_dir: "Output"
---

```{r}
# # --> TO DO:
#  NEED UPDATED ACT dataset w/ pop10, pop90 & less missingness from Amanda

```

# Summary of script 

* uploaded geocovariates for MM, ACT and area grid 
* dropped columns w/ any NAs
* [temporary?] made sure all datasets had same covariates
* used ST model’s covariate.preprocess() function to clean up geocovariates for MM stops & ACT locations:
	+ common.value: excluded variables which have less than 20% of being different from the most common value in monitoring data
	  - eliminates variables with little variability that are not likely to improve (or even worsen) the model fit   
	+ low.landuse:  excluded varlabies with maximum land use variables less than 10 in monitoring data
	  - this land use is a small fraction and likely to not have a significant impact relative to everything else in within a buffer    
	+ sd.ratio: excluded variables with SD of cohort data greater than 5 times of SD of monitoring data
	  -	drops variables whose distribution is very different in the ACT cohort than the monitoring region in an effort to reduce model extrapolation later on   
	+ outlier: excluded variables with outliers more than 2% in monitoring and cohort data combined
	  -	variables may worsen model fit   
	+ log transformed proximities variables, made min distance 10 m
	  -	TRAP tends to exponentially decays with increasing distance from the source    
    -	Setting the minimum distance to 10 m is to protect against any possible ACT location geocoding issue since we do not believe that participant locations were closer than 10 m to proximity covariates (e.g., the middle of a roadway)    
	+ other 
	  - dropped RLU
	  - created some new proximity variables (e.g. distance to a123)
* dropped variables in MM and ACT dataset that I won’t use
	+ e.g., satelite/emission estimates
* cleaned up grid covariates using individual functions used within the covariate.preprocess() function. Didn’t use the covariate.preprocess() function b/c this drops covariates if e.g., they are too variable between datasets. This can result in a different set of covariates than those for MM stops & ACT locations.

* mapped monitoring, study and spatiotemporal modeling areas 
  + monitoring area
    - compsoed of Census tracts
    - filled in monitoring holes/gaps by including census tracts if monitoring occurred on a minimum of ~ 2 sides of that tract 

# Key findings

* most of the cohort is in Seattle, so the monitoring region captures a large fraction of the cohort. 
* study region captures only a few more individuals
* ST area is much larger and captures most of the cohort

# Analyses 

### --> update act_area if IDs change later 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = F, 
                      cache=T, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE,
                      fig.height = 8, fig.width = 8
                      )  

options(knitr.kable.NA = '')

pacman::p_load(kable, kableExtra,
               tidyverse
               )  

set.seed(1)

source("0.Global_Fns.R")
source("A2.0.1_Var&Fns.R")
source("A2.0.3_functions_covariate_preprocessing_regional.R")

cov_mm0 <- read.csv(file.path("Data", "Aim 2", "Geocovariates", "time-varying", "dr0311_mobile_covars.csv")) %>%
  # fix labeling & duplicate issue w/ cohort pop covariates
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), ~ gsub(".x", "", .))

cov_act0 <- read.csv(file.path("Data", "Aim 2", "Geocovariates", "time-varying", "dr0311_cohort_covars.csv")) 
# grid
grid_covars0 <- read.csv(file.path("Data", "Aim 2", "Geocovariates", "time-varying", "dr0311_grid_covars.csv" ))  


```

### --> update act_area if IDs later change or when get new grid

```{r}
# # save location table to ID their location within/outside study area in GIS
# cov_act0 %>%
#   select(location_id:longitude) %>%
#   write.csv(file.path("Data", "Aim 2", "Geocovariates", "time-varying", "smaller files for GIS", "dr0311_cohort_covars_lat_long.csv" ), row.names = F   )
# 
# grid_covars0 %>%
#   select(location_id:longitude) %>%
#   write.csv(file.path("Data", "Aim 2", "Geocovariates", "time-varying", "smaller files for GIS", "dr0311_grid_covars_lat_long.csv" ), row.names = F   )



act_area <- read.csv(file.path("..", "GIS", "Shapefiles", "ACT", "cohort_lat_long.csv")) %>%
  select(location_id = location_i,
         site_location = site_loc) %>%
  mutate(site_location = factor(site_location, levels = c("monitoring", "study", "st")))


```


```{r}
# time-varying covariates
# check that they all have same time-varying covariates
## pop
mm_pop_names <- sort(names(cov_mm0)[grepl("pop", names(cov_mm0))])
cohort_pop_names <- sort(names(cov_act0)[grepl("pop", names(cov_act0))])
grid_pop_names <- sort(names(grid_covars0)[grepl("pop", names(grid_covars0))])

# # looks good
# table(mm_pop_names == cohort_pop_names)
# table(cohort_pop_names == grid_pop_names)


### --> repeat for NDVI, emissions


```


# Geocovariate Processing 

prepare geocovaraites for covariate.preprocess() function.

```{r}
########################  mobile monitoring ######################## 
cov_mm1 <- cov_mm0 %>%
  #drop columns if any NAs
  select_if(~!any(is.na(.))) %>%
   #don't need this
  select(-contains("region")) %>%
  mutate(site_type = "FIXED")

#save mm location info
locations_mm <- cov_mm1 %>%
  select(site_id = native_id,
         latitude:lambert_y)

#only keep covariates
cov_mm1 <- cov_mm1 %>%
  ### --> check in future that this is correct
  select(-c(location_id:county))

mm_names <- names(cov_mm1)

```

```{r}
######################## cohort ########################
cov_act1 <- cov_act0 %>%
  #don't need these
  select(- contains("state"), -county,
         -contains("region")) %>%
  #drop columns w/ all NAs
  select_if(~!all(is.na(.))) %>%
  #drop rows w/ NAs
  drop_na() %>%
  mutate(site_type = "P") 

locations_act <- cov_act1 %>%
  # add site_location (monitoring vs within a monitoring buffer)
  left_join(act_area, by= "location_id") %>%
  #save act location info 
  select(site_id = location_id,
         latitude:lambert_y, 
         site_location)

cov_act1 <- cov_act1 %>%
  #only keep covariates
  ### --> check in future that this is correct
  select(-c(location_id:lambert_y))  

act_names <- names(cov_act1)

```

```{r}
################### grid ###################
grid_covars1 <- grid_covars0 %>%
  #don't need these
  select(- contains("state"), -county,
         -contains("region")) %>%
  #drop columns w/ all NAs
  select_if(~!all(is.na(.))) %>%
  #drop rows w/ NAs
  drop_na() %>%
  mutate(site_type = "P") %>% # [delete?]
  rename(site_id = location_id)

locations_grid <- grid_covars1 %>%
  select(site_id,
         latitude:lambert_y)

grid_covars1 <- grid_covars1 %>%
  #only keep covariates
  select(-c(native_id, latitude:lambert_y))  

grid_names <- names(grid_covars1)

```

```{r}
# # check that all 3 datasets have same no. covariates
# ## looks good
# ncol(cov_mm1) == ncol(cov_act1)
# ncol(cov_act1) == ncol(grid_covars1)
 


######################## Only keep columns if in mm & cohort datasets ######################## 
# # cohort dataset had fewer columns at one point

# # variables
# keep_var <- mm_names[mm_names %in% act_names]
# cov_mm1 <- cov_mm1[,keep_var]
# cov_act1 <- cov_act1[,keep_var]
# 
# # dim(cov_mm1)
# # dim(cov_act1)
# 
# grid_covars1 <- grid_covars1[, keep_var]

```

# Initial covariates 

Length: `r ncol(cov_act1)-1`


# Final covariates to be used in analysis

clean up geocovariates using covariate.preprocess() function (lab protocol/code) and additional cleaning 
* returns log-transformed proximity variables; drops old land use ("lu") variables; drops variables not available/ready for use in our study area

```{r}
######################## covariate.preprocess() ########################
cov_preprocessed <- covariate.preprocess(covars.mon = cov_mm1, 
                                         covars.sub = cov_act1, #cov_act_fake0,  #cov_act1,
                                         region = "NW")

######################## Drop additinoal variables I won't be using ########################
# * emissions data 

cov_mm <- cov_preprocessed$covars.mon %>%
  # drop AP predictions (these are based on other covariate models)
  select(-contains("log_em_"),  -contains("no2_")) 

final_cov <- names(cov_mm)

# add site info back in 
cov_mm <- cbind(locations_mm, cov_mm)


cov_act <- cov_preprocessed$covars.sub %>%
  select(-contains("log_em_"),  -contains("no2_")) 

cov_act <- cbind(locations_act, cov_act)

```

```{r}
################### grid ###################
# grid_preprocessed <- covariate.preprocess(covars.mon = cov_mm1, 
#                                          covars.sub = grid_covars1, 
#                                          region = "NW"
#                                          )
# 
# cov_grid <- grid_preprocessed$covars.sub 

# don't use covariate.preprocess() b/c some cov may be dropped that are not when mobile monitoring & ACT covariates are run. Use individual transformation fns instead.
cov_grid <- grid_covars1 %>%
  combine_a123_m() %>%
  combine_a23_m() %>%
  combine_a23_ll() %>%
  log_transform_distance() %>%
  # delete since otherwise it is repeated w/ locations_grid
  select(-site_id)

cov_grid <- cbind(locations_grid, cov_grid)

```

### --> add emissions description: "emissions (g)"
```{r}
cov_descrip <- data.frame(Covariate = final_cov) %>%
  mutate(Covariate= as.character(Covariate)) %>%
    split_cov_name(cov = "Covariate")%>%
  group_by(Covariate = cov) %>%
  dplyr::summarize("Buffers" = paste0(sort(unique(buffer)), collapse = ", ")) %>%
  mutate(Description = recode(Covariate,
                          elev_above = "number of points (out of 24) more than 20 m and 50 m uphill of a location for a 1000 m and 5000 m buffer, respectively",
                         elev_below = "number of points (out of 24) more than 20 m and 50 m downhill of a location for a 1000 m and 5000 m buffer, respectively",
                         elev_at_elev = "number of points (out of 24) within 20 m and 50 m of the location' elevation for a 1000 m and 5000 m buffer, respectively",
                         elev_stdev = "standard deviation of elevation of 20 points surrounding the location",
                         elev_elevation = "elevation above sea level in meters",
                         imp_a = "average imperviousness",
                         intersect_a1_a3_s = "number of a1-a3 road intersections",
                         intersect_a2_a2_s = "number of a2-a2 road intersections",
                         intersect_a2_a3_s = "number of a2-a3 road intersections",
                         intersect_a3_a3_s = "number of a3-a3 road intersections",
                         ll_a1_s = "length of a1 roads",
                         ll_a23_s = "length of a2 and a3 roads",
                         log_m_to_a1 = "log meters to closest a1 road",
                         log_m_to_a1_a1_intersect = "log meters to closest a1-a1 road intersection",
                         log_m_to_a1_a3_intersect = "log meters to closest a1-a3 road intersection",
                         log_m_to_a123 = "log meters to closest a1, a2 or a3 road",
                         log_m_to_a2_a2_intersect = "log meters to closest a2-a2 road intersection",
                         log_m_to_a2_a3_intersect= "log meters to closest a2-a3 road intersection",
                         log_m_to_a23 = "log meters to closest a2 or a3 road",
                         log_m_to_a3_a3_intersect = "log meters to closest a3-a3 road intersection",
                         log_m_to_airp = "log meters to closest airport",
                         log_m_to_coast = "log meters to closest coastline",
                         log_m_to_comm = "log meters to closest commercial and services area",
                         log_m_to_l_airp = "log meters to closest large airport",
                         log_m_to_l_port = "log meters to closest large port",
                         log_m_to_m_port = "log meters to closest medium port",
                         log_m_to_rr = "log meters to closest railroad",
                         log_m_to_ry = "log meters to closest rail yard",
                         log_m_to_truck = "log meters to closest truck route",
                         log_m_to_waterway = "log meters to closest waterway",
                         ndvi_q25_a = "NDVI (25th quantile)",
                         ndvi_q50_a = "NDVI (50th quantile)",
                         ndvi_q75_a = "NDVI (75th quantile)",
                         ndvi_summer_a = "average summer time NDVI",
                         ndvi_winter_a = "average winter time NDVI",
                         pop_s = "2000 population density",
                         pop10_s = "2010 population density",
                         pop90_s = "1990 population density",
                         rlu_barren_p = "proportion of barren land",
                         rlu_decid_forest_p = "proportion of deciduous forest",
                         rlu_dev_hi_p = "proportion of highly developed land (e.g., commercial and services; industrial; transportation, communication and utilities)",
                         rlu_dev_lo_p = "proportion of low developed land  (e.g., residential)",
                         rlu_dev_med_p = "proportion of medium developed land (e.g., residential)",
                         rlu_dev_open_p = "proportion of developed open land",
                         rlu_evergreen_p = "proportion of evergreen forest",
                         rlu_herb_wetland_p = "proportion of herb (nonforested) wetland",
                         rlu_mix_forest_p = "proportion of mixed forest",
                         rlu_water_p = "proportion of water",
                         rlu_woody_wetland_p = "proportion of woody wetland",
                         tl_s = "length of truck routes",
                         
                         ### --> add emissions description
                         emissions_s = "sum of emissions (g) on highways and major roads"
                         
                         ),
    Kind = ifelse(grepl("elev", Covariate), "elevation", 
                  ifelse(grepl("^imp", Covariate), "imperviousness",
                         ifelse(grepl("_a[1-3]", Covariate), "roads",
                                ifelse(grepl("airp", Covariate), "airports",
                                       ifelse(grepl("coast", Covariate), "coast",
                                              ifelse(grepl("comm", Covariate), "commercial and services",
                                                     ifelse(grepl("port", Covariate), "port",
                                                            ifelse(grepl("rr$|ry$", Covariate), "railroads, rail yards",
                                                                   ifelse(grepl("truck|tl_", Covariate), "truck routes",
                                                                          # --> ? rlu also has a water variable. keep as "land use"?
                                                                          ifelse(grepl("water", Covariate), "water",
                                                                                 ifelse(grepl("ndvi", Covariate), "NDVI",
                                                                                        ifelse(grepl("^pop", Covariate), "population",
                                                                                               ifelse(grepl("^rlu", Covariate), "land use",
                                                                                                      
                                                                                                      ### --> UPDATE emissions text
                                                                                                      ifelse(grepl("emissions", Covariate), "emissions", ""
                         ) ) ) ) ))))))))))
    ) %>%
  select(Kind, everything()) %>%
  arrange(Kind)

# table   
cov_descrip %>% kable(caption = paste0("Geocovariates and buffers to be used in analysis (n = ", length(final_cov), ")"), row.names = T
                      ) %>%
  kable_styling() %>%
  add_footnote("see MESA DOOP for additional details") #%>% save_kable(file.path("A2_Images", "test.png"))

# # save table
#   # includes 1990, 2000 population densities
# write_excel_csv(cov_descrip, file.path(tables_path, "cov_descrip.csv"), na = "")
 
```

## ACT Cohort Sample size

Map of spatiotemporal, study and monitoring area.

```{r}
monitoring_ids <- na.omit(cov_act[cov_act$site_location=="monitoring", "site_id"]) %>% as.vector()
study_ids <- append(monitoring_ids, 
                    na.omit(cov_act[cov_act$site_location=="study", "site_id"]) %>% as.vector())
st_ids <- append(study_ids, 
                    na.omit(cov_act[cov_act$site_location=="st", "site_id"]) %>% as.vector())

```

Map of ST, study and modeling area

```{r}
# ST area
cov_act %>% 
  filter(site_id %in% st_ids) %>%
  map_fn(color_map = F,
         color_by = "site_id", 
         map_title = "",
    include_monitoring_area = T, #monitoring_area_alpha = 1,
    include_study_area = T, #study_area_alpha = 0.4,
    include_st_area = T #st_area_alpha = 0.3
         )

```

Map of ST modeling area

```{r}
# ST area
cov_act %>% 
  filter(site_id %in% st_ids) %>%
  map_fn(color_map = F,
         color_by = "site_id", 
         map_title = "",
    include_monitoring_area = F, 
    include_study_area = F, 
    include_st_area = T #st_area_alpha = 0.3
         )

```


Map of study & monitoring area

```{r}
# study & monitoring area
cov_act %>% 
  filter(site_id %in% study_ids) %>%
  map_fn(color_map = F,
         color_by = "site_id", 
         map_title = "",
    include_monitoring_area = T, #monitoring_area_alpha = 1,
    include_study_area = T #study_area_alpha = 0.4,
    #include_st_area = T #st_area_alpha = 0.3
         )
  
  # map_base(include_monitoring_area = T, #monitoring_area_alpha = 1,
  #          include_study_area = T, #study_area_alpha = 0.4,
  #          include_spatiotemporal_area = T,
  #          map_title = "Monitoring and study areas"
  #          )


```

### --> error? % of locations in study area too small? 

```{r}

data.frame(
  Area = c("United States", 
           "Study Area",
           "Mobile Monitoring",
           "Spatiotemporal Modeling"
                ),
  N = c(nrow(cov_act),
        length(study_ids),
        length(monitoring_ids),
        length(st_ids)
        )) %>%
  mutate("Proportion of Total"  = N/nrow(cov_act)) %>%
kable(caption = "ACT cohort locations included in the monitoring, study and spatiotemporal modeling areas relative to all U.S. locations on record", 
      col.names = c("Area", "No. Locations", "Proportin of Total"),
      digits = 2) %>% 
  kable_styling()

```


```{r}
# # Save datasets

# saveRDS(cov_mm,file = file.path("Data", "Aim 2", "Geocovariates", "cov_mm_preprocessed.rda"))
# saveRDS(cov_act,file = file.path("Data", "Aim 2", "Geocovariates", "cov_act_preprocessed.rda"))
# saveRDS(cov_grid,file = file.path("Data", "Aim 2", "Geocovariates", "cov_grid_preprocessed.rda"))

```


 