---
title: "Geocovariate Preprocessing"
author: "Magali Blanco"
date: ' `r Sys.Date()` '
output:
  html_document:
    number_sections: yes
    df_print: paged
    toc: yes
    toc_depth: '3'
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
editor_options:
  chunk_output_type: console
params: 
  output_dir: "Output"
---

```{r}
# # --> TO DO:
# issue: lot of NAs in ACT dataset, only few columns w/o any NAs

```

# Notes





```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = F, 
                      cache=T, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE,
                      fig.height = 8, fig.width = 8
                      )  

options(knitr.kable.NA = '')

pacman::p_load(kable, kableExtra,
               tidyverse
               )  

set.seed(1)

source("0.Global_Fns.R")
source("A2.0.1_Var&Fns.R")
source("A2.0.3_functions_covariate_preprocessing_regional.R")

images_path <- file.path(images_path0, "0. Geocovariates")
tables_path <- file.path(tables_path0, "0. Geocovariates")

cov_mm0 <- read.csv(file.path("Data", "Aim 2", "Geocovariates", "dr0311_mobile_locations.txt")) 
cov_act0 <- read.csv(file.path("Data", "Aim 2", "Geocovariates", "cohort_covars_20200107.csv")) 
act_in_study0 <- read.csv(file.path("..", "GIS", "Shapefiles", "ACT", "ACT_selected", "cohort_in_monitoring_area_0.04deg_buffer.csv")) %>%
  select(location_id = location_i,
         site_location = site_type)  %>%
  # label locations within monitoring vs within a buffered area around the monitoring location
  mutate(site_location = relevel(factor(ifelse(site_location == "", "additional within buffer", as.character(site_location))), ref = "monitoring"))  


```

# Initial covariates 

```{r}
initial_cov <- cov_mm0 %>%
  select(-(location_id:msa)) %>%
  names()

```

Length: `r length(initial_cov)`


```{r}
# names
#initial_cov 

```

# Sample Size

## Mobile Monitoring 

```{r}

cov_mm0 %>%
  mutate(`Stop Kind` = ifelse(grepl("MS", native_id), "ACT stop", "AQS site")) %>%
  group_by(`Stop Kind`) %>%
    dplyr::summarize(N = n()) %>%
  kable(caption = "Mobile monitoring stops. ACT stops are those chosen to represent the ACT cohort, AQS site stops are AQS co-location sites within the monitoring area") %>%
  kable_styling()

```


## ACT Cohort 

```{r}
data.frame(
  Locations = c("Entire Cohort", 
                "In Study", 
                "In monitoring area", 
                "Within a buffer of the monitoring area"),
  N = c(nrow(cov_act0), 
        nrow(act_in_study0),
        length(act_in_study0$site_location[act_in_study0$site_location == "monitoring"]),
        length(act_in_study0$site_location[act_in_study0$site_location != "monitoring"])
        )
  ) %>%
kable(caption = "ACT cohort locations included in this study") %>% 
  add_indent(3:4) %>% 
  add_footnote("buffered area is a 0.04 degree (~ 5k meter) buffer around the monitoring area") %>%
  kable_styling()


```

Map of monitoring and study area.

```{r}
cov_mm0 %>%
  map_fn(color_map = F, 
         #need this for fn to work even though not using
         color_by = "region_nw",
         include_monitoring_area = T, #monitoring_area_alpha = 1,
         include_study_area = T, #study_area_alpha = 0.4,
         map_title = "Monitoring and study areas"
         )

```




# Geocovariate Processing 

prepare geocovaraites for covariate.preprocess() function.

```{r}
########################  mobile monitoring ######################## 
cov_mm1 <- cov_mm0 %>%
  #drop columns if any NAs
  select_if(~!any(is.na(.))) %>%
   #don't need this
  select(-contains("region")) %>%
  mutate(site_type = "FIXED")

#save mm location info
locations_mm <- cov_mm1 %>%
  select(site_id = native_id,
         latitude:lambert_y)

#only keep covariates
cov_mm1 <- cov_mm1 %>%
  select(-c(location_id:msa, latitude:lambert_y))

mm_names <- names(cov_mm1)

```


```{r}

######################## ACT ########################
#  fake ACT cohort geocovariate dataset so names are the same across datasets
# cov_act_fake0 <- cov_mm1 %>% slice(1:100)  

# actual data
cov_act1 <- cov_act0 %>%
  #only keep locations in our study area
  filter(location_id %in% act_in_study0$location_id) %>%
  #don't need these
  select(-c(X), - contains("state"), -county,
         -contains("region")) %>%
  #drop columns w/ all NAs
  select_if(~!all(is.na(.))) %>%
  #drop rows w/ NAs
  drop_na() %>%
  mutate(site_type = "P") 

locations_act <- cov_act1 %>%
  # add site_location (monitoring vs within a monitoring buffer)
  left_join(act_in_study0, by= "location_id") %>%
  #save act location info 
  select(site_id = location_id,
         latitude:lambert_y, 
         site_location)

cov_act1 <- cov_act1 %>%
  #only keep covariates
  select(-c(location_id:lambert_y))  

act_names <- names(cov_act1)

######################## Only keep columns if in both datasets ######################## 

 
# # act dataset has fewer columns
# length(mm_names)
# length(act_names)

# variables
keep_var <- mm_names[mm_names %in% act_names]
cov_mm1 <- cov_mm1[,keep_var]
cov_act1 <- cov_act1[,keep_var]

# dim(cov_mm1)
# dim(cov_act1)

```

clean up geocovariates using covariate.preprocess() function (lab protocol/code) and additional cleaning 
* returns log-transformed proximity variables; drops old land use ("lu") variables; drops variables not available/ready for use in our study area

```{r}
######################## covariate.preprocess() ########################
cov_preprocessed <- covariate.preprocess(covars.mon = cov_mm1, 
                                         covars.sub = cov_act1, #cov_act_fake0,  #cov_act1,
                                         region = "NW")

######################## Drop additinoal variables I won't be using ########################
# * emissions data 

cov_mm <- cov_preprocessed$covars.mon %>%
  # drop AP predictions (these are based on other covariate models)
  select(-contains("em_"),  -contains("no2_")) 

final_cov <- names(cov_mm)

# add site info back in 
cov_mm <- cbind(locations_mm, cov_mm)

#View(cov_mm)

cov_act <- cov_preprocessed$covars.sub %>%
  select(-contains("em_"),  -contains("no2_"))

cov_act <- cbind(locations_act, cov_act)

```

# Final covariates to be used in analysis

```{r}
cov_descrip <- data.frame(Covariate = final_cov) %>%
  mutate(Covariate= as.character(Covariate)) %>%
    split_cov_name(cov = "Covariate")%>%
  group_by(Covariate = cov) %>%
  dplyr::summarize("Available Buffer Sizes" = paste0(sort(unique(buffer)), collapse = ", ")) %>%
  mutate(Description = recode(Covariate,
                          elev_above = "number of points (out of 24) more than 20 m and 50 m uphill of a location for a 1000 m and 5000 m buffer, respectively",
                         elev_below = "number of points (out of 24) more than 20 m and 50 m downhill of a location for a 1000 m and 5000 m buffer, respectively",
                         elev_at_elev = "number of points (out of 24) within 20 m and 50 m of the location' elevation for a 1000 m and 5000 m buffer, respectively",
                         elev_stdev = "standard deviation of elevation of 20 points surrounding the location",
                         elev_elevation = "elevation above sea level in meters",
                         imp_a = "average imperviousness",
                         intersect_a1_a3_s = "number of a1-a3 road intersections",
                         intersect_a2_a2_s = "number of a2-a2 road intersections",
                         intersect_a2_a3_s = "number of a2-a3 road intersections",
                         intersect_a3_a3_s = "number of a3-a3 road intersections",
                         ll_a1_s = "length of a1 roads",
                         ll_a23_s = "length of a2 and a3 roads",
                         log_m_to_a1 = "log meters to closest a1 road",
                         log_m_to_a1_a1_intersect = "log meters to closest a1-a1 road intersection",
                         log_m_to_a1_a3_intersect = "log meters to closest a1-a3 road intersection",
                         log_m_to_a123 = "log meters to closest a1, a2 or a3 road",
                         log_m_to_a2_a2_intersect = "log meters to closest a2-a2 road intersection",
                         log_m_to_a2_a3_intersect= "log meters to closest a2-a3 road intersection",
                         log_m_to_a23 = "log meters to closest a2 or a3 road",
                         log_m_to_a3_a3_intersect = "log meters to closest a3-a3 road intersection",
                         log_m_to_airp = "log meters to closest airport",
                         log_m_to_coast = "log meters to closest coastline",
                         log_m_to_comm = "log meters to closest commercial and services area",
                         log_m_to_l_airp = "log meters to closest large airport",
                         log_m_to_l_port = "log meters to closest large port",
                         log_m_to_m_port = "log meters to closest medium port",
                         log_m_to_rr = "log meters to closest railroad",
                         log_m_to_ry = "log meters to closest rail yard",
                         log_m_to_truck = "log meters to closest truck route",
                         log_m_to_waterway = "log meters to closest waterway",
                         ndvi_q25_a = "NDVI (25th quantile)",
                         ndvi_q50_a = "NDVI (50th quantile)",
                         ndvi_q75_a = "NDVI (75th quantile)",
                         ndvi_summer_a = "average summer time NDVI",
                         ndvi_winter_a = "average winter time NDVI",
                         pop_s = "2000 population density",
                         pop10_s = "2010 population density",
                         pop90_s = "1990 population density",
                         rlu_barren_p = "proportion of barren land",
                         rlu_decid_forest_p = "proportion of deciduous forest",
                         rlu_dev_hi_p = "proportion of highly developed land (e.g., commercial and services; industrial; transportation, communication and utilities)",
                         rlu_dev_lo_p = "proportion of low developed land  (e.g., residential)",
                         rlu_dev_med_p = "proportion of medium developed land (e.g., residential)",
                         rlu_dev_open_p = "proportion of developed open land",
                         rlu_evergreen_p = "proportion of evergreen forest",
                         rlu_herb_wetland_p = "proportion of herb (nonforested) wetland",
                         rlu_mix_forest_p = "proportion of mixed forest",
                         rlu_water_p = "proportion of water",
                         rlu_woody_wetland_p = "proportion of woody wetland",
                         tl_s = "length of truck routes"
                         ),
    Kind = ifelse(grepl("elev", Covariate), "elevation", 
                  ifelse(grepl("^imp", Covariate), "imperviousness",
                         ifelse(grepl("_a[1-3]", Covariate), "roads",
                                ifelse(grepl("airp", Covariate), "airports",
                                       ifelse(grepl("coast", Covariate), "coast",
                                              ifelse(grepl("comm", Covariate), "commercial and services",
                                                     ifelse(grepl("port", Covariate), "port",
                                                            ifelse(grepl("rr$|ry$", Covariate), "railroads, rail yards",
                                                                   ifelse(grepl("truck|tl_", Covariate), "truck routes",
                                                                          # --> ? rlu also has a water variable. keep as "land use"?
                                                                          ifelse(grepl("water", Covariate), "water",
                                                                                 ifelse(grepl("ndvi", Covariate), "NDVI",
                                                                                        ifelse(grepl("^pop", Covariate), "population",
                                                                                               ifelse(grepl("^rlu", Covariate), "land use", ""
                         ) ) ) ) )))))))))
    ) %>%
  select(Kind, everything()) %>%
  arrange(Kind)

# table   
cov_descrip %>% kable(caption = paste0("Geocovariates and buffers to be used in analysis (n = ", length(final_cov), ")"), row.names = T) %>%
  kable_styling() %>%
  add_footnote("see MESA DOOP for additional details") #%>% save_kable(file.path("A2_Images", "test.png"))

# # save table
#   # includes 1990, 2000 population densities
# write_excel_csv(cov_descrip, file.path(tables_path, "cov_descrip.csv"), na = "")
 
```


# Sensitivity Analyses

Change TRAP indicator variable [? & UFP] transformations (log-transformed to navtive)

```{r}
cov_preprocessed_native <- covariate.preprocess(covars.mon = cov_mm1, 
                                         covars.sub = cov_act1, 
                                         region = "NW", 
                                         remove_nonlog_dist = FALSE) 

cov_mm_native <- cov_preprocessed_native$covars.mon %>%
  # drop AP predictions (these are based on other covariate models)
  select(-contains("em_"),  -contains("no2_"), 
         #only keep distances in native scale
         -contains("log_")) 

final_cov_native <- names(cov_mm_native)

# add site info back in 
cov_mm_native <- cbind(locations_mm, cov_mm_native)

cov_act_native <-cov_preprocessed$covars.sub %>%
  select(-contains("em_"),  -contains("no2_"), -contains("log_"))

cov_act_native <- cbind(locations_act, cov_act_native)

```

Save datasets

```{r}
#dim (cov_act)

# # proximity covariates in log scale
# saveRDS(cov_mm,file = file.path("Data", "Aim 2", "Geocovariates", "cov_mm_log_scale_preprocessed.rda"))
# saveRDS(cov_act,file = file.path("Data", "Aim 2", "Geocovariates", "cov_act_log_scale_preprocessed.rda"))
# 
# # proximity covariates in native scale
# saveRDS(cov_mm_native,file = file.path("Data", "Aim 2", "Geocovariates", "cov_mm_native_scale_preprocessed.rda"))
# saveRDS(cov_act_native,file = file.path("Data", "Aim 2", "Geocovariates", "cov_act_native_scale_preprocessed.rda"))

```


 