---
title: 'Aim 2: Site Medians'
author: "Magali Blanco"
date: "12/19/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
# ---> TO DO:
# estimate BC from 5 channel readings


```

```{r}
#notes
#BC = 880 nm (IR); 625 nm (Red); 528 nm (Green); 470 nm (Blue); and 375 nm (UV);  

```

```{r setup, include=FALSE}
# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
           detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

# load packages 
pacman::p_load(dplyr, tidyverse, chron, lubridate, knitr)   

# source global variables & functions
source("A2.0.1_Var&Fns.R")
source("ONA smoothing_5_channels.R")

#read in data
mm_full0 <- readRDS(file.path("Data", "Aim 2", "Mobile Monitoring", "all_data_2019-12-22.rda")) 

#unique(mm_full0$variable)

### --> why do these runs have missing variable/value? 2019-05-14_R03, 2019-07-17_R07	

#### --> update file later: there are 310 site_ids and in mm_full. There should be 309.           
# We stopped sampling MS0398 and switched to MS0601 which is fairly close

site_ids <- read.csv(file.path("Data", "Aim 2", "Mobile Monitoring", "locations_190715.csv")) %>%
  select(site_id) %>%
  #drop Roosevelt garage stop
  filter(site_id != "MS0000") %>%
  unique()

mm_full <- mm_full0 %>%
  # --> why do 2 runs have missing values??
  select(-duration_sec) %>%
  drop_na(value) %>%
  filter(!variable %in% c("ufp_disc_ct_cm3",
                         "ufp_disc_med_size_nm", 
                         "ufp_pt_screen_ct_cm3",
                         "ufp_scan_20_5_ct_cm3")) %>%
  #filter(!grepl("ufp_disc_med_size_nm|ufp_pt_screen_ct_cm3|ufp_scan_20_5_ct_cm3", variable)) %>%
  
  mutate(variable = recode_factor(factor(variable),  
                              "ufp_pt_noscreen_ct_cm3" = "ptrak_pt_cm3")) %>%
  #--> not sure why there are repeated identical rows for ufp_scan_11_5_ct_cm3
  unique()

#unique(mm_full$variable)

#drop old stops 
mm_full <- left_join(site_ids, mm_full)

#relabel instruments that were incorrectly labeled
mm_full <- mm_full %>%
  mutate(instrument_id = ifelse(instrument_id == "BC_0063", "BC_63",
                                #ifelse(instrument_id == "CO_2", "CO_3",
                                       ifelse(instrument_id == "PMSCAN_1", "PMSCAN_3",
                                              instrument_id))
         )

#Create NanoScan counts (20-421 nm) similar to ptraks: 20-1000 nm)
ns <- mm_full %>%
  #look at variables from NanoScan
  filter(grepl("scan", variable)) %>%
  #not sure why there are repeated identical rows for ufp_scan_11_5_ct_cm3
  unique() %>%
  #make wide format to calculate the difference
  spread(variable, value) %>%
  mutate(scan_20_421_pt_cm3 = ufp_scan_ct_cm3 - ufp_scan_11_5_ct_cm3 - ufp_scan_15_4_ct_cm3) %>%
  select(-c(ufp_scan_11_5_ct_cm3, ufp_scan_15_4_ct_cm3,
            ufp_scan_ct_cm3)) %>%
  #dplyr::rename(scan_10_421_pt_cm3 = ufp_scan_ct_cm3) #%>%
  #make back to long format
  gather("variable", "value", scan_20_421_pt_cm3)

# replace old nanoscan calculations w/ new ones similar to PTRAK
mm_full <- mm_full %>%
  filter(!grepl("scan", variable)) %>%
  rbind(ns) %>%
  arrange(time)  
  
#separate UFP and BC readings since doing different analyses on these

# UFP instruments
ufp <- mm_full %>%
  filter(grepl("ptrak|scan", variable))

# BC aethelometer
bc <- mm_full %>%
  filter(grepl("ma200", variable))

```

### -->	Combine 2 stops if they are “close”? We stopped sampling MS0398 and switched to MS0601 which is close

```{r, ?delete?}
# geo <- read.csv(file.path("Data", "Aim 2", "Geocovariates", "dr0311_mobile_locations.txt")) %>%
#   select("native_id", "latitude", "longitude", "m_to_a1", "m_to_a2", "ll_a1_s01500", "m_to_coast", "m_to_l_port", "m_to_comm", "m_to_airp", "m_to_rr", "m_to_truck", "elev_elevation", "pop10_s15000", "ndvi_q50_a07500")
# #write.csv(geo, file.path("Data", "Aim 2", "Geocovariates", "geo_few.csv"))
# 
# #"We stopped sampling MS0398 and switched to MS0601 which is close"
# #t <- geo %>% filter(native_id %in% c("MS0398", "MS0601"))

```


# Drop erroneous UFP instrument readings. 
-identify very low/high concentrations
-compare to PTRAK (20-1000 nm) to Nanoscan (20-421 nm) readings.
  
very low concentrations: Elena (MOVUP Study) excluded UPF < 100 b/c: a) had very few samples that were less than 100 (less then 1%), b) they did not correlate to low measures on other particle measurement instruments, c) these values also resulted in extreme values on some the ratio metrics.

very high concentrations: don't do anything to high concentrations (PTRAK max is 50k ufp/cm3 b/c associated with both very low and high NanoScan concentrations (it's unclear whether it is the nanoscan or the PTRAK that is innacurate).

```{r}
print("summary of 1 sec PTRAK distribution (all data):") 
ufp %>% filter(grepl("ptrak", variable)) %>%
  group_by(instrument_id) %>%
distribution.table(., var.string = "value")

ns <- ufp %>%
  filter(grepl("scan", variable)) %>%
  select(-variable) %>%
  dplyr::rename(scan_20_421_pt_cm3 = value) %>%
  select(-instrument_id) 
  
low.ptrak.conc <- 2000
very.low.ptrak.conc <- 100

#take avg when duplicate instruments on car # don't do b/c avgs bad readings so they end up looking OK
  # group_by(site_id, runname, route, aqs_id, aqs_location, site_long, site_lat, time) %>%
  # dplyr::summarize(scan_20_421_pt_cm3 = mean(scan_20_421_pt_cm3))
  
ptrak <- ufp %>%
  filter(grepl("ptrak", variable)) %>%
  select(-variable) %>%
  dplyr::rename(ptrak_pt_cm3 = value) # %>% select(-instrument_id)  

#plot showing when low Concs are seen & by what instruments. 
## PMPT_93 has issue on  3/22
## PMPT_94 has issue on  7/13.
ptrak %>%
  filter(ptrak_pt_cm3 < very.low.ptrak.conc) %>%
  #gather("variable", "value", ptrak_pt_cm3, scan_20_421_pt_cm3) %>%
  ggplot(aes(x=time, y = ptrak_pt_cm3)) +
  geom_point(aes(
    col=instrument_id
                 )) +
  facet_wrap(~runname, scales = "free") +
  labs(title = paste0("Time series plot to identify low PTRAK concentration times"),
  subtitle = paste0("only showing PTRAK conc <",
                      very.low.ptrak.conc,
                      " ufp/cm3)"))

ufp.w <- ptrak %>% select(-instrument_id) %>%
  left_join(ns)

####### very low concentrations  #######


# compare PTRAK to NS
ufp.w %>%
  filter(ptrak_pt_cm3 < low.ptrak.conc) %>%
  mutate(ptrak_low_conc = ptrak_pt_cm3 < very.low.ptrak.conc) %>%
  ggplot(aes(x=scan_20_421_pt_cm3, y = ptrak_pt_cm3)) + 
  geom_point(aes(col = ptrak_low_conc), alpha=0.4) +
  geom_abline(intercept = 0, slope = 1) + 
  geom_smooth(aes(group=ptrak_low_conc)) + 
  labs(title = paste0("Low PTRAK concentrations (< ", low.ptrak.conc, " ufp/cm3) relative to \ncomparable NanoScan (20-421 nm) concentrations"),
       col = paste0("PTRAK < ",very.low.ptrak.conc, " ufp/cm3" ))


# #plot to ID when low PTRAKs readings occurred
# ufp.w %>%
#   filter(ptrak_pt_cm3 < very.low.ptrak.conc) %>%
#   gather("variable", "value", ptrak_pt_cm3, scan_20_421_pt_cm3) %>%
#   ggplot(aes(x=time, y = value, col = variable)) + 
#   geom_point() + 
#   facet_wrap(~runname, scales = "free") + 
#   labs(title = paste0("Time series plot to identify low PTRAK concentration times"),
#   subtitle = paste0("only showing PTRAK conc <",
#                       very.low.ptrak.conc,
#                       " ufp/cm3)"))

date.with.issue1 <- "2019-03-22"
run.with.issue1 <- paste0(date.with.issue1, "_R07")
date.with.issue2 <- "2019-07-13"
run.with.issue2 <- paste0(date.with.issue2, "_R03")

#duplicate instruments used in some cases
run2019_03_22_R07.instruments <- unique(ufp[ufp$runname == run.with.issue1, "instrument_id"])
run2019_07_13_R03.instruments <- unique(ufp[ufp$runname == run.with.issue2, "instrument_id"])

ufp.w %>%
  filter(runname == run.with.issue1,
         time > paste0(date.with.issue1, " 17:13:30"),
         time < paste0(date.with.issue1, " 17:15")
         ) %>%
  gather("variable", "value", ptrak_pt_cm3, scan_20_421_pt_cm3) %>%
  ggplot(aes(x=time, y = value, col = variable)) + 
  geom_point(alpha=0.3, aes(shape=)) +
  labs(title = paste0("Time series of when very low PTRAK concentrations \n(< ", very.low.ptrak.conc, " ufp/cm3) were observed"),
       subtitle = paste0(run.with.issue1, ", instruments used: ", paste0(run2019_03_22_R07.instruments, collapse = ", ")))

ufp.w %>%
  filter(runname == run.with.issue2,
         time > paste0(date.with.issue2, " 05:38:30"),
         time < paste0(date.with.issue2, " 05:41:40")
         ) %>%
  gather("variable", "value", ptrak_pt_cm3, scan_20_421_pt_cm3) %>%
  ggplot(aes(x=time, y = value, col = variable)) + 
  geom_point(alpha=0.3, aes(shape=site_id)) + 
  labs(title = paste0("Time series of when very low PTRAK concentrations \n(< ", very.low.ptrak.conc, " ufp/cm3) were observed"),
       subtitle = paste0(run.with.issue2, ", instruments used: ", paste0(run2019_07_13_R03.instruments, collapse = ", ")))

####### very high concentrations  #######

myquantile <- 0.99
high.ptrak.conc <- quantile(ufp.w$ptrak_pt_cm3, 0.8)
very.high.ptrak.conc <- quantile(ufp.w$ptrak_pt_cm3, myquantile)

ptrak.max.limit <- max(ufp.w$ptrak_pt_cm3)

ufp.w %>%
  filter(ptrak_pt_cm3 > very.high.ptrak.conc) %>%
  ggplot(aes(x=ptrak_pt_cm3)) + 
  geom_histogram() + 
  labs(title = paste0("distribution of PTRAK concentrations >", 
                      myquantile,
                      " quantile (",
                      very.high.ptrak.conc," ufp/cm3)"))

#ptrak vs NS
# #unclear what instrument is faulty when looking at very high concentrations
ufp.w %>%
  filter(ptrak_pt_cm3 > high.ptrak.conc) %>%
  mutate(ptrak_high_conc = ptrak_pt_cm3 > very.high.ptrak.conc) %>%
  ggplot(aes(x=scan_20_421_pt_cm3, y = ptrak_pt_cm3)) + 
  geom_point(aes(col = (ptrak_pt_cm3 == ptrak.max.limit)), alpha=0.4) +
  geom_abline(intercept = 0, slope = 1) + 
  labs(title = paste0("High PTRAK concentrations (> ", myquantile, " quantile, ", very.high.ptrak.conc, " ufp/cm3) relative to \ncomparable NanoScan (20-421 nm) concentrations"),
       col = paste0("PTRAK = max limit \n(", ptrak.max.limit, " ufp/cm3)" ))

```

Drop bad UFP readings from low alcohol wick issues.

```{r}
#PMPT_93
bad.times1 <- seq(ymd_hms(paste0(date.with.issue1, " 17:13:30")),
                  ymd_hms(paste0(date.with.issue1, " 17:15:00")),
                  by = 1)  
tz(bad.times1) <- "PST8PDT" #  Sys.timezone()

#PMPT_94
bad.times2 <- seq(ymd_hms(paste0(date.with.issue2, " 05:38:30")),
                  ymd_hms(paste0(date.with.issue2, " 05:41:40")),
                  by = 1)  
tz(bad.times2) <- "PST8PDT"

ufp <- ufp %>%
  filter(!(time %in% bad.times1 & instrument_id == "PMPT_93"),
         !(time %in% bad.times2 & instrument_id == "PMPT_94")
         ) 
  # check that it looks good
  # %>% filter(time %in% c(bad.times1, bad.times2))

```

Final 1-second PTRAK readings. They are log normal.

```{r}
ufp %>%
  filter(grepl("ptrak", variable)) %>%
  ggplot(aes(x=value)) + 
  geom_histogram() + 
  labs(title = paste0("ptrak", " concentrations after dropping erroneous readings \ndue to alcohol wick isues"),
       subtitle = "on log x scale",
       x = "Concentration (pt/cm3)"
       ) + 
  scale_x_log10()

 
num.ptrak.seconds.dropped <- length(bad.times1) + length(bad.times2)

print(paste0("number of PTRAK seconds dropped: ", num.ptrak.seconds.dropped))

print("summary of 1 sec PTRAK distribution after dropping poor instrument readings:") 
ufp %>% filter(grepl("ptrak", variable)) %>%
  group_by(instrument_id) %>%
distribution.table(., var.string = "value")
 
```
 
# Correct BC readings using the ONA correction

```{r}
bc.w <- bc %>%
  spread(variable, value) %>% 
  ONA()

# compare.aeth <- bc.w %>%
#   select(contains("bc1"),
#          contains("ona")) %>%
#   gather("ma200_channel", "ma200_conc", ma200_blue_bc1:ma200_uv_bc1) %>%
#   gather("ona_channel", "ona_conc", ona_uv:ona_ir)

#BC/IR
bc.w %>%
  ggplot(aes(x= ma200_ir_bc1, y = ona_ir)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  geom_smooth() + 
  labs(title = "IR (~black carbon) concentrations before and after ONA correction")

#UV
bc.w %>%
  ggplot(aes(x= ma200_uv_bc1, y = ona_uv)) + 
  geom_point() + 
  geom_abline(intercept = 0, slope = 1) + 
  geom_smooth() + 
  labs(title = "UV concentrations before and after ONA correction")

bc <- bc.w %>%
  #only keep ONA-corrected values
  select(site_id:instrument_id, contains("ona")) %>%
  gather("variable", "value", contains("ona"))
  
```

Estimate BC from wavelength ratios.

### --> see Favez 2010 for ratios ?

```{r}


  
  
```

Combine clean datasets. 

```{r}
mm_full <- rbind(ufp, bc) %>%
  arrange(time) %>%
  dplyr::group_by(runname, site_id) %>%   
  #set time to arrival time 
  dplyr::mutate(arrival_time = min(time)) %>%
  mutate(date = as.Date(substr(arrival_time, 1,10))) %>%
  ungroup()

```

# QAQC

Instruments Used

```{r}
#instrument used each day
mm_full %>%
  #select(date, instrument_id, variable) %>%
  #grepl("ptrak|scan", variable) %>%
  filter(variable %in% c("ptrak_pt_cm3", "scan_20_421_pt_cm3")) %>%
  unique() %>%
  ggplot(aes(x=date, y=instrument_id, colour = instrument_id)) + 
  geom_point(alpha=0.5) + 
  theme(legend.position = "none") + 
  labs(title = "Instruments used") 
 
```

Compare collocated PTRAK readings 

```{r}
# don't need to compare: PMPT 4 - has never been used on its own. PMPT1 - has never been collocated (only used at begining of study)

mm_full %>%
    filter(instrument_id %in% c("PMPT_93", "PMPT_4")) %>%
  spread(instrument_id, value) %>%
  drop_na("PMPT_93", "PMPT_4") %>%
  colo.plot(data.wide = ., 
                      x.variable = "PMPT_93", x.label = "PTRAK ID 93",
                      y.variable = "PMPT_4",  y.label = "PTRAK ID 94",
                      mytitle = paste0("Comparison of collocated PTRAK instrument readings\n1-sec data"),

                      r2.digits = 2)

```

[? delete] Compare NanoScan instruments.

```{r} 
ns_trim <- 0.01

mm_full %>%  
    #select only values from desired instruments
    filter(instrument_id %in% c("PMSCAN_5", "PMSCAN_3"),
           value > quantile(value, ns_trim),
           value < quantile(value, (1-ns_trim))
           ) %>%
    spread(instrument_id, value) %>%
  colo.plot(x.variable = "PMSCAN_5", x.label = "NanoScan ID 5",
          y.variable = "PMSCAN_3", y.label = "NanoScan ID 3",
          mytitle = paste0("Comparison of collocated NanoScan instrument readings" , 
                                        "\ndropped top and bottom ", (ns_trim)*100, "% of data"),
          )

```

Compare NanoScan (20-421 nm +) to ptrak (20- 1000 nm) since NanoScan tends to be more steady. Assuming few particles > 421 nm, such that the NanoScan and PTRAK are comparable.

Dropping very low nanoscan readings and those above 500k pt/cm3 (PTRAK instrument threshold)

```{r}
# use wide (takes avg of identical collocatd instruments) since not comparing specific instrument IDs, but instrument Type   
 
mm_full %>%
filter(instrument_id %in% c("PMSCAN_5", "PMPT_94"),
       #some Nanoscan readings are < 100
       value > 100,
       #drop PTRAK values @ threshold
       value < 500000
       ) %>%
  select(-instrument_id) %>%
  spread(variable, value) %>%
  drop_na(ptrak_pt_cm3, scan_20_421_pt_cm3) %>%
  colo.plot(x.variable = "scan_20_421_pt_cm3", x.label = "NanoScan 5 (pt/cm3; 20-421 nm)",
                      y.variable = "ptrak_pt_cm3", y.label = "PTRAK 94 (pt/cm3; 20-1000 nm)",
                      mytitle = paste0("Comparison of collocated PTRAK and NanoScan instruments" , 
                                        "\ndropped NanoScan readings <100 and > 500k pt/cm3"),
                      r2.digits = 2)

```

### --> ? apply a between method calibration (MOVUP report "Quality Control")

```{r}

```


# Calculate Stop medians and means    

Distribution of 1-second PTRAK readings is log-normal, overall and by site.

```{r}

mm_full %>%
  filter(grepl("ptrak", variable)) %>%  
  #filter(variable %in% c("ptrak_ct_cm3")) %>%
  ggplot(aes(x=value)) +
  geom_density(alpha=0.1) + 
  labs(title = "1-second PTRAK readings",
       subtitle = "on log x scale",
       x = "Concentration (pt/cm3)"
       ) +
    scale_x_log10() +
  theme(legend.position = "none")

mm_full %>%
  filter(grepl("ptrak", variable)) %>%  
  ggplot(aes(y=value, x=site_id, group=site_id)) +
  geom_boxplot(alpha=0.05) + 
  scale_y_log10() + 
  labs(title = "1-second PTRAK readings",
       y = "Concentration (pt/cm3)",
       x = "site"
       ) 

```

Since PTRAK instruments respond similar, take the average 1-sec reading when duplicate instruments are on platform before calculating stop means or medians.

```{r}
 
mm <- mm_full %>%
  select(-time, instrument_id) %>%
  #drop tape position
  filter(!grepl("tape_posit", variable)) %>%
  dplyr::group_by(date, runname, route, site_id, aqs_id, aqs_location, site_long, site_lat, arrival_time, variable) %>% 
  dplyr::summarize(median_value = median(value, na.rm = T),
            mean_value = mean(value, na.rm = T)) %>%
  ungroup() %>%
  arrange(arrival_time) %>%
  #add temporal variables
  add.temporal.variables(data = ., date.var = "arrival_time")

# #give each site unique number ID, based on time when stop was first sampled
site_no <- mm %>%
  select(site_id) %>% unique() %>%
  dplyr::mutate(site_no = seq(1:length(site_id)))

# #number of times each site has been visited
# site_visit_no <- mm %>%
#   select(site_id, runname) %>%
#   group_by(site_id) %>%
#   #only 1 observation row
#   unique() %>%
#   dplyr::mutate(site_visit_no = seq(1:n()))

mm <- left_join(mm, site_no) 
  #left_join(site_visit_no) %>%
 

```

Make wide format.

```{r}
mm.w.median <- mm %>%
  select(-mean_value) %>%
  spread(variable, median_value) %>%  #
  rename_at(vars(contains("ptrak"), contains("ma200"), contains("scan")), ~(paste0(., "_median"))) 

mm.w.mean <- mm %>%
  select(-median_value) %>%
  spread(variable, mean_value) %>%  #
  rename_at(vars(contains("ptrak"), contains("ma200"), contains("scan")), ~(paste0(., "_mean"))) 

mm.w <- left_join(mm.w.median, mm.w.mean)
 
```

Will focus on medians vs means b/c:
* more robust to outliers during short-two minute stops
* data are right skewed 

```{r}
## Mean is only ~3% higher? 
print("Average mean/median ratio")
mean(mm$mean_value[mm$variable=="ptrak_pt_cm3"])/mean(mm$median_value[mm$variable=="ptrak_pt_cm3"])

#compare mean vs median. if no different, use one 
mm %>%
  filter(variable == "ptrak_pt_cm3") %>%
  gather("method", "value", median_value, mean_value) %>%
  mutate(method = ifelse(method == "median_value", "median", "mean")) %>%
  ggplot(aes(x=value, fill=method)) + 
  geom_density(alpha=0.3) + 
  scale_x_log10() + 
  labs(
    title = "Mean vs median stop readings from 1-sec data",
    subtitle = "log x scale",
    x = "Concentration (pt/cm3)"
    )

#colocation plot
mm %>%
  filter(grepl("ptrak", variable)) %>%
colo.plot(
  x.variable = "median_value", x.label = "median value",
  y.variable = "mean_value", y.label = "mean value",
  #col.by = "season", 
  mytitle = "Comparing diferent central tendency metrics\nfor stop concentrations"
  )

mm %>%
  filter(variable == "ptrak_pt_cm3") %>%
  dplyr::rename(mean = mean_value,
         median = median_value
         ) %>%
  gather("method", "value", median, mean) %>%
  group_by(method) %>%
  distribution.table(var.string = "value") %>%
  kable(caption = "Distribution of stop means and medians. N = number of stop visits (308 sites x ~30 stop visits/site)")

```

Empiric fractions of overall mean and median relative to 1-sec data. Computing the percentile of the ovarll mean and median UFP concentration value relative to all values

### --> ?do by site & show the distribution of these percentiles?

```{r}
#overall
## Empiric fraction:
ufp.values <- mm_full$value[mm_full$variable == "ptrak_pt_cm3"]

### mean
print("empiric fraction of overall mean")
round(sum(ufp.values < mean(ufp.values)) / length(ufp.values), 2)
### median
print("empiric fraction of overall median")
round(sum(ufp.values < median(ufp.values)) / length(ufp.values), 2)

## Parametric fraction:
### median
### log transform values since right skewed
# round(pnorm((median(log(ufp.values)) - mean(log(ufp.values)))/sd(log(ufp.values))), 2)

```

Save datasets for quicker access later. 

````{r}
# saveRDS(mm, file.path("Data", "Aim 2", "Mobile Monitoring", "mm_2019-12-22.rda"))
# saveRDS(mm.w, file.path("Data", "Aim 2", "Mobile Monitoring", "mm.w_2019-12-22.rda"))
# saveRDS(mm_full, file.path("Data", "Aim 2", "Mobile Monitoring", "mm_full_2019-12-22.rda"))

```
