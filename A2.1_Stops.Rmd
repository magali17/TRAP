---
title: 'Aim 2: Site Medians'
author: "Magali Blanco"
date: "12/19/2019"
output: html_document
---

```{r setup, include=FALSE}

# to do
# 1. drop very low UFP readings
# 2. ONA BC correction

##########################################################################################
#script to: 
##1) summarize high temporal resolution mobile monitoring data into stop MEDIANS (reduce file size)
##2) clean up geocovariates. drop: a) AP predictions, which are based on other covariates & other models, b) variables w/ too little or too much variation 
##3) clean up overnight data from AQS sites, calculate median hourly concentrations
##########################################################################################
# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
           detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

# load packages 
pacman::p_load(dplyr, tidyverse, chron, lubridate, knitr)   

# source global variables & functions
source("A2.0.1_Var&Fns.R")
set.seed(1)
##########################################################################################
############################# 1. mobile monitoring #######################################
##########################################################################################

#mobile monitoring 
mm_full0 <- readRDS(file.path("Data", "Aim 2", "Mobile Monitoring", "all_data_191218.rda"))  

### --> error 
mm_full <- mm_full0 %>%
  select(-duration_sec) %>%
  #drop gps readings
  filter(!str_detect(variable, "gps")) %>%
  
# mm_full <- readRDS(file.path("Data", "Aim 2", "Mobile Monitoring", "all_data_191218.rda")) %>%
#   #drop unwanted variable values to reduce data size
#   filter(variable %in% c("bc_ir880nm_ng_m3", 
#                          "ufp_pt_noscreen_ct_cm3", 
#                     "ufp_scan_11_5_ct_cm3", "ufp_scan_15_4_ct_cm3", "ufp_scan_ct_cm3")
#     )  %>%
  mutate(
    variable = recode_factor(factor(variable), 
                              #"bc_ir880nm_ng_m3" = "bc_880_ng_m3",
                              "ufp_pt_noscreen_ct_cm3" = "ptrak_ct_cm3"
                             )
    )

#read in current locations
site_ids <- read.csv(file.path("Data", "Aim 2", "Mobile Monitoring", "locations_190715.csv")) %>%
  select(site_id) %>%
  #drop Roosevelt garage stop
  filter(site_id != "MS0000") %>%
  unique()

#### --> update file later: there are 310 site_ids and in mm_full. There should be 309.           
# We stopped sampling MS0398 and switched to MS0601 which is fairly close




############################ clean up ###################################################
#drop old stops 
mm_full <- left_join(site_ids, mm_full)

#give each site unique number ID, based on time when stop was first sampled
site_no <- mm_full %>%
  arrange(route, time) %>%
  select(site_id) %>% unique() %>%
  mutate(site_no = seq(1:length(site_id)))

#number of times each site has been visited
site_visit_no <- mm_full %>%
  select(site_id, runname) %>%
  group_by(site_id) %>%
  #only 1 observation row
  unique() %>%
  mutate(site_visit_no = seq(1:n()))

mm_full <- mm_full %>% left_join(site_no) %>%
  left_join(site_visit_no)

#relabel instruments that were incorrectly labeled
mm_full <- mm_full %>%
  mutate(instrument_id = ifelse(instrument_id == "BC_0063", "BC_63",
                                #ifelse(instrument_id == "CO_2", "CO_3",
                                       ifelse(instrument_id == "PMSCAN_1", "PMSCAN_3",
                                              instrument_id)) 
  )

############################ drop low UFP values ###################################################

## --> check to see if need to drop UFP readings
# Elena excluded UPF < 100 b/c: a) had very few samples that were less than 100 (less then 1%), b) they did not correlate to low measures on other particle measurement instruments, c) these values also resulted in extreme values on some the ratio metrics I used  











############################ BC ONA correction ###################################################
### --> ONA BC correction? 







 
#take avg of each stop to REDUCE FILE SIZE
mm <- mm_full %>%
  group_by(runname, site_id) %>%  #, instrument_id, variable
  #set time to arrival time, in case a stop elapsed e.g., 2 diff hours
  mutate(arrival_time = min(time)) %>%
  select(-time) %>%
  # ?drop faulty ptrak & BC readings (?? < 100)
  
  
  
#take median of each unique site stop for each instrument
  ## don't include duration_sec b/c for some reason, some stops have 2 (or more?) entries @ same time, but diff durations (? GPS error??) and this creates multiple rows per sample
  group_by(runname, route, site_id, aqs_id, aqs_location, site_long, site_lat, arrival_time, instrument_id, variable, site_no, site_visit_no) %>%
  summarize(median_value = median(value, na.rm = T),
            mean_value = mean(value, na.rm = T)) %>%
  ungroup()


# #give each driving day a unique ID
# run_no <- mm %>%
#   arrange(runname) %>%
#   select(runname) %>%
#   unique() %>%
#   mutate(run_no = seq(1:length(runname)))
# 
# mm <- mm %>% left_join(run_no)
# 
# #number of times each site has been visited
# site_visit_no <- mm %>%
#   group_by(site_id) %>%
#   select(site_id, runname) %>%
#   unique() %>%
#   #group_by(site_id) %>%
#   mutate(site_visit_no = seq(1:n()))
# 
# mm <- mm %>% left_join(site_id_visit_no)

#ID if stops are AQS sites
mm <- mm %>%
  mutate(aqs_site = ifelse(is.na(aqs_id), 0, 1))

#add temporal variables
mm <- mm %>% 
  mutate(
   date = as.Date(substr(arrival_time, 1,10))) %>%
  add.temporal.variables(data = ., date.var = "arrival_time")

 
#create NanoScan counts (20-420 nm) (~similar to ptraks: 20-1000 nm)
ns_mean_values <- mm %>% 
  #look at variables from NanoScan
  filter(grepl("scan", variable)) %>%
  # drop median_value for now since spread fn is more complex if both mean_value and median_value
  select(-median_value) %>%
  #make wide format to calculate the difference
  spread(variable, mean_value) %>%
  mutate(ufp_scan_20_421_nm_ct_cm3 = ufp_scan_ct_cm3 - ufp_scan_11_5_ct_cm3 - ufp_scan_15_4_ct_cm3) %>% 
  rename(ufp_scan_10_421_nm_ct_cm3 = ufp_scan_ct_cm3) %>%
  select( - ufp_scan_11_5_ct_cm3, 
          -ufp_scan_15_4_ct_cm3) %>%
  #make back to long forma
  gather("variable", "mean_value", ufp_scan_10_421_nm_ct_cm3:ufp_scan_20_421_nm_ct_cm3)

# same as above but with medians
ns_median_values <- mm %>% 
  filter(grepl("scan", variable)) %>%
  select(-mean_value) %>%
  spread(variable, median_value) %>%
  mutate(ufp_scan_20_421_nm_ct_cm3 = ufp_scan_ct_cm3 - ufp_scan_11_5_ct_cm3 - ufp_scan_15_4_ct_cm3) %>% 
  rename(ufp_scan_10_421_nm_ct_cm3 = ufp_scan_ct_cm3) %>%
  select( - ufp_scan_11_5_ct_cm3, 
          -ufp_scan_15_4_ct_cm3) %>%
  gather("variable", "median_value", ufp_scan_10_421_nm_ct_cm3:ufp_scan_20_421_nm_ct_cm3)

ns_values <- left_join(ns_mean_values, ns_median_values) 

#replace old nanoscan bin values with new ones 
mm <- mm %>%
  filter(!grepl("scan", variable)) %>%
  rbind(ns_values) %>%
  arrange(arrival_time)  


############################ make wide format ############################################

#note: dataframe does NOT include instrument_ID - takes avg reading if 2 instruments were collocated
mm.wide_means <- mm %>% 
  select(-instrument_id,
         -median_value
         ) %>%
  #group_by arrival_time first to order by time
  group_by(arrival_time, runname, site_id, variable, 
           route, aqs_id, aqs_location, site_long, site_lat, site_no, site_visit_no, aqs_site, date, hour, time_of_day, day, time_of_week, month, season, #duration_sec
           ) %>% 
  #spread() fn has issues when have dupliate instruments taking readings at same time - so take avg of both the readings
  summarize(mean = mean(mean_value)) %>%
  ungroup() %>%
  spread(variable, mean) %>%
  rename(
    bc_880_ng_m3_mean = ma200_ir_bc1,
    ptrak_ct_cm3_mean = ptrak_ct_cm3,
    scan_10_421_nm_ct_cm3_mean = ufp_scan_10_421_nm_ct_cm3,
    scan_20_421_nm_ct_cm3_mean = ufp_scan_20_421_nm_ct_cm3
  )

mm.wide_medians <- mm %>% 
  #?? don't care whate instrument took measurement, as long as we have a measurement?
  select(-instrument_id,
         -mean_value) %>%
  group_by(arrival_time, runname, site_id, variable, 
           route, aqs_id, aqs_location, site_long, site_lat, site_no, site_visit_no, aqs_site, date, hour, time_of_day, day, time_of_week, month, season) %>% 
  #spread() fn has issues when have dupliate instruments taking readings at same time - so take avg of both the readings
  summarize(one_median = mean(median_value)) %>%
  ungroup() %>%
  spread(variable, one_median) %>%
  rename(
    bc_880_ng_m3_median = ma200_ir_bc1,
    ptrak_ct_cm3_median = ptrak_ct_cm3,
    scan_10_421_nm_ct_cm3_median = ufp_scan_10_421_nm_ct_cm3,
    scan_20_421_nm_ct_cm3_median = ufp_scan_20_421_nm_ct_cm3
  )

mm.wide <- left_join(mm.wide_means, mm.wide_medians)

############################ save data for quicker access ################################
# saveRDS(mm, file.path("Data", "Aim 2", "Mobile Monitoring", "mm_191112.rda"))
# saveRDS(mm.wide, file.path("Data", "Aim 2", "Mobile Monitoring", "mm.wide_191112.rda"))
# saveRDS(mm_full, file.path("Data", "Aim 2", "Mobile Monitoring", "mm_full_191112.rda"))



```
 