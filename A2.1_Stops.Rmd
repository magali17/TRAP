---
title: 'Aim 2: Stop Readings'
author: "Magali Blanco"
date: '`r Sys.Date()`'
output:
  html_document:
    number_sections: yes
    df_print: paged
    toc: yes
    toc_depth: '3'
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
editor_options:
  chunk_output_type: console
---

```{r}
# ---> TO DO:

```

```{r, echo=F}
# notes
#BC = 880 nm (IR); 625 nm (Red); 528 nm (Green); 470 nm (Blue); and 375 nm (UV);  

```

# Summary of Script  
* Calculated stop medians and means. Will use medians for primary analysis b/c the distributions of raw instrument readings are log-normal, overall & by site. 
	+ Since co-located duplicate instruments responded similar, I took the average raw reading when duplicate instruments were on the platform before calculating stop means or medians   

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      cache=T, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE,
                      fig.height = 5, fig.width = 10
                      )  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
           detach, character.only=TRUE, unload=TRUE, force=TRUE))
}
 
# load packages 
pacman::p_load(tidyverse, 
               # tables
               knitr, kableExtra,
               # dates
               chron, lubridate,
               # statistics
               Hmisc
               )   

# source global variables & functions
source("0.Global_Fns.R")
source(file.path("A2.0.1_Var&Fns.R"))

# images_path <- file.path(images_path0, "1. Stops")
# tables_path <- file.path(tables_path0, "1. Stops")

#read in data
mm_clean <- readRDS(file.path("Data", "Aim 2", "Mobile Monitoring", "mm_clean_2020-03-08.rda"))

```

# Raw Data 

Distribution of raw readings. They are log-normal overall, and by site.

```{r}

mm_clean %>%
  ggplot(aes(y=value)) +
  geom_boxplot(alpha=0.05) + 
  facet_wrap(~variable, scales= "free") +
  labs(title = "Raw readings for all sites",
       y = "Concentration",
       x = ""
       )

mm_clean %>%
  ggplot(aes(y=value, x=site_id, group=site_id)) +
  geom_boxplot(alpha=0.05) + 
  facet_wrap(~variable, scales= "free") +
  labs(title = "Raw readings by site",
       y = "Concentration",
       x = "site"
       ) 

```

# Calculate Stop medians and means    

Since PTRAK instruments respond similar, take the average 1-sec reading when duplicate instruments are on platform before calculating stop means or medians.

```{r}
 
mm <- mm_clean %>%
  select(-time, instrument_id) %>%
  dplyr::group_by(date, runname, route, site_id, aqs_id, aqs_location, site_long, site_lat, arrival_time, variable) %>% 
  dplyr::summarize(median_value = median(value, na.rm = T),
            mean_value = mean(value, na.rm = T)) %>%
  ungroup() %>%
  arrange(arrival_time) %>%
  #add temporal variables
  add.temporal.variables(data = ., date.var = "arrival_time")

# #give each site unique number ID, based on time when stop was first sampled
site_no <- mm %>%
  select(site_id) %>% unique() %>%
  dplyr::mutate(site_no = seq(1:length(site_id)))

mm <- left_join(mm, site_no) 
  #left_join(site_visit_no) %>%
 

```

```{r}
# Make wide format 
mm.w.median <- mm %>%
  select(-mean_value) %>%
  spread(variable, median_value) %>%  #
  rename_at(vars(contains("ptrak"), contains("bc"), contains("scan")), ~(paste0(., "_median"))) 

mm.w.mean <- mm %>%
  select(-median_value) %>%
  spread(variable, mean_value) %>%  #
  rename_at(vars(contains("ptrak"), contains("bc"), contains("scan")), ~(paste0(., "_mean"))) 

mm.w <- full_join(mm.w.median, mm.w.mean)
 
```

Will focus on medians vs means because    
* they are more robust to outliers during short-two minute stops   
* the data are right skewed    

```{r}
## Mean is only ~3% higher? 
print("Average mean/median ratio")
mean(mm$mean_value[mm$variable=="ptrak_pt_cm3"])/mean(mm$median_value[mm$variable=="ptrak_pt_cm3"])

```

The distribution of stop means and medians are very similar.

```{r}
#compare mean vs median. if no different, use one 
mm %>%
  filter(grepl("ptrak|bc", variable)) %>%
  gather("stop", "value", median_value, mean_value) %>%
  mutate(stop = ifelse(stop == "median_value", "median", "mean")) %>%
  ggplot(aes(x=value, fill=stop)) + 
  geom_density(alpha=0.3) + 
  #scale_x_log10() + 
  facet_wrap(~variable, scales="free") +
  labs(
    title = "Mean vs median stop readings",
    #subtitle = "log x scale",
    x = "Concentration"
    )

```

Mean estimates are typically a little higher than median estimates.

```{r}
#colocation plot
## PTRAK
mm %>%
  filter(grepl("ptrak", variable)) %>%
  colo.plot(
  x.variable = "median_value", x.label = "median value",
  y.variable = "mean_value", y.label = "mean value",
  mytitle = "PTRAK stop concentration estimates (pt/cm3)") 

## BC
mm %>%
  filter(grepl("bc", variable)) %>%
  colo.plot(
  x.variable = "median_value", x.label = "median value",
  y.variable = "mean_value", y.label = "mean value",
  mytitle = "BC stop concentration estimates (ng/m3)") 

```

Final distribution of stop means and medians. These are right skewed as well. 

```{r}
mm %>%
  filter(grepl("ptrak|bc", variable)) %>%
  dplyr::rename(mean = mean_value,
         median = median_value) %>%
  gather("Stop", "value", median, mean) %>%
  group_by(variable, Stop) %>%
  distribution.table(var.string = "value") %>%
  kable(caption = "Distribution of stop means and medians. N = number of stop visits (308 sites x ~30 stop visits/site)") %>%
  kable_styling()

```


````{r}
# Save dataset
# saveRDS(mm.w, file.path("Data", "Aim 2", "Mobile Monitoring", "mm_stops_2020-03-08.rda"))

```
