---
title: "Hx Vehicle Counts"
author: "Magali Blanco"
date: ' `r Sys.Date()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
editor_options:
  chunk_output_type: console
---

```{r, echo=F}
#Notes 

# --> error making long format??

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache=T, cache.comments = F, message = F, warning = F, tidy.opts=list(width.cutoff=60), tidy=TRUE, fig.height = 8)  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
      detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

pacman::p_load(dplyr, tidyverse, knitr)  

```

Clean up count data for use in GIS. 

```{r}
traffic <- read.csv(file.path("Data", "Aim 3", "Hx Traffic Counts", "historic-traffic-volumes.csv")) %>%
  filter(Year >= 1990) %>%
  select(Year, AADT, Latitude, Longitude, Location) %>% 
  #group into 5-yr intervals since there is a lot of missing data
  mutate(Yr_grp = ifelse(Year >= 1990 & Year <= 1994, 1990,
                         ifelse(Year >= 1995 & Year <= 1999, 1995, 
                                ifelse(Year >= 2000 & Year <= 2004, 2000,
                                       ifelse(Year >= 2005 & Year <= 2009, 2005,
                                       ifelse(Year >= 2010 & Year <= 2014, 2010, 2015
                                              ))))),
         #Label traffic counts on ramps
         Ramp = grepl("RAMP", Location, ignore.case = T)
  )
          
  
traffic.wide <- traffic %>%
  group_by(Yr_grp, Latitude, Longitude, Location, Ramp) %>%  
  #some years have multiple readings at the same location - counters across the road? take avg to get 1 estimate
  summarize(AADT = mean(AADT)) %>%
  spread(Yr_grp, AADT)  %>%
  #only keep locations with values each 5-year period
  drop_na() #%>%
  #mutate(point_id = row_number())
   
#write.csv(traffic.wide, "hx.traffic.counts.csv", row.names = F)

```

compare ramp vs highway counts.
### ---> why do the curves look so similar over time? 

```{r}
traffic.in.region0 <- read.csv("../Write Up/1. Proposal/Aim 3. Hx UFP/GIS/Hx Traffic Counts/hx.traffic.counts.in.study.region.csv")

traffic.in.region <- traffic.in.region0 %>%
  select(
    point_id,
    X1990:Ramp
  ) %>%
  gather(Year=X1990:X2015, "Year", "AADT") %>%
  mutate(
    Year = as.numeric(substr(Year, 2,5))
  )

traffic.in.region %>%
  #filter(Ramp=="FALSE") %>%
  ggplot(aes(x=AADT, fill=Ramp)) + 
  geom_histogram(position = "dodge") + 
  facet_wrap(~Year)

```


#Estimating road segment counts prior to 2005

#### --> ?redo using data from points selected using a road network

Calculate weighted avg of vehicle counts on road segments based on distance of each highway traffic counter (2 traffic counters used per segment).

```{r}
myjoin0 <- read.csv("../Write Up/1. Proposal/Aim 3. Hx UFP/GIS/Traffic Sections/joins/JoinedNearest2PtsToEachSection.csv")

#calculate weighted avg based on each point's distance from a road link
myjoin <- myjoin0 %>%
  group_by(OBJECTID) %>%
  mutate(
    dist_sum = sum(distance),
    dist_wt = (dist_sum - distance)/dist_sum,
    wt_1990 = X1990*dist_wt,
    wt_1995 = X1995*dist_wt,
    wt_2000 = X2000*dist_wt,
    wt_2005 = X2005*dist_wt,
    wt_2010 = X2010*dist_wt,
    wt_2015 = X2015*dist_wt
    ) %>%
  group_by(OBJECTID,
           #SRID, BegARM, EndARM, Year_2005, Location, LOC_ERROR, Shape_Leng
           ) %>%
  summarize(
    AADT_1990 = round(sum(wt_1990)),
    AADT_1995 = round(sum(wt_1995)),
    AADT_2000 = round(sum(wt_2000)),
    AADT_2005 = round(sum(wt_2005)),
    AADT_2010 = round(sum(wt_2010)),
    AADT_2015 = round(sum(wt_2015))
  )  

#write.csv(myjoin, "wt.avg.counts.by.point.distance.csv", row.names = F)

```

AADT estiamtes in our study region (from points).
Uses 2005 WADOT road segments as the reference shapefile. 

```{r}
HxWtAADT0 <- read.csv("../Write Up/1. Proposal/Aim 3. Hx UFP/GIS/Traffic Sections/HxWtAvgAADTInStudyArea.csv")

HxWtAADT <- HxWtAADT0 %>%
  select(
    OBJECTID,
    Shape_Leng,
    X1990:X2015
  ) %>%
  rename(
    "AADT_points_1990_94" = X1990,
    "AADT_points_1995_99" = X1995,
    "AADT_points_2000_04" = X2000,
    "AADT_points_2005_09" = X2005,
    "AADT_points_2010_14" = X2010,
    "AADT_points_2015_18" = X2015
    ) #%>%
  #gather(Year = "1990":"2015", "Year", "AADT")

# traffic %>%
#   ggplot(aes(x=AADT, fill=Ramp)) + 
#   geom_histogram(position = "dodge") + 
#   facet_wrap(~Yr_grp)

```

## Validation 
WADOT Road section estimates from 2005-2018, calculate 5-year averages & later compare to weighted avgs. 2005 used as the reference shapefile. 

```{r}
sections0 <- read.csv("~/Everything/School/PhD_UW/Dissertation/Write Up/1. Proposal/Aim 3. Hx UFP/GIS/Traffic Sections/2005_2018_InStudy.csv")

sections <- sections0 %>%
  select(
    OBJECTID,
    AADT_sections_2005 = Year_2005,
    AADT_sections_2006 = X2006_Year_,
    AADT_sections_2007 = X2007_Year_,
    AADT_sections_2008 = X2008_Year_,
    AADT_sections_2009 = X2009_Year_,
    AADT_sections_2010 = X2010_Year_,
    AADT_sections_2011 = X2011_Year_,
    AADT_sections_2012 = X2012_ESTAA,
    AADT_sections_2013 = X2013_Year_, 
    AADT_sections_2014 = X2014_Year_,
    AADT_sections_2015 = X2015_Year_,
    AADT_sections_2016 = X2016_AADT,
    AADT_sections_2017 = X2017_AADT,
    AADT_sections_2018 = X2018_AADT,
    
    #distnace beween 2005 road segment and nearest road segment joined for each year
    dist_ft_06 = distance06,
    dist_ft_07 = distance07,
    dist_ft_08 = distance08,
    dist_ft_09 = distance09,
    dist_ft_10 = distance10,
    dist_ft_11 = distance11,
    dist_ft_12 = distance12,
    dist_ft_13 = distance13,
    dist_ft_14 = distance14,
    dist_ft_15 = distance15,
    dist_ft_16 = distance16,
    dist_ft_17 = distance17,
    dist_ft_18 = distance18,
   )  

#calculate 5-year averages AADT estimates from road sections
sections$AADT_sections_2005_09 <- sections %>% 
  select(AADT_sections_2005:AADT_sections_2009) %>%
  rowMeans()

sections$AADT_sections_2010_14 <- sections %>% 
  select(AADT_sections_2010:AADT_sections_2014) %>%
  rowMeans()

sections$AADT_sections_2015_18 <- sections %>% 
  select(AADT_sections_2015:AADT_sections_2018) %>%
  rowMeans()

#rearrange columns
sections <- sections %>%
  select(OBJECTID,
         AADT_sections_2005_09:AADT_sections_2015_18,
         AADT_sections_2005:dist_ft_18)

```

```{r}
#check that files are the same before merging #looks good 
# nrow(HxWtAADT0) == nrow(sections)
# table(HxWtAADT0$OBJECTID == sections$OBJECTID)
# table(HxWtAADT0$Year_2005 == sections$AADT2005)

#merge
compare <- sections %>%
  select(
    OBJECTID,
    AADT_sections_2005_09: AADT_sections_2015_18
  ) %>%
  left_join(HxWtAADT[c("OBJECTID", 
                       "AADT_points_2005_09",
                       "AADT_points_2010_14",
                       "AADT_points_2015_18"
                       )]
            )

```

```{r comparison plot fn}
#plots
# returns plots w/ linear fit, R2 and RMSE
compare.fn <- function(mydata = compare, x, y) {

  # x = "AADT_sections_2005_09"
  # y = "AADT_points_2005_09"
  mydata <- mydata %>%
    rename(x = x,
           y = y)
  
  lm1 <- lm(y~x, data=mydata) 
  lm1.s <- lm1 %>% 
    summary()
  
  eqt <- paste0("y = ", 
                round(lm1.s$coefficients["(Intercept)", "Estimate"]),
                " + ",
                round(lm1.s$coefficients["x", "Estimate"], 1),
                "x"
                )
  r2 <- paste0(
    "R2 = ",
    round(lm1.s$r.squared, 2)
  )
  
  rmse <- paste0("RMSE = ", sqrt(mean((predict(lm1) - mydata$y)^2)) %>% round()
                  )
  
  myresult <- mydata %>%
    ggplot(aes(x=x, y= y)) + 
    geom_point() + 
    geom_smooth() + 
    #1-1 line
    geom_abline(intercept = 0, slope = 1) + 
    labs(x = x, y=y,
        subtitle = paste(eqt, "\n",
                         r2, "\n",
                         rmse)
         )
  
  return(myresult)
  
}
 
```

Estimates from lines (not using road network) are not great. 

```{r}
## 2005-2009
compare.fn(x= "AADT_sections_2005_09",
           y = "AADT_points_2005_09")

## 2010 - 2014
compare.fn(x= "AADT_sections_2010_14",
           y = "AADT_points_2010_14")

## 2015 - 2018
compare.fn(x= "AADT_sections_2015_18",
           y = "AADT_points_2015_18")

```


