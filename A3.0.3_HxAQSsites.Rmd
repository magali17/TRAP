---
title: "AQS Sites"
author: "Magali Blanco"
date: ' `r Sys.Date()` '
output: 
  html_document:
    toc: yes
    toc_depth: '3'
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache=T, cache.comments = F, message = F, warning = F, tidy.opts=list(width.cutoff=60), tidy=TRUE, fig.height = 8)  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
      detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

pacman::p_load(readxl, 
               tidyverse, knitr, 
               kable, kableExtra,
               lubridate,
               splines,
               ) 

source("0.Global_Fns.R") # add_season()

#set plot theme
#theme_set(theme_linedraw() + theme(legend.position="bottom")) 

set.seed(1)

```


# Annual Averages  

Select Black carbon & EC "TOR" since EC TOR this is available at all times, whereas EC "TOT" is only available for more recent years. It is a different measurement method.

```{r}
# Annual BC & EC data 

#upload data
folder_path <- file.path("Data", "Aim 3", "Hx BC at AQS Sites")

#annual concentrations
file_prename <- file.path("annual", "annual_conc_by_monitor_")
years <- seq(1996, 2019)

aqs_annual <- data.frame()

#append Hx annual avg for sites of interest 
for (i in seq_along(years)) { #1:3) { 
  #i=23
  one_yr <- read.csv(file.path(folder_path, paste0(file_prename, years[i], ".csv"))) %>%
    filter(
      #only keep AQS sites in our study area
      State.Name == "Washington",
      County.Name %in% c("King", "Snohomish"),
      #drop Darringotn & Marysville locations outside study area
      !Site.Num %in% c(20, 1007), 
       #use EC TOR b/c TOT is also available but only for more recent years
      
      # AQS parameter code 88101 – PM2.5 at local conditions, only report those data validated from Federal Reference Methods, Federal Equivalent Methods, or other methods that are to be used in making NAAQS decisions. (https://www.epa.gov/aqs/aqs-memos-technical-note-reporting-pm25-continuous-monitoring-and-speciation-data-air-quality)
      
      grepl(x = Parameter.Name, pattern = "Black carbon|EC PM2.5 LC TOR|PM2.5 - Local Conditions", 
            ignore.case = T) #
      #Black Carbon PM2.5 at 880 nm, Black Carbon PM10 LC, EC PM2.5 LC TOR, EC PM2.5 LC TOT, Optical EC PM2.5 LC TOT
    ) %>%
    # select columns of interest
    select(
      Year, Local.Site.Name, Parameter.Name, Parameter.Code, County.Name,
      Arithmetic.Mean, Arithmetic.Standard.Dev, X50th.Percentile,
      Sample.Duration, Method.Name, Units.of.Measure,
      Observation.Count, Observation.Percent, Completeness.Indicator, Valid.Day.Count, Required.Day.Count
      )
  
  aqs_annual <- rbind(aqs_annual, one_yr)
  
}

#rename sites  
aqs_annual$Local.Site.Name <- stringi::stri_trans_totitle(aqs_annual$Local.Site.Name)

```

Data from PSCAA Tool for Kent & Duwamish after 2010 (missing from EPA data).

```{r}
 pscaa0 <-  data.table::fread(file.path(folder_path, "PSCAA", "132355030837815289TelemetryData.csv"),
                           #skip lines until see this text & make it column headers
                           skip = "Observation Time", 
                           #keeps reading after blank row
                           fill=T, sep = ","
                          
                          
                          ) %>%
  rename(Date = `Observation Time`) %>%
  mutate(
    Date = mdy_hms(Date),
    Year=year(Date)
  ) %>%
  rename_all(~sub(" -.*", "", .)) 

pscaa <- pscaa0 %>%
  gather("site", "value", -Date, -Year) %>%
  drop_na(value)

pscaa_mean <- pscaa %>%
  group_by(Year, site) %>%
  dplyr::summarize(
    mean = mean(value)
  ) %>%
  ungroup() %>%
  as.data.frame()

```

### --> scatterplots comparing PSCAA to EPA readings

```{r}

```


### --> ? do each of these locations have enough data to estimate annual avg?

```{r}
pscaa_mean %>%
  filter(grepl("Kent|Duwamish", site, ignore.case = T)) %>%
  ggplot(aes(x=Year, y = mean, col = site, group=site)) +
  geom_point() +
  geom_line() + 
  labs(y ="ug/m3", x = "Year",
       title = "PSCAA Annual estimates from monthly averages for sites w/o EPA data")

```


We see that Beacon Hill has multiple EC TOR measurements for 1 year beacuase multiple measurement methods were used. At Beacon Hill, the URG 3000N method reported higher concentrations than the more common IMPROVE method.

Tim Larson: The data are consistent with the introduction of ultra-low sulfur diesel fuel in Seattle, which allowed for the use of diesel particle filters that would have otherwise been poisoned by the sulfur. Seattle was ahead of the US by ~ 1 yr in the introduction of this fuel.

Note: Some years did not meet the "Completeness Indicator" requirement (insufficient samples were collected).

```{r}
aqs_annual %>%
  # dont include pm2.5
  filter(!grepl("Local Conditions", Parameter.Name)) %>%
  mutate(
    Parameter = ifelse(grepl(x = Parameter.Name, "EC PM2.5", ignore.case = T), "Elemental Carbon", "Black Carbon"),
    Method.Name = substr(Method.Name, 1, 30)
  ) %>%
  ggplot(aes(x=Year, y = Arithmetic.Mean, col=Local.Site.Name, shape=Method.Name)) + 
  geom_point(aes(#size=Completeness.Indicator
                 )) + 
  geom_line(aes(linetype = Parameter)) + 
  labs(col = "Site", 
       y = "Annual Arithmetic Mean (ug/m3)" 
         ) #+ theme(legend.text=element_text(size=5))

```


```{r PM2.5 trend is slightly diff than BC trend}
# # PM2.5 in Seattle (or King County). Using: "QS parameter code 88101 – PM2.5 at local conditions," only report those data validated from Federal Reference Methods, Federal Equivalent Methods, or other methods that are to be used in making NAAQS decisions." (https://www.epa.gov/aqs/aqs-memos-technical-note-reporting-pm25-continuous-monitoring-and-speciation-data-air-quality)
# # 
# # We don't see the same dip as BC.
# 
# 
# aqs_annual %>%
#   # only include pm2.5
#   filter(grepl("Local Conditions", Parameter.Name),
#          # reduce what's plotted
#          #grepl("Seattle", Local.Site.Name)
#          Year < 2012
#          ) %>%
#   mutate(
#     #Parameter = ifelse(grepl(x = Parameter.Name, "EC PM2.5", ignore.case = T), "Elemental Carbon", "Black Carbon"),
#     Method.Name = substr(Method.Name, 1, 21),
#     Local.Site.Name = substr(Local.Site.Name, 1, 21)
#   ) %>%
#   ggplot(aes(x=Year, y = Arithmetic.Mean, col=Local.Site.Name, 
#              #shape=Method.Name, 
#              size = grepl("Beacon Hill", Local.Site.Name)
#              )) + 
#   geom_point() + 
#   geom_line(aes(linetype = Parameter.Name), alpha=0.8) + 
#   geom_vline(xintercept = c(2001, 2004)) +
#   labs(col = "Site", 
#        y = "Annual Arithmetic Mean (ug/m3)",
#        size = "Beacon Hill"
#          ) #+ theme(legend.position = "bottom")


# dont include pm2.5 in dataset anymore
aqs_annual <- aqs_annual %>%
  filter(!grepl("Local Conditions", Parameter.Name)) 
```

For Beacon Hill, we will thus only use the IMPROVE method for EC since it is the same method that was used since 1996, and this site will be used to establish a temporal trend and adjust our annual estimates.

For all other sites, we will only look at BC, since it is what we are interested in comparing our final model predictions to. The PSCAA noted that we may see differences in BC levels over time because of:
* changing detection limits, particularly for older data (Erik Saganic, PSCAA; & Beth Fridman, DOE)
* In 2005 an alternate thermal protocol (IMPROVE_A) was identified and used to analyze IMPROVE samples collected after January 1, 2005, although the EC_TOR is insensitive to the change in temperature protocols (https://www.tandfonline.com/doi/pdf/10.3155/1047-3289.57.9.1014) (Beth Friedman, DOE)
* aethalometer corrections: the earlier Black Carbon data reported was 32% lower than new data being reported as BC_633 (Magee Scientific TAPI M633). You will have to apply this correction factor to the data while compiling a long-term trend. The instruments were upgraded at the following sites: (Isha Khanna, PSCAA)
  * Seattle 10th & Weller: 2/3/2016
  * Tacoma Alexander/Tideflats: 3/22/2017
  * Seattle Duwamish: 1/1/2018
  * Kent: 1/1/2018

```{r}

aqs_annual <- aqs_annual %>%
  filter(
    # for BH, keep long-term EC readings & BC readings
    (grepl("Beacon Hill", Local.Site.Name) & grepl("IMPROVE|Magee", Method.Name) ) |
      # for all other sites, only keep BC
        (!grepl("Beacon Hill", Local.Site.Name) & grepl("Black carbon", Parameter.Name, ignore.case = T)
       )  
     )  
```

```{r}

aqs_annual %>%  
  mutate(
    Parameter = ifelse(grepl(x = Parameter.Name, "EC PM2.5", ignore.case = T), "Elemental Carbon", "Black Carbon")#,
    #Method.Name = substr(Method.Name, 1, 30)
  ) %>%
  ggplot(aes(x=Year, y = Arithmetic.Mean, 
             col=Local.Site.Name,
             )) + 
  geom_point(aes(shape=Method.Name)) + 
  geom_line(aes(linetype = Parameter)) + 
  labs(col = "Site", 
       y = "Annual Arithmetic Mean (ug/m3)" 
         ) 
 
```

### --> TL? increase BC readings by 32% for older aethalometer methods to make these consistent with newer M633 method.

```{r}
adj_factor <- 1.32

#EPA data 
aqs_annual <- aqs_annual %>%
  mutate(
    # increase older methods by 32% since newer methods report 32% higher readings
    Arithmetic.Mean = ifelse(grepl("Magee Scientific AE2100", Method.Name), Arithmetic.Mean*adj_factor, Arithmetic.Mean),
    # label which sites were adjusted 
    Adjusted = ifelse(grepl("Magee Scientific AE2100", Method.Name), T, F),
    Method.Name = gsub(" -.*", "", Method.Name)
  )
  

# PSCAA data
pscaa_mean <- pscaa_mean %>%
  mutate(
    # increase older methods by 32% since newer methods report 32% higher readings
    mean = ifelse(grepl("Kent", site) & Year < 2018, mean*adj_factor, mean),
    # label which sites were adjusted 
    Adjusted = ifelse(grepl("Kent", site) & Year < 2018, T, F)
  )

```

```{r}
aqs_annual %>%  
  mutate(
    Parameter = ifelse(grepl(x = Parameter.Name, "EC PM2.5", ignore.case = T), "Elemental Carbon", "Black Carbon")#,
    #Method.Name = substr(Method.Name, 1, 30)
  ) %>%
  ggplot(aes(x=Year, y = Arithmetic.Mean, 
             col=Local.Site.Name,
             )) + 
  geom_point(aes(shape=Method.Name)) + 
  geom_line(aes(linetype = Parameter)) + 
  labs(col = "Site", 
       y = "Annual Arithmetic Mean (ug/m3)" 
         ) 
```

```{r}
pscaa_mean %>%
    filter(grepl("Kent|Duwamish", site, ignore.case = T)) %>%
  ggplot(aes(x=Year, y = mean, 
             col=site,
             )) + 
  geom_point() + 
  geom_line() + 
  labs(col = "Site", 
       y = "Annual Arithmetic Mean (ug/m3)" 
         ) 
  
```

Adjusted BC readings for specific years. Readings from older instruments were increased by 32% to make them comparable to more recent methods that report 32% higher readings.

```{r}
epa_annual_table <- aqs_annual %>%
  filter(grepl("black carbon", Parameter.Name, ignore.case = T)) %>%
  select(
    Site = Local.Site.Name, 
    Year, 
    Mean = Arithmetic.Mean,
    Adjusted
  ) %>%
  mutate(Source = "EPA")

pscaa_annual_table <- pscaa_mean %>%
    filter(grepl("Kent|Duwamish", site, ignore.case = T)) %>%
  select(
    Site = site, Year, Mean = mean, Adjusted
  )  %>%
  mutate(Source = "PSCAA")

observed_annual <- rbind(epa_annual_table, pscaa_annual_table) %>%
  arrange(Site)
   
  
```

```{r}
observed_annual %>%
  ggplot(aes(x=Year, y=Mean, col = Site)) + 
  geom_point(aes(shape = Source)) + 
  geom_line(aes(linetype = Adjusted)) + 
  labs(y = "Annual Average (ug/m3)",
       title = "Final BC readings at AQS sites to be used for validation"
       )

```

```{r}
observed_annual %>% 
  kable(caption = "Final BC readings at AQS sites to be used for validation", 
        digits = 2) %>%
  kable_styling()

```

### Fit a trend line to Beacon Hill EC readings

Only include BH since:   

a) the rest start later & make smooth() fit go "up"
b) general trends for each site & parameter seem to be similarly decreasing over time

```{r}
# df to save model predictions
aqs_trend_predictions <- with(aqs_annual, expand.grid(Year = Year,
                                                      Local.Site.Name = Local.Site.Name))  

# model to predict EC by year & site
aqs_trend_m1 <- aqs_annual %>%
  lm(Arithmetic.Mean ~ ns(Year, df = 3) + Local.Site.Name, data = .,)
  
# save predictions
aqs_trend_predictions <- aqs_trend_predictions %>%
  mutate(yhat = predict(aqs_trend_m1, newdata = .))

```

### --> plot actual fit instead of geom_smooth()

```{r}
aqs_annual %>%  
  # ??drop sites w/ only a few sites (loess has issues plotting these??)
  filter(
    grepl("Beacon", Local.Site.Name),
    grepl("EC", Parameter.Name)
    #!grepl("10th|Jackson|Yesler", Local.Site.Name)
    ) %>%
  mutate(
    Parameter = ifelse(grepl(x = Parameter.Name, "EC PM2.5", ignore.case = T), "Elemental Carbon", "Black Carbon"),
    Method.Name = substr(Method.Name, 1, 20)
  ) %>%
  ggplot(aes(x=Year, y = Arithmetic.Mean,
             col=Local.Site.Name,
             linetype = Parameter,
              )) + 
  geom_point() + 
  geom_line() + 
  geom_smooth(method = lm, formula = y ~ splines::ns(x, df= 3), se = F) + 
  labs(col = "Site", 
       y = "Annual Arithmetic Mean (ug/m3)" 
         )  

```

Plot model predictions

```{r}

aqs_annual %>%  
  mutate(
    Parameter = ifelse(grepl(x = Parameter.Name, "EC PM2.5", ignore.case = T), "Elemental Carbon", "Black Carbon"),
    Method.Name = substr(Method.Name, 1, 20)
  ) %>%
  ggplot(aes(x=Year, y = Arithmetic.Mean, col=Local.Site.Name), 
         alpha=0.5) + 
  geom_point(aes(shape=Method.Name)) + 
  geom_line(aes(linetype = Parameter)) + 
  labs(col = "Site", 
       y = "Annual Arithmetic Mean (ug/m3)" 
         ) +
  # add predictions
  #geom_point(data = aqs_trend_predictions, aes(x=Year, y = yhat, col= Local.Site.Name)) +
  geom_smooth(data = aqs_trend_predictions, aes(x=Year, y = yhat, col= Local.Site.Name)) 
  


# aqs_trend_predictions %>%
#   ggplot(aes(x=Year, y = yhat, col= Local.Site.Name)) + 
#   geom_point() +
#   geom_smooth() + 
#   labs(
#     y = "Predicted EC (ug/m3)",
#     col = "Site"
#   ) 

```





# Sensitivity: Non-heating month annual averages

### --> estimate annual non-heating month averages

### --> verify that EC and BC readings are similar during the non-heating months and dissimilar during the heating months, starting in 2003 when both of these readings are available

 

```{r, eval=T}
# Daily BC & EC data 
#daily concentrations
file_prename_daily <- file.path("daily", "daily_SPEC_")
aqs_daily <- data.frame()
#years <- c(2003)

#append Hx annual avg for sites of interest 
for (i in seq_along(years)) { #
  #i=1
  one_yr <- read.csv(file.path(folder_path, paste0(file_prename_daily, years[i], ".csv"))) %>%
    filter(
      #only keep AQS sites in our study area
      State.Name == "Washington",
      County.Name %in% c("King", "Snohomish"),
      #drop Darringotn & Marysville locations outside study area
      #!Site.Num %in% c(20, 1007),
      grepl(x = Parameter.Name, pattern = "Black Carbon|EC PM2.5 LC TOR", ignore.case = T)  #EC PM2.5
      #Black Carbon PM2.5 at 880 nm, Black Carbon PM10 LC, EC PM2.5 LC TOR, EC PM2.5 LC TOT
      #Parameter.Code %in% c(88313, 85313, 88321, 88381)
    ) %>%
    #select columns of interest
    select(
      Date.Local, Local.Site.Name, Parameter.Name, Parameter.Code, County.Name,
      Arithmetic.Mean,  
      Sample.Duration, Method.Name, Units.of.Measure, 
      Observation.Count, Observation.Percent
      )
  
  aqs_daily <- rbind(aqs_daily, one_yr)
  
}

#rename sites - take "Seattle" out
aqs_daily$Local.Site.Name <- stringi::stri_trans_totitle(aqs_daily$Local.Site.Name)

# only keep one method for Beacon Hill
aqs_daily <- aqs_daily %>%
  filter(!(grepl("Beacon Hill", Local.Site.Name) &
         grepl("EC", Parameter.Name) &
         grepl("URG", Method.Name))
         )

# add season
aqs_daily <- aqs_daily %>% 
  add_season(.date_var = "Date.Local")

  
   


```

