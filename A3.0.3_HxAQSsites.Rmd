---
title: "AQS Sites"
author: "Magali Blanco"
date: ' `r Sys.Date()` '
output: 
  html_document:
    toc: yes
    toc_depth: '3'
editor_options: 
  chunk_output_type: console
---

# Purpose of Script

The purpose of this script is to characterize historical black carbon (BC) levels at AQS sites in order to:   
a) estimate a temporal BC trend and adjustment our 2019 BC (and UFP?) mobile monitoring exposure surface back in time    
  - rationale: our model's time-varying covariate predictors may not fully capture the significantly decreasing trends in AP over time.    
b) validate historical (hx) model predictions   


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache=T, cache.comments = F, message = F, warning = F, tidy.opts=list(width.cutoff=60), tidy=TRUE, fig.height = 8)  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
      detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

pacman::p_load(readxl, 
               tidyverse, knitr, 
               kable, kableExtra,
               lubridate,
               splines,
               ) 

source("0.Global_Fns.R") # add_season()

#set plot theme
#theme_set(theme_linedraw() + theme(legend.position="bottom")) 

set.seed(1)

```


# Availalbe Data

Data are mostly from the EPA. Some readings come from the PSCAA since they are missing in the EPA dataset. 

## EPA yearly 

**Won't use these data** since it is unclear of whether years were balanced. Their "completeness" indicator is not necessarily relevant to our scientific question (e.g., can be "complete" if an extreme value surpasses the 24hr limit even if data were limited).

From the EPA data, we select Black carbon & EC "TOR" since EC TOR this is available at all times, whereas EC "TOT" is only available for more recent years. It is a different measurement method.

```{r}
# Annual BC & EC data 

#upload data
folder_path <- file.path("Data", "Aim 3", "Hx BC at AQS Sites")
# 
# #annual concentrations
# file_prename <- file.path("annual", "annual_conc_by_monitor_")
# years <- seq(1996, 2019)
# 
# aqs_annual <- data.frame()
# 
# #append Hx annual avg for sites of interest
# for (i in seq_along(years)) { #1:3) {
#   #i=23
#   one_yr <- read.csv(file.path(folder_path, paste0(file_prename, years[i], ".csv"))) %>%
#     filter(
#       #only keep AQS sites in our study area
#       State.Name == "Washington",
#       County.Name %in% c("King", "Snohomish"),
#       #drop Darringotn & Marysville locations outside study area
#       !Site.Num %in% c(20, 1007),
#        #use EC TOR b/c TOT is also available but only for more recent years
# 
#       # AQS parameter code 88101 – PM2.5 at local conditions, only report those data validated from Federal Reference Methods, Federal Equivalent Methods, or other methods that are to be used in making NAAQS decisions. (https://www.epa.gov/aqs/aqs-memos-technical-note-reporting-pm25-continuous-monitoring-and-speciation-data-air-quality)
# 
#       grepl(x = Parameter.Name, pattern = "Black carbon|EC PM2.5 LC TOR|PM2.5 - Local Conditions",
#             ignore.case = T) #
#       #Black Carbon PM2.5 at 880 nm, Black Carbon PM10 LC, EC PM2.5 LC TOR, EC PM2.5 LC TOT, Optical EC PM2.5 LC TOT
#     ) %>%
#     # select columns of interest
#     select(
#       Year, Local.Site.Name, Parameter.Name, Parameter.Code, County.Name,
#       Arithmetic.Mean, #Arithmetic.Standard.Dev, X50th.Percentile,
#       Sample.Duration, Method.Name, Units.of.Measure,
#       Observation.Count, Observation.Percent, Completeness.Indicator, Valid.Day.Count, Required.Day.Count
#       )
# 
#   aqs_annual <- rbind(aqs_annual, one_yr)
# 
# }
# 
# #rename sites
# aqs_annual$Local.Site.Name <- stringi::stri_trans_totitle(aqs_annual$Local.Site.Name)
# aqs_annual$Method.Name <- gsub(" -.*", "", aqs_annual$Method.Name)
# 
# #save for quicker access later
# write_rds(aqs_annual, file.path("Data", "Aim 3", "Hx BC at AQS Sites", "annual", "aqs_annual.rda"))

aqs_annual0 <- read_rds(file.path("Data", "Aim 3", "Hx BC at AQS Sites", "annual", "aqs_annual.rda")) %>%
  filter(!grepl("Local Conditions", Parameter.Name)) 

```

We see that Beacon Hill has multiple EC TOR measurements for 1 year beacuase multiple measurement methods were used. At Beacon Hill, the URG 3000N method reported higher concentrations than the more common IMPROVE method.

Tim Larson: The data are consistent with the introduction of ultra-low sulfur diesel fuel in Seattle, which allowed for the use of diesel particle filters that would have otherwise been poisoned by the sulfur. Seattle was ahead of the US by ~ 1 yr in the introduction of this fuel.

Note: Some years did not meet the "Completeness Indicator" requirement (insufficient samples were collected).

```{r}
aqs_annual0 %>%
  # dont include pm2.5
  filter(!grepl("Local Conditions", Parameter.Name)) %>%
  mutate(
    #Parameter = ifelse(grepl(x = Parameter.Name, "EC PM2.5", ignore.case = T), "Elemental Carbon", "Black Carbon")
  ) %>%
  ggplot(aes(x=Year, y = Arithmetic.Mean, col=Local.Site.Name, shape=Method.Name)) + 
  geom_point(aes(#size=Completeness.Indicator
                 )) + 
  geom_line(aes(linetype = Parameter.Name)) + 
  labs(col = "Site", 
       y = "Annual Arithmetic Mean (ug/m3)" 
         ) #+ theme(legend.text=element_text(size=5))

```

```{r PM2.5 trend is slightly diff than BC trend}
# # PM2.5 in Seattle (or King County). Using: "QS parameter code 88101 – PM2.5 at local conditions," only report those data validated from Federal Reference Methods, Federal Equivalent Methods, or other methods that are to be used in making NAAQS decisions." (https://www.epa.gov/aqs/aqs-memos-technical-note-reporting-pm25-continuous-monitoring-and-speciation-data-air-quality)
# # 
# # We don't see the same dip as BC.
# 
# 
# aqs_annual %>%
#   # only include pm2.5
#   filter(grepl("Local Conditions", Parameter.Name),
#          # reduce what's plotted
#          #grepl("Seattle", Local.Site.Name)
#          Year < 2012
#          ) %>%
#   mutate(
#     #Parameter = ifelse(grepl(x = Parameter.Name, "EC PM2.5", ignore.case = T), "Elemental Carbon", "Black Carbon"),
#     Method.Name = substr(Method.Name, 1, 21),
#     Local.Site.Name = substr(Local.Site.Name, 1, 21)
#   ) %>%
#   ggplot(aes(x=Year, y = Arithmetic.Mean, col=Local.Site.Name, 
#              #shape=Method.Name, 
#              size = grepl("Beacon Hill", Local.Site.Name)
#              )) + 
#   geom_point() + 
#   geom_line(aes(linetype = Parameter.Name), alpha=0.8) + 
#   geom_vline(xintercept = c(2001, 2004)) +
#   labs(col = "Site", 
#        y = "Annual Arithmetic Mean (ug/m3)",
#        size = "Beacon Hill"
#          ) #+ theme(legend.position = "bottom")



# # dont include pm2.5 in dataset anymore
# aqs_annual <- aqs_annual %>%
#   filter(!grepl("Local Conditions", Parameter.Name)) 
```

**Method selection** 

For Beacon Hill, we will thus only use the IMPROVE method for EC since it is the same method that was used since 1996, and this site will be used to establish a temporal trend and adjust our annual estimates.

For all other sites, we will only look at BC, since this is what we are interested in.

**Data Completeness**   

This approach is similar to that detailed in the MESA DOOP, though the DOOP has an added requirement that the max number of days between measurements be 45 dys for an annual average. Instead, we check the daily EPA files to check that roughly an equal number of samples come from different times of the year. 

### --> ? 

Only include estimates if at least ~66% of the data area available:     
* For BC (hourly measurements), this is: 1 measurement/hr * 24 hr/dy x 365 dy/yr * 75% = 6570 measurements    
* For EC (one 24 hr every 3 dys), this is: 0.33 measurement/dy x 365 dy/yr * 75% =  90 dys


```{r}
# based on MESA (~66%)
min_fraction <- 0.66
# BC: hourly
bc_min <- 24*365*min_fraction    #or MESA: 244 * 24  
# EC: every 3 dys
ec_min <- 1/3*365*min_fraction    #or MESA: 82 

aqs_annual <- aqs_annual0 %>%
  filter(
    # parameters to keep
    (
    # for BH, keep long-term EC readings & BC readings
    (grepl("Beacon Hill", Local.Site.Name) & grepl("IMPROVE|Magee", Method.Name) ) |
      # for all other sites, only keep BC
        (!grepl("Beacon Hill", Local.Site.Name) & grepl("Black carbon", Parameter.Name, ignore.case = T)
       )
    ) &
    # data completenesss
      (
      (grepl("Black carbon", Parameter.Name, ignore.case = T) & Observation.Count >= bc_min) |
        (grepl("EC", Parameter.Name, ignore.case = T) & Observation.Count >= ec_min)
      )
     )

#years kept for trend fitting at BH
trend_years <- with(aqs_annual, 
     Year[grepl("Beacon Hill", aqs_annual$Local.Site.Name ) & grepl("EC", Parameter.Name) ]
)

```

```{r}
aqs_annual %>%  
  mutate(
    #Parameter = ifelse(grepl(x = Parameter.Name, "EC PM2.5", ignore.case = T), "Elemental Carbon", "Black Carbon")#,
    #Method.Name = substr(Method.Name, 1, 30)
  ) %>%
  ggplot(aes(x=Year, y = Arithmetic.Mean, 
             col=Local.Site.Name,
             )) + 
  geom_point(aes(shape=Method.Name)) + 
  geom_line(aes(linetype = Parameter.Name)) + 
  labs(col = "Site", 
       y = "Annual Arithmetic Mean (ug/m3)",
       title = "Annual Avg BC and EC Concentrations", 
       subtitle = "Source: EPA Annual files"
       ) 
 
```


## EPA daily 

The only long-term data available starting in 1996 is for EC. BC starts being collected in 2003, intermittently at some sites.

**Only EC readings are avaialble.** Thus, cannot check that annual BC readings have an even number of observations during heating and non-heating months.

Isha: "Elemental Carbon is sampled through filter-based sampling by URG samplers and analyzed by EPA labs as a part of the speciation studies ongoing at Duwamish, Beacon hill, 10th & Weller in Seattle. The data from Speciation study gets uploaded to EPA’s website directly from the lab and we don’t upload it on our website as it is not a real-time instrument and it takes some months for that data to be made available."

```{r, eval=T}
# # Daily BC & EC data
# #daily concentrations
# file_prename_daily <- file.path("daily", "daily_SPEC_")
# aqs_daily <- data.frame()
# #years <- c(2003)
# 
# #append Hx annual avg for sites of interest
# for (i in seq_along(years)) { #
#   #i=1
#   one_yr <- read.csv(file.path(folder_path, paste0(file_prename_daily, years[i], ".csv"))) %>%
#     filter(
#       #only keep AQS sites in our study area
#       State.Name == "Washington",
#       County.Name %in% c("King", "Snohomish"),
#       #drop Darringotn & Marysville locations outside study area
#       !Site.Num %in% c(20, 1007),
#       #grepl(x = Parameter.Name, pattern = "Black Carbon|EC PM2.5 LC TOR", ignore.case = T)  #EC PM2.5
#       #Black Carbon PM2.5 at 880 nm, Black Carbon PM10 LC, EC PM2.5 LC TOR, EC PM2.5 LC TOT
#     ) %>%
#     #select columns of interest
#     select(
#       Date.Local, Local.Site.Name, Parameter.Name, Parameter.Code, County.Name,
#       Arithmetic.Mean,
#       Sample.Duration, Method.Name, Units.of.Measure,
#       Observation.Count, Observation.Percent
#       )
# 
#   aqs_daily <- rbind(aqs_daily, one_yr)
# 
# }
# 
# #rename sites
# aqs_daily$Local.Site.Name <- stringi::stri_trans_totitle(aqs_daily$Local.Site.Name)
# 
# # only keep one method for Beacon Hill
# aqs_daily <- aqs_daily %>%
#   filter(!(grepl("Beacon Hill", Local.Site.Name) &
#          grepl("EC", Parameter.Name) &
#          grepl("URG", Method.Name))
#          )
# 
# # add month
# aqs_daily <- aqs_daily %>%
#   mutate(month = month(x = Date.Local, label = F))
#  
# #save for quicker access later
# write_rds(aqs_daily, file.path("Data", "Aim 3", "Hx BC at AQS Sites", "daily", "aqs_daily.rda")) 

# heating months, accroding to the PSCAA
non_heating_mo <- c(4:9) 
  
aqs_daily0 <- read_rds(file.path("Data", "Aim 3", "Hx BC at AQS Sites", "daily", "aqs_daily.rda")) %>%
  mutate(
    Year = year(Date.Local),
    # delete everything after dash; match "IMPROVE" w/ aqs_annual
    Method.Name = gsub(" -.*", "", Method.Name),
    month_type = ifelse(month %in% non_heating_mo, "non-heating", "heating" )
  )

aqs_daily_all_mo <- aqs_daily0 %>%
  group_by(Year, Local.Site.Name, Parameter.Name, #Method.Name
           ) %>%
  dplyr::summarize(mean_all_months = mean(Arithmetic.Mean))

aqs_daily_nh <- aqs_daily0 %>%
  # only keep non-heating (nh) month data (non winter wood-heating): April - Sept (PSCAA 2017 Annual Report)
  filter(month_type ==  "non-heating") %>%
  group_by(Year, Local.Site.Name, Parameter.Name, #Method.Name
           ) %>%
  dplyr::summarize(mean_nh = mean(Arithmetic.Mean))

aqs_daily_h <- aqs_daily0 %>%
  # only keep non-heating (nh) month data (non winter wood-heating): April - Sept (PSCAA 2017 Annual Report)
filter(month_type ==  "heating") %>%  
  group_by(Year, Local.Site.Name, Parameter.Name, #Method.Name
           ) %>%
  dplyr::summarize(mean_h = mean(Arithmetic.Mean))

aqs_daily_join <- left_join(aqs_daily_all_mo, aqs_daily_nh) %>%
  left_join(aqs_daily_h) %>%
  gather("method", "value", contains("mean")) %>%
  drop_na(value) %>%
  mutate(
    method = ifelse(grepl("_nh", method), "non-heating (Apr-Sep)", ifelse(grepl("_h", method), "heating (Oct-Mar)", "all months")),
    # years that will be used for trend
    in_trend = Year %in% trend_years
    
    ) %>%
  as.data.frame()
  
  
  
```

For annual EC, the years that remain have roughly an equal number of samples from heating vs non-heating months. 

### --> ? issue: can't check this for BC

```{r}
aqs_daily0 %>%
  filter(grepl("Beacon Hill", Local.Site.Name)) %>%
  group_by(Year, Local.Site.Name, Parameter.Name, month_type) %>%
  dplyr::summarize(
    no_samples = n()
  ) %>%
  mutate(
    in_trend = Year %in% trend_years 
    ) %>%
  ggplot(aes(x=Year, y=no_samples, fill=month_type, alpha = in_trend)) + 
  geom_bar(stat="identity") + 
  scale_alpha_discrete(range = c(0.4, 1)) +
  
  labs(y = "No. of 1 Day Samples",
       title = "Number of samples collected at Beacon Hill by month type",
       subtitle = "Heating months are Oct-Mar"
       )

```

The EC trend at BH is very similar when all of the data are used vs when only the non-heating months are used. Using EPA daily pollutant files. 

```{r}
aqs_daily_join %>%
  # --> ?only include trend years for Beacon Hill 
  filter(Year %in% trend_years) %>%
  
  ggplot(aes(x=Year, y=value, col=Local.Site.Name, linetype=method, shape=method)) + 
  geom_point() + 
  #geom_line() + 
  geom_smooth(se = F) +
  labs(y = "Conc (ug/m3)",
       title = "Annual Avg Concentrations estimated from heating, non-heating and all months", 
       subtitle = "Source: EPA Daily files. For Beacon Hill, only including trend years."
       )
```

Trend looks strange? 

All data 

```{r}
aqs_daily0 %>%
  filter(grepl("Beacon Hill", Local.Site.Name),
           Year %in% trend_years
         ) %>%
  ggplot(aes(x=Date.Local, y=Arithmetic.Mean, col=Local.Site.Name, )) + 
  geom_point(alpha=0.4) + 
  geom_smooth() +
  labs(
    title = "Time series of Beacon Hill EC trend",
    subtitle = "Source: EPA Daily files"
       )

```

Monthly trend. We generally see higher EC levels during heating months. The difference in BC during heating and non-heating months is greater for earlier times.

```{r}
yr_bin <- 10

aqs_daily0 %>%
  filter(grepl("Beacon Hill", Local.Site.Name)) %>%
  mutate(month = month(month, label = T),
         year_bin = factor(floor(Year/yr_bin)*yr_bin)
         ) %>%
  
  ggplot(aes(x=month, y=Arithmetic.Mean, 
             #shape=year_bin, 
             linetype=year_bin
             )) + 
  geom_point(alpha=0.4, aes(col=month_type, )) + 
  geom_smooth(aes(x=as.numeric(month)), se=F) +
  labs(
    title = "Time series of Beacon Hill EC trend",
    subtitle = "Source: EPA Daily files"
       ) #+ 
  #are heating vs nh months more different over time? -Yes.
  facet_wrap(~year_bin)
```



## PSCAA 

The EPA  does not have BC readings for Kent or Duwamish after 2010. These data are available trough the PSCAA Data Tool. 

Isha: "...BC is monitored real-time and the PSCAA has the complete data available on their website. The method name is reflected for Black Carbon in terms of Black Carbon and Black Carbon_633 to differentiate between the two different kinds of instruments they have had at the sites."

```{r}
 pscaa0 <-  data.table::fread(file.path(folder_path, "PSCAA", "132355030837815289TelemetryData.csv"),
                           #skip lines until see this text & make it column headers
                           skip = "Observation Time", 
                           #keeps reading after blank row
                           fill=T, sep = ","
                           ) %>%
  rename(Date = `Observation Time`) %>%
  mutate(
    Date = mdy_hms(Date),
    Year=year(Date)
  ) %>%
  rename_all(~sub(" -.*", "", .)) 

pscaa <- pscaa0 %>%
  gather("site", "value", -Date, -Year) %>%
  drop_na(value) %>%
  #only keep Seattle & other relevant sites
  filter(grepl("Seattle|Lake Forest|Kent", site))

pscaa_mean <- pscaa %>%
  group_by(Year, site) %>%
  dplyr::summarize(
    mean = mean(value)
  ) %>%
  ungroup() %>%
  as.data.frame() %>%
  mutate(
    site = recode_factor(factor(site),
                          "Lake Forest Park" = "Lake Forest Park Towne Center",
                          "Seattle Beacon Hill" = "Seattle - Beacon Hill",
                          "Seattle Olive & Boren" = "Seattle - Olive St",
                          "Seattle 10th & Weller" = "Seattle-10th & Weller",
                          "Seattle Duwamish Vly" = "Seattle - Duwamish"
                          
                          
                          )
  )


# do????
# compare against w/ EPA annual
aqs_all <- aqs_annual %>%
  select(Year, site=Local.Site.Name, Parameter.Name, Method.Name, Arithmetic.Mean) %>%
  full_join(pscaa_mean) %>%
  
  # only keep if we have readings for both (comparison purposes)
  drop_na(Arithmetic.Mean, mean) %>%
  # only keep BC readings
  filter(!grepl("EC", Parameter.Name)) %>%

  gather("source", "value", contains("mean")) %>%
  mutate(
    source = ifelse(source == "mean", "PSCAA Monthly", "EPA Annual")
  )


  
```

PSCAA does not have EC readings. 

Estimates also seem to be slightly different than the EPA files. This difference may be due to averaging differences when annual averages are calculating (e.g. mean of lower 98th quantile).

PSCAA files do not differentiate between different methods used to calculate BC.

**Thus, do not use these files?**

```{r}
 pscaa_mean %>%
  ggplot(aes(x=Year, y=mean, col=site)) +
  geom_point() + 
  geom_line() + 
  labs(
    y = "Conc (ug/m3)",
    title = "Annual avg BC",
    subtitle = "Source: PSCAA monthly avg files"
  )
  

```

 
PSCAA vs EPA annual. EPA averages are generally higher than PSCAA estimates.

```{r}
aqs_all %>%
  ggplot(aes(x= Year, y=value, col=site, linetype=source)) + 
  geom_point() + 
  geom_line() +
  #facet_wrap(~Method.Name) + 
  labs(
    title = "Comparison of BC readings for sites and years with both EPA and PSCAA estimates"
  )

```




# Fit a trend line to Beacon Hill EC readings 

Using EPA annual data since it is the most complete and most accuate/finalized? 

Only include BH since general trends for each site & parameter seem to be similarly decreasing over time

```{r}

# model to predict EC by year & site
aqs_trend <- aqs_annual %>%
  filter(grepl("Beacon Hill", Local.Site.Name),
         grepl("EC", Parameter.Name)
         ) %>%
  select(Year, Local.Site.Name, Arithmetic.Mean)

aqs_trend <- data.frame(Year =c(1995:2018)) %>%
  left_join(aqs_trend)

#don't use bad years in prediction
#aqs_trend$Arithmetic.Mean[aqs_trend$Year %in% drop_years] <- NA

spline_fit <- "Arithmetic.Mean ~ splines::ns(Year, df = 3)"

m1 <- aqs_trend %>%
  lm(as.formula(spline_fit), data = .)
  
aqs_trend$yhat <- predict(m1, newdata = aqs_trend)

#calculate the relative difference between EC for any given year, relative to 2018 (latest year), on an additive and multiplicative scale
ref_2018 <- aqs_trend$yhat[aqs_trend$Year==2018]

aqs_trend <- aqs_trend %>%
  mutate(
    difference = yhat - ref_2018,
    ratio = yhat/ref_2018
  )
  
```

```{r}
aqs_trend %>%  
  #gather("key", "value", Arithmetic.Mean:yhat)
  ggplot(aes(x=Year, y = Arithmetic.Mean, col = "Observed")) + 
  geom_point() + 
  geom_line() +
  
  #geom_smooth(method = lm, formula = y ~ splines::ns(x, df= 3), se = F, aes(col = "Predicted")) + 
  geom_point(aes(x=Year, y = yhat, col = "Predicted")) +
  geom_line(aes(x=Year, y = yhat, col = "Predicted")) + 

  labs(col = "Estimate", 
       y = "Annual Arithmetic Mean (ug/m3)",
       title = "Annual average EC at Beacon Hill - observed and predicted from a spline",
       subtitle = spline_fit
         )  

```

2019 Model prediction adjustment factors based on EC trend at Beacon Hill

```{r}

aqs_trend %>%
  gather("method", "value", difference:ratio) %>%
  ggplot(aes(x=Year, y = value, col=method)) + 
  geom_point() + 
  labs(
    title = "2019 Model prediction adjustment factors based on EC (ug/m3) trend at Beacon Hill"
    )

```
 
 



# Adjust Hx BC readings for Validation    

For all other sites, we will only look at BC, since it is what we are interested in comparing our final model predictions to. 



```{r}
# pscaa_mean %>%
#   filter(grepl("Kent|Duwamish", site, ignore.case = T)) %>%
#   ggplot(aes(x=Year, y = mean, col = site, group=site)) +
#   geom_point() +
#   geom_line() + 
#   labs(y ="ug/m3", x = "Year",
#        title = "PSCAA Annual estimates from monthly averages for sites w/o EPA data")

```

### --> TL? increase BC readings by 32% for older aethalometer methods to make these consistent with newer M633 method.

The PSCAA noted that we may see differences in BC levels over time because of:    
* aethalometer corrections: the earlier Black Carbon data reported was 32% lower than new data being reported as BC_633 (Magee Scientific TAPI M633). You will have to apply this correction factor to the data while compiling a long-term trend. Should apply the adjustment to all M633 sites for consistency. In addition, the instruments were upgraded at the following Seattle/Tacoma sites: (source: Isha Khanna at PSCAA)    
  * Seattle 10th & Weller: 2/3/2016    
  * Tacoma Alexander/Tideflats: 3/22/2017   
  * Seattle Duwamish: 1/1/2018   
  * Kent: 1/1/2018     
* changing detection limits, particularly for older data (Erik Saganic, PSCAA; & Beth Fridman, DOE)     
* In 2005 an alternate thermal protocol (IMPROVE_A) was identified and used to analyze IMPROVE samples collected after January 1, 2005, although the EC_TOR is insensitive to the change in temperature protocols  (https://www.tandfonline.com/doi/pdf/10.3155/1047-3289.57.9.1014) (Beth Friedman, DOE)     


```{r}
adj_factor <- 1.32

#EPA data 
aqs_annual <- aqs_annual %>%
  mutate(
    # increase older methods by 32% since newer methods report 32% higher readings
    Arithmetic.Mean = ifelse(grepl("Magee Scientific AE2100", Method.Name), Arithmetic.Mean*adj_factor, Arithmetic.Mean),
    # label which sites were adjusted 
    Adjusted = ifelse(grepl("Magee Scientific AE2100", Method.Name), T, F),
    Method.Name = gsub(" -.*", "", Method.Name)
  )
  

# PSCAA data
pscaa_mean <- pscaa_mean %>%
  mutate(
    # increase older methods by 32% since newer methods report 32% higher readings
    mean = ifelse(grepl("Kent", site) & Year < 2018, mean*adj_factor, mean),
    # label which sites were adjusted 
    Adjusted = ifelse(grepl("Kent", site) & Year < 2018, T, F)
  )

```

```{r}
aqs_annual %>%  
  filter(!grepl("EC", Parameter.Name)) %>%
  mutate(
    #Parameter = ifelse(grepl(x = Parameter.Name, "EC PM2.5", ignore.case = T), "Elemental Carbon", "Black Carbon")#,
    #Method.Name = substr(Method.Name, 1, 30)
  ) %>%
  ggplot(aes(x=Year, y = Arithmetic.Mean, 
             col=Local.Site.Name,
             )) + 
  geom_point(aes(shape=Method.Name)) + 
  geom_line(aes(linetype = Parameter.Name)) + 
  labs(col = "Site", 
       y = "Annual Arithmetic Mean (ug/m3)",
       subtitle = "source: EPA Annual data"
         ) 
```

```{r}
### ---> ? don't include PSCAA data? 

# pscaa_mean %>%
#     filter(grepl("Kent|Duwamish", site, ignore.case = T)) %>%
#   ggplot(aes(x=Year, y = mean, 
#              col=site,
#              )) + 
#   geom_point() + 
#   geom_line() + 
#   labs(col = "Site", 
#        y = "Annual Arithmetic Mean (ug/m3)",
#        subtitle = "source: PSCAA monthly avg data"
#          ) 
  
```

Adjusted BC readings for specific years. Readings from older instruments were increased by 32% to make them comparable to more recent methods that report 32% higher readings.

```{r}
epa_annual_table <- aqs_annual %>%
  filter(grepl("black carbon", Parameter.Name, ignore.case = T)) %>%
  select(
    Site = Local.Site.Name, 
    Year, 
    Mean_ug_m3 = Arithmetic.Mean,
    Adjusted
  ) %>%
  mutate(Source = "EPA")

pscaa_annual_table <- pscaa_mean %>%
    filter(grepl("Kent|Duwamish", site, ignore.case = T)) %>%
  select(
    Site = site, Year, Mean_ug_m3 = mean, Adjusted
  )  %>%
  mutate(Source = "PSCAA")

observed_annual <- rbind(epa_annual_table #, 
                         #pscaa_annual_table
                         ) %>%
  arrange(Site)
   
  
```

```{r}
observed_annual %>%
  ggplot(aes(x=Year, y=Mean_ug_m3, col = Site)) + 
  geom_point(aes(shape = Source)) + 
  geom_line(aes(linetype = Adjusted)) + 
  labs(y = "Annual Average (ug/m3)",
       title = "Final BC readings at AQS sites to be used for validation"
       ) 

```

Validation set with trend overlay showing that trend adjutment may capture changes in BC over time. This is most cleraly seen for Beacon Hill, which has more data than any other site.

```{r}
aqs_trend %>%
  gather("method", "value", difference:ratio) %>%
  ggplot(aes(x=Year, y = value)) + 
  geom_point(aes(shape=method)) + geom_line(aes(group=method)) +
  
  geom_point(data=observed_annual, aes(y=Mean_ug_m3, col = Site)) + 
  geom_line(data=observed_annual, aes(y=Mean_ug_m3, col = Site)) +
  
  labs(
    title = "BC readings to be used for validation \nand temporal trend adjustment factors",
    shape = "trend adjustment method"
    )

 
```

 
# Potential limitations of the available data 

**EPA Annual**       
* unclear from which days annual averages were calculated (e.g., from every season?) THough daily file has these data for EC.    

**EPA Daily**   
* only available for EC    

**PSCAA**     
* online tool does not include exact parameter name, method used
* no EC data 

 


Save datasets.

```{r}
# datasets to be used in prediction models for trend adjustment & validation

# # trend adjustment values
# aqs_trend %>%
#   write_rds(., file.path("Data", "Aim 3", "Hx BC at AQS Sites", "trend_adjustment.rda"))
# 
# # annual avgs for validation
# observed_annual %>%
#   write_rds(., file.path("Data", "Aim 3", "Hx BC at AQS Sites", "aqs_avgs_for_validation.rda"))


```

