---
title: "PM2.5 Over Time"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Purpose    

* to learn more about whether we may be able to project ST NO2 predictions back in time prior to 1995 (??? 2019). This may also be a good exercise for my 3rd aim where Iâ€™m working on projecting the 2019 surface back to 1995.

  - if surfaces are similar, we may feel more comfortable projectin back in time using, for example, a trend 
  
* looking at cohort locations (vs a grid) since these are the locations we care about 



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      cache=F, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE,
                      dpi=300
                      #fig.height = 6
                      )  
set.seed(1)

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
      detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

# Load key packages using pacman 
my_repo <- 'http://cran.r-project.org'
if (!require("pacman")) {install.packages("pacman", repos = my_repo)}

pacman::p_load( 
               #ggforce,
               sf, #mapping
               
               #readraster
               raster, stars, 
               
               ggspatial, #mapping, adding scales, N arrows...
               ggrepel, #avoid overlapping labels
               kableExtra,
               ggmap, # get_stamenmap() # NEED?
               #caret, #need?
               #attach these last to use these functions as the defaults?
               tidyverse,
               lubridate
               )  

 

# ggplot settings
theme_set(theme_bw())
#theme_update(legend.position = "bottom")```


```

```{r}
# common variables
crs_m <- 32148
crs_deg <- 4326

#comparison years
years <- c(1995, 2015)

```


```{r}
source("map_fns.R")


pm25.0 <- read.csv(file.path("Data", "ACT", "tr0074_st_pm25.csv")) %>%
  #calculate annual average for each location_id
  mutate(year = year(ymd(start_date))) %>%
  group_by(location_id, year) %>%
  summarize(pm25 = mean(PM25_concentration)) %>%
  left_join(read.csv(file.path("Data", "ACT", "tr0074_addresses.csv"))[c("location_id", "latitude", "longitude")]) %>%
  # drop duplicate rows
  unique() %>%
  ungroup()

#only keep desired years
pm25 <- pm25.0 %>%
  filter(year %in% years)

pm25_shp <- st_as_sf(pm25, 
                     coords=c("longitude","latitude"), crs=crs_deg, remove=F) 

```


```{r}
background_map0 <- suppressMessages(get_stamenmap(bbox = add_bbox_buffer(pm25_shp, 
                                                                        x_buffer = 0.25, 
                                                                        y_buffer = 0.05
                                                                        ),
 #terrain, terrain-background, terrain-labels, terrain-lines, toner, toner-2010, toner-2011, toner-background, toner-hybrid, toner-labels, toner-lines, toner-lite, or watercolor
                                                 maptype = "toner-lite",   
                                                 zoom = 8
                                                 )) 

#background_map %>% ggmap()
```

```{r}
#returns dot map colored by PM2.5 concentration for a specific year 
# pt_data = pm25_shp
# plot_year = years[i]
# plot_limits = c(range$min, range$max)
                


basic_map <- function(background_map = background_map0,
                      pt_data, 
                      plot_year,
                      plot_limits = ""
                      )   {
  
  pt_data <- pt_data %>%
    filter(year == plot_year)
  
  # if none given, use that year alone
  if(plot_limits == "") {
    plot_limits <- c(min(pt_data$pm25), max(pt_data$pm25))
  }
  
  map <- ggmap(ggmap = background_map) +
     geom_sf(data = pt_data,
            aes(col = pm25),
            inherit.aes = FALSE,
            alpha=0.1,
            size=0.5
            ) +
      # add scale & N arrow to top left
      annotation_scale(location = "tr", 
                       #bar_cols = c("black", "blue"), 
                       #width_hint = 0.5
                       ) +
      annotation_north_arrow(location = "tr",
                             #point towards North Pole
                             which_north = "true",
                            # pad_x = unit(0.75, "in"),
                             pad_y = unit(0.5, "in"),
                             style = north_arrow_fancy_orienteering
                             ) +
      theme(
          # Put bottom-left corner of legend box in bottom-left corner of graph
          legend.justification=c(0,1), legend.position=c(0,1),
          #legend.background = element_blank()
            ) +
      scale_color_gradient(low = "yellow", high = "red", 
                           limits = plot_limits
                           ) +
      labs( 
           col = "PM2.5",
           title = paste0(plot_year), # " PM2.5 (ug/m3) Predictions \nat cohort locations"),
           x = "Longitude",
           y = "Latitude"
      )
  
  return(map)

  
}

```


Maps of PM2.5 early on & in more recent years

```{r}

range <- pm25 %>%
  summarize(
    min = min(pm25),
    max = max(pm25)
  )

for(i in seq_along(years)){
   
  map <- basic_map(pt_data = pm25_shp, 
                   plot_year = years[i], 
                   plot_limits = c(range$min, range$max)
                   )
  
  print(map)
  
  }

```

* higher concentration PM2.5 locations have dropped over time at a greater rate than lower concentration locations  

```{r}
pm25 %>%
  spread(year, pm25) %>%
  ggplot(aes(x=`1995`, y =`2015`)) + 
  geom_point(alpha=0.1) +
  geom_abline(intercept = 0, slope=1) + 
  geom_smooth(method = "lm") +
  xlim(range$min, range$max) +
  ylim(range$min, range$max) + 
  labs(title = "PM2.5 (ug/m3) ST Model Prediction at Cohort Locations"
         )
  
```

### --> ? quantify the change

```{r}
pm25_shp %>%
  spread(year, pm25) %>%
  mutate(diff = `2015`- `1995`) %>%
  gather("year", "pm25", `1995`:diff) %>%
  basic_map(pt_data = ., plot_year = "diff")
  
```

