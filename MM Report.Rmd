---
title: "Mobile Monitoring Data Review"
author: "Magali Blanco"
date: ' `r Sys.Date()` '
output:
  html_document:
    number_sections: yes
    df_print: paged
    toc: yes
    toc_depth: '3'
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}  
knitr::opts_chunk$set(echo = F, cache=T, cache.comments = F, message = F, warning = F, tidy.opts=list(width.cutoff=60), tidy=TRUE, fig.height = 8)  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
      detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

pacman::p_load(dplyr, tidyverse, chron, knitr)  #chronn: is.holiday, is.weekend

#set plot theme
theme_set(theme_linedraw() + theme(legend.position="bottom")) 
 
```

### see Qs in code

### --> convert to PST? 
### date_time_pst =as.POSIXct(format(date_time_local, tz="Etc/GMT+8")) 

```{r average stop data}
source("A2-3_Var&Fns.R")

#load stop average data 
mm <- readRDS(file.path("Data", "MobileMonitoring", "mm_190806.rda"))
mm.wide <- readRDS(file.path("Data", "MobileMonitoring", "mm.wide_190806.rda"))

#load overnight AQS site data 
ptrak <- readRDS(file.path("Data", "MobileMonitoring", "ptrak_190628.rda"))

```

```{r definitions}
#start/end dates
#start.date = min(mm$date) #in A2-3 variables.R sourcing
end.date = max(mm$date)

#on what days have instruments been used?
instrument.use <- mm %>% group_by(instrument_id) %>%
  summarize(no_runs = length(unique(runname)))
 
#UFP instrument variable names 
ufp <- c(#"bc_ir880nm_ng_m3", 
          #     "neph_bscat_per_m", 
               "ufp_disc_ct_cm3", 
               "ufp_pt_noscreen_ct_cm3", 
               "ufp_pt_screen_ct_cm3", 
               "ufp_scan_ct_cm3")

```

Data used in this report are those less than the `r myquantile` quantile.


# Data Completeness 

```{r}
total_site_visits <- nrow(mm.wide)

instrument_readings <- mm.wide %>%
  select(bc_ir880nm_ng_m3 : ufp_scan_ct_cm3)  

total_stops <- instrument_readings %>% nrow()

complete_instrument_readings <- instrument_readings %>%
  drop_na() %>% nrow()
   
  
data_completeness <- data.frame(variable = names(instrument_readings),
                 stop_count = NA,
                 percent_complete = NA)

for(i in 1:nrow(data_completeness)) {
  data_completeness$stop_count[i] <- nrow(drop_na(instrument_readings[i]))
  data_completeness$percent_complete[i] <- data_completeness$stop_count[i] / total_site_visits *100  
  }

data_completeness <- data_completeness %>%
  arrange(desc(percent_complete))
  
total_df <- data.frame(variable = c("total stops", "all instruments running"),
                       stop_count = c(total_stops, complete_instrument_readings),
                       percent_complete = c(NA, complete_instrument_readings/total_stops*100))

data_completeness <- rbind(total_df, data_completeness)

# data_completeness <- data_completeness %>% 
#   mutate(percent_complete = round(percent_complete, 1)) 
   
kable(data_completeness, digits = 1, caption = "Data Completeness")

```
 
# Data Collection Over Time  

```{r}
#instrument used each day
mm %>%
  #1 record per variable combination - to reduce file size
  select(date, instrument_id, variable) %>% 
  unique() %>%
  ggplot(aes(x=date, y=instrument_id, colour = instrument_id)) + 
  geom_point() + 
  facet_wrap(~variable, scales="free", ncol = 2) + 
  theme(legend.position = "none") + 
  labs(title = "Instruments used over time")

```

```{r}
#stops over time 
mm %>%  
  #1 record per date-site_no to reduce file size
  select(date, site_no, route, aqs_id) %>%   
  unique() %>%
  #all sites
  ggplot(aes(x=date, y=site_no, colour=route)) + 
  geom_point() + 
  #aqs sites 
  geom_point(aes(shape=aqs_id), colour="black") + 
  labs(title = paste("Sites visited over time", subtitle= paste(start.date, "-", end.date))) 
  
```

```{r}
#stops by season/day of week/time of day/hour 
##stops by season
mm %>%  
  select(runname, site_no, season, site_id) %>%   
  unique() %>%
  ggplot(aes(x=site_no, fill=season)) + 
  geom_bar() + 
  labs(title = "Number of visits to each site by season", subtitle= paste(start.date, "-", end.date)) 
  
 
```

```{r}
##stops by time of week
mm %>%  
  select(runname, site_no, weekend) %>%   
  unique() %>%
  #all sites
  ggplot(aes(x=site_no, fill=weekend)) + 
  geom_bar() + 
  labs(title = "Number of visits to each site by time of week", subtitle= paste(start.date, "-", end.date)) 

```

```{r}
##stops by day of the week
mm %>%  
  select(runname, site_no, day) %>%   
  unique() %>%
  #all sites
  ggplot(aes(x=site_no, fill=day)) + 
  geom_bar() + 
  labs(title = "Number of visits to each site by week day", subtitle= paste(start.date, "-", end.date)) 

```

```{r}
##stops by time of day
mm %>%  
  select(runname, site_no, time_of_day) %>%   
  unique() %>%
  #all sites
  ggplot(aes(x=site_no, fill=time_of_day)) + 
  geom_bar() + 
  labs(title = "Number of visits to each site by time of day", subtitle= paste(start.date, "-", end.date)) 

```

# Collocations 
## Field  

### DiscMini's

```{r} 
colo.plot(primary.instrument = "PMDISC_3", secondary.instrument = "PMDISC_8")

```

### PTRAKs

```{r}
#need to compare PMPT_1 to PMPT_93 and PMPT_94, and PMPT_93 to PMPT_94



#the colocations we actually have
colo.plot(primary.instrument = "PMPT_93", secondary.instrument = "PMPT_4")
colo.plot(primary.instrument = "PMPT_94", secondary.instrument = "PMPT_4")


```


### Neph   
PM25_176 has always/mostly been used.

```{r}
colo.plot(primary.instrument = "PM25_176", secondary.instrument = "PM25_205")

```

### BC    
Fit is not great, but BC_63 has always/mostly been used.

```{r}
colo.plot(primary.instrument = "BC_63", secondary.instrument = "BC_66")

```

## Lab/Garage  

### PTRAKs   

```{r}
# see data in database 
#PTRAK lab collocations:
# 3/20
# 3/22
# 4/9 Lab ptrak
# 4/18 Lab ptrak
# 4/19 (just DiscMini)
# 5/6 Lab ptrak
# 5/8 Lab Ptrak zerp; Discmini colo
# 5/9 lab scan
# 5/10 discmini, nanoscan 
# 5/31 disc
# 7/9 ptrak, scan
# 7/10 disc zero
# 8/9 disc, ptrak







```

# Overnight AQS Site Readings
Using PST.   

## PTRAK

```{r}
# #attributes()
# #upload datasets, R recognizes that they are in both PST and PDT
# Ptrak.10W <- read.csv("Data/MobileMonitoring/Overnight Collocations/Ptrak 10W.csv") %>% 
#   mutate(Location = as.factor("10W"))  
# 
# Ptrak.BH <- read.csv("Data/MobileMonitoring/Overnight Collocations/Ptrak BH.csv") %>% 
#   mutate(Location = as.factor("BH"))  
# 
# ptrak <- rbind(Ptrak.10W, Ptrak.BH) %>% 
#   mutate(
#     date_time_local = as.POSIXct(paste(Date, Time), format="%m/%d/%y %H:%M:%S", tz = "America/Los_Angeles"),
#     #convert to PST (this creates a character vector), convert back to date-time format
#     date_time_pst =as.POSIXct(format(date_time_local, tz="Etc/GMT+8")), 
#     date = as.Date(date_time_pst),
#     hour = as.numeric(format(date_time_pst, format="%H")),
#     time_of_day = factor(ifelse(hour %in% early_am, "early_am",
#                  ifelse(hour %in% am, "am",
#                         ifelse(hour %in% noon, "noon",
#                                ifelse(hour %in% evening, "evening", "night")))),
#                  levels= c("early_am", "am", "noon", "evening", "night")),
#     day = factor(format(date_time_pst, "%a"), 
#                  levels= c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")),
#     weekend = factor(ifelse(day =="Sat" | day == "Sun", "weekend", "weekday")),
#     #month = as.numeric(format(date_time_pst, format="%m")),
#     month = factor(format(date_time_pst, "%b"), 
#                    levels= c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")),
#     season = factor(ifelse((date >= winter1 & date < spring) | date >= winter2, "winter",
#                     ifelse(date >= spring & date < summer, "spring",
#                            ifelse(date >= summer & date < fall, "summer", "fall"))),
#                     levels = c("winter", "spring", "summer", "fall"))
#     ) %>%
#   select(date_time_pst, date, hour, time_of_day, day, weekend, month, season, Conc_pt_cm3, Location)
# 
# 
# # ??? take median (since not excluding extreme values) or use raw 10-sec values?
# #calculate median/avg concentration per day-hour
# ptrak <- ptrak %>%
#   group_by(date, hour, time_of_day, day, weekend, month, season, Location) %>%
#   summarize(Conc_pt_cm3 = round(median(Conc_pt_cm3)))

```

Plotting median hourly concentrations (all data included) at Beacon hill (BH) and 10th & Weller (10W).

```{r}
ptrak %>%
  ggplot(aes(x=hour, y=Conc_pt_cm3, group=hour, fill=time_of_day)) + 
  geom_boxplot() + 
  facet_wrap(~Location) # + weekend

ptrak %>%
  ggplot(aes(x=day, y=Conc_pt_cm3)) + 
  geom_boxplot() + 
  facet_wrap(~Location)

ptrak %>%
  ggplot(aes(x=month, y=Conc_pt_cm3)) + 
  geom_boxplot() + 
  facet_wrap(~Location)


```


```{r}
#table of obsevations over time before/after weighing (e.g., % samples during day before/after weighting)


```


# Data Summary  
## Density Plots

```{r}
#density plots of concentrations for each pollutant & instrument
mm %>% 
  ggplot(aes(x=value, fill = instrument_id)) +  
  geom_density( alpha=0.3) + 
  facet_wrap(~variable, scales = "free", ncol = 2) + 
  labs(title = "Density plots of Pollutant Concentrations by Instrument",
       subtitle = paste0(start.date, " - ", end.date)) + 
  theme(legend.position = "none")

```

```{r}
#density plots of UFP instrument concentrations
mm %>% 
  filter(variable %in% ufp) %>%
  ggplot(aes(x=value, fill = variable)) +  
  geom_density(alpha=0.3) +
  scale_x_log10() +
  labs(title = "Density plots of UFP Concentrations (#/cm3)",
        subtitle = paste0(start.date, " - ", end.date,
                          "\nlog x scale",
                          "\nPTRAK: 20 nm - 1 µm (50 nm - 1 µm w/ screen);\nDiSCmini:10-700 nm; \nNanoScan: 10-420 nm"))

``` 

 

## Concentrations Over Time

### --> add bigger PTRAK plots

```{r}
#concentrations by time & season 
mm %>%
  ggplot(aes(x=month, y=value, fill=season)) + 
  geom_boxplot(notch=T) + 
  facet_wrap(~variable, scales="free", ncol = 2) + 
  labs(title= "Concentrations over time",
       subtitle = paste0(start.date, " - ", end.date))  

```

```{r}
#concentrations by week day
mm %>%
  ggplot(aes(x=day, y=value, fill=weekend)) + 
  geom_boxplot(notch=T) + 
  facet_wrap(~variable, scales="free", ncol = 3) + 
  labs(title= "Concentrations by week day",
       subtitle = paste0(start.date, " - ", end.date))  
 
```


```{r}
#concentrations by hour and time of day
mm %>%
  ggplot(aes(x=hour, y=value, fill=time_of_day, group=hour)) + 
  geom_boxplot(notch=T) + 
  facet_wrap(~variable, scales="free", ncol = 3) + 
  labs(title= "Concentrations by hour",
       subtitle = paste0(start.date, " - ", end.date))  

 
```

##Concentrations by Geographic Features 

### --> need geocovariates from Amanda/Data team 

```{r}
#distance to roadway

#distance to airport

#population density

#elevation

```


## Pollutant Correlations  
 
```{r}
plot(mm.wide[21:32])

# what method to use for dealing with NA's? 
cor.table <- cor(scale(mm.wide[21:32]), use="complete.obs")

heatmap(cor.table )

```









 








 