---
title: "Untitled"
author: "Magali Blanco"
date: "4/18/2019"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
### --> see paper notes from 5/3 MOVUP mtg 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache=T, cache.comments = F, message = F, warning = F, tidy.opts=list(width.cutoff=60), tidy=TRUE, fig.width = 8, fig.height = 6)  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
      detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

pacman::p_load(dplyr, tidyverse, chron)  #chronn: is.holiday, is.weekend

```

```{r first.instrument.reading}
#read in data
mm.raw <- readRDS("Data/MobileMonitoring/stop_data_190222_190806.rda") %>% 
  #drop unwanted variable values to reduce data size
  filter(!variable %in% c("gps_lat",
                          "gps_long",
                          "ufp_pt_screen_ct_cm3",
                          "ufp_disc_med_size_nm",
                          "bc_uv375nm_ng_m3" #this is not total BC
                         ) 
         )

#give each site unique number ID, based on time (df is sorted by time)
site_no <- mm.raw %>%  
  arrange(route, time) %>%
  select(site_id) %>% unique() %>% 
  mutate(site_no = seq(1:length(site_id))) 

#give each driving day a unique ID
run_no <- mm.raw %>% 
  arrange(runname) %>%
  select(runname) %>% unique() %>%
  mutate(run_no = seq(1:length(runname)))

mm <- mm.raw %>% left_join(site_no) %>%
  left_join(run_no)

```

create temporal variables

```{r}
#seasons
winter1 <- as.Date("2018-12-21")
winter2 <- as.Date("2019-12-21")
spring <- as.Date("2019-03-20")
summer <- as.Date("2019-06-21")
fall <- as.Date("2019-09-23")  

#time of day
early_am <- seq(5,8)
am <- seq(9,11)
noon <- seq(12,15)
evening <- seq(16,20)
night <- c(seq(21,23), seq(0,4)) #? 0-4 in "night"?

mm <- mm %>% mutate(
    #create date column
    hour = as.numeric(format(mm$time, "%H")),
    date = as.Date(substr(time, 1,10)),  #or use runname?
    day = weekdays(time),
    weekend =  is.weekend(time),
    season = ifelse((date >= winter1 & date < spring) | date >= winter2, "winter", 
                    ifelse(date >= spring & date < summer, "spring",
                           ifelse(date >= summer & date < fall, "summer", "fall"))),
     time_of_day = factor(ifelse(hour %in% early_am, "early_am",
                       ifelse(hour %in% am, "am",
                              ifelse(hour %in% noon, "noon",
                                     ifelse(hour %in% evening, "evening", "night")))),
                       levels= c("early_am", "am", "noon", "evening", "night")
                       )
    )


```

## --> 
# --> add column to ID primary instruments

```{r}
# instrument.use <- mm %>% group_by(instrument_id) %>%
#   summarize(
#     no_runs = length(unique(runname))
#   )
 
#replace BC_0063 with BC_63
mm$instrument_id[mm$instrument_id == "BC_0063"] <- "BC_63"

mm %>%
  ggplot(aes(x=run_no, y=value, colour = instrument_id)) + 
  geom_boxplot() + 
  facet_wrap(~variable, scales="free")

```


## --> compare primary & secondary instrument agreement 

```{r}

```

 
## new df w/ only 1 instrument at a time

```{r}

```


```{r}
start.date = format(min(mm$time), "%Y-%m-%d")
end.date = format(max(mm$time), "%Y-%m-%d")

```
 
number of stops over time 

```{r, fig.height=6}
mm %>%  
  ggplot(aes(x=time, y=site_no, colour=route)) + geom_point() + labs(title = paste("Site Stops", start.date, "-", end.date)) + geom_point(data=mm[mm$site_kind=="Collocation",], aes(x=time, y=site_no), colour="black")
  
```



## trimmed, weighted mean concentration per location
??? how to do this??

```{r}
#overall








#by season



```



















########### OLD PLOTS ###########  

#plots of UFP

```{r}
#histograms of all values

# ### ? some routes seem separated? 
# mm.long %>% #filter(pollutant != "bc_uv375nm_ng_m3" & pollutant != "bc_uv375nm_ng_m3" ) 
#   ggplot(aes(x=value)) + geom_histogram() + facet_wrap(~pollutant, scales = "free")

```

\newpage
PTRAK w/ and w/o screen

```{r}
mm %>% filter(ufp_pt_ct_cm3 < quantile(ufp_pt_ct_cm3, 0.9, na.rm = T) & ufp_pt_screen_ct_cm3 < quantile(ufp_pt_screen_ct_cm3, 0.9, na.rm = T)) %>%
  ggplot(aes(x=ufp_pt_ct_cm3, y=ufp_pt_screen_ct_cm3, colour=route)) + 
  geom_point() + 
  geom_smooth(method = "loess") + 
  labs(x="Ptrak (#/cm3)", y= "Ptrak with Screen (#/cm3)", title = "Ptraks")


```

\newpage
UFP instrument comparison

```{r}
### --> recode pollutant names 
## --> few nanoscan values b/c they're by the minute

#ufp_scan_ct_cm3, ufp_disc_ct_cm3, ufp_pt_ct_cm3, ufp_pt_screen_ct_cm3
alpha = 0.4

mm.long %>% filter((pollutant == "ufp_scan_ct_cm3" | 
                      pollutant =="ufp_disc_ct_cm3" | 
                      pollutant == "ufp_pt_ct_cm3" | 
                      pollutant == "ufp_pt_screen_ct_cm3") & 
                     value < quantile(value, 0.99, na.rm = T)) %>% 
  #recode_factor(pollutant, "ufp_scan_ct_cm3" = "Scan") %>%
  
  ggplot(aes(x=value, fill=pollutant)) +  
  geom_histogram(position = "dodge") + 
  labs(title = "Histogram of UFP Values", 
       subtitle = "top 1% values excluded",
       x= "#/cm3",
       fill="instrument"
       )

```

-nanoscan 

```{r}
mm.long %>% filter((pollutant == "ufp_scan_ct_cm3") & 
                     value < quantile(value, 0.99, na.rm = T)) %>% 
  #recode_factor(pollutant, "ufp_scan_ct_cm3" = "Scan") %>%
  
  ggplot(aes(x=value, fill=pollutant)) +  
  geom_histogram(position = "dodge") + 
  labs(title = "Histogram of UFP Values", 
       subtitle = "top 1% values excluded",
       x= "#/cm3",
       fill="instrument"
       )
```



\newpage
temporal trends- whole-week patterns

```{r, fig.height=10}
### -->get rid of gps_long, gps_lat
### ---> relevel facors & 
### in main mm df 



mm.long %>% mutate(day = substr(day, 1,2)) %>% 
  #levels(as.factor(day), c("Mo", "Tu", "We", "Th", "Fr", "Sa", "Su")) %>%
  
  ggplot(aes(x=day, y=value)) + geom_boxplot() + facet_wrap(~pollutant, scales="free") + scale_y_log10()



```



```{r, fig.height=10}
### --> ? dont' fill by pollutant

mm.long %>%  
  ggplot(aes(x=weekend, y=value)) + geom_boxplot() + facet_wrap(~pollutant, scales="free") + scale_y_log10() #fill=route


```

\newpage
temporal trends- diurnal patterns

```{r}

```



```{r}
#boxplots of measurements at same locations

#calculate mean of all values (including duration) by location



# ?histograms of means


```



 