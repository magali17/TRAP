---
title: "Survival Analysis"
author: "Magali Blanco"
date: "9/6/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r, echo=F}
#NOTES
##4. merge with github. always do these 4 steps all together. enter the following into the Terminal (does not work any other way for some reason)
###a. git pull origin master #do this before start editing & before you're read to upload changes again
###b. git add mb_functions.R 
###c. git commit -m "my commit message in parentheses" 
###d. git push origin master



# see BIOST 537 Ch 5 Lecture, slide 33/57  
# --> use package to calc #s & %s instead of by hand? 

#sensitivity analyses
##when using ONSET AGE (age_act), need to drop exposure predictions after age_act. filter(age_at_exposure <= age_act) & dementia_now = ifelse(age_at_exposure < age_act, 0, anydementia),


```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache=T, cache.comments = F, message = F, warning = F, tidy.opts=list(width.cutoff=60), tidy=TRUE, fig.height = 8)  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
      detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

pacman::p_load(survival, haven, tidyverse, knitr, Hmisc, EnvStats)  #Himsc: describe(); EnvStats: summaryFull()

#minimum percent of months required for us to consider a prediction "valid"
min.pct <- 0.95

#To open doc:/home/gradstudent/magali/a. TRAP Project/R TRAP Project/data/issue_001.sas7bdat 

# dem0 <- read_sas(file.path("~", "a. TRAP Project", "R TRAP Project", "data", "issue_001_2.sas7bdat"), NULL)

dem0 <- read_sas(file.path("Data", "Aim 1", "issue_001_3.sas7bdat"), NULL)

#select relevant columns, e.g. 10-yr estimates
dem <- dem0 %>%
  select(
    study_id,
    birthdt,
    intakedt,
    last_visit,
    onsetage,
    anydementia,  
    dsmivdx,
    nindx,
    
    #M1, 6, sensitivity analyses
    exposure_year:exp_mos_coverage20_yr, 
    
    #M2
    apoe,
    male,
    education, degree,
    tr_med_inc_hshld, 
    race,
    
    #M3
    smoke, pack_years, 
    exercise, exercise_reg,
    
    #M4a
    Hypertension, Diabetes,
    CV_DIS, #indicates whether subject has ever reported having stroke, TIA, or CEA.
    Heart_Dis, #indicates whether subject has ever reported having an MI, Angina, CABG, or Angioplasty.
    bmi,
    
    #M4b
    CASI_SC, casi_valid
    ) %>%
  #create new variables
  mutate(
    age_intake = floor(as.numeric(intakedt - birthdt)/365),
    # ?? recalculate? Think "age" is rounded  #? is last_predx_visit actually the 2nd to last visit?
    age_last_visit = floor(as.numeric(last_visit - birthdt)/365),
    #traditional definition used by ACT for follow-up time for cases and controls
    age_act = ifelse(!is.na(onsetage), onsetage, age_last_visit),
    
    # update anydementia. Unless someone was suspected of dementia and was evaluated for it, the ANYDEMENTIA (as well as DSMIVDX, ANYAD, NINDX, etc.) field will be blank. Think of ‘0’ as a confirmation of no dementia, while blank as a presumption of no dementia.
    anydementia = ifelse(is.na(anydementia), 0, anydementia),
    dsmivdx = ifelse(is.na(dsmivdx), 0, dsmivdx),
    nindx = ifelse(is.na(nindx), 0, nindx),
    ## create AD variable
    #ad_dsmivdx = ifelse(dsmivdx == 1, dsmivdx, NA),
     #Time-varying covariates
    age_end_exposure = age_at_exposure,
    #recalculate age_end_exposure to be age at ppl's birthdays. this prevents age_at_exposure_year from being smaller than ?age_intake/starting age at times
    #earlier issue b/c expo predictions were only given through onset age, so we had "few" incident cases by year
    #age_end_exposure2 = floor(as.numeric(as.Date(paste0(exposure_year, "-", format(birthdt, "%m-%d"))) - birthdt)/365), 
    #"start" of the exposure period should be < "end" of exposure period for time-varying analysis
    age_start_exposure = age_end_exposure - 1,
    ### ? need to change age_last_visit to age_act for sensitivity analyses ?
    dementia_now = ifelse(age_end_exposure < age_last_visit, 0, anydementia),
    #clean up variables
    ## filter out invalid casi_sc scores (e.g., 666.6 - 999.9)
    casi = ifelse(casi_valid ==1, CASI_SC, NA),
    income_cat = ifelse(tr_med_inc_hshld < 20000, 1,
                               ifelse(tr_med_inc_hshld >= 20000 & tr_med_inc_hshld < 35000, 2,
                                      ifelse(tr_med_inc_hshld >= 35000 & tr_med_inc_hshld < 50000, 3,
                                             ifelse(tr_med_inc_hshld >= 50000 & tr_med_inc_hshld < 75000, 4, 5)
                                             )
                                      )
                               )
    ) %>%
  #drop relabeled/edited variables
  select(
    -age_at_exposure,
    -casi_valid, -CASI_SC,
    #-tr_med_inc_hshld
  ) 

# #proportion of observations with at least 95% of months in 10-year period; for NO2 and PM2.5
# prop.table(table(dem0$exp_mos_coverage10_yr>0.95)) %>% round(2)

dem <- dem %>%
  filter(
    #drop PM10 predictions
    pollutant %in% c("no2", "pm25"),
    #only keep observations with predictions at at least 95% of the months in the 10-year period
    exp_mos_coverage10_yr >= min.pct
  ) %>%
  select(
    study_id:last_visit,
    age_intake,
    age_last_visit,
    age_act,
    onsetage, #delete, using age_act instead
    
    anydementia, #not using this for TVC?
    dsmivdx,
    nindx,
    #ad_dsmivdx,
    dementia_now,
    
    age_start_exposure,
    age_end_exposure,
    #age_end_exposure2,  #delete
    exposure_year:degree,
    tr_med_inc_hshld,
    income_cat,
    race:bmi, 
    casi
  )
 
dem <- dem %>% 
  filter(
    ## ??--> drop individuals w/ only baseline obsevations? B/c cases captured at baseline would not have been enrolled? 
    age_intake != age_last_visit,
    #drop exposure predictions after the last visit when individuals are no longer followed. Also, could make TVC analysis problematic (e.g., dementia_now variable may be 1)
    ## --> note: when using act_age, have to change age_last_visit to age_act
    age_end_exposure <= age_last_visit
  )
 
#make wide format
no2 <- dem %>% 
  filter(pollutant == "no2") %>%
  select(-pollutant) %>%
  rename(
    no2_1yr = exp_avg01_yr,
    no2_5yr = exp_avg05_yr,
    no2_10yr = exp_avg10_yr,
    no2_20yr = exp_avg20_yr,
    no2_10yr10yrlag = exp_avg10_yr10yrlag,
    no2_10yr20yrlag = exp_avg10_yr20yrlag,
    no2_coverage_1yr = exp_mos_coverage01_yr,
    no2_coverage_5yr = exp_mos_coverage05_yr,
    no2_coverage_10yr = exp_mos_coverage10_yr,
    no2_coverage_20yr = exp_mos_coverage20_yr,
    no2_coverage_10yr10yrlag = exp_mos_coverage10_yr10yrlag,
    no2_coverage_10yr20yrlag = exp_mos_coverage10_yr20yrlag
    ) 

pm25 <- dem %>% 
  filter(pollutant == "pm25") %>%
  select(-pollutant) %>%
  rename(
    pm25_1yr = exp_avg01_yr,
    pm25_5yr = exp_avg05_yr,
    pm25_10yr = exp_avg10_yr,
    pm25_20yr = exp_avg20_yr,
    pm25_10yr10yrlag = exp_avg10_yr10yrlag,
    pm25_10yr20yrlag = exp_avg10_yr20yrlag,
    pm25_coverage_1yr = exp_mos_coverage01_yr,
    pm25_coverage_5yr = exp_mos_coverage05_yr,
    pm25_coverage_10yr = exp_mos_coverage10_yr,
    pm25_coverage_20yr = exp_mos_coverage20_yr,
    pm25_coverage_10yr10yrlag = exp_mos_coverage10_yr10yrlag,
    pm25_coverage_10yr20yrlag = exp_mos_coverage10_yr20yrlag
    )   
dem.w <- full_join(no2, pm25)

```

# Quality Control

Make sure age variables make sense 

```{r, echo=T}
#age at: intake, onset (age_act), last visit
# age_start_exposure, age_end_exposure

table(dem$age_intake <= dem$age_act) #table(dem$age_intake <= dem$onsetage)
table(dem$age_intake <= dem$age_last_visit)
table(dem$age_act <= dem$age_last_visit)

#check taht there is only one time period when dementia_now = 1 for each participant #looks good
dem.w %>% 
  filter(
        # age_end_exposure <= age_last_visit
         ) %>%
  group_by(study_id) %>%
  dplyr::summarize(
    #number of times each patient has dementia_now==1 (should be max 1)
    dem_now_n = sum(dementia_now==1)
  ) %>%
  with(., table(dem_now_n <= 1))

#number of individuals w/ dementia incidence: ~1270 
dem.w %>% group_by(study_id) %>%
  dplyr::summarize(
  dem = mean(anydementia)
) %>% 
  with(., table(dem))

#person-years over time
dem.w %>%
  mutate(dementia_now = factor(dementia_now, levels = c(1,0))) %>%
  ggplot(aes(x= exposure_year, 
             #y=study_id, 
             fill= dementia_now
             )) + 
  geom_bar() + 
  labs(title= "person-years",
       fill = "dementia incidence")

#number of dementia cases per year
dem.w %>%
  filter(dementia_now==1) %>%
  ggplot(aes(x= exposure_year)) + 
  geom_bar() + 
  labs(title= "number of dementia incident cases over time")

#follow-up time
##new id by intake date  
new_id <- dem.w %>%
  arrange(intakedt) %>%
  select(study_id) %>%
  unique() %>%
  mutate(id = row_number())

dem.w %>% 
  #filter(study_id < 1100) %>%
  left_join(new_id) %>%
  mutate(dementia_now = factor(dementia_now)) %>%
  ggplot(aes(x=exposure_year, y=id, group=id, colour=dementia_now)) + 
  geom_line() +
  geom_point(aes(size=dementia_now))

```


#Descriptive Statistics 

Distribution of key covariates.

```{r}
dem.w %>%
  select(
    study_id,
    age_intake:age_act,
    apoe:casi) %>% 
  #one row per individual
  unique() %>% 
  gather(key = "variable",  value = "value", -study_id) %>%  
  ggplot(aes(x=value)) + 
  geom_histogram() +
    facet_wrap(~variable, scales = "free")

#there are few non-white individuals, thus use race=1 (white) in models
table(dem.w$race)

```


Missingness of key covariates. 

Data is for all individuals with NO2 and/or PM2.5 predictions. #   
-lot of individuals with missing apoe readings    
-lot of missing median household income values   


```{r}
dem.w %>%
  select(
    study_id,
    age_intake:age_act,
    apoe:casi) %>%
  #only one row per individuals
  unique() %>%
  #describe()  #Info: how continuous the variable is, Gmd: Gini's mean difference - measure of dispersion
  summaryFull()  

 


```



Statistics calculated for individuals with at least `r min.pct*100`% of the months requied to estimate predictions (114/120 months for 10-year avg).

Median NO2 (ppb) and PM2.5 (µg/m3) concentration at baseline.

```{r baseline characteristics}
dem.bsl <- dem %>%
  #keep predictions from baseline. age_at_exposure_year may be < age_intake if ...? Jan 1st
  #filter(age_at_exposure_year <= age_intake)
  group_by(study_id, pollutant) %>%
  filter(
    #exposure range at baseline is year at age_intake going back to age_intake-1
    age_start_exposure <= age_intake,   # or <= ?? #age_at_exposure may be the same or 1 yr younger than age_intake at baseline
    #take first reading (baseline reading)
    #age_start_exposure == min(age_start_exposure)
    ) %>%
    
    #alredy did this above. #only look at baseline predictions where >= 95% of the month data exists 
    #exp_mos_coverage10_yr >= min.pct) %>%
  ungroup() %>%
  drop_na(exp_avg10_yr)

#calculate median baseline pollutant levels
bsl.expo.distrib <- dem.bsl %>% 
  group_by(pollutant) %>%
  #drop_na(exp_avg10_yr) %>%
  summarize(
    N = n(),
    median = median(exp_avg10_yr),
    iqr = IQR(exp_avg10_yr),
    mean = mean(exp_avg10_yr),
    sd = sd(exp_avg10_yr),
    min = min(exp_avg10_yr),
    max = max(exp_avg10_yr)
  )

kable(bsl.expo.distrib, digits = 0, caption = "")

median.bsl.no2 <- bsl.expo.distrib %>%
  filter(pollutant == "no2") %>%
  select(median) %>%
  as.numeric() %>% round()

median.bsl.pm25 <- bsl.expo.distrib %>%
  filter(pollutant == "pm25") %>%
  select(median) %>%
  as.numeric() %>% round()

#variable for whether baseline concentrations are above/below median concentration
dem.bsl <- dem.bsl %>%
  mutate(
    no2_median = ifelse(pollutant == "no2" & exp_avg10_yr >= median.bsl.no2, "above", 
                         ifelse(pollutant == "no2" & exp_avg10_yr < median.bsl.no2,"below", NA)),
    pm25_median = ifelse(pollutant == "pm25" & exp_avg10_yr >= median.bsl.pm25, "above", 
                         ifelse(pollutant == "pm25" & exp_avg10_yr < median.bsl.pm25,"below", NA))
    )


```

Participant characteristics based on 10-year average pollutant exposure at baseline. Percents are calculated based on the number of individuals with available data (missing values removed).

### --> compare #s to when use summaryAll()? 

```{r}
#All
t1a <- dem.bsl %>%
  group_by(pollutant) %>%
  summarize(
    no2_median = "all",
    pm25_median = "all",
    N = n(),
    age_entry_median = median(age_intake),
    age_entry_iqr = round(IQR(age_intake), 1),
    male_n = sum(male),
    male_pct = round(male_n/N*100, 1),
    race_known_n = sum(!is.na(race)),
    race_nonwhite_n = sum(race !=1, na.rm = T),
    race_nonwhite_pct = round(race_nonwhite_n/race_known_n*100, 1),
    edu_known_n = sum(!is.na(degree)),
    edu_beyond_hs_n = sum(degree >2, na.rm = T),
    edu_beyond_hs_pct = round(edu_beyond_hs_n/N*100, 1),
    #--> update w/ correct income variable
    # income_median = median(income),
    # income_iqr = IQR(income),
    apoe_known_n = sum(!is.na(apoe)),
    apoe_carrier_n = sum(apoe, na.rm=T),
    apoe_carrier_pct = round(apoe_carrier_n/apoe_known_n, 1),
    smoke_known_n = sum(!is.na(smoke)),
    smoke_never_n = sum(smoke==0, na.rm = T),
    smoke_never_pct = round(smoke_never_n/smoke_known_n*100, 1),
    smoke_former_n = sum(smoke==1, na.rm = T),
    smoke_former_pct = round(smoke_former_n/smoke_known_n*100, 1),
    smoke_current_n = sum(smoke==2, na.rm = T),
    smoke_current_pct = round(smoke_current_n/smoke_known_n*100, 1),
    exercise_median = median(exercise, na.rm = T),
    exercise_iqr = round(IQR(exercise, na.rm = T), 1),
    exercise_regular_known_n = sum(!is.na(exercise_reg)),
    exercise_regular_n = sum(exercise_reg==1, na.rm = T),
    exercise_regular_pct = round(exercise_regular_n/exercise_regular_known_n*100, 1),
    bmi_median = median(bmi, na.rm = T),
    bmi_iqr = round(IQR(bmi, na.rm = T), 1),
    hypertension_known_n = sum(!is.na(Hypertension)),
    hypertension_n = sum(Hypertension == 1, na.rm=T),
    hypertension_pct = round(hypertension_n/hypertension_known_n*100, 1),
    diabetes_known_n = sum(!is.na(Diabetes)),
    diabetes_n = sum(Diabetes == 1, na.rm=T),
    diabetes_pct = round(diabetes_n/diabetes_known_n*100, 1),
    cv_dis_known_n = sum(!is.na(CV_DIS)),
    cv_dis_n = sum(CV_DIS == 1, na.rm=T),
    cv_dis_pct = round(cv_dis_n/cv_dis_known_n*100, 1),
    heart_dis_known_n = sum(!is.na(Heart_Dis)),
    heart_dis_n = sum(Heart_Dis == 1, na.rm=T),
    heart_dis_pct = round(heart_dis_n/heart_dis_known_n*100, 1)
  ) %>%
  as.data.frame()

#Above/Below median
t1b <- dem.bsl %>%
  group_by(pollutant, no2_median, pm25_median) %>%
  summarize(
    N = n(),
    age_entry_median = median(age_intake),
    age_entry_iqr = round(IQR(age_intake), 1),
    male_n = sum(male),
    male_pct = round(male_n/N*100, 1),
    race_known_n = sum(!is.na(race)),
    race_nonwhite_n = sum(race !=1, na.rm = T),
    race_nonwhite_pct = round(race_nonwhite_n/race_known_n*100, 1),
    edu_known_n = sum(!is.na(degree)),
    edu_beyond_hs_n = sum(degree >2, na.rm = T),
    edu_beyond_hs_pct = round(edu_beyond_hs_n/N*100, 1),
    #--> update w/ correct income variable
    # income_median = median(income),
    # income_iqr = IQR(income),
    apoe_known_n = sum(!is.na(apoe)),
    apoe_carrier_n = sum(apoe, na.rm=T),
    apoe_carrier_pct = round(apoe_carrier_n/apoe_known_n, 1),
    smoke_known_n = sum(!is.na(smoke)),
    smoke_never_n = sum(smoke==0, na.rm = T),
    smoke_never_pct = round(smoke_never_n/smoke_known_n*100, 1),
    smoke_former_n = sum(smoke==1, na.rm = T),
    smoke_former_pct = round(smoke_former_n/smoke_known_n*100, 1),
    smoke_current_n = sum(smoke==2, na.rm = T),
    smoke_current_pct = round(smoke_current_n/smoke_known_n*100, 1),
    exercise_median = median(exercise, na.rm = T),
    exercise_iqr = round(IQR(exercise, na.rm = T), 1),
    exercise_regular_known_n = sum(!is.na(exercise_reg)),
    exercise_regular_n = sum(exercise_reg==1, na.rm = T),
    exercise_regular_pct = round(exercise_regular_n/exercise_regular_known_n*100, 1),
    bmi_median = median(bmi, na.rm = T),
    bmi_iqr = round(IQR(bmi, na.rm = T), 1),
    hypertension_known_n = sum(!is.na(Hypertension)),
    hypertension_n = sum(Hypertension == 1, na.rm=T),
    hypertension_pct = round(hypertension_n/hypertension_known_n*100, 1),
    diabetes_known_n = sum(!is.na(Diabetes)),
    diabetes_n = sum(Diabetes == 1, na.rm=T),
    diabetes_pct = round(diabetes_n/diabetes_known_n*100, 1),
    cv_dis_known_n = sum(!is.na(CV_DIS)),
    cv_dis_n = sum(CV_DIS == 1, na.rm=T),
    cv_dis_pct = round(cv_dis_n/cv_dis_known_n*100, 1),
    heart_dis_known_n = sum(!is.na(Heart_Dis)),
    heart_dis_n = sum(Heart_Dis == 1, na.rm=T),
    heart_dis_pct = round(heart_dis_n/heart_dis_known_n*100, 1)
  ) %>%
  as.data.frame()

#combine tables
t1 <- rbind(t1a, t1b) %>% 
  as.data.frame() %>%
    #paste N & pcts together
  mutate(
    median = ifelse(!is.na(no2_median), no2_median, pm25_median),
    
    age_median_iqr = paste0(age_entry_median, " (", age_entry_iqr, ")"),
    male_n_pct = paste0(male_n, " (", male_pct, "%)"),
    race_nonwhite_n_pct = paste0(race_nonwhite_n, " (", race_nonwhite_pct, "%)"),
    edu_beyond_hs_n_pct = paste0(edu_beyond_hs_n, " (", edu_beyond_hs_pct, "%)"),
    apoe_carrier_n_pct = paste0(apoe_carrier_n, " (", apoe_carrier_pct, "%)"),
    smoke_never_n_pct = paste0(smoke_never_n, " (", smoke_never_pct, "%)"),
    smoke_former_n_pct = paste0(smoke_former_n, " (", smoke_former_pct, "%)"),
    smoke_current_n_pct = paste0(smoke_current_n, " (", smoke_current_pct, "%)"),
    exercise_median_iqr = paste0(exercise_median, " (", exercise_iqr, ")"),
    exercise_regular_n_pct = paste0(exercise_regular_n, " (", exercise_regular_pct, "%)"),
    bmi_median_iqr = paste0(bmi_median, " (", bmi_iqr, ")"),
    hypertension_n_pct = paste0(hypertension_n, " (", hypertension_pct, "%)"),
    diabetes_n_pct = paste0(diabetes_n, " (", diabetes_pct, "%)"),
    cv_dis_n_pct = paste0(cv_dis_n, " (", cv_dis_pct, "%)"),
    heart_dis_n_pct = paste0(heart_dis_n, " (", heart_dis_pct, "%)")
  ) %>%
  #get rid of repeat columns
  select(
    pollutant, 
    median, 
    N,
    age_median_iqr:heart_dis_n_pct
  ) %>%
  #place NO2 and PM25 next to eachother 
  arrange(pollutant)


# transpose
t1 <- t(t1) %>% 
  as.data.frame() 

t1 %>% kable(caption = "")
  

```

# Inferential Statistics

```{r}
#3. create survival object w/ TVC dataset (accounts for "delayed entry")
# exp: s.stanford.tvc = with(stanford.tvc, Surv(tstart,tstop,death))
# dem.no2 <- dem %>%
#   filter(pollutant== "no2")

s.dem <- with(dem.w, Surv(
  # --> update so that time < time2
  time = age_start_exposure,  
  time2 =age_end_exposure,  
  event = dementia_now
                         )
             )

```

Model 1 (Reduced): Age (time axis), NO2 (time-varying) 

### --> ? Use cluster(study_id) or robust=T in coxph()? 

```{r  }

# summary(coxph(s.stanford.tvc~trt, data=stanford.tvc))
dem.w %>%
  coxph(s.dem ~ no2_10yr,# +  cluster(study_id),  #or robust=T ?
        data=., 
        robust = T,
        #ties = "exact" #takes Very long time; instead using default Efron approximation
        ) %>% 
  summary()

## ? CIs
#survfit.prison0 <- survfit(surv.prison0~1, data=prison0, conf.type="log-log")

```

M2 (a priori): M1 + gender, education, median household income, race, calendar year 2 ; APOE stratification  

```{r}
dem.w %>%
  coxph(s.dem ~ no2_10yr + 
          male + education + factor(race==1) + tr_med_inc_hshld + exposure_year + strata(apoe), 
        data=., 
        robust = T,
        ) %>%
  summary()

```

M3 (extended): M2 + smoking + physical activity 
### --> ? how to treat smoke? factor? use continuous pack_years instead?

```{r}

dem.w %>%
  coxph(s.dem ~ no2_10yr + 
          male + education + factor(race==1) + tr_med_inc_hshld + exposure_year + strata(apoe) + 
          factor(smoke) + exercise, 
        data=., 
        robust = T,
        ) %>%
  summary()

```

Model 4 (Extended & mediation): M3 + hypertension, diabetes, CV summary, heart disease summary, BMI

```{r}
 dem.w %>%
  coxph(s.dem ~ no2_10yr + 
          male + education + factor(race==1) + tr_med_inc_hshld + exposure_year + strata(apoe) + 
          factor(smoke) + exercise +
          Hypertension + Diabetes + CV_DIS + Heart_Dis + bmi, 
        data=., 
        robust = T,
        ) %>%
  summary()

```

Model 5 (APOE interaction): M2 + NO2*APOE

```{r}
dem.w %>%
  coxph(s.dem ~ no2_10yr + 
          male + education + factor(race==1) + tr_med_inc_hshld + exposure_year + strata(apoe) +
          no2_10yr*apoe , 
        data=., 
        robust = T,
        ) %>%
  summary()

```

Model 6 (copollutant): M2 + PM2.5 (time-varying)

```{r}
dem.w %>%
  coxph(s.dem ~ no2_10yr + 
          male + education + factor(race==1) + tr_med_inc_hshld + exposure_year + strata(apoe) + 
          pm25_10yr, 
        data=., 
        robust = T,
        ) %>%
  summary()

```






```{r lincom}
# estimating SE & CIs for linear combinations of coefficients
# m2c <- coxph(surv.addicts ~ dose*prison + strata(clinic), data=addicts)
# #summary(m2c)
# 
# est <- as.numeric(exp(60*coef(m2c)["dose"] + 1*coef(m2c)["prison"] + 100*coef(m2c)["dose:prison"]))
# 
# se <- deltamethod(g = ~exp(60*x1 + x2 + 100*x3),
#                   mean = coef(m2c)[c("dose", "prison", "dose:prison")],
#                   cov= vcov(m2c)[c("dose", "prison", "dose:prison"), 
#                                  c("dose", "prison", "dose:prison")],
#                   ses = T) 
# 
# ci = as.numeric(c(est-se*1.96, est+ se*1.96))

```

